---
title: "IAPS_Preprocessing"
author: '@H Cuve'
date: "12/12/2019"
output: html_document
---



# Preferences
list necessary package install them if not already and load them
```{r eval=FALSE, include=FALSE}
# devtools::install_github("dmirman/gazer")


list.of.packages <- c("ggplot2", "data.table", 'readr', "rhdf5", 'tidyverse', "gazer", 'lmerTest')
new.packages <- list.of.packages[!(list.of.packages %in% installed.packages()[,"Package"])]
if(length(new.packages)) install.packages(new.packages)
lapply(list.of.packages, require, character.only = TRUE)
lapply(new.packages, require, character.only = TRUE)


# setwd("~/Documents/Intero Study/data/Bio/Dec12")
hdf5FilesPath<- "~/OneDrive - Nexus365/InteroStudy2020/analysis/DataAnalysisJanuary2020/DataAnalysisJan2020/Eyetracking/2021"

```

# plotting preferences

```{r, plotting}
p<- list()
```

# gp extractor fucntion
takes gp files and returns a clean files with messages parsed and deletes unnecessary stuff

```{r, gp extractor}
gp.extractor(hdf5FilesPath)
gp.extractor = function(hdf5FilesPath) {
  
  setwd(hdf5FilesPath)
  
  hdfFilesList = list.files(hdf5FilesPath, pattern = "\\.hdf5$")
  
  if (length(hdfFilesList) == 0){
    
    return(message('No HDF5 files found in the directory provided.'))
  }
  # f = 1
  for (f in 1:length(hdfFilesList)) {
    
    message(sprintf("Extracting file %i / %i - %s", f, length(hdfFilesList), hdfFilesList[f]))
    
    #notr this sometimes fails because e are using a notebook 
    # Extract Events from hdf5, in that case run it from command
    tmp.events =h5read(hdfFilesList[f], '/data_collection/events/experiment/MessageEvent')
    tmp.eyetr  = h5read(hdfFilesList[f], '/data_collection/events/eyetracker/BinocularEyeSampleEvent')
    
    # tmp.events<- tmp.events[245:nrow(tmp.events), ]
    
    
    # problem file
    # tmp.events
    
    # Get subejct id from Events
    ssid = sapply(strsplit(grep('SubjJID', tmp.events$text, value = TRUE), split = ": "), "[", 2)
    date = sapply(strsplit(grep('DATE', tmp.events$text, value = TRUE), split = ": "), "[", 2)
    session = sapply(strsplit(grep('Session:', tmp.events$text, value = TRUE), split = ":"), "[", 2)
    cali<- subset(tmp.events, grepl('Cali', tmp.events$text) == TRUE)
    
    # Create DF for trials data
    tmp.df = data.frame(matrix(ncol = ncol(tmp.eyetr)))
    names(tmp.df) = names(tmp.eyetr)
    colnames(tmp.df)
    
    # Prepare Events, keep only start/end messages
    phrases = c('tStart', 'tEnd')
    tmp.events_backup<- tmp.events
    # tmp.events<-  tmp.events_backup
    tmp.events = subset(tmp.events, grepl(paste(phrases, collapse = "|"), tmp.events$text))
    
    # Create start/end references
    tmp.events$tStart   = NA
    tmp.events$tEnd     = NA
    
    # Trial number extraction 
    tmp.events$tNo      = NA
    tmp.df$tNo          = NA
    tmp.df$Condition    = NA
    
    # Space for subject id
    tmp.df$ssid         = NA
    tmp.df$text<-NA
    
    for (l in 1:nrow(tmp.events)) {
      # sub(".*_", "", tmp.events)
      
      # sub("[^_]*/_", "", tmp.events$text)
      # ([^\/]+$)
      # remove everything upto to _
      # as.numeric(strsplit(tmp.events$text[l], split = '_')[[1]][3])
      # "Extracting file %i / %i - %s", f, length(hdfFilesList), hdfFilesList[f])
      
      message(sprintf("Grabing start messages %s", tmp.events$text[l]))
      
      if ((grepl('tStart', tmp.events$text[l])) == TRUE) {
        tmp.events$tStart[l] = tmp.events$time[l]
        
        if ((grepl('tEnd', tmp.events$text[l+1])) == TRUE){
          tmp.events$tEnd[l] = tmp.events$time[l+1]
        }
        
        else {
          message('trial start/end structure not valid')
        }
      }
      
    }
    message(sprintf("done grabbing messages"))
    # readline(prompt="Press [enter] to continue")
    
    tmp.events$tNo<- as.numeric(as.character(gsub(".*_","",tmp.events$text)))

    # tmp.events$tNo[is.na(tmp.events$tNo) == TRUE]<- -7
    
    # tmp.events$screencontent = strsplit(tmp.events$text, split = '_')[[1]][2]
    # readline(prompt="Press [enter] to continue")
     message(sprintf("making screencontent"))
    tmp.events$screencontent<- if_else(grepl('fixation', tmp.events$text), 'fixation',
                                       if_else(grepl('Valence', tmp.events$text), 'ValenceResp',
                                               if_else(grepl('rest', tmp.events$text), 'rest1', 
                                                       if_else(grepl('IntResp', tmp.events$text), 'IntResp','stim'))))
    
    # unique(tmp.events$screencontent)
    
    # first let's do condition
    
    tmp.events$Condition<- if_else(grepl('IAPS', tmp.events$text), 'IAPS',
                                   if_else(grepl('Example', tmp.events$text), 'Practice',
                                           if_else(grepl('rest', tmp.events$text), 'Rest', NULL)))
    tmp.events$stim<- if_else(tmp.events$Condition == 'IAPS', sub(".*_ *(.*?) *jpg.*", "\\1", tmp.events$text),
                              if_else(tmp.events$Condition == 'Practice', sub(".*_ *(.*?) *jpg.*", "\\1", tmp.events$text), 'REST'))
    
    # substitute periods
    tmp.events$stim<- gsub('\\.', '.jpg', tmp.events$stim)
    # tmp.events$tNo<- as.numeric(tmp.events$tNo)
    tmp.events$tNo<- if_else(tmp.events$Condition == 'Practice', (tmp.events$tNo)-6,
                             if_else(tmp.events$Condition == 'Rest',-7, tmp.events$tNo))
    # tmp.events$tNo<- tmp.events$tNo1
    tmp.events$tNo<- if_else(tmp.events$tNo> -1, tmp.events$tNo+1, tmp.events$tNo) # avoid zeros
    
    tmp.events1 = subset(tmp.events, grepl('tStart',tmp.events$text))
    tmp.events1$tNo1<- NULL
    tmp.events1$tNo2<- NULL
    
    # tmp.eyetr_backup<- tmp.eyetr
    # tmp.df_backup<- tmp.df
    # tmp.df<- tmp.df_backup
    colnames(tmp.df)
    # rm(tmp.raw.trial)
    # colnames(tmp.raw.trial)
    colnames(tmp.df)
    colnames(tmp.events1)
    colnames(tmp.eyetr)
    tmp.df$screencontent<- NA
    tmp.df$stim<- NA
    # e=10
    tmp.events1$tEnd<- if_else(tmp.events1$tNo == -7, tmp.events1$tStart+120, tmp.events1$tEnd)
    message(sprintf("subsetting eyetracking data"))
    
    for(e in 1:nrow(tmp.events1)) {
      
      # Subset the EyeTracking data based on start/end
      tmp.raw.trial = subset(tmp.eyetr, tmp.eyetr$time >= tmp.events1$tStart[e] & tmp.eyetr$time <= tmp.events1$tEnd[e])
      
      tmp.raw.trial$tNo = tmp.events1$tNo[e]
      
      tmp.raw.trial$Condition = tmp.events1$Condition[e]
      tmp.raw.trial$screencontent = tmp.events1$screencontent[e]
      tmp.raw.trial$stim = tmp.events1$stim[e]
      # tmp.raw.trial$stim = tmp.events1$[e]
      tmp.raw.trial$ssid = ssid
      tmp.raw.trial$text = tmp.events1$text[e]
       message(sprintf("binding tmp.df"))
      tmp.df= rbind(tmp.raw.trial, tmp.df)
    }
     message(sprintf("done binding"))
    
    # Add ssid
    # tmp.df$ssID = ssid[e]
    tmp.df<- tmp.df%>%
      arrange(time)
    
    # Save file
    name = sprintf("ss%s_GPdata",ssid)
    message(sprintf("saving data"))
    
    write_csv(tmp.df, paste(name,".csv"))
    # write_csv(tmp.df, "test.csv")
    # write calibration cali
    name2 = sprintf("ss%s_GPdata_cali", ssid)
    write_csv(cali, paste(name2,".csv"))
    
    
    
  }
  
  # write_csv(tmp.df, 'tmpdf_extracted.csv')
  
  message("Processing Completed.")
  tmp.df
}

tmp_full<- gp.extractor(hdf5FilesPath)


```

now cleaning
we need to have data for ledalab
gaze path
clean and tracloss

```{r, cleaning}
# function to read all the csvs into one dataframe
rm(tmp_full)
read_plus <- function(flnm) {
  data.table::fread(flnm, select = c("session_id","event_id", "time", "left_gaze_x", "left_gaze_y","right_gaze_x", "right_gaze_y","left_pupil_measure1",
                                     "right_pupil_measure1","gsr", 'hr',"status", "tNo",  "Condition", "screencontent", "stim", "ssid", "text")) %>% 
    mutate(filename = flnm)
}

# now read them

tmp.df2 <-
  list.files(pattern = "*.csv", 
             full.names = T) %>% 
  map_df(~read_plus(.))
rm(db_beh)

tmp.df2$ssid<- substr(tmp.df2$filename, 5,7)
unique(tmp.df2$ssid)
head(tmp.df2)

# check if we have all participants
colnames(tmp.df2)
unique(tmp.df2$ssid)

# gp preprocessing cuntion, checks for losses, averages gaze and pupil and pixelate
gp_preprocessing = function(tmp.df2) {
  
  message(sprintf("step1 lft gaze validity"))
  
  tmp.df2$left_gaze_x_cor<- if_else(tmp.df2$status != '20', tmp.df2$left_gaze_x, NULL)
  tmp.df2$left_gaze_x_cor<- if_else(tmp.df2$status != '22', tmp.df2$left_gaze_x_cor, NULL)
  tmp.df2$left_gaze_y_cor<- if_else(tmp.df2$status != '20', tmp.df2$left_gaze_y, NULL)
  tmp.df2$left_gaze_y_cor<- if_else(tmp.df2$status != '22', tmp.df2$left_gaze_y_cor, NULL)
  
  message(sprintf("step2 right gaze validity"))
  
  tmp.df2$right_gaze_x_cor<- if_else(tmp.df2$status != '2', tmp.df2$right_gaze_x, NULL)
  # 
  tmp.df2$right_gaze_x_cor<- if_else(tmp.df2$status != '22', tmp.df2$right_gaze_x_cor, NULL)
  tmp.df2$right_gaze_y_cor<- if_else(tmp.df2$status != '22', tmp.df2$right_gaze_y, NULL)
  tmp.df2$right_gaze_y_cor<- if_else(tmp.df2$status != '22', tmp.df2$right_gaze_y_cor, NULL)

  # pupil validity
  message(sprintf("step3 pupil validity"))
  tmp.df2$left_pupil_measure1<- if_else(tmp.df2$status != '20', tmp.df2$left_pupil_measure1, NULL)
  tmp.df2$left_pupil_measure1<- if_else(tmp.df2$status != '22', tmp.df2$left_pupil_measure1, NULL)
  
  tmp.df2$right_pupil_measure1<- if_else(tmp.df2$status != '2', tmp.df2$right_pupil_measure1, NULL)
  tmp.df2$right_pupil_measure1<- if_else(tmp.df2$status != '22', tmp.df2$right_pupil_measure1, NULL)
  table(is.na(tmp.df2$right_pupil_measure1))
  
  # tmp.df2$right_pupil_measure1<- if_else(tmp.df2$pupil_meas>7, tmp.df2$right_pupil_measure1, NULL)
  message(sprintf("step 4 cutingt off screen in points and repixel"))
  tmp.df2$left_gaze_x_cor<- if_else(tmp.df2$left_gaze_x_cor >= -960 & tmp.df2$left_gaze_x_cor <= 960, tmp.df2$left_gaze_x_cor, NULL)
  tmp.df2$right_gaze_x_cor<- if_else(tmp.df2$right_gaze_x_cor >= -960 & tmp.df2$right_gaze_x_cor <= 960, tmp.df2$right_gaze_x_cor, NULL)
  
  tmp.df2$left_gaze_y_cor<- if_else(tmp.df2$left_gaze_y_cor >= -540 & tmp.df2$left_gaze_y_cor <= 540, tmp.df2$left_gaze_y_cor, NULL)
  tmp.df2$right_gaze_y_cor<- if_else(tmp.df2$right_gaze_y_cor >= -540 & tmp.df2$right_gaze_y_cor <= 540, tmp.df2$right_gaze_y_cor, NULL)
  
  tmp.df2$left_gaze_x_cor_pix<- tmp.df2$left_gaze_x_cor+960
  tmp.df2$right_gaze_x_cor_pix<- tmp.df2$right_gaze_x_cor+960
  
  tmp.df2$left_gaze_y_cor_pix<- tmp.df2$left_gaze_y_cor+540
  tmp.df2$right_gaze_y_cor_pix<- tmp.df2$right_gaze_y_cor+540
  
  # is left or right and na
  
  tmp.df2$left_na<- is.na(tmp.df2$left_gaze_x_cor) 
  tmp.df2$right_na<- is.na(tmp.df2$right_gaze_x_cor)
  tmp.df2$both_na<- if_else(tmp.df2$left_na == TRUE & tmp.df2$right_na == TRUE, TRUE, FALSE)
  
  message(sprintf("step5 gaze x  means"))
  tmp.df2$gaze_x_cor<-if_else(tmp.df2$left_na == TRUE & tmp.df2$both_na == FALSE, tmp.df2$right_gaze_x_cor,
                              if_else(tmp.df2$right_na == TRUE & tmp.df2$both_na == FALSE, tmp.df2$left_gaze_x_cor,
                                      ((tmp.df2$left_gaze_x_cor + tmp.df2$right_gaze_x_cor)/2)))
  message(sprintf("step6 gaze y means"))
  
  tmp.df2$gaze_y_cor<-if_else(tmp.df2$left_na == TRUE & tmp.df2$both_na == FALSE, tmp.df2$right_gaze_y_cor,
                              if_else(tmp.df2$right_na == TRUE & tmp.df2$both_na == FALSE, tmp.df2$left_gaze_y_cor,
                                      ((tmp.df2$left_gaze_y_cor + tmp.df2$right_gaze_y_cor)/2)))
  
  message(sprintf("step6 repixel gaze means"))
  tmp.df2$gaze_x_cor_pix<- tmp.df2$gaze_x_cor + 960
  min(tmp.df2$gaze_x_cor_pix, na.rm = TRUE)
  
  tmp.df2$gaze_y_cor_pix<- tmp.df2$gaze_y_cor+540
  min(tmp.df2$gaze_y_cor_pix, na.rm = TRUE)
  
  # clean_pupil
  message(sprintf("cleaning pupil"))
  
  max(tmp.df2$left_pupil_measure1)
  
  tmp.df2$pupil<- if_else(tmp.df2$left_na == TRUE & tmp.df2$both_na == FALSE, tmp.df2$right_pupil_measure1,
                          if_else(tmp.df2$right_na == TRUE & tmp.df2$both_na == FALSE, tmp.df2$left_pupil_measure1,
                                  ((tmp.df2$left_pupil_measure1 + tmp.df2$right_pupil_measure1)/2)))
  # tmp.df2$trackloss<- if_else(tmp.df2$status > 0, TRUE, FALSE)
  tmp.df2$trialUnq<- paste(tmp.df2$tNo, paste(tmp.df2$screencontent, paste(tmp.df2$stim)))
  tmp.df2$distance = 600
  
  # min(tmp.df2$pupil, na.rm = TRUE)
  # max(tmp.df2$pupil, na.rm = TRUE)
  # colnames(tmp.df2)
  tmp.df2<- tmp.df2%>%
    arrange(time)
}

tmp.df2<- gp_preprocessing(tmp.df2)
 colnames(tmp.df2) 
  
# # calculate trackloss
# (sprintf("calculating trackloss"))
#  
#   tmp.df2_trackloss<- tmp.df2%>%
#     group_by(tNo, trialUnq, ssid, trackloss)%>%
#     summarise(n = n()) %>%
#     mutate(trackloss_prop = n() / sum(n))%>%
#     mutate(mean_valid = 1- trackloss_prop)
#   
# tmp.df2_trackloss<- subset(tmp.df2_trackloss, tmp.df2_trackloss$trackloss == TRUE)
# tmp.df2_trackloss<- tmp.df2_trackloss %>%
#   group_by(trackloss)%>%
#   # summarise(mean_loss = mean(trackloss_prop))%>%
#   mutate(mean_valid = 1- trackloss_prop)
# 
# 
#   tmp.df2_trackloss$trackloss<- NULL
  # tmp.df2<- left_join(tmp.df2, tmp.df2_trackloss, by = c('tNo', 'trialUnq', 'ssid'))
  
```




# rezeroing

```{r}
colnames(tmp.df2)
tmp.df3<- tmp.df2
# tmp.df3<- tmp.df2
colnames(tmp.df3)


# create start at every screen content
tmp.df3<- tmp.df3%>% 
  arrange(time)%>%
  group_by(ssid)%>%
  mutate(firststart = duplicated(trialUnq))

# make zeros
tmp.df3$zero<- if_else(tmp.df3$firststart == FALSE, tmp.df3$time, NULL)
# fill in the zeros
tmp.df3<- tmp.df3%>%
  group_by(Condition, tNo, ssid)%>%
  # group_by(text)%>%
  fill(zero)
# rezero
tmp.df3<-tmp.df3%>%
  arrange(time)%>%
  group_by(ssid, tNo)%>%
  mutate(timerezero = time - zero)

min(tmp.df3$timerezero, na.rm = TRUE)
natest<-subset(tmp.df3, is.na(tmp.df3$ssid) == TRUE)
# let's check to see if it looks fine
ggplot(tmp.df3, aes(time, gsr, colour = as.factor(ssid)))+
  geom_line()
  # facet_grid(~screencontent)

# ggplot(subset(tmp.df3, tmp.df3$Condition == 'IAPS'), aes(timerezero, gsr, colour = as.factor(ssid)))+
#   geom_line()

  # create a new time rezero where before stim start is negative
tmp.df3<- tmp.df3%>%
  # arrange(time)%>%
  group_by(ssid, Condition, screencontent)%>%
  mutate(firststartSTIM = duplicated(tNo))

#this will create a time in the stim start wich we can use to do the r=secnd rezero
tmp.df3$zero_stim<- if_else(tmp.df3$firststartSTIM == FALSE & tmp.df3$screencontent == 'stim', tmp.df3$time, NULL)
   
    tmp.df3<- tmp.df3%>%
      # arrange(time)%>%
      group_by(tNo, ssid)%>%
      fill(zero_stim)
   
   tmp.df3<- tmp.df3%>%
      arrange(time)%>%
     group_by(ssid, tNo)%>%
      fill(zero_stim, .direction = c('up'))
   tmp.df3$timerezero2<- tmp.df3$time-tmp.df3$zero_stim
   # check timerezero2
   
     min(tmp.df3$timerezero2, na.rm = TRUE)
  max(tmp.df3$timerezero2, na.rm = TRUE)

# time 3 including rest
  # simply inclues rest as is

tmp.df3$timerezero3<- if_else(tmp.df3$Condition == 'Rest', tmp.df3$timerezero, tmp.df3$timerezero2)
min(tmp.df3$timerezero3, na.rm = TRUE)


# let's check
unique(tmp.df3$ssid)
tmp.df3<- subset(tmp.df3, is.na(tmp.df3$ssid) == FALSE)

ggplot(subset(tmp.df3, tmp.df3$Condition == 'IAPS') , aes(x = timerezero3, y= gsr, colour = as.factor(ssid)))+
    geom_smooth()+
    # geom_()+
    geom_vline(aes(xintercept = 0), colour = 'red', linetype = 'dashed', size = 2)+
    geom_vline(aes(xintercept = 4), colour = 'gray30', linetype = 'dotted', size = 2)+
    geom_vline(aes(xintercept = 8), colour = 'gray30', linetype = 'dotted', size = 2)+
    geom_vline(aes(xintercept = 6), colour = 'blue', linetype = 'dashed', size = 2)


ggplot(subset(tmp.df3, tmp.df3$tNo == -4) , aes(x = timerezero2, y= gsr, colour = as.factor(ssid)))+
  # geom_point()
      geom_line() +
    # geom_smooth(aes())+
    geom_vline(aes(xintercept = 0), colour = 'red', linetype = 'dashed', size = 2)+
    geom_vline(aes(xintercept = 4), colour = 'gray30', linetype = 'dotted', size = 2)+
    geom_vline(aes(xintercept = 8), colour = 'gray30', linetype = 'dotted', size = 2)+
    geom_vline(aes(xintercept = 6), colour = 'blue', linetype = 'dashed', size = 2)

ggplot(subset(tmp.df3, tmp.df3$tNo == -1) , aes(x = timerezero2, y= gsr, colour = as.factor(ssid)))+
  # geom_point()
      geom_line() +
    # geom_smooth(aes())+
    geom_vline(aes(xintercept = 0), colour = 'red', linetype = 'dashed', size = 2)+
    geom_vline(aes(xintercept = 4), colour = 'gray30', linetype = 'dotted', size = 2)+
    geom_vline(aes(xintercept = 8), colour = 'gray30', linetype = 'dotted', size = 2)+
    geom_vline(aes(xintercept = 6), colour = 'blue', linetype = 'dashed', size = 2)


```


triggers
```{r}
unique(tmp.df3$tNo)
natest<- subset(tmp.df3, is.na(tmp.df3$tNo) == TRUE)
tmp.df3<- subset(tmp.df3, is.na(tmp.df3$tNo) == FALSE)

tmp.df3$intercept_time<- if_else
(tmp.df3$firststart == FALSE, tmp.df3$time, 
                          if_else(tmp.df3$firststartSTIM == FALSE, tmp.df3$time,
                                  NULL))
# takes a bit with a group - so don't run
ggplot(tmp.df3, aes(time, gsr))+
  geom_line()+
  geom_vline(aes(xintercept = intercept_time))

# should trigger be this or should I create a uoque code for this based on the images
unique(tmp.df3$tNo)

tmp.df3$trigger<- as.double(tmp.df3$tNo)

tmp.df3$trigger<- if_else(tmp.df3$firststart == FALSE, tmp.df3$trigger, 
                          if_else(tmp.df3$firststartSTIM == FALSE, tmp.df3$trigger, 0))
tmp.df3$trigger <- if_else(tmp.df3$screencontent == 'fixation' &tmp.df3$firststart == FALSE, 100,
                          if_else(tmp.df3$screencontent == 'ValenceResp' & tmp.df3$firststart == FALSE, 101,
                             if_else(tmp.df3$screencontent == 'IntResp' & tmp.df3$firststart == FALSE, 102, tmp.df3$trigger))) 

unique(tmp.df3$trigger)
tmp.df3$trigger<- if_else(tmp.df3$firststart == TRUE, 0, tmp.df3$trigger)

unique(tmp.df3$trigger)


```


writing for ledalab

```{r}
tmp.df3<- tmp.df3%>%
  arrange(ssid, time,tNo)
# gsr baseline wil be the 1 second before tial start
# gsr to microsiemnes 1/J3*100000
options(scipen = 999)
tmp.df3$gsr_ms<- 1/tmp.df3$gsr*100000
unique(tmp.df3$ssid)
max(tmp.df3$gsr_ms)
min(tmp.df3$gsr_ms)

# gsr for leda
colnames(tmp.df3)
db_GSR<- select(tmp.df3, c(3,  17, 47, 46 ))
db_GSR$tNo<- NULL
colnames(db_GSR)

db_GSR$Condition2<- if_else(db_GSR$Condition == 'Rest', 'Rest', 'IAPS')
unique(db_GSR$Condition2)
db_GSR$split_column<- paste0(db_GSR$Condition2,paste(db_GSR$ssid))
unique(db_GSR$split_column)
  (sprintf("writing for ledlab"))

split_column<- unique(db_GSR$split_column)

split_gsr = split(db_GSR, list(db_GSR$split_column))

    for (ssid in names(split_gsr)) {
      write_tsv(split_gsr[[ssid]][,c("time","gsr_ms", "trigger")], paste0("gpgsr_", paste0(ssid),".txt"), col_names = FALSE)
    }
```


# baselining gsr
```{r}
# use ms to baseline

tmp.df3$gsr_bas<- if_else(tmp.df3$timerezero3 >= -3 & tmp.df3$timerezero3 < 0, tmp.df3$gsr_ms, NULL)
# true if baseline within window
tmp.df3$gsr_bastrue<- if_else(tmp.df3$timerezero3 >= -3 & tmp.df3$timerezero3 < 0, TRUE, FALSE)

# create bseline median
tmp.df3<- tmp.df3%>%
  arrange(time)%>%
  group_by(ssid, tNo, gsr_bastrue)%>%
  mutate(gsr_bas_mean = median(gsr_bas))

# fill the baseline mean
tmp.df3<- tmp.df3%>%
  # arrange(time)%>%
  group_by(ssid, tNo)%>%
  fill(gsr_bas_mean)

# fill up to complete
tmp.df3<- tmp.df3%>%
  # arrange(time)%>%
  group_by(ssid, tNo)%>%
  fill(gsr_bas_mean, .direction = 'up')

# do baseline correction
tmp.df3<- tmp.df3%>%
  # arrange(time)%>%
  group_by(ssid, tNo)%>%
  mutate(gsr_basCor = gsr_ms - gsr_bas_mean)

# rest baselining
tmp.df3<- tmp.df3%>%
  # arrange(time)%>%
  group_by(ssid, Condition)%>%
  mutate(gsr_restmean = median(gsr_ms))

tmp.df3$gsr_basCor<- if_else(tmp.df3$Condition == 'Rest', tmp.df3$gsr_ms- tmp.df3$gsr_restmean, tmp.df3$gsr_basCor)

# plot diagnosis
ggplot(subset(tmp.df3, tmp.df3$Condition == 'IAPS') , aes(x = timerezero3, y= gsr_basCor, colour = as.factor(ssid)))+
  # stat_summary(geom = 'line', fun.data = 'mean')+
    geom_smooth()+
    geom_vline(aes(xintercept = 0), colour = 'red', linetype = 'dashed', size = 2)+
    geom_vline(aes(xintercept = 4), colour = 'gray30', linetype = 'dotted', size = 2)+
    geom_vline(aes(xintercept = 8), colour = 'gray30', linetype = 'dotted', size = 2)+
    geom_vline(aes(xintercept = 6), colour = 'blue', linetype = 'dashed', size = 2)
  
 ggplot(subset(tmp.df3, tmp.df3$Condition == 'Rest') , aes(x = timerezero3, y= gsr_basCor, colour = as.factor(ssid)))+
  # stat_summary(geom = 'line', fun.data = 'mean')+
    geom_smooth()+
    geom_vline(aes(xintercept = 0), colour = 'red', linetype = 'dashed', size = 2)+
    geom_vline(aes(xintercept = 4), colour = 'gray30', linetype = 'dotted', size = 2)+
    geom_vline(aes(xintercept = 8), colour = 'gray30', linetype = 'dotted', size = 2)+
    geom_vline(aes(xintercept = 6), colour = 'blue', linetype = 'dashed', size = 2) 
  # tmp.df_norest$tNo<- as.factor(tmp.df_norest$tNo)
    
ggplot(subset(tmp.df3, tmp.df3$screencontent == 'stim') , aes(x = timerezero3, y= gsr_basCor, olour = as.factor(ssid)))+
    geom_smooth(aes())+
    geom_vline(aes(xintercept = 0), colour = 'red', linetype = 'dashed', size = 2)+
    geom_vline(aes(xintercept = 4), colour = 'gray30', linetype = 'dotted', size = 2)+
    geom_vline(aes(xintercept = 8), colour = 'gray30', linetype = 'dotted', size = 2)+
    geom_vline(aes(xintercept = 6), colour = 'blue', linetype = 'dashed', size = 2)
 

```

#baseline and clean pupil

```{r}
library(gazer)

tmp.df3$pupil<- if_else(tmp.df3$pupil> 7.2, tmp.df3$pupil, NULL)
min(tmp.df3$pupil, na.rm = TRUE)

tmp.df3<- tmp.df3 %>%
  group_by(ssid, trialUnq) %>%
  mutate(extendpupil=extend_blinks(pupil, fillback=100, fillforward=100, hz=150))

min(tmp.df3$extendpupil, na.rm = TRUE)

# let's check

ggplot(subset(tmp.df3, tmp.df3$tNo == -3), aes(x = timerezero3, y= extendpupil , colour = as.factor(ssid)))+
      geom_line()
  # geom_line(aes(y = extendpupil), linetype = 'dashed', colour = 'red')

# Smooth and Interpolate
tmp.df3$subject<- tmp.df3$ssid
tmp.df3$trial = tmp.df3$trialUnq

# min(pup_extend$pupil, na.rm = TRUE)
tmp.df3$extendpupil
?smooth_interpolate_pupil

library(gazer)
tmp.df3 <- smooth_interpolate_pupil(tmp.df3, pupil="pupil", extendpupil="extendpupil",
                                    extendblinks=TRUE, step.first= 'smooth',
                                    maxgap=Inf, 
                                    filter = 'moving',
                                    type="linear", hz=150, n = 30)

# tmp.df3<-test

min(tmp.df3$pup_interp)
max(tmp.df3$pup_interp)

ggplot(subset(tmp.df3, tmp.df3$tNo == -4 & tmp.df3$ssid == 309) , aes(x = timerezero3, y= pup_interp, colour = as.factor(ssid)))+
  geom_line()
  # facet_grid(~Condition)


# create baseline pupil mean
tmp.df3backup<- tmp.df3
tmp.df3$pup_bas<- if_else(tmp.df3$timerezero3 >= -1 & tmp.df3$timerezero3 < 1, tmp.df3$pup_interp, NULL)
# true if bseline if baseline within widnown
tmp.df3$pup_bastrue<- if_else(tmp.df3$timerezero3 >= -1 & tmp.df3$timerezero3 < 1, TRUE, FALSE)


tmp.df3<- tmp.df3%>%
  # arrange(time)%>%
  group_by(tNo, pup_bastrue)%>%
  mutate(pup_bas_med = median(pup_bas))


# fill the baseline mean pupil
tmp.df3<- tmp.df3%>%
  # arrange(time)%>%
  group_by(tNo)%>%
  fill(pup_bas_med)

# fill up to complete pupil
tmp.df3<- tmp.df3%>%
  # arrange(time)%>%
  group_by(tNo)%>%
  fill(pup_bas_med, .direction = 'up')


# do baseline correction
tmp.df3<- tmp.df3%>%
  # arranÃ‡ge(time)%>%
  group_by(tNo)%>%
  mutate(pup_basCor = pup_interp - pup_bas_med)


# we only one the median for rest
tmp.df3<- tmp.df3%>%
  group_by(Condition)%>%
  mutate(pupilrest = median(pup_interp))

tmp.df3$pup_basCor<- if_else(tmp.df3$Condition == 'Rest', tmp.df3$pup_interp-tmp.df3$pupilrest, tmp.df3$pup_basCor)


# MAD removal
tmp.df3<-tmp.df3 %>%
  dplyr::group_by(subject, trial) %>%
  dplyr::mutate(speed=speed_pupil(pup_interp,time)) %>%
  dplyr::mutate(MAD=calc_mad(speed))%>%
  dplyr::filter(speed < MAD)

tmp.df3
 
ggplot(subset(tmp.df3, tmp.df3$tNo == -3), aes(x = timerezero3, y = pup_basCor, colour = as.factor(ssid)))+
  geom_line()
 
  
ggplot(subset(tmp.df3, tmp.df3$Condition == 'IAPS') , aes(x = timerezero3, y= pup_basCor, colour = as.factor(ssid)))+
    geom_smooth(se = F)+
    geom_vline(aes(xintercept = 0), colour = 'red', linetype = 'dashed', size = 2)+
    geom_vline(aes(xintercept = 4), colour = 'gray30', linetype = 'dotted', size = 2)+
    geom_vline(aes(xintercept = 8), colour = 'gray30', linetype = 'dotted', size = 2)+
    geom_vline(aes(xintercept = 6), colour = 'blue', linetype = 'dashed', size = 2)

unique(tmp.df3$ssid)

ggplot(subset(tmp.df3, tmp.df3$Condition == 'Rest') , aes(x = timerezero3, y= pup_basCor, colour = as.factor(ssid)))+
    geom_smooth(se = T)+
    geom_vline(aes(xintercept = 0), colour = 'red', linetype = 'dashed', size = 2)+
    geom_vline(aes(xintercept = 4), colour = 'gray30', linetype = 'dotted', size = 2)+
    geom_vline(aes(xintercept = 8), colour = 'gray30', linetype = 'dotted', size = 2)+
    geom_vline(aes(xintercept = 6), colour = 'blue', linetype = 'dashed', size = 2)

colnames(tmp.df3)
table(is.na(tmp.df3$gsr_ms))
table(is.na(tmp.df3$hr))


min(tmp.df3$hr, na.rm = TRUE)
max(tmp.df3$hr, na.rm = TRUE)

tmp.df3$hr<- if_else(tmp.df3$hr > 40 & tmp.df3$hr< 120, tmp.df3$hr, NULL)

colnames(tmp.df3)
tmp.df4<- select(tmp.df3, c(1:3,11:19,24:27,33:37,44,46,47,51,53:56,60))
head(tmp.df4)


tmp.df4$trackloss<- if_else(tmp.df4$status> 0, 1, 0)
tmp.df4$hr_na<- if_else(is.na(tmp.df4$hr) == TRUE, TRUE, FALSE)
tmp.df4$hr_na<- if_else(tmp.df4$hr_na == TRUE, 1, 0)
tmp.df4 <- tmp.df4%>%
  group_by(ssid, tNo, trialUnq, text)%>%
  mutate(gaze_loss_prop = sum(trackloss)/n())%>%
  mutate(gaze_valid_prop = 1 - gaze_loss_prop)%>%
  mutate(hr_na_prop = sum(hr_na)/n())

colnames(tmp.df4)
write_csv(tmp.df4, 'intero_tsdata_clean.csv')

tmp.df4<- read_csv('intero_tsdata_clean.csv')
tmp.df4<- tmp.df4%>%
  arrange(ssid, time, tNo )
unique(tmp.df4$trigger)
tmp.df4$trigger2<- tmp.df4$trigger

tmp.df4$trigger2<- if_else(tmp.df4$trigger>99, tmp.df4$trigger, tmp.df4$tNo)
unique(tmp.df4$trigger2)
tmp.df4_sum<- tmp.df4%>%
  arrange(ssid, time, tNo)%>%
  group_by(ssid, subject, trial, Condition, screencontent, tNo, stim, trialUnq,text)%>%
  summarise_at(c('hr', 'pup_basCor', 'gsr_basCor', 'hr', 'time', 'gaze_loss_prop', 'gaze_valid_prop', 'hr_na_prop', 'timerezero3'), mean, na.rm = TRUE)

tmp.df4_sum$trigger<-if_else(tmp.df4_sum$screencontent == 'fixation', 100,
                          if_else(tmp.df4_sum$screencontent == 'ValenceResp', 101,
                             if_else(tmp.df4_sum$screencontent == 'IntResp', 102, tmp.df4_sum$tNo))) 
  
unique(tmp.df4_sum$trigger)
  
unique(tmp.df4_sum$trigger)

write_csv(tmp.df4_sum, 'intero_aggdata_clean.csv')

tmp.df4_sum<- tmp.df4_sum%>%
  arrange(time, tNo, ssid)

head(tmp.df4_sum)

unique(tmp.df4_sum$tNo)

ggplot(tmp.df4_sum, aes(tNo, gaze_valid_prop, colour = as.factor(ssid)))+
  geom_point()+
  geom_line()

ggplot(subset(tmp.df4_sum, tmp.df4_sum$screencontent == 'stim'), aes(tNo, gaze_valid_prop, colour = as.factor(ssid)))+
  geom_point()+
  geom_line()


(sprintf("preparing for gazepath"))
  colnames(tmp.df4)
  
  for_gazepath<- select(tmp.df4, c(1:3,5:22, 29,33:34))
  
  for_gazepath$screencontent[for_gazepath$screencontent == 'rest1']<- 'fixation'
  for_gazepath<- for_gazepath%>%
    arrange(ssid, time, tNo)
  
  colnames(for_gazepath)
  
  for_gazepath<- subset(for_gazepath, is.na(for_gazepath$time) == FALSE)
   # View(for_gazepath)
  
  for_gazepath$split_column<- paste0(for_gazepath$ssid, paste0(for_gazepath$screencontent))
  splitcol<- unique(for_gazepath$split_column)
  splitcol
  # ssid<- unique(for_gazepath$ssid)
  # ssid
  split_df = split(for_gazepath, list(for_gazepath$split_column))
  
  
  (sprintf("writing for gazepath"))
  # ssid = split(for_gazepath, list(for_gazepath$ssid))
  # for (ssid in names(split_df)) {
    for (splitcol in names(split_df)) {
      # message( split_df[splitcol])
      write_csv(split_df[[splitcol]], paste0('gp_',paste0(splitcol),".csv"))
    }


```
process gazepath and ledalab
```{r}
library(gazepath)
GUI()

```


# Import Ledalab
```{r}
read_leda <- function(flnm) {
  data.table::fread(flnm) %>% 
    mutate(filename = flnm)
}

# now read them
db_leda <-
  list.files(pattern = "*.txt", 
             full.names = T) %>% 
  map_df(~read_leda(.))

db_leda$trigger<- as.numeric(db_leda$Event.NID)
unique(db_leda$trigger)
db_leda$ssid<- as.numeric(substr(db_leda$filename, 13,15))
colnames(tmp.df4_sum)
colnames(db_leda)
nrow(tmp.df4_sum)
nrow(db_leda)
colnames(tmp.df4_sum)
tmp.df4_sum2<- subset(tmp.df4_sum,tmp.df4_sum$tNo != -7)
tmp.df4_sum2<- tmp.df4_sum2%>%
  arrange(ssid, time, tNo)%>%
  group_by(ssid)%>%
  mutate(order = 1:224)

db_leda2<- subset(db_leda, db_leda$trigger != -7)
db_leda2<- db_leda2%>%
  arrange(ssid, Event.Nr)%>%
  group_by(ssid)%>%
  mutate(order = 1:224)

tmp.df4_sum_fullt<- left_join(tmp.df4_sum2, db_leda2, by = c("order", "trigger", "ssid"))
tmp.df4_sum_full_backup<- tmp.df4_sum_full

tmp.df4_sum_full<- left_join(tmp.df4_sum2, db_leda2, by = c("order", "trigger", "ssid"))

# tmp.df4_sum_full<- bind_cols(tmp.df4_sum, db_leda)

tmp.df4_sum_full<- tmp.df4_sum_full%>%
  arrange(ssid, tNo)
```

read parsed data
```{r}
read_parsed <- function(flnm) {
    read_csv(flnm) %>%
        mutate(filename = flnm)
}

db_parsed <- list.files(pattern = "*.csv", 
               full.names = T) %>% 
    map_df(~read_parsed(.))


# return content between spaces
# pu things in the correct order
# library(stringr)
db_parsed$screencontent<- str_extract(db_parsed$trialUnq, "(?<=\\s)(.*)(?=\\s)")
unique(db_parsed$screencontent)
db_parsed$screencontent[db_parsed$screencontent == 'rest1']<- 'fixation'


db_parsed$screencontent_no<- if_else(db_parsed$screencontent == 'fixation', 1,
                                      if_else(db_parsed$screencontent == 'stim', 2,
                                              if_else(db_parsed$screencontent == 'ValenceResp', 3,
                                                      if_else(db_parsed$screencontent == 'IntResp', 4, NULL))))

db_parsed$tNo<- as.numeric(substr(db_parsed$trialUnq, 1,2))
unique(db_parsed$screencontent_no)
db_parsed$ssid<- substr(db_parsed$Participant, 4,6)

db_parsed<- db_parsed%>%
  arrange(ssid, tNo, screencontent_no)

ggplot(db_parsed, aes(mean_x, mean_y))+
  geom_point()+
  facet_grid(ssid~screencontent)

unique(db_parsed$tNo)
# db_parsed$tNo<- if_else(db_parsed$tNo > -1, db_parsed$tNo-1, db_parsed$tNo )

db_parsed<-db_parsed%>%
  group_by(ssid, tNo, screencontent,Value)%>%
  mutate(mean_fix_dur = mean(Duration))%>%
  mutate(mean_POGsdSacAmp = mean(POGsdSacAmp))%>%
  mutate(fix_count = sum(Value == 'f'))%>%
  mutate(sac_count = sum(Value == 's'))

# this might be needed for tempoal analisys
write_csv(db_parsed, 'db_parsed.csv')

db_parsed_summarised<- db_parsed%>%
  group_by(ssid, tNo,screencontent, trialUnq, screencontent_no, Value)%>%
  summarise_at(c('fix_count', 'sac_count', 'mean_fix_dur', 'mean_POGsdSacAmp', 'RMS'), mean, na.rm = TRUE)


colnames(db_parsed_summarised)
db_parsed_summarised_fix<- subset(db_parsed_summarised, db_parsed_summarised$Value == 'f')
db_parsed_summarised_fix$sac_count<- NULL
db_parsed_summarised_fix$POGsd<- db_parsed_summarised_fix$mean_POGsdSacAmp
db_parsed_summarised_fix$mean_POGsdSacAmp<- NULL
db_parsed_summarised_fix$Value<-NULL
db_parsed_summarised_sac<- subset(db_parsed_summarised, db_parsed_summarised$Value == 's')
db_parsed_summarised_sac$fix_count<- NULL
db_parsed_summarised_sac$mean_sac_dur<-  db_parsed_summarised_sac$mean_fix_dur
db_parsed_summarised_sac$SacAmp<- db_parsed_summarised_sac$mean_POGsdSacAmp
db_parsed_summarised_sac$mean_POGsdSacAmp<- NULL
db_parsed_summarised_sac$mean_fix_dur<- NULL
db_parsed_summarised_sac$RMS<- NULL
db_parsed_summarised_sac$Value<- NULL
View(db_parsed_summarised_sac)
View(db_parsed_summarised_fix)
db_parsed_summarised_sac$Value<- NULL
db_parsed_summarised_fix$Value<- NULL
db_parsed_summarised_sac$RMS<- NULL

View(db_parsed)

colnames(db_parsed_summarised_fix)
colnames(db_parsed_summarised_sac)


db_parsed_summarised2<- left_join(db_parsed_summarised_fix,db_parsed_summarised_sac, by = (c('ssid', 'tNo', 'screencontent', "screencontent_no", "trialUnq")))

db_parsed_summarised2<- db_parsed_summarised2%>%
  arrange(ssid, tNo, screencontent_no)
# View(db_parsed_summarised2)
write_csv(db_parsed_summarised2, 'db_parsed_summarised.csv')

db_parsed_summarised2$ssid<- as.numeric(db_parsed_summarised2$ssid)
db_parsed_summarised2
tmp.df4_sum_full<- left_join(tmp.df4_sum_full,db_parsed_summarised2, by = c("ssid", "trialUnq", "tNo", "screencontent"))
rm(tmp.df4_sum_fullt)
testna<- subset(tmp.df4_sum_fullt, is.na(tmp.df4_sum_fullt$mean_fix_dur) == TRUE)

tmp.df4_sum_fullt
```



Behavioral data

```{r}
colnames(X309_2019_Dec_11_1807_01)

read_plus_beh <- function(flnm, select = c("condition", "stimIAPS","stimDescription", "ValenceMean","ArousalMean","trigger",
                                     "trialsPract.thisTrialN","trialIAPS.thisTrialN", "self_valence_4.response","self_valence_2.response","Self_intensity_2.response","Self_intensity_3.response", "self_valence_4.rt", "self_valence_2.rt", "Self_intensity_2.rt", "Self_intensity_3.rt")) {
  read.csv(flnm) %>% 
    mutate(filename = flnm)
}

# now read them
db_beh <-
  list.files(pattern = "*.csv", 
             full.names = T) %>% 
  map_df(~read_plus_beh(.))


library(data.table)  
files <- list.files(pattern = ".csv")
temp <- do.call(rbind,lapply(files, read.csv), header = TRUE)

#install.packages("data.table", repos = "https://cran.rstudio.com")
library(data.table)

# Read all the files and create a FileName column to store filenames
db_beh <- rbindlist(sapply(files, fread, simplify = FALSE),
                use.names = TRUE, idcol = "filename")

db_beh<- select(db_beh, c("filename", "condition", "stimIAPS","stimDescription", "ValenceMean","ArousalMean","trigger",
                                     "trialsPract.thisTrialN","trialIAPS.thisTrialN", "self_valence_4.response","self_valence_2.response","Self_intensity_2.response","Self_intensity_3.response", "self_valence_4.rt", "self_valence_2.rt", "Self_intensity_2.rt", "Self_intensity_3.rt"))

files <- list.files(pattern = ".csv")
db304<- rbindlist(sapply(files, fread, simplify = FALSE),
                use.names = TRUE, idcol = "filename")



db304<- select(db304, c("filename", "condition", "stimIAPS","stimDescription", "ValenceMean","ArousalMean","trigger",
                                     "trialsPract.thisTrialN","trialIAPS.thisTrialN", "self_valence_4.response","self_valence_2.response","Self_intensity_2.response","Self_intensity_3.response", "self_valence_4.rt", "self_valence_2.rt", "Self_intensity_2.rt", "Self_intensity_3.rt"))

# db304$ssid<- 304
colnames(db_beh)
db_beh<- bind_rows(db_beh, db304)
db_beh$ssid<- substr(db_beh$filename, 1,3)

# for (i in 1:length(temp)) assign(temp[i], read.csv(temp[i]))

View(db_beh)

colnames(db_beh)

db_beh2<- db_beh

# create one column for arousl and RT

db_beh2$valence<- if_else(is.na(db_beh2$self_valence_4.response) == FALSE, db_beh2$self_valence_4.response,
                          if_else(is.na(db_beh2$self_valence_2.response) == FALSE, db_beh2$self_valence_2.response, NULL))

db_beh2$Self_intensity_3.response<- as.double(db_beh2$Self_intensity_3.response)                      
db_beh2$arousal<- if_else(is.na(db_beh2$Self_intensity_2.response) == FALSE, db_beh2$Self_intensity_2.response,
                          if_else(is.na(db_beh2$Self_intensity_3.response) == FALSE,
                                  db_beh2$Self_intensity_3.response, NULL))


db_beh2$valence_rt<- if_else(is.na(db_beh2$self_valence_4.rt) == FALSE, db_beh2$self_valence_4.rt,
                          if_else(is.na(db_beh2$self_valence_2.rt) == FALSE, db_beh2$self_valence_2.rt, NULL))
                          
db_beh2$arousal_rt<- if_else(is.na(db_beh2$Self_intensity_2.rt) == FALSE, db_beh2$Self_intensity_2.rt,
                          if_else(is.na(db_beh2$Self_intensity_3.rt) == FALSE, db_beh2$Self_intensity_3.rt, NULL))


db_beh2$trialsPract.thisTrialN<- db_beh2$trialsPract.thisTrialN - 6
db_beh2$trialIAPS.thisTrialN<-db_beh2$trialIAPS.thisTrialN +1 
db_beh2$tNo<- if_else(is.na(db_beh2$Self_intensity_2.response) == FALSE, db_beh2$trialsPract.thisTrialN, db_beh2$trialIAPS.thisTrialN)
unique(db_beh2$tNo)
db_beh2<- subset(db_beh2, is.na(db_beh2$tNo) == FALSE)

db_beh2<- db_beh2%>%
  arrange(ssid, tNo)

ggplot(db_beh2, aes(tNo, valence, colour = ssid))+
  geom_point()+
  geom_line()

ggplot(db_beh2, aes(x = tNo, y = valence_rt))+
  geom_line()

ggplot(db_beh2, aes(x = valence, y = ValenceMean))+
  geom_point()+
  geom_smooth(method = lm, se = T)

ggplot(db_beh2, aes(x = arousal, y = ArousalMean))+
  geom_point()+
  geom_smooth(method = lm, se = T)

colnames(db_beh2)
db_beh2$triggeracq<- db_beh2$trigger
db_beh3<- select(db_beh2, c(2:6, 18:24))

# db_beh3<- subset(db_beh3, is.na(db_beh3$condition) == FALSE)

colnames(db_beh3)
colnames(tmp.df4_sum_full)
db_beh3$ssid<- as.numeric(db_beh3$ssid)
rm(tmp.df4_sum_full_t)

tmp.df4_sum_full<- left_join(tmp.df4_sum_full, db_beh3, by = c('ssid', 'tNo'))

unique(tmp.df4_sum_full$ssid)
colnames(tmp_df4300_sum_full)
colnames(tmp.df4_sum_full)

tmp.df4_sum_full<- tmp.df4_sum_full[,1:54]
tmp.df4_sum_full<- bind_rows(tmp.df4_sum_full, tmp_df4300_sum_full)

db_selfrep <- read_csv("~/Documents/InteroStudy/data/Bio/Dec12/db_selfrep.csv")

db_selfrep$ssid<- as.numeric(db_selfrep$ssid)

tmp.df4_sum_full<- left_join(tmp.df4_sum_full, db_selfrep, by = 'ssid' )

View(tmp.df4_sum_full)
write_csv(tmp.df4_sum_full, 'intero_data_full.csv')

tmp.df4_sum_full<- tmp.df4_sum_full%>%
  arrange(ssid, tNo, screencontent_no)
```


check
```{r}

View(tmp.df4_sum_full)
tmp.df4_sum_full_stim<- subset( tmp.df4_sum_full,  tmp.df4_sum_full$screencontent == 'stim')

levels(as.factor(tmp.df4_sum_full_stim$Event.Name))
tmp.df4_sum_full_stim<- subset(tmp.df4_sum_full_stim, tmp.df4_sum_full_stim$gaze_valid_prop> .85)
colnames(tmp.df4_sum_full_stim)

# is objective arousal and self report arousal correated
tmp.df4_sum_full_stim$ValenceMean_cat<- if_else(tmp.df4_sum_full_stim$ValenceMean > 4, 'pos', 'neg')

ggplot(tmp.df4_sum_full_stim, aes(arousal, log1p(TTP.AmpSum)), color = as.factor(ssid))+
         geom_point()+
  geom_smooth(method= 'lm')+
  facet_grid(~ValenceMean_cat)
ggplot(tmp.df4_sum_full_stim, aes(arousal, log1p(TTP.AmpSum), color = as.factor(ssid)))+
         geom_point()+
  geom_smooth(method= 'lm')+
   facet_grid(~ValenceMean_cat)
  # facet_grid(~ssid) # for some subjects

color = as.factor(ssid)
ggplot(tmp.df4_sum_full_stim, aes(arousal, pup_basCor))+
         geom_point()+
  geom_smooth(method= 'lm')+
   facet_grid(~ValenceMean_cat)
  # facet_grid(~ssid)
color = as.factor(ssid)
ggplot(tmp.df4_sum_full_stim, aes(arousal, hr))+
         geom_point()+
  geom_smooth(method= 'lm')+
   facet_grid(~ValenceMean_cat)


ggplot(tmp.df4_sum_full_stim, aes(arousal, hr))+
         geom_point()+
  geom_smooth(method= 'lm')


ggplot(tmp.df4_sum_full_stim, aes(arousal, pup_basCor))+
         geom_point()+
  geom_smooth(method= 'lm')

# do our physio signals corelate with one another

ggplot(tmp.df4_sum_full_stim, aes(gsr_basCor, hr, color = as.factor(ssid)))+
         geom_point()+
  geom_smooth(method= 'lm')+
   facet_grid(~ValenceMean_cat)


ggplot(subset(tmp.df4_sum_full_stim, tmp.df4_sum_full_stim$CDA.AmpSum > 0), aes(TTP.AmpSum, hr))+
         geom_point()+
  geom_smooth(method= 'lm')+
   facet_grid(~ValenceMean_cat)

ggplot(tmp.df4_sum_full_stim, aes(gsr_basCor, pup_basCor))+
         geom_point()+
  geom_smooth(method= 'lm')+
   facet_grid(~ValenceMean_cat)
 colour = as.factor(ssid)
ggplot(tmp.df4_sum_full_stim, aes(hr, pup_basCor))+
         geom_point()+
  geom_smooth(method= 'lm')+
   facet_grid(~ValenceMean_cat)


ggplot(tmp.df4_sum_full_stim, aes(arousal, log1p(CDA.PhasicMax)), color = as.factor(ssid))+
         geom_point()+
  geom_smooth(method= 'lm')+
   facet_grid(~ValenceMean_cat)

# okay arousal on gaze

# is there and affect of arousal on number of fxation and saccadescolor = as.factor(ssid)
library(tibble)

is_outlier <- function(x) {
  return(x < quantile(x, 0.25) - 1.5 * IQR(x) | x > quantile(x, 0.75) + 1.5 * IQR(x))
}

ggplot(tmp.df4_sum_full_stim, aes(CDA.PhasicMax, fix_count))+
         geom_point()+
  geom_smooth(method= 'lm')+
   facet_grid(~ValenceMean_cat)

ggplot(tmp.df4_sum_full_stim, aes(CDA.PhasicMax, sac_count))+
         geom_point()+
  geom_smooth(method= 'lm')+
   facet_grid(~ValenceMean_cat)

ggplot(tmp.df4_sum_full_stim, aes(ValenceMean_cat, sac_count))+
  # geom_jitter()+
  stat_summary( geom = 'pointrange', fun.data = 'mean_se', colour = "red", size = 2)
    # geom_boxplot()
  # geom_text(aes(label=ssid),hjust=0, vjust=0)


ggplot( tmp.df4_sum_full_stim, aes(IAS, cor_arousal))+
  geom_point()+
  geom_smooth(method = 'lm')
  # stat_summary( geom = 'pointrange', fun.data = 'mean_se', colour = "red", size = 2)+
    # geom_boxplot()+
  # geom_text(aes(label=ssid),hjust=0, vjust=0)


ggplot(tmp.df4_sum_full_stim, aes(ValenceMean_cat, fix_count))+
  # geom_jitter()+
  stat_summary( geom = 'pointrange', fun.data = 'mean_se', colour = "red", size = 2) 
    # geom_boxplot()+
  # geom_text(aes(label=ssid),hjust=0, vjust=0)


ggplot(tmp.df4_sum_full_stim, aes(ValenceMean_cat, mean_sac_dur))+
  # geom_jitter()+
  stat_summary( geom = 'pointrange', fun.data = 'mean_se', colour = "red", size = 2)
    # geom_boxplot()
  # geom_text(aes(label=ssid),hjust=0, vjust=0)

ggplot(tmp.df4_sum_full_stim, aes(ValenceMean_cat, mean_fix_dur))+
  # geom_jitter()+
  stat_summary( geom = 'pointrange', fun.data = 'mean_se', colour = "red", size = 2)
  geom_boxplot()
  # geom_text(aes(label=ssid),hjust=0, vjust=0)

ggplot(tmp.df4_sum_full_stim, aes(CDA.PhasicMax, fix_count, color = as.factor(ssid)))+
         geom_point()+
  geom_smooth(method= 'lm')
  # facet_grid(~ssid)+
    # geom_text(aes(label=ssid),hjust=0, vjust=0)

ggplot(subset(tmp.df4_sum_full_stim, tmp.df4_sum_full_stim$mean_fix_dur < 6000), aes(TTP.AmpSum, mean_fix_dur))+
         geom_point()+
  geom_smooth(method= 'lm')+
   facet_grid(~ValenceMean_cat)

ggplot(subset(tmp.df4_sum_full_stim, tmp.df4_sum_full_stim$mean_fix_dur < 6000 & tmp.df4_sum_full_stim$CDA.AmpSum>0 ), aes(CDA.PhasicMax, mean_fix_dur))+
         geom_point()+
  geom_smooth(method= 'lm')+
   facet_grid(~ValenceMean_cat)

ggplot(tmp.df4_sum_full_stim, aes(TAS, IAS))+
         geom_point()+
  geom_smooth(method= 'lm')

p<- list()
library(lmerTest)


tmp.df4_sum_full_stim$TAS_c<- scale(tmp.df4_sum_full_stim$TAS, center = TRUE,scale = TRUE)
tmp.df4_sum_full_stim$IAS_c<- scale(tmp.df4_sum_full_stim$IAS, center = TRUE, scale = TRUE)
tmp.df4_sum_full_stim$arousal_c<- scale(tmp.df4_sum_full_stim$arousal, center = TRUE,scale = TRUE)

tmp.df4_sum_full_stim<- tmp.df4_sum_full_stim%>%
  group_by(ssid)%>%
  mutate(cor_arousal = cor(arousal_c, hr))
tmp.df4_sum_full_stim<- tmp.df4_sum_full_stim%>%
  # mutate(ssid = as.factor(ssid))%>%
  mutate(stim = as.factor(stim))
tmp.df4_sum_full_stim$ssid<- as.factor(tmp.df4_sum_full_stim$ssid)

tmp.df4_sum_full_stim$valence_c<- scale(tmp.df4_sum_full_stim$valence, center = TRUE, scale = TRUE)
tmp.df4_sum_full_stim$TTP.AmpSum<- scale(tmp.df4_sum_full_stim$TTP.AmpSum,center = TRUE, scale = TRUE)

# test soe models
tmp.df4_sum_full_stimagg<- (tmp.df4_sum_full_stim%>%
              group_by(ssid)%>%
              summarise_at(c('IAS_c', 'TAS_c', 'AQ','cor_arousal', 'fix_count'), mean, na.rm = TRUE))


ggplot(tmp.df4_sum_full_stimagg, aes(TAS_c, cor_arousal))+
  geom_point()+
  geom_smooth(method = 'lm')

ggplot(tmp.df4_sum_full_stimagg, aes(IAS_c, cor_arousal))+
  geom_point()+
  geom_smooth(method = 'lm')

# tmp.df4_sum_full_stimagg<- subset(tmp.df4_sum_full_stimagg, is.na(tmp.df4_sum_full_stimagg$IAS_c) == FALSE)

p$a<- glmer(fix_count ~ 1 + IAS_c * CDA.ISCR *ValenceMean_cat + (1 | ssid ),
           family = poisson(), data = tmp.df4_sum_full_stim)

summary(p$a)

p$a1<- lmer(mean_fix_dur ~ 1 + IAS_c * (arousal_c + hr) * ValenceMean_cat + (1 | ssid ),
           REML = FALSE, data = tmp.df4_sum_full_stim)

summary(p$a1)


p$a1<- lmer(mean_fix_dur ~ 1 + IAS_c * + hr * ValenceMean_cat + (1 | ssid ),
           REML = FALSE, data = tmp.df4_sum_full_stim)

summary(p$a1)

p$a2<- lmer(mean_fix_dur ~ 1 + IAS_c * (arousal_c + TTP.AmpSum) + (1 | ssid ),
           REML = FALSE, data = tmp.df4_sum_full_stim)

summary(p$a2)

p$a2<- lmer(mean_fix_dur ~ 1 + cor_arousal * hr + (1 | ssid ),
           REML = FALSE, data = tmp.df4_sum_full_stim)

tmp.df4_sum_full_stim$hr_c<- scale(tmp.df4_sum_full_stim$hr, center = TRUE, scale = TRUE)

p$a3<- glmer(sac_count ~ 1 + IAS_c * hr * ValenceMean_cat  + (1 | ssid ),
           family = poisson(), data = tmp.df4_sum_full_stim)

summary(p$a3)
# p$a2<- lmer(mean_fix_dur ~ 1 + cor_arousal * ( hr)+ (1 | ssid ),
#            REML = FALSE, data = tmp.df4_sum_full_stim)
p$a4<- lmer(gsr_basCor ~ 1 + IAS_c * arousal_c + (1 | ssid ),
           REML = FALSE, data = tmp.df4_sum_full_stim)

summary(p$a4)     
       
       tmp.df4_sum_full_stim_cor<- tmp.df4_sum_full_stim%>%
  group_by(ssid, TAS, IAS, AQ, `DASS Total`)%>%
  summarise(cor_arousal_self = cor(arousal,  log1p(CDA.PhasicMax)))

ggplot(tmp.df4_sum_full_stim_cor, aes(`DASS Total`, cor_arousal_self))+
         geom_point()+
  geom_smooth(method= 'lm')

cor(tmp.df4_sum_full_stim_cor$cor_arousal_self, tmp.df4_sum_full_stim_cor$TAS,  use = 'complete')
cor(tmp.df4_sum_full_stim_cor$cor_arousal_self, tmp.df4_sum_full_stim_cor$IAS,  use = 'complete')
cor(tmp.df4_sum_full_stim_cor$TAS, tmp.df4_sum_full_stim_cor$IAS,  use = 'complete')

tmp.df4_sum_full_stim_cor [1:8,]%>%
  summarise(cor2 = cor(cor_arousal_self, TAS, use = 'complete'))


ggplot(tmp.df4_sum_full_stim, aes(arousal_c, log1p(mean_fix_dur)))+
  geom_point()+
  geom_smooth(method = 'lm')

```



IMPORT BIOPAC

```{r}
colnames(tmp.df4_sum_full)

# import
read_leda_bio <- function(flnm) {
  data.table::fread(flnm) %>% 
    mutate(filename = flnm)
}

# now read them
db_leda_bio <-
  list.files(pattern = "*.txt", 
             full.names = T) %>% 
  map_df(~read_leda_bio(.))

db_leda_bio$trigger<- as.numeric(db_leda_bio$Event.NID)
db_leda_bio$ssid<- as.numeric(substr(db_leda_bio$filename, 3,5))



colnames(tmp.df4_sum_full)
unique(tmp.df4_sum_full$trigger)

tmp.df4_sum_full_bio<- subset(tmp.df4_sum_full, tmp.df4_sum_full$ssid>303)
# tmp.df4_sum_full_bio<- subset(tmp.df4_sum_full_bio, tmp.df4_sum_full_bio$trigger!= -7)


levels(as.factor(tmp.df4_sum_full_bio$ssid))
unique(tmp.df4_sum_full_bio$trigger)
levels(as.factor(db_leda_bio$ssid))

db_leda_bio$ssid<- as.factor(db_leda_bio$ssid)
db_leda_bio$trigger<- as.factor(db_leda_bio$trigger)
db_leda_bio$order<- db_leda_bio$Event.Nr
tmp.df4_sum_full_bio$ssid<- as.factor(tmp.df4_sum_full_bio$ssid)
tmp.df4_sum_full_bio$trigger<- as.factor(tmp.df4_sum_full_bio$trigger)

colnames(tmp.df4_sum_full_bio)

unique(db_leda_bio$trigger)
unique(db_leda_bio$Event.Name)
unique(tmp.df4_sum_full_bio$trigger)
unique(tmp.df4_sum_full_bio$Event.Name)

tmp.df4_sum_full_bio%>%
  arrange(ssid, tNo, order)
db_leda_bio<- db_leda_bio%>%
  arrange(ssid, order)

tmp.df4_sum_full_bio$trigger<- tmp.df4_sum_full_bio$tNo
tmp.df4_sum_full_bio$trigger<- if_else(tmp.df4_sum_full_bio$screencontent == 'fixation', 100,
                                       if_else(tmp.df4_sum_full_bio$screencontent == 'ValenceResp', 101,
                                               if_else(tmp.df4_sum_full_bio$screencontent == 'IntResp', 102, tmp.df4_sum_full_bio$tNo)))

unique(tmp.df4_sum_full_bio$trigger)

tmp.df4_sum_full_biot<-left_join(tmp.df4_sum_full_bio, db_leda_bio, by = c("order", "ssid", "trigger"))
(db_leda_bio$trigger)

nrow(tmp.df4_sum_full_bio)
nrow(db_leda_bio)

tmp.df4_sum_full<- tmp.df4_sum_full%>%
  arrange(ssid, tNo)

ggplot(tmp.df4_sum_full_biot, aes(CDA.PhasicMax.x, CDA.PhasicMax.y))+
  geom_point()+
  geom_smooth(method = 'lm')

ggplot(tmp.df4_sum_full_biot, aes(TTP.AmpSum.x, TTP.AmpSum.y))+
  geom_point()+
  geom_smooth(method = 'lm')

tmp.df4_sum_full_biot
ggplot(subset(tmp.df4_sum_full_biot, tmp.df4_sum_full_biot$ssid != 308), aes(TTP.AmpSum.y, arousal, colour = ssid))+
  geom_point()+
  geom_smooth(method = 'lm', se = T)

ggplot(subset(tmp.df4_sum_full_biot, tmp.df4_sum_full_biot$ssid != 308), aes(TTP.AmpSum.y, arousal))+
  geom_point()+
  geom_smooth(method = 'lm', se = T)
ggplot(subset(tmp.df4_sum_full_biot, tmp.df4_sum_full_biot$ssid != 308 & tmp.df4_sum_full_biot$TTP.AmpSum.y> 0), aes( TTP.AmpSum.y, arousal))+
  geom_point()+
  geom_smooth(method = 'lm', se = T)
tmp.df4_sum_full_biot1 <-subset(tmp.df4_sum_full_biot, tmp\.df4_sum_full_biot$ssid != 308)

cor(tmp.df4_sum_full_biot1$arousal, tmp.df4_sum_full_biot1$Global.Mean.y, use = 'complete.obs')
```

import biopac hear rate
```{r}
nrow(tmp.df4_sum_full_bio)

colnames(tmp.df4_sum_full_bio)
unique(tmp.df4_sum_full_bio$ssid)

unique(db_biohr$filename)

# import
read_biohr <- function(flnm) {
  data.table::fread(flnm) %>% 
    mutate(filename = flnm)
}

# now read them
db_biohr <-
  list.files(pattern = "*.csv", 
             full.names = T) %>% 
  map_df(~read_biohr(.))

db_biohr$ssid<- substr(db_biohr$filename, 6,8)
db_biohr$order<- db_biohr$Order

db_biohr$Order<- NULL
db_biohr$filename<- NULL
db_biohr$trigger<- as.factor(as.character(db_biohr$trigger))
unique(tmp.df4_sum_full_bio$ssid)
unique(db_biohr$ssid)
tmp.df4_sum_full_bio$trigger<- as.factor(as.character(tmp.df4_sum_full_bio$trigger))

db_biohr$ssid<- as.factor(as.character(db_biohr$ssid))
tmp.df4_sum_full_bio_hr<- left_join(tmp.df4_sum_full_biot, db_biohr, by = c('ssid', 'order', 'trigger'))

ggplot(subset(tmp.df4_sum_full_bio_hr, tmp.df4_sum_full_bio_hr$screencontent == 'stim'), aes(hr, HR_BIO))+
  geom_point()+
  geom_smooth(method = 'lm')

ggplot(subset(tmp.df4_sum_full_bio_hr, tmp.df4_sum_full_bio_hr$screencontent == 'stim'), aes(CDA.PhasicMax.x, CDA.PhasicMax.y))+
  geom_point()+
  geom_smooth(method = 'lm')
tmp.df4_sum_full_bio_hr_stim<- subset(tmp.df4_sum_full_bio_hr, tmp.df4_sum_full_bio_hr$screencontent != 'fixation')

cor(tmp.df4_sum_full_bio_hr_stim$hr, tmp.df4_sum_full_bio_hr_stim$HR_BIO, use = 'complete')


# tmp.df4_sum_full_bio_hr_stim_1<- subset(tmp.df4_sum_full_bio_hr_stim, tmp.df4_sum_full_bio_hr_stim$HR_BIO> 50)

tmp.df4_sum_full_bio_hr_stim$valence_cat<- if_else(tmp.df4_sum_full_bio_hr_stim$valence >0, 'pos',
                                                  if_else(tmp.df4_sum_full_bio_hr_stim$valence < 0, 'neg', 'neutral'))

unique(tmp.df4_sum_full_bio_hr_stim$screencontent)

ggplot(tmp.df4_sum_full_bio_hr_stim, aes(HR_BIO, arousal))+
  geom_point()+
  geom_smooth(method = 'lm')
  # facet_grid(~valence_cat)

cor(tmp.df4_sum_full_bio_hr_stim$HR_BIO, tmp.df4_sum_full_bio_hr_stim$arousal, use = 'complete')
cor(tmp.df4_sum_full_bio_hr_stim$HR_BIO, tmp.df4_sum_full_bio_hr_stim$valence, use = 'complete')

tmp.df4_sum_full_bio_hr_stim%>%
      group_by(ssid, IAS)%>%
      summarise(corr = cor(HR_BIO, arousal, use = 'complete'))%>%
  summarise(new = cor(corr, IAS))
  # summarise_at(c('TAS'), mean)

ggplot(tmp.df4_sum_full_bio_hr_stim, aes(HR_BIO, arousal))+
  geom_point()+
  geom_smooth(method = 'lm')+
  facet_grid(~valence_cat)

tmp.df4_sum_full_bio_hr_stim%>%
group_by(valence_cat)%>%
  summarise(corr = cor(HR_BIO, arousal, use = 'complete'))
ggplot(tmp.df4_sum_full_bio_hr_stim, aes(HR_BIO, valence))+
  geom_point()+
  geom_smooth(method = 'lm')+
  facet_grid(~valence_cat)

ggplot(tmp.df4_sum_full_bio_hr_stim, aes(HR_BIO, ValenceMean))+
  geom_point()+
  geom_smooth(method = 'lm')
  # facet_grid(~valence_cat)

ggplot(tmp.df4_sum_full_bio_hr_stim, aes(HR_BIO, mean_sac_dur))+
  geom_point()+
  geom_smooth(method = 'lm')+
  facet_grid(~valence_cat)

ggplot(tmp.df4_sum_full_bio_hr_stim, aes(HR_BIO, pup_basCor))+
  geom_point()+
  geom_smooth(method = 'lm')+
  facet_grid(~valence_cat)

ggplot(tmp.df4_sum_full_bio_hr_stim, aes(HR_BIO, Global.Mean.y))+
  geom_point()+
  geom_smooth(method = 'lm')


ggplot(tmp.df4_sum_full_bio_hr_stim, aes(HR_BIO, TAS))+
  geom_point()+
  geom_smooth(method = 'lm')

ggplot(tmp.df4_sum_full_bio_hr_stim, aes(HR_BIO, `DASS Anxiety`))+
  geom_point()+
  geom_smooth(method = 'lm')
  
  
  



```
