---
title: "Paper_analyses"
author: "Helio"
date: "22/07/2021"
output: html_document
---


Code for the paper: Valence modulated “subjective-objective” arousal

data<- last opened

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```



Participants section

```{r}
participants_demog <- db_full4new_stim_screen_pupil_nopract %>%
  subset(Group == "NT")%>%
  group_by(ssid, Gender)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)

# gender
table(participants_demog$Gender)
colnames(participants_demog)
summary(participants_demog$Age)
sd(participants_demog$Age, na.rm = TRUE)
# table(is.na(participants_demog$Age))
```



Pupil changes and subjective arousal and valence ratings


# let's model it formally
  
# remember baseline corection is equivalendt to stimuli intercept
 
```{r} 
pupil_arousal_findings<- list()
library(lmerTest)

unique(db_full4new_stim_screen_pupil_nopract$stimIAPS)
unique(substr(db_full4new_stim_screen_pupil_nopract$stimIAPS, 1,8))
db_full4new_stim_screen_pupil_nopract$Label<- substr(db_full4new_stim_screen_pupil_nopract$stimIAPS, 1,8)


db_full4new_stim_screen_pupil_nopract<- left_join(db_full4new_stim_screen_pupil_nopract, imageJ_IAPS, by = "Label")

nrow(db_full4new_stim_screen_pupil_nopract)
# rows = 2858

db_full4new_stim_screen_pupil_nopract$Mean_gray_z<- scale(db_full4new_stim_screen_pupil_nopract$Mean, center = TRUE, scale = TRUE)[,1]


db_full4new_stim_screen_pupil_nopract$ssid_num <- as.numeric(as.character(db_full4new_stim_screen_pupil_nopract$ssid))


```


lmer pupil

```{r}
options(contrasts = c("contr.sum","contr.poly"))
options(scipen = 999)


pupil_arousal_findings$pupil_from_arousal <- lmer(pup_basCor ~ arousal_c*Mean_gray_z  +(1 +Mean_gray_z | ssid) + (0+arousal_c| ssid), REML = FALSE,
                      data = subset(db_full4new_stim_screen_pupil_nopract, 
                                    pupil_outlier == FALSE & ssid_num< 500 & 
                                    arousal_outler == FALSE))

summary(pupil_arousal_findings$pupil_from_arousal)
# singularity (drop arousal c slope)

# is there a correlation between mean arousal rating and meang, gray(

db_full4new_stim_screen_pupil_nopract%>%
  group_by(stimIAPS,ground_valence_lab) %>%
  summarise_at(c('arousal_c', 'Mean_gray_z'), mean, na.rm = TRUE)%>%
  ggplot(aes(arousal_c, Mean_gray_z, color = ground_valence_lab))+
  geom_point()+
  ggpubr::stat_cor()


db_full4new_stim_screen_pupil_nopract %>%
  subset(ssid_num<500)%>%
  group_by(ssid)%>%
  mutate(cor_ar_vl = cor(arousal, valence, use = "complete"))%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(ssid,cor_ar_vl))+
  geom_point()+
  geom_hline(yintercept = -.75)+
  geom_hline(yintercept = -.90)
  geom_histogram()
  
  
  
  ggplot(aes(arousal_c, Mean_gray_z, color = ground_valence_lab))+
  geom_point()+
  ggpubr::stat_cor()


```


# Valence and arousal
```{r}

db_full4new_stim_screen_pupil_nopract$ssid<- as.factor(as.character(db_full4new_stim_screen_pupil_nopract$ssid))

pupil_arousal_findings$pupil_from_ar_vale <- lmer(pup_basCor ~ (valence_c* arousal_c) +
                                                    Mean_gray_z  +
                                                    (1 + Mean_gray_z | ssid)+
                                                    (0+ valence_c* arousal_c | ssid),
                                                  REML = FALSE,
                      data = subset(db_full4new_stim_screen_pupil_nopract, 
                                    pupil_outlier == FALSE & ssid_num< 500 & 
                                      arousal_outler == FALSE))
unique(db_full4new_stim_screen_pupil_nopract$tNo)

unique(db_full4new_stim_screen_pupil_nopract$ssid)
relgrad <- with(pupil_arousal_findings$pupil_from_ar_vale@optinfo$derivs,solve(Hessian,gradient))
max(abs(relgrad)) #0.0002044252

summary(pupil_arousal_findings$pupil_from_ar_vale)
plot(pupil_arousal_findings$pupil_from_ar_vale)

# car::vif(pupil_arousal_findings$pupil_from_ar_vale) #curoff 4


plots_paper$interaction_ar_vl <- interactions::interact_plot(pupil_arousal_findings$pupil_from_ar_vale , pred = arousal_c, modx = valence_c, plot.points = TRUE)

interactions::interact_plot(pupil_arousal_findings$pupil_from_ar_val_gaze , pred = valence_c , modx = arousal_c)

# export model table
library(MuMIn)
library(sjmisc)
sjPlot::tab_model(pupil_arousal_findings$pupil_from_ar_vale)

```

Linear mixed model fit by maximum likelihood . t-tests use Satterthwaite's method ['lmerModLmerTest']
Formula: pup_basCor ~ (valence_c * arousal_c) + Mean_gray_z + (1 + Mean_gray_z |  
    ssid) + (0 + valence_c * arousal_c | ssid)
   Data: subset(db_full4new_stim_screen_pupil_nopract, pupil_outlier ==      FALSE & ssid_num < 500 & arousal_outler == FALSE)

     AIC      BIC   logLik deviance df.resid 
  8493.9   8579.2  -4231.9   8463.9     2170 

Scaled residuals: 
    Min      1Q  Median      3Q     Max 
-3.6141 -0.5987  0.0067  0.5952  3.6796 

Random effects:
 Groups   Name                Variance Std.Dev. Corr       
 ssid     (Intercept)         0.78415  0.8855              
          Mean_gray_z         0.13611  0.3689   0.55       
 ssid.1   valence_c           0.04233  0.2057              
          arousal_c           0.02296  0.1515    0.89      
          valence_c:arousal_c 0.01700  0.1604   -0.19  0.01
 Residual                     2.57999  1.6062              
Number of obs: 2185, groups:  ssid, 43

Fixed effects:
                    Estimate Std. Error       df t value             Pr(>|t|)    
(Intercept)         -0.66764    0.14166 44.77819  -4.713          0.000023962 ***
valence_c            0.08546    0.06557 28.33677   1.603              0.20294    
arousal_c            0.44137    0.06445 22.53213   6.848          0.000000619 ***
Mean_gray_z         -0.96311    0.06622 43.35750 -14.544 < 0.0000000000000002 ***
valence_c:arousal_c  0.15461    0.04434 24.37046   3.487              0.00187 ** 
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

Correlation of Fixed Effects:
            (Intr) vlnc_c arsl_c Mn_gr_
valence_c   -0.042                     
arousal_c   -0.031  0.746              
Mean_gray_z  0.453 -0.013  0.028       
vlnc_c:rsl_  0.147 -0.267 -0.128  0.035

same analyses as above but regress brightness out of pupil

```{r}

pupil_arousal_findings$pupil_from_brightness <- lmer(pup_basCor ~ 
                                                    Mean  +
                                                    (1  | ssid),
                                                    # (0+ valence_c* arousal_c | ssid),
                                                  REML = FALSE,
                      data = subset(db_full4new_stim_screen_pupil_nopract, 
                                    # pupil_outlier == FALSE & ssid_num< 500 & 
                                      # arousal_outler == FALSE
                                    ))

pupil_arousal_findings$pupil_from_brightness_lm <- lm(pup_basCor ~ 
                                                    Mean,
                                                    
                      data = subset(db_full4new_stim_screen_pupil_nopract, 
                                    # pupil_outlier == FALSE & ssid_num< 500 & 
                                      # arousal_outler == FALSE
                                    ))



summary(pupil_arousal_findings$pupil_from_brightness)

plot(pupil_arousal_findings$pupil_from_brightness)

# store residuals
db_full4new_stim_screen_pupil_nopract$pup_resid <- resid(pupil_arousal_findings$pupil_from_brightness)

db_full4new_stim_screen_pupil_nopract$pup_resid_lm <-
resid(pupil_arousal_findings$pupil_from_brightness_lm)


db_full4new_stim_screen_pupil_nopract%>%
  ggplot(aes(pup_resid, Mean_gray_z))+
  geom_point()+
  geom_smooth(method = 'lm', se = F)+
  ggpubr::stat_cor()

# no correlated with IV - good


db_full4new_stim_screen_pupil_nopract%>%
  ggplot(aes(pup_resid, pup_basCor))+
  geom_point()+
  geom_smooth(method = 'lm', se = F)+
  ggpubr::stat_cor()

# strong correlation, in this case this is good, because it means there is a large ammount of unexplain ed variane not acconted for by the predictor



# predict pupil residuals
pupil_arousal_findings$pupil_resid_from_ar_vale <- lmer(pup_resid_lm ~ (arousal_c*valence_c) +
                                                    
                                                    (1+arousal_c*valence_c  | ssid),
                                                    # (0+ valence_c* arousal_c | ssid),
                                                  REML = FALSE,
                      data = subset(db_full4new_stim_screen_pupil_nopract, 
                                    pupil_outlier == FALSE &
                                    ssid_num< 500 
                                    &
                                      arousal_outler == FALSE
                                      )) # results hold with or withouth outliers 


summary(pupil_arousal_findings$pupil_resid_from_ar_vale)

# using residuals from lmer create a singularity as they eliminate individual participants variability, this is solved by using residuals from lm

plots_paper<- list()
plots_paper$interaction_ar_vl <- interactions::interact_plot(pupil_arousal_findings$pupil_from_ar_vale, pred = arousal_c, modx = valence_c)

interactions::interact_plot(pupil_arousal_findings$pupil_resid_from_ar_vale , pred = valence_c , modx = arousal_c)

plots_paper$interaction_ar_vl+p$graphstyle

plots_paper$interaction_ar_vl
```
interaction plot

```{r}
sf = 1 # scaling factor to make it easier to change sizes of everything, in which case change here

p$graphstyle_int <-  theme(#base plot theme
  
  # axis lines
  axis.line.y = element_line(color="black", size = 1.5),
  axis.line.x = element_line(color="black", size = 1,5),
  
  axis.title.y=element_text(size = 16*(sf+.5), margin=margin(0,5,0,0)),
  axis.title.x=element_text(size = 16*(sf+.5), margin=margin(0,5,0,0)),
  
  # text
  strip.text.x = element_text(size = 12*(sf+.5),  colour = "black"),
  strip.text.y = element_text(size = 12*(sf+.5),  colour = "black"),
  
  text=element_text(size = 14, family = "sans"),
  axis.text.x = element_text(size = 14*(sf+.5), family = "sans", colour = "black",),
  axis.text.y = element_text(size = 14*(sf+.5), family = "sans", colour = "black"),
  
  
  # panel
  panel.grid.major = element_blank(),
  panel.background = element_blank(),
  # panel.background = element_rect(fill="transparent"),
  # panel.border = element_rect(fill="transparent"),
  # strip shades (reco rectagles)
   # strip.background = element_blank(),
  
  # legend
  legend.position = "top",
  legend.key = element_rect(colour = "transparent", fill="transparent"),
  #legend.direction = "horizontal",

  legend.text = element_text(size = 10*(sf+.3)),
  # legend.title = element_text(size = 10*(sf+.3)),
  # legend line tends to be really small in print so adjust here
  legend.key.height = unit(.5, "cm"),
  legend.key.width = unit(2, "cm"),
  
  #legend.text = element_text(size = 10*sf),
  # legend.title=element_blank(),
  #legend.text = element_blank(),
  #axis.ticks = element_blank(),
)


plots_paper$interaction_ar_vl<- plots_paper$interaction_ar_vl +
  theme_classic()+
  p$graphstyle_int+
  xlab("Arousal (z)")+
  ylab("Pupil change (z)")+
  scale_y_continuous(breaks = c(-1,0,1))

plots_paper$interaction_ar_vl<- plots_paper$interaction_ar_vl+   scale_y_continuous(breaks = c(-2,-1,0,1), limits = c(-2,1))

 plots_paper$interaction_ar_vl +
   theme_classic()+
   p$graphstyle_int
   


plots_paper[["interaction_ar_vl"]][["data"]]%>%
  ggplot(aes(arousal_c, pup_basCor, linetype = modx_group))+
  stat_summary(aes(color = valence_c), geom = 'line', size = 2)+
  p$graphstyle_int
```




Predict arousal from pupil


```{r}
# with arousal as DV
pupil_arousal_findings$arousal_from_pup <- lmer(arousal_c ~ valence_c*pup_basCor  + (1| stimIAPS)+
                                                 # (1 | ssid),
                                                  (0 +valence_c+pup_basCor | ssid),
                                                REML = FALSE,
                      data = subset(db_full4new_stim_screen_pupil_nopract, 
                                    pupil_outlier == FALSE & ssid_num<500 & 
                                      arousal_outler == FALSE))
summary(pupil_arousal_findings$arousal_from_pup)
anova(pupil_arousal_findings$arousal_from_pup)

# expected correlation between valence and pupil is low



interactions::interact_plot(pupil_arousal_findings$arousal_from_pup , pred = valence_c, modx = pup_basCor)

interactions::interact_plot(pupil_arousal_findings$arousal_from_pup, pred =pup_basCor , modx =  valence_c) #better 
# same pattern
# pupil is more aligned with subjective arousal in the more positive trials



# flip dv to valence

pupil_arousal_findings$valence_from_pup <- lmer(valence_c ~ arousal_c*pup_basCor  + (1| stimIAPS)+
                                                 # (1 | ssid),
                                                  (0 +arousal_c +pup_basCor | ssid),
                                                REML = FALSE,
                      data = subset(db_full4new_stim_screen_pupil_nopract, 
                                    pupil_outlier == FALSE & ssid_num<500 & 
                                      arousal_outler == FALSE))
summary(pupil_arousal_findings$valence_from_pup)
anova(pupil_arousal_findings$valence_from_pup)

# so it's not the case that pupil is tracking valence
# it's the case that arousal pupil relation is modulated by valence, and this is true regardless of whether we use a maximal or minimal model

interactions::interact_plot(pupil_arousal_findings$valence_from_pup , pred = valence_c, modx = pup_basCor)

interactions::interact_plot(pupil_arousal_findings$valence_from_pup, pred =pup_basCor , modx =  arousal_c)



```





Timecourse analyses

# prepare timecourse data
```{r prepare timecourse data}
rm(justone_test, lucy_plots, test)

nrow(tmp.df4_full_stim_downs_jun2021)

# import the timecourse

nrow(tmp.df4_full_stim_downs_jun2021)
tmp.df4_full_stim_downs_jun2021 <- readRDS("~/OneDrive - Nexus365/InteroStudy2020/analysis/DataAnalysisJanuary2020/DataAnalysisJan2020/tmp.df4_full_stim_downs_jun2021.rds")

db_full4new_stim_subset<- db_full4new_stim_screen_pupil_nopract[,c(1:4,6:7,12:13,16,21:27, 31:56,80:81,84:96,98:114,116:124)]


# match types of merging variables
tmp.df4_full_stim_downs_jun2021_with_beh2$ssid<- as.character(tmp.df4_full_stim_downs_jun2021_with_beh2$ssid)
db_full4new_stim_subset$ssid<- as.character(db_full4new_stim_subset$ssid)

# tNo
tmp.df4_full_stim_downs_jun2021_with_beh2$tNo <- as.character(tmp.df4_full_stim_downs_jun2021_with_beh2$tNo)

db_full4new_stim_subset$tNo <- as.character(db_full4new_stim_subset$tNo)
# unique(db_full4new_stim_subset$tNo)
# unique(tmp.df4_full_stim_downs_jun2021_with_beh2$tNo)

# merge
nrow(tmp.df4_full_stim_downs_jun2021_with_beh2)
# 87529

table(is.na(db_full4new_stim_subset$mediansplit_self_valence))

tmp.df4_full_stim_downs_jun2021_with_beh2$tNo<- as.numeric(tmp.df4_full_stim_downs_jun2021_with_beh2$tNo)

tmp.df4_full_stim_downs_jun2021_with_beh2<- tmp.df4_full_stim_downs_jun2021_with_beh2%>%
  arrange(ssid,tNo, timerezero3)

tmp.df4_full_stim_downs_jun2021_with_beh <- left_join(tmp.df4_full_stim_downs_jun2021_with_beh2, db_full4new_stim_subset)


```


# higher sample dataset

```{r}
library(ggplot2)
library(tidyverse)
install.packages("gazer")
library(gazer)

tmp.df4_full_stim_downs_jun2021$tNo<- as.numeric(tmp.df4_full_stim_downs_jun2021$tNo)

tmp.df4_full_stim_downs_jun2021_60bins<- left_join(tmp.df4_full_stim_downs_jun2021, db_full4new_stim_subset, by = c("ssid", "tNo", "trial"))


# create a dataframe version where we downsample to60 and not to 30
tmp.df4_full_stim_downs_jun2021_60bins$Label<- substr(tmp.df4_full_stim_downs_jun2021_60bins$stimIAPS, 1,8)

tmp.df4_full_stim_downs_jun2021_60bins<- left_join(tmp.df4_full_stim_downs_jun2021_60bins, imageJ_IAPS, by = "Label")


tmp.df4_full_stim_downs_jun2021_60bins$Mean_gray_z<- scale(tmp.df4_full_stim_downs_jun2021_60bins$Mean, center = TRUE, scale = TRUE)[,1]






nrow(tmp.df4_full_stim_downs_jun2021_60bins)
# 172168 good


```


Quick check that things make sense
```{r}


# group_by(stimIAPS)%>%
tmp.df4_full_stim_downs_jun2021_with_beh<- tmp.df4_full_stim_downs_jun2021_with_beh %>%
  ungroup()%>%
  mutate(mediansplit_sample_valence2 = 
           if_else(ValenceMeanThisSample >= 
                     median(ValenceMeanThisSample,
                            na.rm = TRUE), 
                   "More positive", "More negative"))%>%
  mutate(mediansplit_sample_arousal2 = if_else(ArousalMeanThisSample >=
                                                  median(ArousalMeanThisSample,
                                                         na.rm = TRUE), "High", "Low"))



# higher sample rate]

tmp.df4_full_stim_downs_jun2021_60bins<- tmp.df4_full_stim_downs_jun2021_60bins %>%
  ungroup()%>%
  mutate(mediansplit_sample_valence2 = 
           if_else(ValenceMeanThisSample > 
                     median(ValenceMeanThisSample,
                            na.rm = TRUE), 
                   "More positive", "More negative"))%>%
  mutate(mediansplit_sample_arousal2 = if_else(ArousalMeanThisSample >
                                                  median(ArousalMeanThisSample,
                                                         na.rm = TRUE), "High", "Low"))




tmp.df4_full_stim_downs_jun2021_with_beh %>%
  subset(!is.na(ground_arousal_lab))%>%
  ggplot(aes(x = timerezero3, y = pup_basCor))+
  stat_smooth(aes(group= ground_arousal_lab, color = ground_arousal_lab), fun = mean,geom = "line",
               se = F, alpha = .1, size = 1.5)+
  stat_smooth(aes(group=ground_arousal_lab, color = ground_arousal_lab), size = 3)+  
theme_classic()+
  ylab("Pupil size (z)")+
  xlab("Time (s)")+
  # p$graphstyle+
  scale_color_brewer(palette = "Dark2")+
  xlim(0,6)+
   facet_grid(~mediansplit_self_valence)


```



```{r}
tmp.df4_full_stim_downs_jun2021_60bins %>%
  subset(!is.na(ground_arousal_lab))%>%
  ggplot(aes(x = timerezero3, y = pup_basCor))+
  stat_smooth(aes(group= ground_arousal_lab, color = ground_arousal_lab), fun = mean,geom = "line",
               se = F, alpha = .1, size = 1.5)+
  stat_smooth(aes(group=ground_arousal_lab, color = ground_arousal_lab), size = 3)+  
theme_classic()+
  ylab("Pupil size (z)")+
  xlab("Time (s)")+
  # p$graphstyle+
  scale_color_brewer(palette = "Dark2")+
  xlim(0,6)+
   facet_grid(~mediansplit_self_valence)

```

```{r}

tmp.df4_full_stim_downs_jun2021_60bins %>%
  subset(!is.na(ground_arousal_lab))%>%
  ggplot(aes(x = timerezero3, y = pup_basCor))+
  stat_smooth(aes(group= mediansplit_sample_arousal2, color = mediansplit_sample_arousal2), fun = mean,geom = "line",
               se = F, alpha = .1, size = 1.5)+
  stat_smooth(aes(group=mediansplit_sample_arousal2, color = mediansplit_sample_arousal2), size = 3)+  
theme_classic()+
  ylab("Pupil size (z)")+
  xlab("Time (s)")+
  # p$graphstyle+
  scale_color_brewer(palette = "Dark2")+
  xlim(0,6)+
   facet_grid(~mediansplit_sample_valence2)



tmp.df4_full_stim_downs_jun2021_60bins %>%
  subset(!is.na(ground_arousal_lab))%>%
  ggplot(aes(x = timerezero3, y = pup_basCor))+
  stat_smooth(aes(group= mediansplit_sample_valence2, color = mediansplit_sample_valence2), fun = mean,geom = "line",
               se = F, alpha = .1, size = 1.5)+
  stat_smooth(aes(group=, color = mediansplit_sample_valence2), size = 3)+  
theme_classic()+
  ylab("Pupil size (z)")+
  xlab("Time (s)")+
  # p$graphstyle+
  scale_color_brewer(palette = "Dark2")+
  xlim(0,6)+
   facet_grid(~ mediansplit_sample_arousal2)


# what causes 
tmp.df4_full_stim_downs_jun2021_60bins %>%
  subset(!is.na(ground_arousal_lab))%>%
  ggplot(aes(x = timerezero3, y = pup_basCor))+
  stat_smooth(aes(group= mediansplit_sample_valence2, color = mediansplit_sample_valence2), fun = mean,geom = "line",
               se = F, alpha = .1, size = 1.5)+
  stat_smooth(aes(group=, color = mediansplit_sample_valence2), size = 3)+  
theme_classic()+
  ylab("Pupil size (z)")+
  xlab("Time (s)")+
  # p$graphstyle+
  scale_color_brewer(palette = "Dark2")+
  xlim(0,6)
   facet_grid(~ mediansplit_sample_arousal2)
   
   
   tmp.df4_full_stim_downs_jun2021_60bins %>%
  subset(!is.na(ground_arousal_lab))%>%
  ggplot(aes(x = timerezero3, y = pup_basCor))+
  stat_smooth(aes(color = mediansplit_sample_arousal2), fun = mean,geom = "line",
               se = F, alpha = .1, size = 1.5)+
  stat_smooth(aes(group=stimIAPS, color = mediansplit_sample_arousal2), size = .6, se = F)+
theme_classic()+
  ylab("Pupil size (z)")+
  xlab("Time (s)")+
     # geom_text(aes(label = ssid))+
  # p$graphstyle+
  scale_color_brewer(palette = "Dark2")+
  xlim(0,6)+
     geom_text(aes(label = stimIAPS))
   facet_grid(~ mediansplit_sample_valence2)
   
tmp.df4_full_stim_downs_jun2021_60bins %>%
  subset(!is.na(ground_arousal_lab))%>%
  ggplot(aes(x = timerezero3, y = pup_basCor))+
  # stat_smooth(aes(color = mediansplit_ground_arousal), fun = mean,geom = "line",
  #              se = F, alpha = .1, size = 1.5)+
  stat_smooth(aes(group=stimIAPS, color = ground_arousal_lab), size = .6, se = F)+
theme_classic()+
  ylab("Pupil size (z)")+
  xlab("Time (s)")+
     # geom_text(aes(label = ssid))+
  # p$graphstyle+
  scale_color_brewer(palette = "Dark2")+
  xlim(0,6)+
     # geom_text(aes(label = stimIAPS))+
   facet_grid(~ ground_valence_lab)



```

check baselining onto specific valences
```{r Scrap this}

# - use IAPS data to split valence - positive negative
# - within that - compute arousal low mid high within each valence both for the iaps data and my study
# do this on a participant basis or sampleÇ? try sample first
tmp.df4_full_stim_downs_jun2021_60bins %>%
  ungroup()%>%
  group_by(ground_valence_lab)%>%
  mutate(ArousalMean_z_by_val = scale(ArousalMean, center = TRUE, scale = TRUE)[,1])%>%
   mutate(Arousal_z_by_val = scale(arousal, center = TRUE, scale = TRUE)[,1])%>%
  group_by(stimIAPS,ground_valence_lab)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  # ggplot(aes(ground_valence_lab, ArousalMean_z_by_val ))+
  ggplot(aes(ground_valence_lab, Arousal_z_by_val ))+
  # geom_point()+
  stat_summary(geom = 'pointrange')

# hpw does this relate to the original ratigs

# do this on a participant basis or sampleÇ? try sample first
tmp.df4_full_stim_downs_jun2021_60bins %>%
  ungroup()%>%
  group_by(ground_valence_lab)%>%
  mutate(ArousalMean_z_by_val = scale(ArousalMean, center = TRUE, scale = TRUE)[,1])%>%
   mutate(Arousal_z_by_val = scale(arousal, center = TRUE, scale = TRUE)[,1])%>%
  # group_by(stimIAPS,ground_valence_lab)%>%
  # summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  # ggplot(aes(ground_valence_lab, ArousalMean_z_by_val ))+
  ggplot(aes(ValenceMean, ArousalMean_z_by_val ))+
  geom_point()+
  geom_smooth(method = 'lm', se = F)+
  # geom_smooth(aes(group = ground_valence_lab), method = 'lm', se = F)
  # stat_summary(geom = 'pointrange')+
      ggpubr::stat_cor()


tmp.df4_full_stim_downs_jun2021_60bins %>%
  ungroup()%>%
  group_by(ground_valence_lab)%>%
  mutate(ArousalMean_z_by_val = scale(ArousalMean, center = TRUE, scale = TRUE)[,1])%>%
   mutate(Arousal_z_by_val = scale(arousal, center = TRUE, scale = TRUE)[,1])%>%
  group_by(stimIAPS,ground_valence_lab)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  # ggplot(aes(ground_valence_lab, ArousalMean_z_by_val ))+
  ggplot(aes(Arousal_z_by_val, valence_c))+
  geom_point()+
  geom_smooth(method = 'lm', se = F)+
  # geom_smooth(aes(group = ground_valence_lab), method = 'lm', se = F)
  # stat_summary(geom = 'pointrange')+
      ggpubr::stat_cor()




?cut
tmp.df4_full_stim_downs_jun2021_60bins$valence_self<- cut(tmp.df4_full_stim_downs_jun2021_60bins$valence, 3,
                                                          labels = c("Negative", "Neutral", "Positive"))


tmp.df4_full_stim_downs_jun2021_60bins %>%
  ungroup()%>%
  group_by(ground_valence_lab)%>%
  # mutate(ArousalMean_z_by_val = scale(ArousalMean, center = TRUE, scale = TRUE)[,1])%>%
   mutate(Arousal_z_by_val = scale(arousal, center = TRUE, scale = TRUE)[,1])%>%
  group_by(stimIAPS,ground_valence_lab)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  # ggplot(aes(ground_valence_lab, ArousalMean_z_by_val ))+
  ggplot(aes(ground_valence_lab, Arousal_z_by_val))+
  geom_point()+
  # geom_smooth(aes(group = ground_valence_lab), method = 'lm', se = F)
  stat_summary(geom = 'pointrange')+
      ggpubr::stat_cor()

  
  # mean center within neutral positive, neutral negative


tmp.df4_full_stim_downs_jun2021_60bins$neutral_pos<- if_else(tmp.df4_full_stim_downs_jun2021_60bins$ground_valence_lab!= "More negative", TRUE, FALSE)

tmp.df4_full_stim_downs_jun2021_60bins$neutral_neg <- if_else(tmp.df4_full_stim_downs_jun2021_60bins$ground_valence_lab!= "More positive", TRUE, FALSE)

tmp.df4_full_stim_downs_jun2021_60bins <- tmp.df4_full_stim_downs_jun2021_60bins%>%
  group_by(neutral_pos)%>%
  mutate(neutral_pos_mean_arousal = mean(ArousalMean, na.rm = TRUE),
                                         neutral_pos_sd_arousal = sd(ArousalMean, na.rm = TRUE))%>%
  mutate(neutral_pos_mean_arousal_self = mean(arousal, na.rm = TRUE),
         neutral_pos_sd_arousal_self = sd(arousal, na.rm = TRUE))%>%
  group_by(neutral_neg)%>%
  
  mutate(neutral_neg_mean_arousal = mean(ArousalMean, na.rm = TRUE),
                                         neutral_neg_sd_arousal = sd(ArousalMean, na.rm = TRUE)) %>%
  mutate(neutral_neg_mean_arousal_self = mean(arousal, na.rm = TRUE),
         neutral_neg_sd_arousal_self = sd(arousal, na.rm = TRUE))
  
# group_by()

# replace the values when neutral_pos and neutral_neg is FALSE respectivelly
# library(dplyr)
# check how many nas do we have before we start
table(is.na(tmp.df4_full_stim_downs_jun2021_60bins$neutral_neg_mean_arousal))
 # FALSE   TRUE 
# 158193  13975 


# compute new variables where arousal is scaled to negative (negative value - mean of negative and neutral) same to positive
tmp.df4_full_stim_downs_jun2021_60bins <- tmp.df4_full_stim_downs_jun2021_60bins %>%
    mutate_at(vars(matches('^neutral_pos_.*$')), ~ 
                  replace(., neutral_pos == FALSE, NA))
  
table(is.na(tmp.df4_full_stim_downs_jun2021_60bins$neutral_pos_mean_arousal))
table(is.na(tmp.df4_full_stim_downs_jun2021_60bins$neutral_pos_sd_arousal_self))

table(is.na(tmp.df4_full_stim_downs_jun2021_60bins$neutral_neg_mean_arousal_self))


tmp.df4_full_stim_downs_jun2021_60bins <- tmp.df4_full_stim_downs_jun2021_60bins %>%
    mutate_at(vars(matches('^neutral_neg_.*$')), ~ 
                  replace(., neutral_neg == FALSE, NA))

table(is.na(tmp.df4_full_stim_downs_jun2021_60bins$neutral_neg_sd_arousal_self))


tmp.df4_full_stim_downs_jun2021_60bins$neutral_pos_mean_arousal <- if_else(tmp.df4_full_stim_downs_jun2021_60bins$neutral_pos == TRUE, tmp.df4_full_stim_downs_jun2021_60bins)
  

colnames(tmp.df4_full_stim_downs_jun2021_60bins)


tmp.df4_full_stim_downs_jun2021_60bins$arousal_rel_neutral_ground <- ifelse(tmp.df4_full_stim_downs_jun2021_60bins$neutral_pos == TRUE & 
                                                                      tmp.df4_full_stim_downs_jun2021_60bins$ground_valence_lab == "More positive", tmp.df4_full_stim_downs_jun2021_60bins$ArousalMean - tmp.df4_full_stim_downs_jun2021_60bins$neutral_pos_mean_arousal,
                                                                    ifelse(tmp.df4_full_stim_downs_jun2021_60bins$ground_valence_lab == "More negative" & tmp.df4_full_stim_downs_jun2021_60bins$neutral_neg == TRUE, tmp.df4_full_stim_downs_jun2021_60bins$ArousalMean - 
                                                                             tmp.df4_full_stim_downs_jun2021_60bins$neutral_neg_mean_arousal, 
                                                                           tmp.df4_full_stim_downs_jun2021_60bins$ArousalMean - mean(tmp.df4_full_stim_downs_jun2021_60bins$ArousalMean, na.rm = TRUE)))


# same with self report

tmp.df4_full_stim_downs_jun2021_60bins$arousal_rel_neutral_self <- ifelse(tmp.df4_full_stim_downs_jun2021_60bins$neutral_pos == TRUE & 
                                                                      tmp.df4_full_stim_downs_jun2021_60bins$ground_valence_lab == "More positive", tmp.df4_full_stim_downs_jun2021_60bins$arousal - tmp.df4_full_stim_downs_jun2021_60bins$neutral_pos_mean_arousal_self,
                                                                    ifelse(tmp.df4_full_stim_downs_jun2021_60bins$ground_valence_lab == "More negative" & tmp.df4_full_stim_downs_jun2021_60bins$neutral_neg == TRUE, tmp.df4_full_stim_downs_jun2021_60bins$arousal - 
                                                                             tmp.df4_full_stim_downs_jun2021_60bins$neutral_neg_mean_arousal_self, 
                                                                           tmp.df4_full_stim_downs_jun2021_60bins$arousal - mean(tmp.df4_full_stim_downs_jun2021_60bins$arousal, na.rm = TRUE)))


# visualise new ground and self report arousal baseline separetelly for positive and negative valenced stimuli (based on IAPS validation)
table(is.na(tmp.df4_full_stim_downs_jun2021_60bins$arousal_rel_neutral_ground))
  
table(is.na(tmp.df4_full_stim_downs_jun2021_60bins$arousal_rel_neutral_ground), tmp.df4_full_stim_downs_jun2021_60bins$ground_valence_lab)

library(tidyverse)

tmp.df4_full_stim_downs_jun2021_60bins%>%
  group_by(stimIAPS, ground_valence_lab)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(ground_valence_lab, ArousalMean))+
  geom_point()+
  stat_summary(geom = 'pointrange')

tmp.df4_full_stim_downs_jun2021_60bins%>%
  group_by(stimIAPS, ground_valence_lab)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(ground_valence_lab, arousal_rel_neutral_ground))+
  # geom_point()+
  stat_summary(geom = 'pointrange')


tmp.df4_full_stim_downs_jun2021_60bins%>%
  group_by(stimIAPS, ground_valence_lab)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(ground_valence_lab, arousal_rel_neutral_self))+
  geom_point()+
  stat_summary(geom = 'pointrange')

arousal_rel_neutral_self

# ?cut
# is the cutoff for positive in the prevopis variable too large
tmp.df4_full_stim_downs_jun2021_60bins$ground_valence_2<- cut(tmp.df4_full_stim_downs_jun2021_60bins$ValenceMean, c(0,4,5,9), 
                                                              labels = c("negative", "neutral", "positive"))

tmp.df4_full_stim_downs_jun2021_60bins%>%
  group_by(stimIAPS, ssid,ground_valence)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(stimIAPS, abs(arousal), color = ground_valence))+
  # geom_point()+
  stat_summary(funy = mean, geom = 'pointrange')


tmp.df4_full_stim_downs_jun2021_60bins%>%
  group_by(stimIAPS, ssid,ground_valence)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(ground_valence, abs(arousal), color = ground_valence))+
  geom_boxplot()+
  stat_summary(funy = mean, geom = 'pointrange')

tmp.df4_full_stim_downs_jun2021_60bins%>%
  subset(!is.na(ground_valence))%>%
  group_by(stimIAPS, ssid,ground_valence)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(ground_valence, abs(arousal), color = ground_valence))+
  geom_boxplot()+
  stat_summary(funy = mean, geom = 'pointrange')

# absoluting 

tmp.df4_full_stim_downs_jun2021_60bins%>%
  subset(!is.na(ground_valence))%>%
  # group_by(ground_valence)%>%
  ungroup()%>%
  mutate(abs_arousal = abs(arousal), na.rm = TRUE)%>%
  mutate(abs_arousal_z = abs_arousal - mean(abs_arousal, na.rm = TRUE))%>%
  # summarise_at(c('mean_abs_arousal'), median, na.rm = TRUE)
  group_by(ssid,ground_valence_2)%>%
  summarise_if(is.numeric, median, na.rm = TRUE)%>%
  ggplot(aes(ground_valence_2, abs_arousal_z, color = ground_valence_2))+
  geom_point()+
  stat_summary(funy = median, geom = 'pointrange')+
  geom_boxplot()


absolutetest<- tmp.df4_full_stim_downs_jun2021_60bins%>%
  group_by(stimDescription,ground_valence_2)%>%
  # summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  mutate(arousal_abs = abs(arousal), valence_abs = abs(valence))%>%
  
  summarise_at(c("arousal", "ArousalMean", "ValenceMean","arousal_abs", "valence", "valence_abs", "arousal_abs_on_pos"), mean, na.rm = TRUE) 



absolutetest %>%
  ggplot(aes(ValenceMean,arousal_abs))+
  geom_point()+
  geom_text(aes(label = stimDescription))

absolutetest %>%
  ggplot(aes(ArousalMean,arousal_abs))+
  geom_point()+
  geom_text(aes(label = stimDescription))

# he U shape relationship seems to hold dependign on whether arousal is absolute - converting actovation to absolute

# absolute arousal don't correlate with iaps arousal
# we we taking valence absolute as intensity
absolutetest %>%
  ggplot(aes(ValenceMean,valence_abs))+
  geom_point()+
  geom_text(aes(label = stimDescription))

# arousal vs absolute valence
absolutetest %>%
  ggplot(aes(ArousalMean,valence_abs))+
  geom_point()+
  geom_text(aes(label = stimDescription))+
  geom_smooth(method = 'lm', se = F)+
  ggpubr::stat_cor()
# it seems like arousal in our case is picking something that is not just intemnsity of vaence, as it correlates better with arousal Mean

absolutetest %>%
  ggplot(aes(valence,valence_abs))+
  geom_point()+
  geom_text(aes(label = stimDescription))+
  geom_smooth(method = 'lm', se = F)+
  ggpubr::stat_cor()

# try and compute correlation using valencabs(

tmp.df4_full_stim_downs_jun2021_60bins%>%
  subset(!is.na(ground_valence_2))%>%
  group_by(ssid, stimIAPS,ground_valence_2)%>%
  
  mutate(arousal_abs = abs(arousal), valence_abs = abs(valence))%>%
  group_by(ssid, ground_valence_2)%>%
  mutate(cortest = cor(valence_abs, pup_basCor, use = "complete"))%>%
  
  # summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  # summarise_at(c("arousal", "ArousalMean","ValenceMean", "arousal_abs", "valence", "valence_abs", "arousal_abs_on_pos"), mean, na.rm = TRUE) %>%
  
  ggplot(aes(ground_valence_2, cortest, color = ground_valence_2))+
  # geom_point()+
  stat_summary(funy = mean, geom = 'pointrange')
    theme(axis.text.x = element_text(angle = 60))


```

just positive check
```{r}
# Plot just positive
tmp.df4_full_stim_downs_jun2021_60bins %>%
  subset(ground_valence_2 == "positive")%>%
  group_by(stimDescription,ground_valence_2)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(stimDescription, arousal))+
  # geom_point()+
  stat_summary(funy = mean, geom = 'pointrange', color = "blue")+
   stat_summary(aes( y = ArousalMean), funy = mean, geom = 'pointrange', color = "red")+
  theme(axis.text.x = element_text(angle = 60))


tmp.df4_full_stim_downs_jun2021_60bins %>%
  subset(ground_valence_2 == "positive")%>%
  group_by(stimDescription,ground_valence_2)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(stimDescription, arousal))+
  # geom_point()+
  stat_summary(funy = mean, geom = 'pointrange', color = "blue")+
   stat_summary(aes( y = ArousalMean), funy = mean, geom = 'pointrange', color = "red")+
  theme(axis.text.x = element_text(angle = 60))

# if we removed the erotic ones would we have positive tracking arousal better


# negative
tmp.df4_full_stim_downs_jun2021_60bins %>%
  subset(ground_valence_2 == "negative")%>%
  group_by(stimDescription,ground_valence_2)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(stimDescription, arousal))+
  # geom_point()+
  stat_summary(funy = mean, geom = 'pointrange', color = "blue")+
   stat_summary(aes( y = ArousalMean), funy = mean, geom = 'pointrange', color = "red")+
  theme(axis.text.x = element_text(angle = 60))


tmp.df4_full_stim_downs_jun2021_60bins %>%
  subset(ground_valence_2 == "positive")%>%
  group_by(stimIAPS,ground_valence_2)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(ArousalMean, arousal))+
  geom_point()+
  geom_smooth(method = 'lm')+
  ggpubr::stat_cor()

tmp.df4_full_stim_downs_jun2021_60bins %>%
  subset(ground_valence_2 == "negative")%>%
  group_by(stimIAPS,ground_valence_2)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(ArousalMean, arousal))+
  geom_point()+
  geom_smooth(method = 'lm')+
  ggpubr::stat_cor()


tmp.df4_full_stim_downs_jun2021_60bins %>%
  subset(ground_valence_2 == "neutral")%>%
  group_by(stimIAPS,ground_valence_2)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(ArousalMean, arousal))+
  geom_point()+
  geom_smooth(method = 'lm')+
  ggpubr::stat_cor()
  
  # geom_point()+
  stat_summary(funy = mean, geom = 'pointrange', color = "blue")+
   stat_summary(aes( y = ArousalMean), funy = mean, geom = 'pointrange', color = "red")+
  theme(axis.text.x = element_text(angle = 60))
  
  
  
  tmp.df4_full_stim_downs_jun2021_60bins %>%
  subset(ground_valence_2 == "positive")%>%
  group_by(stimDescription,ground_valence_2)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(stimDescription, arousal))+
  # geom_point()+
  stat_summary(funy = mean, geom = 'pointrange', color = "blue")+
   stat_summary(aes( y = ArousalMean), funy = mean, geom = 'pointrange', color = "red")+
  theme(axis.text.x = element_text(angle = 60))
  

  tmp.df4_full_stim_downs_jun2021_60bins %>%
  subset(ground_valence_2 != "negative")%>%
  group_by(stimDescription,ground_valence_2)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(stimDescription, abs(arousal), color = ground_valence_2))+
  # geom_point()+
  stat_summary(funy = mean, geom = 'pointrange')+
   # stat_summary(aes( y = ArousalMean), funy = mean, geom = 'pointrange')+
  theme(axis.text.x = element_text(angle = 60))
  
  
  tmp.df4_full_stim_downs_jun2021_60bins$arousal_abs_on_pos<- if_else(tmp.df4_full_stim_downs_jun2021_60bins$ground_valence_2!= "negative", abs(tmp.df4_full_stim_downs_jun2021_60bins$arousal), tmp.df4_full_stim_downs_jun2021_60bins$arousal)
  
  
    tmp.df4_full_stim_downs_jun2021_60bins %>%
  # subset(ground_valence_2 != "negative")%>%
  group_by(stimDescription,ground_valence_2)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(ground_valence_2, arousal_abs_on_pos, color = ground_valence_2))+
  geom_point()+
  stat_summary(funy = mean, geom = 'pointrange')+
   # stat_summary(aes( y = ArousalMean), funy = mean, geom = 'pointrange')+
  theme(axis.text.x = element_text(angle = 60))
    
    
        tmp.df4_full_stim_downs_jun2021_60bins %>%
  # subset(ground_valence_2 != "negative")%>%
  group_by(stimDescription,ground_valence_2)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(ground_valence_2, abs(arousal), color = ground_valence_2))+
  # geom_point()+
  stat_summary(funy = mean, geom = 'pointrange')+
   # stat_summary(aes( y = ArousalMean), funy = mean, geom = 'pointrange')+
  theme(axis.text.x = element_text(angle = 60))
  
```

erotica check
```{r}
# if we removed the erotic ones would we have positive tracking arousal better?
  
  
  # organise pupil by growing order of positivearousal
  tmp.df4_full_stim_downs_jun2021_60bins %>%
  subset(ground_valence_2 == "positive")%>%
  group_by(stimIAPS,stimDescription, ground_valence_2)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
    arrange(arousal)%>%
  ggplot(aes(arousal, pup_basCor))+
    geom_text(aes(label = stimDescription))+
  # geom_point()+
  stat_summary(funy = mean, geom = 'pointrange', color = "blue")+
    xlim(-7,-2)+
    ggpubr::stat_cor()
   stat_summary(aes( y = ArousalMean), funy = mean, geom = 'pointrange', color = "red")+
  theme(axis.text.x = element_text(angle = 60))
   
   # so arousal (ativation) sis till being tracked even if we exclude the sexual stimuli
   
   
   
     tmp.df4_full_stim_downs_jun2021_60bins %>%
  subset(ground_valence_2 == "negative")%>%
  group_by(stimIAPS,stimDescription, ground_valence_2)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
    arrange(arousal)%>%
  ggplot(aes(arousal, pup_basCor))+
    geom_text(aes(label = stimDescription))+
  # geom_point()+
  stat_summary(funy = mean, geom = 'pointrange', color = "blue")+
    # xlim(-7,-2)+
    ggpubr::stat_cor()

# if we removed the erotic ones would we have positive tracking arousal better

# maybe not every emotional experience causes a detectable physiologicachangedFiles(
# preparing ubjects might allow them to calibrate
```

```{r}
# does absolute arousal correlate with other variables of interest
tmp.df4_full_stim_downs_jun2021_60bins$abs_arousal<- abs(tmp.df4_full_stim_downs_jun2021_60bins$arousal)

tmp.df4_full_stim_downs_jun2021_60bins %>%
  subset(ssid_num< 500)%>%
  subset(!is.na(groun_valence))%>%
  group_by(ssid, stimIAPS)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(pup_basCor, arousal))+
  geom_point()+
  stat_smooth(aes(group = ssid),method = 'lm', se = F)
    ggpubr::stat_cor()

tmp.df4_full_stim_downs_jun2021_60bins %>%
  subset(!is.na(groun_valence))%>%
  group_by(ssid, stimIAPS)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(pup_basCor, abs_arousal))+
  geom_point()+
  geom_smooth(aes(group = ssid),method = 'lm', se = F)+
  ggpubr::stat_cor()+
  facet_grid()

tmp.df4_full_stim_downs_jun2021_60bins %>%
  subset(!is.na(groun_valence))%>%
  group_by(ssid, stimIAPS,ground_valence_lab)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  group_by(ssid,ground_valence_lab)%>%
  mutate(corar = cor(abs_arousal, pup_basCor, use = "complete"))%>%
  ggplot(aes(ground_valence_lab, corar))+
  # geom_point()
  stat_summary(geom = 'pointrange')


tmp.df4_full_stim_downs_jun2021_60bins %>%
  group_by(stimIAPS)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(ArousalMean, ArousalMeanThisSample))+
  geom_point()+
  ggpubr::stat_cor()

tmp.df4_full_stim_downs_jun2021_60bins %>%
  group_by(stimIAPS)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(ArousalMean, abs_arousal))+
  geom_point()+
  ggpubr::stat_cor()
# this again suggests that there is not too much of a problem in our response format as the absolute would be the equivalent of an scale that encodes for calence (direction)
```

a few checks on stim by ratings 
```{r eval=FALSE, include=FALSE}
<!-- tmp.df4_full_stim_downs_jun2021_60bins%>% -->
<!--   group_by(stimIAPS, ssid,valence_self)%>% -->
<!--   summarise_if(is.numeric, mean, na.rm = TRUE)%>% -->
<!--   ggplot(aes(stimIAPS, arousal, color = valence_self))+ -->
<!--   # geom_point()+ -->
<!--   stat_summary(funy = mean, geom = 'pointrange') -->


<!-- tmp.df4_full_stim_downs_jun2021_60bins%>% -->
<!--   group_by(stimIAPS, ssid,valence_self)%>% -->
<!--   summarise_if(is.numeric, mean, na.rm = TRUE)%>% -->
<!--   ggplot(aes(stimIAPS, abs(valence), color = valence_self))+ -->
<!--   # geom_point()+ -->
<!--   stat_summary(funy = mean, geom = 'pointrange') -->


<!-- tmp.df4_full_stim_downs_jun2021_60bins%>% -->
<!--   group_by(stimIAPS, ssid,ground_valence)%>% -->
<!--   summarise_if(is.numeric, mean, na.rm = TRUE)%>% -->
<!--   ggplot(aes(stimIAPS, abs(valence), color = ground_valence))+ -->
<!--   # geom_point()+ -->
<!--   stat_summary(funy = mean, geom = 'pointrange') -->
  
```

```{r}
# create the new arousal corrected within positive/negative - neutral
tmp.df4_full_stim_downs_jun2021_60bins$arousal_rel_neutral_ground_z <- ifelse(tmp.df4_full_stim_downs_jun2021_60bins$neutral_pos == TRUE & 
                                                                      tmp.df4_full_stim_downs_jun2021_60bins$ground_valence_lab == "More positive", tmp.df4_full_stim_downs_jun2021_60bins$arousal_rel_neutral_ground/ tmp.df4_full_stim_downs_jun2021_60bins$neutral_pos_sd_arousal,
                                                                    ifelse(tmp.df4_full_stim_downs_jun2021_60bins$ground_valence_lab == "More negative" & tmp.df4_full_stim_downs_jun2021_60bins$neutral_neg == TRUE, tmp.df4_full_stim_downs_jun2021_60bins$arousal_rel_neutral_ground / 
                                                                             tmp.df4_full_stim_downs_jun2021_60bins$neutral_neg_sd_arousal, 
                                                                           tmp.df4_full_stim_downs_jun2021_60bins$arousal_rel_neutral_ground/ sd(tmp.df4_full_stim_downs_jun2021_60bins$ArousalMean, na.rm = TRUE)))


# do the same with self report arousal but using ground valence?
tmp.df4_full_stim_downs_jun2021_60bins$arousal_self_rel_neutral_ground_z <- ifelse(tmp.df4_full_stim_downs_jun2021_60bins$neutral_pos == TRUE & 
                                                                                     tmp.df4_full_stim_downs_jun2021_60bins$ground_valence_lab == "More positive", tmp.df4_full_stim_downs_jun2021_60bins$arousal_rel_neutral_ground/ tmp.df4_full_stim_downs_jun2021_60bins$neutral_pos_sd_arousal,
                                                                    ifelse(tmp.df4_full_stim_downs_jun2021_60bins$ground_valence_lab == "More negative" & tmp.df4_full_stim_downs_jun2021_60bins$neutral_neg == TRUE, tmp.df4_full_stim_downs_jun2021_60bins$arousal_rel_neutral_ground / 
                                                                             tmp.df4_full_stim_downs_jun2021_60bins$neutral_neg_sd_arousal, 
                                                                           tmp.df4_full_stim_downs_jun2021_60bins$arousal_rel_neutral_ground/ sd(tmp.df4_full_stim_downs_jun2021_60bins$ArousalMean, na.rm = TRUE)))



table(is.na(tmp.df4_full_stim_downs_jun2021_60bins$arousal_rel_neutral_ground))
table(is.na(tmp.df4_full_stim_downs_jun2021_60bins$arousal_rel_neutral_ground), tmp.df4_full_stim_downs_jun2021_60bins$ground_valence_lab)


tmp.df4_full_stim_downs_jun2021_60bins%>%
  group_by(stimIAPS, ground_valence_lab)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(ground_valence_lab, ArousalMean))+
  # geom_point()+
  # stat_summary(geom = 'pointrange')
 geom_boxplot()
tmp.df4_full_stim_downs_jun2021_60bins %>%
  group_by(stimIAPS, ground_valence_lab)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(ground_valence_lab, arousal_rel_neutral_ground_z ))+
  # geom_point()+
  geom_boxplot()
  # stat_summary(geom = 'pointrange')


# original valence arousal
tmp.df4_full_stim_downs_jun2021_60bins %>%
  group_by(stimIAPS, ground_valence_lab)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(ValenceMean, ArousalMean ))+
  geom_point()+
  geom_smooth(method = 'lm', se = F)+
  ggpubr::stat_cor()

tmp.df4_full_stim_downs_jun2021_60bins %>%
  group_by(stimIAPS, ground_valence_lab)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(ValenceMean, arousal_rel_neutral_ground_z ))+
  geom_point()+
  geom_smooth(method = 'lm', se = F)+
  ggpubr::stat_cor()



```



    
  
  
```{r}
  tmp.df4_full_stim_downs_jun2021_60bins %>%
  ungroup()%>%
  group_by(ground_valence_lab)%>%
  mutate(ArousalMean_z_by_val = scale(ArousalMean, center = TRUE, scale = TRUE)[,1])%>%
   mutate(Arousal_z_by_val = scale(arousal, center = TRUE, scale = TRUE)[,1])%>%
  group_by(stimIAPS,ground_valence_lab)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  # ggplot(aes(ground_valence_lab, ArousalMean_z_by_val ))+
  ggplot(aes(valence_c, ArousalMean ))+
  geom_point()+
  # geom_smooth(aes(group = ground_valence_lab), method = 'lm', se = F)
  stat_summary(geom = 'pointrange')+
  ggpubr::stat_cor()
  
  

      tmp.df4_full_stim_downs_jun2021_60bins %>%
  ungroup()%>%
  group_by(ground_valence_lab)%>%
  mutate(ArousalMean_z_by_val = scale(ArousalMean, center = TRUE, scale = TRUE)[,1])%>%
      
      group_by(ground_valence_lab)%>%
   mutate(Arousal_z_by_val = scale(arousal, center = TRUE, scale = TRUE)[,1])%>%
  group_by(stimIAPS,ground_valence_lab)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  # ggplot(aes(ground_valence_lab, ArousalMean_z_by_val ))+
  ggplot(aes(ArousalMean_z_by_val,pup_basCor ))+
  geom_point()+
      geom_smooth(method = 'lm', se = F)+
      ggpubr::stat_cor()
    
    tmp.df4_full_stim_downs_jun2021_60bins %>%
  ungroup()%>%
  group_by(ground_valence_lab)%>%
  mutate(ArousalMean_z_by_val = scale(ArousalMean, center = TRUE, scale = TRUE)[,1])%>%
      
      group_by(ground_valence_lab)%>%
   mutate(Arousal_z_by_val = scale(arousal, center = TRUE, scale = TRUE)[,1])%>%
  group_by(stimIAPS,ground_valence_lab)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  # ggplot(aes(ground_valence_lab, ArousalMean_z_by_val ))+
  ggplot(aes(Arousal_z_by_val,pup_basCor ))+
  geom_point()+
      geom_smooth(method = 'lm', se = F)+
      ggpubr::stat_cor()
  # geom_smooth(aes(color = ground_valence_lab), method = 'lm', se = F)
    
    
    
    # original variable
  
      tmp.df4_full_stim_downs_jun2021_60bins %>%
  ungroup()%>%
  group_by(ground_valence_lab)%>%
  mutate(ArousalMean_z_by_val = scale(ArousalMean, center = TRUE, scale = TRUE)[,1])%>%
      
      group_by(ground_valence_lab)%>%
   mutate(Arousal_z_by_val = scale(arousal, center = TRUE, scale = TRUE)[,1])%>%
  group_by(stimIAPS,ground_valence_lab)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  # ggplot(aes(ground_valence_lab, ArousalMean_z_by_val ))+
  ggplot(aes(pup_basCor,arousal))+
  geom_point()+
      geom_smooth(method = 'lm', se = F)+
      ggpubr::stat_cor()
      
      
      
  geom_smooth(aes(color = ground_valence_lab), method = 'lm', se = F)
        tmp.df4_full_stim_downs_jun2021_60bins %>%
  ungroup()%>%
  group_by(ground_valence_lab)%>%
  mutate(ArousalMean_z_by_val = scale(ArousalMean, center = TRUE, scale = TRUE)[,1])%>%
      
      group_by(ground_valence_lab)%>%
   mutate(Arousal_z_by_val = scale(arousal, center = TRUE, scale = TRUE)[,1])%>%
  group_by(stimIAPS,ground_valence_lab)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  # ggplot(aes(ground_valence_lab, ArousalMean_z_by_val ))+
  ggplot(aes(pup_basCor, ArousalMean))+
  geom_point()+
          geom_smooth(method = 'lm', se = F)+
          ggpubr::stat_cor()
  # geom_smooth(aes(group = ground_valence_lab), method = 'lm', se = F)
        

```


Pupil changes over time
<!-- 30 bins -->
```{r}

# create number s for time bins
tmp.df4_full_stim_downs_jun2021_with_behnew<- tmp.df4_full_stim_downs_jun2021_with_behnew%>%
  group_by(ssid, tNo)%>%
  mutate(timebin_no = 1:n())

range(tmp.df4_full_stim_downs_jun2021_with_behnew$timebin_no)

nbins<- unique(tmp.df4_full_stim_downs_jun2021_with_behnew$timebin_no)
nrow(nbins)
# nbins = 30 # number of bins

# create and empty dataframe for the timecourse analyses
timecourse_result_df_int <- data.frame(timebins= rep(NA, 30), 
                                       Estimate_ar= rep(NA, 30), 
                                       t_ar=rep(NA, 30), 
                                       p_ar=rep(NA, 30),
                                       Estimate_vl= rep(NA, 30), 
                                       t_vl=rep(NA, 30), 
                                       p_vl=rep(NA, 30),
                                       Estimate_br= rep(NA, 30), 
                                       t_br=rep(NA, 30), 
                                       p_br=rep(NA, 30),
                                       Estimate_ar_vl= rep(NA, 30), 
                                       t_ar_vl=rep(NA, 30), 
                                       p_ar_vl=rep(NA, 30),
                                       cov= as.character(rep(NA,30)))

# View(timecourse_result_df)
nbins<- nbins[1:28]

i = 0 # remember to always rezero it
# b = 10

# rm(i,b)


for (b in 1:length(nbins)) {
  # for (s in 1:length(nsim)) {

    message(sprintf("$$$$$RUNING lmer %i", nbins[b]))
        lmer_bin_pup  <- lmer(pup_basCor ~ arousal_c* valence+Mean_gray_z  +
                                (1 | ssid),
                                # (0 +arousal_c* valence | ssid),
                                # (1|stimIAPS),
                              REML = FALSE,
                      data = subset(tmp.df4_full_stim_downs_jun2021_with_behnew,
                                    # mediansplit_self_valence == "More positive" & 
                                    timebin_no == nbins[b]))

        #store results from the simulation
            lmer_bin_pup_summary<- summary(lmer_bin_pup)
            lmer_bin_pup_summary
            # lmer_bin_pup_summary[["coefficients"]][3,1]
            timecourse_result_df_int[i,1]<- tmp.df4_full_stim_downs_jun2021_with_behnew$timerezero3[b] #save the exact value of time bin
            
            timecourse_result_df_int[i,2]<- lmer_bin_pup_summary[["coefficients"]][5,1] # first number is term(row), second is column
            timecourse_result_df_int[i,3]<-lmer_bin_pup_summary[["coefficients"]][5,4] # t statistic
            timecourse_result_df_int[i,4]<-lmer_bin_pup_summary[["coefficients"]][5,5] # p value
            # simulated_clusters_JEFFE[i,6]<- nsim[s] #store simulation ount
            timecourse_result_df_int[i,5] <-ifelse(length(lmer_bin_pup_summary$optinfo$conv$lme4$message)
                                                   != 0,
                                               lmer_bin_pup_summary$optinfo$conv$lme4$message, 'pass')

     i = i+1
}


# timecourse_result_df_pos<- timecourse_result_df

timecourse_result_df_int %>%
  ggplot(aes(timebins, t))+
  geom_line(size = 2)+
  geom_line(aes(y = p), linetype = "dashed", size = 2)+
  geom_hline(yintercept = .05, color = 'red', size = 1.5)


```


60 bins

10 hz
each bin is an average of 100ms
<!-- https://link.springer.com/article/10.3758/s13428-018-1075-y -->

```{r}

# create number s for time bins
tmp.df4_full_stim_downs_jun2021_60bins<- tmp.df4_full_stim_downs_jun2021_60bins%>%
  group_by(ssid, tNo)%>%
  mutate(timebin_no = 1:n())

# let's test the interaction term
nbins<- unique(tmp.df4_full_stim_downs_jun2021_60bins$timebin_no)
range(tmp.df4_full_stim_downs_jun2021_60bins$timebin_no)

unique(tmp.df4_full_stim_downs_jun2021_60bins$timebin_no)

# nbins = 60 # number of bins

# create and empty dataframe for the timecourse analyses
timecourse_60bin_result_df <- data.frame(timebins= rep(NA, 60), 
                                       Estimate_ar= rep(NA, 60), 
                                       t_ar=rep(NA, 60), 
                                       p_ar=rep(NA, 60),
                                       Estimate_vl= rep(NA, 60), 
                                       t_vl=rep(NA, 60), 
                                       p_vl=rep(NA, 60),
                                       Estimate_br= rep(NA, 60), 
                                       t_br=rep(NA, 60), 
                                       p_br=rep(NA, 60),
                                       Estimate_ar_vl= rep(NA, 60), 
                                       t_ar_vl=rep(NA, 60), 
                                       p_ar_vl=rep(NA, 60),
                                       cov= as.character(rep(NA,60)))

# View(timecourse_result_df)
# nbins<- nbins[1:60]

i = 0 # remember to always rezero it
# b = 10

# rm(i,b)

# i =1
# unique(tmp.df4_full_stim_downs_jun2021_60bins$)

for (b in 1:length(nbins)) {
  # for (s in 1:length(nsim)) {

    message(sprintf("$$$$$RUNING lmer %i", nbins[b]))
        lmer_bin_pup  <- lmer(pup_basCor ~ (arousal_c* valence)+Mean_gray_z  +
                                (1 | ssid),
                                # (0 +arousal_c* valence | ssid),
                                # (1|stimIAPS),
                              REML = FALSE,
                      data = subset(tmp.df4_full_stim_downs_jun2021_60bins,
                                    ssid_num< 500 &
                                    timebin_no == nbins[b]))

        #store results from the simulation
            lmer_bin_pup_summary<- summary(lmer_bin_pup)
            lmer_bin_pup_summary
            # lmer_bin_pup_summary[["coefficients"]][3,1]
            timecourse_60bin_result_df[i,1]<- tmp.df4_full_stim_downs_jun2021_60bins$timerezero3[b] 
            #save the exact value of time bin
            # store arousal (2,parameter)            # first number is term(row), second is column
            timecourse_60bin_result_df[i,2]<-
            lmer_bin_pup_summary[["coefficients"]][2,1] #estimate
            timecourse_60bin_result_df[i,3]<-
              lmer_bin_pup_summary[["coefficients"]][2,4] # t statistic
            timecourse_60bin_result_df[i,4]<-
            lmer_bin_pup_summary[["coefficients"]][2,5] # p value
            
            # valence
            
            timecourse_60bin_result_df[i,5]<-
            lmer_bin_pup_summary[["coefficients"]][3,1] #estimate
            timecourse_60bin_result_df[i,6]<-
              lmer_bin_pup_summary[["coefficients"]][3,4] # t statistic
            timecourse_60bin_result_df[i,7]<-
              lmer_bin_pup_summary[["coefficients"]][3,5] # p value
            
            # brighteness
            
            timecourse_60bin_result_df[i,8]<-
            lmer_bin_pup_summary[["coefficients"]][4,1] #estimate
            timecourse_60bin_result_df[i,9]<-
              lmer_bin_pup_summary[["coefficients"]][4,4] # t statistic
            timecourse_60bin_result_df[i,10]<-
              lmer_bin_pup_summary[["coefficients"]][4,5] # p value
            
            # interaction arousal x brighteness
            
            timecourse_60bin_result_df[i,11]<-
            lmer_bin_pup_summary[["coefficients"]][5,1] #estimate
            timecourse_60bin_result_df[i,12]<-
              lmer_bin_pup_summary[["coefficients"]][5,4] # t statistic
            timecourse_60bin_result_df[i,13]<-
              lmer_bin_pup_summary[["coefficients"]][5,5] # p value
            
            
            timecourse_60bin_result_df[i,14] <-
              ifelse(length(lmer_bin_pup_summary$optinfo$conv$lme4$message)
                                                   != 0,
                                               lmer_bin_pup_summary$optinfo$conv$lme4$message, 'pass')

     i = i+1
}


# timecourse_result_df_pos<- timecourse_result_df
View(timecourse_60bin_result_df)

  
  # geom_hline(yintercept = .05, color = 'red', size = 1.5)
  

# adjust p values and tag as TRUE whenevee there is at least 3 consecutive p values below .05
?p.adjust

timecourse_60bin_result_df$p_ar_adj<- p.adjust(timecourse_60bin_result_df$p_ar, method = "holm")
timecourse_60bin_result_df$p_ar_adj_TRUE<- if_else(timecourse_60bin_result_df$p_ar_adj<.05, TRUE, FALSE)


timecourse_60bin_result_df$p_vl_adj <- p.adjust(timecourse_60bin_result_df$p_vl, method = "holm")
timecourse_60bin_result_df$p_vl_adj_TRUE<- if_else(timecourse_60bin_result_df$p_vl_adj<.05, TRUE, FALSE)

timecourse_60bin_result_df$p_br_adj <- p.adjust(timecourse_60bin_result_df$p_br, method = "holm")
timecourse_60bin_result_df$p_br_adj_TRUE<- if_else(timecourse_60bin_result_df$p_br_adj<.05, TRUE, FALSE)

timecourse_60bin_result_df$p_ar_vl_adj <- p.adjust(timecourse_60bin_result_df$p_ar_vl, method = "holm")
timecourse_60bin_result_df$p_ar_vl_adj_TRUE<- if_else(timecourse_60bin_result_df$p_ar_vl_adj<.05, TRUE, NULL)

# find the first and last true in a sequence of TRUES
duplicated(timecourse_60bin_result_df$p_ar_adj_TRUE, na.rm = TRUE)



timecourse_60bin_result_df %>%
  ggplot(aes(timebins, Estimate_ar_vl))+
  geom_line(size = 1)
  geom_line(aes(y = t_vl), linetype = "dashed", size = 1)+
  geom_line(aes(y = t_br), linetype = "dotted", size = 1)+
  geom_line(aes(y = t_ar), linetype = "dotdash", size = 1, color = "red")


View(timecourse_60bin_result_df)


?p.adjust

# flad when 3 consecutive rows have a p <.05
require(zoo)

# rle performs lenght encoding
rletest<- rle(timecourse_60bin_result_df$p_ar<.05)
?rle

  (rletest$lengths[rletest$lengths > 3 & rletest$values== TRUE]) # length of each sequence

# To get the vector with only a sequence of "TRUE" you can try

rletest$values[rletest$values != TRUE] <- 0
timecourse_60bin_result_df$p_ar_3below.5<- rep(rletest$values,  rletest$lengths)

table(timecourse_60bin_result_df$p_ar_3below.5)
?p.adjust

timecourse_60bin_result_df%>%
  group_by(p_ar_3below.5)%>%
  mutate(p_ar_adj_clust= p.adjust(p_ar, method = "holm"))

timecourse_60bin_result_df %>%
  mutate(test=rollapply(p_ar, width=3, max, align="left", fill=NA, na.rm=TRUE))%>%
  

  



```

# # figure preferences
good blog in customization 
https://www.datanovia.com/en/blog/ggplot-legend-title-position-and-labels/#rename-legend-labels-and-change-the-order-of-items
```{r}
p<- list()

sf = 1 # scaling factor to make it easier to change sizes of everything, in which case change here

p$graphstyle <-  theme(#base plot theme
  
  # axis lines
  axis.line.y = element_line(color="black"),
  axis.line.x = element_line(color="black"),
  
  axis.title.y=element_text(size = 16*(sf+.5), margin=margin(0,5,0,0)),
  axis.title.x=element_text(size = 16*(sf+.5), margin=margin(0,5,0,0)),
  
  # text
  strip.text.x = element_text(size = 12*(sf+.5),  colour = "black"),
  strip.text.y = element_text(size = 12*(sf+.5),  colour = "black"),
  
  text=element_text(size = 14, family = "sans"),
  axis.text.x = element_text(size = 14*(sf+.5), family = "sans", colour = "black",),
  axis.text.y = element_text(size = 14*(sf+.5), family = "sans", colour = "black"),
  
  
  # panel
  panel.grid.major = element_blank(),
  panel.background = element_blank(),
  # panel.background = element_rect(fill="transparent"),
  # panel.border = element_rect(fill="transparent"),
  # strip shades (reco rectagles)
   strip.background = element_blank(),
  
  # legend
  legend.position = "top",
  legend.key = element_rect(colour = "transparent", fill="transparent"),
  #legend.direction = "horizontal",

  legend.text = element_text(size = 10*(sf+.3)),
  # legend.title = element_text(size = 10*(sf+.3)),
  # legend line tends to be really small in print so adjust here
  legend.key.height = unit(.5, "cm"),
  legend.key.width = unit(2, "cm"),
  
  #legend.text = element_text(size = 10*sf),
  legend.title=element_blank(),
  #legend.text = element_blank(),
  #axis.ticks = element_blank(),
)


```


timecourse stats plots
```{r}
require(RColorBrewer) # make color friendly plots
require(tidyverse)

brewer.pal(4, "Dark2") # gives the exact names of pallets
  # "#1B9E77" "#D95F02" "#7570B3" "#E7298A"
  # timecourse_60bin_result_df$
  # Estimate_ar, Estimate_ar_vl,Estimate_br. Estimate_v
  
plots_timecourse <- list()

#  let's use the order arousal, valence, arousal x valence brightness
View(timecourse_60bin_result_df)
plots_timecourse$eff_size_pup_amp <-   timecourse_60bin_result_df[1:56,] %>% 
  select("timebins","Estimate_ar", "Estimate_vl", "Estimate_br", "Estimate_ar_vl") %>% 
  pivot_longer(-timebins, names_to = "variable", values_to = "Estimate")%>%
    subset(!is.na(Estimate))%>%
  #change the order of the coloring variable here and the name of legends
  mutate(variable = factor(variable, c("Estimate_ar", "Estimate_vl","Estimate_ar_vl",  "Estimate_br"), labels = c("arousal", "valence", "arousal x valence", "brightness")))%>%
  ggplot(aes(timebins, Estimate, group = variable, color= variable))+
  geom_line(aes(linetype = variable), size = 1)+
  
  scale_color_brewer(palette = "Dark2")+
    # scale_color_manual(values=c("#1B9E77", "#D95F02", "#7570B3", "#E7298A"))+
  # use hom correction for significance
  
    # brighteness
    # timecourse_60bin_result_df$timebins[timecourse_60bin_result_df$p_br_adj_TRUE == TRUE]
  
    annotate(geom = 'rect', # use annotate instead of geom_rect, as it is more flexible
             xmin = .16, # got these values from the data-frame. need to fidn a way to automate this
                xmax = 6,
                ymin = -2.03+(sf*.3), # if I ever need to change this, use the scaling factor sf
                ymax = -2+.1+.01+(sf*.3),
                fill =  "#E7298A" , alpha = .5)+ 
    
      annotate("text", 
                x = (1+5.4)/2,
                y = ((-2) +(-2+.1))/2+(sf*.3),
                label = "brightness") +
    
    # arousal
  
    # timecourse_60bin_result_df$p_ar_adj
    # timecourse_60bin_result_df$timebins[timecourse_60bin_result_df$p_ar_adj_TRUE == TRUE]
     annotate(geom = 'rect', xmin = 1,
                xmax = 5.89,
                ymin = -2.03+.1+.1+.1+.1+(sf*.3),
                ymax = -2+.1+.1+.1+.1+.1+.01+(sf*.3),
                fill = "#1B9E77", alpha = .5)+
        annotate("text", 
                  x = (1+5.4)/2,
                y = ((-2+.1+.1+.1+.1) +(-2+.1+.1+.1+.1+.1))/2+(sf*.3),
                 label = "arousal") +

    # arousal-valence
   # timecourse_60bin_result_df$p_ar_vl_adj
    # timecourse_60bin_result_df$timebins[timecourse_60bin_result_df$p_ar_vl_adj_TRUE == TRUE]
       annotate(geom = 'rect', 
                xmin = 1,
                xmax = 5.4,
                ymin = -2.03+.1+.1+(sf*.3),
                ymax = -2+.1+.1+.1+.01+(sf*.3),
                
                fill ="#7570B3", alpha = .5, label = "text")+
    annotate("text", 
                x = (1+5.4)/2,
                y = ((-2+.1+.1) +(-2+.1+.1+.1))/2+(sf*.3),
                label = "arousal x valence") +
        xlab("Time (s)")+
    ylab("Effect size")+
    xlab("Time (s)")+
    ylab("Effect size")

plots_timecourse$eff_size_pup_amp 
# need to rename the label legends


# Edit legend title and labels
plots_timecourse$eff_size_pup_amp <- plots_timecourse$eff_size_pup_amp + 
  p$graphstyle +
    guides(colour = guide_legend(override.aes = list(size=2)))+ #the line size of the legend tends to be smaller in print
  scale_x_continuous(limits = c(0,6), breaks = c(0,2,4,6))+
  scale_y_continuous(limits = c(-2,.7), breaks = c(-1, -0.5, 0,0.5))
  


plots_timecourse$eff_size_pup_amp
plots_timecourse$eff_size_pup_velocity

```


split neutral positive and negative using IAPS validation data and fit the same

```{r}

colnames(tmp.df4_full_stim_downs_jun2021_60bins)

tmp.df4_full_stim_downs_jun2021_60bins$ground_arousal_lab
tmp.df4_full_stim_downs_jun2021_60bins$ground_valence_lab

nbins<- unique(tmp.df4_full_stim_downs_jun2021_60bins$timebin_no)
# create and empty data-frame for the time-course analyses

View(timecourse_60bin_result_df_pos)
timecourse_60bin_result_df_pos <- data.frame(timebins= rep(NA, 60), 
                                       Estimate_ar= rep(NA, 60), 
                                       t_ar=rep(NA, 60), 
                                       p_ar=rep(NA, 60),
                                       # Estimate_vl= rep(NA, 60), 
                                       # t_vl=rep(NA, 60), 
                                       # p_vl=rep(NA, 60),
                                       Estimate_br= rep(NA, 60), 
                                       t_br=rep(NA, 60), 
                                       p_br=rep(NA, 60),
                                       # Estimate_ar_vl= rep(NA, 60), 
                                       # t_ar_vl=rep(NA, 60), 
                                       # p_ar_vl=rep(NA, 60),
                                       cov= as.character(rep(NA,60)))

# View(timecourse_result_df)
# nbins<- nbins[1:60]

i = 0 # remember to always rezero it
# b = 10

# rm(i,b)

# i =1
# unique(tmp.df4_full_stim_downs_jun2021_60bins$)

for (b in 1:length(nbins)) {
  # for (s in 1:length(nsim)) {

    message(sprintf("$$$$$RUNING lmer %i", nbins[b]))
        lmer_bin_pup  <- lmer(pup_basCor ~ arousal_c + Mean_gray_z  +
                                (1 | ssid),
                              REML = FALSE,
                      data = subset(tmp.df4_full_stim_downs_jun2021_60bins,
                                    ssid_num < 500 & ground_valence_lab == "More positive" &
                                    timebin_no == nbins[b]))

        #store results from the simulation
            lmer_bin_pup_summary<- summary(lmer_bin_pup)
            lmer_bin_pup_summary
            # lmer_bin_pup_summary[["coefficients"]][3,1]
            timecourse_60bin_result_df_pos[i,1]<- tmp.df4_full_stim_downs_jun2021_60bins$timerezero3[b] 
            #save the exact value of time bin
            # store arousal (2,parameter)            # first number is term(row), second is column
            timecourse_60bin_result_df_pos[i,2]<-
            lmer_bin_pup_summary[["coefficients"]][2,1] #estimate
            timecourse_60bin_result_df_pos[i,3]<-
              lmer_bin_pup_summary[["coefficients"]][2,4] # t statistic
            timecourse_60bin_result_df_pos[i,4]<-
            lmer_bin_pup_summary[["coefficients"]][2,5] # p value
            
            # brightness
            
            timecourse_60bin_result_df_pos[i,5]<-
            lmer_bin_pup_summary[["coefficients"]][3,1] #estimate
            timecourse_60bin_result_df_pos[i,6]<-
              lmer_bin_pup_summary[["coefficients"]][3,4] # t statistic
            timecourse_60bin_result_df_pos[i,7]<-
              lmer_bin_pup_summary[["coefficients"]][3,5] # p value

            
            timecourse_60bin_result_df_pos[i,8] <-
              ifelse(length(lmer_bin_pup_summary$optinfo$conv$lme4$message)
                                                   != 0,
                                               lmer_bin_pup_summary$optinfo$conv$lme4$message, 'pass')

     i = i+1
}


# timecourse_result_df_pos<- timecourse_result_df
View(timecourse_60bin_result_df_pos)

  
  # geom_hline(yintercept = .05, color = 'red', size = 1.5)
  

# adjust p values and tag as TRUE whenevee there is at least 3 consecutive p values below .05

timecourse_60bin_result_df_pos$p_ar_adj<- p.adjust(timecourse_60bin_result_df_pos$p_ar, method = "holm")
timecourse_60bin_result_df_pos$p_ar_adj_TRUE<- if_else(timecourse_60bin_result_df_pos$p_ar_adj<.05, TRUE, FALSE)


timecourse_60bin_result_df_pos$p_br_adj <- p.adjust(timecourse_60bin_result_df_pos$p_br, method = "holm")
timecourse_60bin_result_df_pos$p_br_adj_TRUE<- if_else(timecourse_60bin_result_df_pos$p_br_adj<.05, TRUE, FALSE)


timecourse_60bin_result_df_pos[1:56,] %>%
  ggplot(aes(timebins, Estimate_ar))+
  geom_line(size = 1)+
  geom_line(aes(y = Estimate_br), linetype = "dashed", size = 1)

  

# subset(tmp.df4_full_stim_downs_jun2021_60bins,
#                                     ssid_num < 500 & ground_valence_lab == "More positive"
#                                    )%>%
#   # group_by(stimIAPS)%>%
#   # summarise_if(is.numeric, mean, na.rm = TRUE)%>%
#   # ggplot(aes(valence, Mean))+
#   # geom_point()+
#   # geom_smooth(method = 'lm', se = F)+
#   # ggpubr::stat_cor()

```
neutral


```{r}



nbins<- unique(tmp.df4_full_stim_downs_jun2021_60bins$timebin_no)
# create and empty data-frame for the time-course analyses

View(timecourse_60bin_result_df_pos)

timecourse_60bin_result_df_neutral <- data.frame(timebins= rep(NA, 60), 
                                       Estimate_ar= rep(NA, 60), 
                                       t_ar=rep(NA, 60), 
                                       p_ar=rep(NA, 60),
                                       # Estimate_vl= rep(NA, 60), 
                                       # t_vl=rep(NA, 60), 
                                       # p_vl=rep(NA, 60),
                                       Estimate_br= rep(NA, 60), 
                                       t_br=rep(NA, 60), 
                                       p_br=rep(NA, 60),
                                       # Estimate_ar_vl= rep(NA, 60), 
                                       # t_ar_vl=rep(NA, 60), 
                                       # p_ar_vl=rep(NA, 60),
                                       cov= as.character(rep(NA,60)))

# View(timecourse_result_df)
# nbins<- nbins[1:60]

i = 0 # remember to always rezero it
# b = 10

# rm(i,b)

# i =1
# unique(tmp.df4_full_stim_downs_jun2021_60bins$)
for (b in 1:length(nbins)) {
  # for (s in 1:length(nsim)) {

    message(sprintf("$$$$$RUNING lmer %i", nbins[b]))
        lmer_bin_pup  <- lmer(pup_basCor ~ arousal_c + Mean_gray_z  +
                                (1 | ssid),
                              REML = FALSE,
                      data = subset(tmp.df4_full_stim_downs_jun2021_60bins,
                                    ssid_num < 500 & ground_valence_lab == "Mild" &
                                    timebin_no == nbins[b]))

        #store results from the simulation
            lmer_bin_pup_summary<- summary(lmer_bin_pup)
            lmer_bin_pup_summary
            # lmer_bin_pup_summary[["coefficients"]][3,1]
            timecourse_60bin_result_df_neutral[i,1]<- tmp.df4_full_stim_downs_jun2021_60bins$timerezero3[b] 
            #save the exact value of time bin
            # store arousal (2,parameter)            # first number is term(row), second is column
            timecourse_60bin_result_df_neutral[i,2]<-
            lmer_bin_pup_summary[["coefficients"]][2,1] #estimate
            timecourse_60bin_result_df_neutral[i,3]<-
              lmer_bin_pup_summary[["coefficients"]][2,4] # t statistic
            timecourse_60bin_result_df_neutral[i,4]<-
            lmer_bin_pup_summary[["coefficients"]][2,5] # p value
            
            # brightness
            
            timecourse_60bin_result_df_neutral[i,5]<-
            lmer_bin_pup_summary[["coefficients"]][3,1] #estimate
            timecourse_60bin_result_df_neutral[i,6]<-
              lmer_bin_pup_summary[["coefficients"]][3,4] # t statistic
            timecourse_60bin_result_df_neutral[i,7]<-
              lmer_bin_pup_summary[["coefficients"]][3,5] # p value

            
            timecourse_60bin_result_df_neutral[i,8] <-
              ifelse(length(lmer_bin_pup_summary$optinfo$conv$lme4$message)
                                                   != 0,
                                               lmer_bin_pup_summary$optinfo$conv$lme4$message, 'pass')

     i = i+1
}


# timecourse_result_df_pos<- timecourse_result_df
View(timecourse_60bin_result_df_neutral)


timecourse_60bin_result_df_neutral$p_ar_adj<- p.adjust(timecourse_60bin_result_df_neutral$p_ar, method = "holm")
timecourse_60bin_result_df_neutral$p_ar_adj_TRUE<- if_else(timecourse_60bin_result_df_neutral$p_ar_adj<.05, TRUE, FALSE)


timecourse_60bin_result_df_neutral$p_br_adj <- p.adjust(timecourse_60bin_result_df_neutral$p_br, method = "holm")
timecourse_60bin_result_df_neutral$p_br_adj_TRUE<- if_else(timecourse_60bin_result_df_neutral$p_br_adj<.05, TRUE, FALSE)



View(timecourse_60bin_result_df_neutral)
timecourse_60bin_result_df_neutral[1:56,] %>%
  ggplot(aes(timebins, Estimate_ar))+
  geom_line(size = 1)+
  geom_line(aes(y = Estimate_br), linetype = "dashed", size = 1)


```


negative


```{r}



nbins<- unique(tmp.df4_full_stim_downs_jun2021_60bins$timebin_no)
# create and empty data-frame for the time-course analyses

View(timecourse_60bin_result_df_pos)

timecourse_60bin_result_df_neg <- data.frame(timebins= rep(NA, 60), 
                                       Estimate_ar= rep(NA, 60), 
                                       t_ar=rep(NA, 60), 
                                       p_ar=rep(NA, 60),
                                       # Estimate_vl= rep(NA, 60), 
                                       # t_vl=rep(NA, 60), 
                                       # p_vl=rep(NA, 60),
                                       Estimate_br= rep(NA, 60), 
                                       t_br=rep(NA, 60), 
                                       p_br=rep(NA, 60),
                                       # Estimate_ar_vl= rep(NA, 60), 
                                       # t_ar_vl=rep(NA, 60), 
                                       # p_ar_vl=rep(NA, 60),
                                       cov= as.character(rep(NA,60)))

# View(timecourse_result_df)
# nbins<- nbins[1:60]

i = 0 # remember to always rezero it
# b = 10

# rm(i,b)

# i =1
# unique(tmp.df4_full_stim_downs_jun2021_60bins$)

for (b in 1:length(nbins)) {
  # for (s in 1:length(nsim)) {

    message(sprintf("$$$$$RUNING lmer %i", nbins[b]))
        lmer_bin_pup  <- lmer(pup_basCor ~ arousal_c + Mean_gray_z  +
                                (1 | ssid),
                              REML = FALSE,
                      data = subset(tmp.df4_full_stim_downs_jun2021_60bins,
                                    ssid_num < 500 & ground_valence_lab == "More negative" &
                                    timebin_no == nbins[b]))

        #store results from the simulation
            lmer_bin_pup_summary<- summary(lmer_bin_pup)
            lmer_bin_pup_summary
            # lmer_bin_pup_summary[["coefficients"]][3,1]
            timecourse_60bin_result_df_neg[i,1]<- tmp.df4_full_stim_downs_jun2021_60bins$timerezero3[b] 
            #save the exact value of time bin
            # store arousal (2,parameter)            # first number is term(row), second is column
            timecourse_60bin_result_df_neg[i,2]<-
            lmer_bin_pup_summary[["coefficients"]][2,1] #estimate
            timecourse_60bin_result_df_neg[i,3]<-
              lmer_bin_pup_summary[["coefficients"]][2,4] # t statistic
            timecourse_60bin_result_df_neg[i,4]<-
            lmer_bin_pup_summary[["coefficients"]][2,5] # p value
            
            # brightness
            
            timecourse_60bin_result_df_neg[i,5]<-
            lmer_bin_pup_summary[["coefficients"]][3,1] #estimate
            timecourse_60bin_result_df_neg[i,6]<-
              lmer_bin_pup_summary[["coefficients"]][3,4] # t statistic
            timecourse_60bin_result_df_neg[i,7]<-
              lmer_bin_pup_summary[["coefficients"]][3,5] # p value

            
            timecourse_60bin_result_df_neg[i,8] <-
              ifelse(length(lmer_bin_pup_summary$optinfo$conv$lme4$message)
                                                   != 0,
                                               lmer_bin_pup_summary$optinfo$conv$lme4$message, 'pass')

     i = i+1
}


# timecourse_result_df_pos<- timecourse_result_df
View(timecourse_60bin_result_df_neg)

# adjust p values
timecourse_60bin_result_df_neg$p_ar_adj<- p.adjust(timecourse_60bin_result_df_neg$p_ar, method = "holm")
timecourse_60bin_result_df_neg$p_ar_adj_TRUE<- if_else(timecourse_60bin_result_df_neg$p_ar_adj<.05, TRUE, FALSE)


timecourse_60bin_result_df_neg$p_br_adj <- p.adjust(timecourse_60bin_result_df_neg$p_br, method = "holm")
timecourse_60bin_result_df_neg$p_br_adj_TRUE<- if_else(timecourse_60bin_result_df_neg$p_br_adj<.05, TRUE, FALSE)



View(timecourse_60bin_result_df_neg)

timecourse_60bin_result_df_neg[1:56,] %>%
  ggplot(aes(timebins, Estimate_ar))+
  geom_line(size = 1)+
  geom_line(aes(y = Estimate_br), linetype = "dashed", size = 1)


```
Pupil velocity test
# velocity analyses


```{r}
# install.packages("pspline")
library(pspline)

predict(sm.spline(tmp.df4_full_stim_downs_jun2021_with_beh$timerezero3, 
                  tmp.df4_full_stim_downs_jun2021_with_beh$pup_basCor), 
        tmp.df4_full_stim_downs_jun2021_with_beh$timerezero3, 1)

D(tmp.df4_full_stim_downs_jun2021_with_beh$pup_basCor, 'x')

tmp.df4_full_stim_downs_jun2021_with_behnew

tmp.df4_full_stim_downs_jun2021_with_behnew <- tmp.df4_full_stim_downs_jun2021_with_behnew %>%
  # subset(!is.na(mediansplit_sample_arousal2))%>%
  # subset(valencearousal_outliers == TRUE) %>%
  # subset(!is.na(mediansplit_sample_arousal2))%>%
  group_by(ssid, stimIAPS) %>%
  mutate(pup_velocity = (abs(lag(pup_basCor)-pup_basCor)/abs(lag(timerezero3)-timerezero3)))
  # mutate(pup_velocity_peak = max(pup_velocity, na.rm = TRUE))


tmp.df4_full_stim_downs_jun2021_with_behnew$pup_velocity

# global

nrow(nbins)
nbins = 30 # number of bins
unique(tmp.df4_full_stim_downs_jun2021_with_behnew$ssid)
tmp.df4_full_stim_downs_jun2021_with_behnew <- tmp.df4_full_stim_downs_jun2021_with_behnew%>%
  group_by(ssid, tNo)%>%
  arrange(ssid,tNo, timerezero3)%>%
  mutate(pup_vel_smooth = zoo::rollmean(pup_velocity, k = 3, fill = NA))
  
zoo::rollmean(pup_velocity, k = 3, fill = NA)

tmp.df4_full_stim_downs_jun2021_with_behnew$pup_vel_smooth

# create and empty dataframe for the timecourse analyses
timecourse_result_df_int_vel <- data.frame(timebins= rep(NA, 30), Estimate= rep(NA, 30), 
                                   t=rep(NA, 30), p=rep(NA, 30), cov= as.character(rep(NA,30)))

# View(timecourse_result_df)
nbins<- nbins[1:28]

i = 0 # remember to always rezero it
# b = 10

rm(b)

nbins<- unique(tmp.df4_full_stim_downs_jun2021_with_behnew$timebin_no)

for (b in 3:length(nbins)) {
  # for (s in 1:length(nsim)) {

    message(sprintf("$$$$$RUNING lmer %i", nbins[b]))
        lmer_bin_pup  <- lmer(pup_vel_smooth ~ arousal_c* valence+Mean_gray_z  +
                                (1 | ssid)+
                                (0 +arousal_c* valence | ssid),
                                # (1|stimIAPS),
                              REML = FALSE,
                      data = subset(tmp.df4_full_stim_downs_jun2021_with_behnew,
                                    # mediansplit_self_valence == "More positive" & 
                                    timebin_no == nbins[b]))

        #store results from the simulation
            lmer_bin_pup_summary<- summary(lmer_bin_pup)
            lmer_bin_pup_summary
            # lmer_bin_pup_summary[["coefficients"]][3,1]
            timecourse_result_df_int_vel[i,1]<- tmp.df4_full_stim_downs_jun2021_with_behnew$timerezero3[b] #save the exact value of time bin
            timecourse_result_df_int_vel[i,2]<- lmer_bin_pup_summary[["coefficients"]][2,1] # first number is term(row), second is column
            timecourse_result_df_int_vel[i,3]<-lmer_bin_pup_summary[["coefficients"]][2,4] # t statistic
            timecourse_result_df_int_vel[i,4]<-lmer_bin_pup_summary[["coefficients"]][2,5] # p value
            # simulated_clusters_JEFFE[i,6]<- nsim[s] #store simulation ount
            timecourse_result_df_int_vel[i,5] <-ifelse(length(lmer_bin_pup_summary$optinfo$conv$lme4$message)
                                                   != 0,
                                               lmer_bin_pup_summary$optinfo$conv$lme4$message, 'pass')

     i = i+1
}


# timecourse_result_df_pos<- timecourse_result_df

timecourse_result_df_int_vel %>%
  ggplot(aes(timebins, t))+
  geom_line(size = 2)+
  geom_line(aes(y = p), linetype = "dashed", size = 2)+
  geom_hline(yintercept = .05, color = 'red', size = 1.5)+
  geom_vline(xintercept = 1, color = 'red')
  # ylim(-4,4)


??ma
?stats::filter
tmp.df4_full_stim_downs_jun2021_60bins %>%
  subset(ssid == 310 & tNo == 10)%>%
  ggplot(aes(timerezero3,pup_vel_smooth))+
  geom_line()+
  geom_point()
  # geom_line(aes(y = pup_velocity),Ç color = 'red')
  # geom_smooth(se = F)

tmp.df4_full_stim_downs_jun2021_60bins%>%
    subset(ssid == 320 & tNo == 20)%>%
  ggplot(aes(timerezero3,pup_basCor))+
  geom_point()+
  geom_line()+
  geom_line(aes(y = pup_vel_smooth), color = 'red')+
  geom_point(aes(y = pup_vel_smooth), color = 'red')
  # geom_line(aes(y = pup_velocity), color = 'red')+
  # geom_smooth(se = F)




```


velocity 100ms
```{r}
unique(tmp.df4_full_stim_downs_jun2021_60bins$ssid)

tmp.df4_full_stim_downs_jun2021_60bins$ssid_num<- as.numeric(as.character(tmp.df4_full_stim_downs_jun2021_60bins$ssid))

tmp.df4_full_stim_downs_jun2021_60bins <- tmp.df4_full_stim_downs_jun2021_60bins %>%
  # subset(!is.na(mediansplit_sample_arousal2))%>%
  # subset(valencearousal_outliers == TRUE) %>%
  # subset(!is.na(mediansplit_sample_arousal2))%>%
  group_by(ssid, tNo) %>%
  mutate(pup_velocity = (abs(lag(pup_basCor)-pup_basCor)/abs(lag(timerezero3)-timerezero3)))%>%
  mutate(pup_velocity_dir = ((lag(pup_basCor)-pup_basCor) / abs(lag(timerezero3)-timerezero3)))
  # mutate(pup_velocity_peak = max(pup_velocity, na.rm = TRUE))


tmp.df4_full_stim_downs_jun2021_60bins%>%
  subset(ssid == 325 & tNo ==38)%>%
  ggplot(aes(timerezero3, pup_velocity))+
  geom_line()

tmp.df4_full_stim_downs_jun2021_60bins%>%
  subset(ssid == 325 & tNo ==38)%>%
  ggplot(aes(timerezero3, pup_basCor))+
  geom_line()

# compared to pupil velocity is much more jerky

# smooth belocity
# number of bins
unique(tmp.df4_full_stim_downs_jun2021_with_behnew$ssid)
tmp.df4_full_stim_downs_jun2021_with_behnew


tmp.df4_full_stim_downs_jun2021_60bins%>%
  subset(ssid == 331 & tNo ==40)%>%
  group_by(ssid, tNo)%>%
  arrange(ssid,tNo, timerezero3)%>%
  mutate(pup_vel_smooth = zoo::rollmean(pup_velocity, k = 3, fill = NA))%>%
   ggplot(aes(timerezero3, pup_velocity))+
  geom_line()+
  geom_line(aes(y = pup_vel_smooth), color = 'red')


tmp.df4_full_stim_downs_jun2021_60bins$four<- paste0(tmp.df4_full_stim_downs_jun2021_60bins$mediansplit_sample_arousal2,
                                                     paste0(tmp.df4_full_stim_downs_jun2021_60bins$mediansplit_sample_valence2))
                                                     
paste0(tmp.df4_full_stim_downs_jun2021_60bins$mediansplit_sample_arousal2)


# unique(tmp.df4_full_stim_downs_jun2021_60bins)


  tmp.df4_full_stim_downs_jun2021_60bins %>%
  subset(ssid_num < 500)%>%
  subset(!is.na(mediansplit_sample_valence2))%>%
  group_by(ssid, tNo)%>%
  arrange(ssid,tNo, timerezero3)%>%
   ggplot(aes(timerezero3, pup_basCor, color = four))+
  stat_smooth(se = F)
  # geom_line(aes(y = pup_vel_smooth), color = 'red')
  
tmp.df4_full_stim_downs_jun2021_60bins %>%
  subset(ssid_num < 500)%>%
  subset(!is.na(mediansplit_sample_valence2))%>%
  group_by(ssid, tNo)%>%
  arrange(ssid,tNo, timerezero3)%>%
   ggplot(aes(timerezero3, pup_velocity, color = four))+
  stat_smooth(se = T)
  # stat_smooth(aes(y = pup_velocity_dir),se = F, linetype = 'dashed')
  # geom_line(aes(y = pup_vel_smooth), color = 'red')


tmp.df4_full_stim_downs_jun2021_60bins %>%
  subset(ssid_num < 500)%>%
  subset(!is.na(mediansplit_sample_valence2))%>%
  group_by(ssid, tNo)%>%
  arrange(ssid,tNo, timerezero3)%>%
   ggplot(aes(timerezero3, pup_velocity_dir, color = four))+
  # stat_summary(fun = mean, geom = 'line')
  stat_smooth(se = T)
  # stat_smooth(aes(y = pup_velocity_dir),se = F, linetype = 'dashed')
  # geom_line(aes(y = pup_vel_smooth), color = 'red')


```

```{r}  
  tmp.df4_full_stim_downs_jun2021_60bins %>%
  subset(ssid_num < 500)%>%
  subset(!is.na(mediansplit_sample_valence2))%>%
  group_by(ssid, tNo)%>%
  arrange(ssid,tNo, timerezero3)%>%
   ggplot(aes(timerezero3, pup_basCor, color = four))+
  stat_smooth(se = F)
  geom_line(aes(y = pup_vel_smooth), color = 'red')
  
  
  tmp.df4_full_stim_downs_jun2021_60bins %>%
  subset(ssid_num < 500)%>%
  subset(!is.na(mediansplit_sample_valence2))%>%
  group_by(ssid, tNo)%>%
  arrange(ssid,tNo, timerezero3)%>%
   ggplot(aes(timerezero3, pup_vel_smooth, color = four))+
  stat_smooth(se = F)
  geom_line(aes(y = pup_vel_smooth), color = 'red')

  
  tmp.df4_full_stim_downs_jun2021_60bins %>%
  subset(ssid_num < 500)%>%
  subset(!is.na(mediansplit_sample_valence2))%>%
  group_by(ssid, tNo)%>%
  arrange(ssid,tNo, timerezero3)%>%
   ggplot(aes(timerezero3, pup_basCor, color = four))+
  stat_smooth(se = F)
  geom_line(aes(y = pup_vel_smooth), color = 'red')



  

```




is velocity correlated with puypil amplitude
```{r}
require(tidyverse)

tmp.df4_full_stim_downs_jun2021_60bins %>%
  group_by(stimIAPS)%>%
  mutate(cor_vel_pup = cor(pup_vel_smooth,pup_basCor, use = 'complete'))%>%
  mutate(vel_max = max(pup_vel_smooth,na.rm = TRUE))%>%
  summarise_if(is.numeric, mean,na.rm = TRUE)%>%
  ggplot(aes(vel_max,pup_basCor))+
  geom_point()+
  geom_smooth(method = 'lm')+
  ggpubr::stat_cor()

```
velocity timecourse
```{r}
# let's test the interaction term
nbins<- unique(tmp.df4_full_stim_downs_jun2021_60bins$timebin_no)
range(tmp.df4_full_stim_downs_jun2021_60bins$timebin_no)

unique(tmp.df4_full_stim_downs_jun2021_60bins$timebin_no)

# nbins = 60 # number of bins

# create and empty dataframe for the timecourse analyses
timecourse_60bin_result_df_vel <- data.frame(timebins= rep(NA, 60), 
                                       Estimate_ar= rep(NA, 60), 
                                       t_ar=rep(NA, 60), 
                                       p_ar=rep(NA, 60),
                                       Estimate_vl= rep(NA, 60), 
                                       t_vl=rep(NA, 60), 
                                       p_vl=rep(NA, 60),
                                       Estimate_br= rep(NA, 60), 
                                       t_br=rep(NA, 60), 
                                       p_br=rep(NA, 60),
                                       Estimate_ar_vl= rep(NA, 60), 
                                       t_ar_vl=rep(NA, 60), 
                                       p_ar_vl=rep(NA, 60),
                                       cov= as.character(rep(NA,60)))

# View(timecourse_result_df)
# nbins<- nbins[1:60]

i = 0 # remember to always rezero it
# b = 10

# rm(i,b)

tmp.df4_full_stim_downs_jun2021_60bins$pup_vel_smooth

nbins<- nbins[3:59]

for (b in 3:length(nbins)) {
  # for (s in 1:length(nsim)) {

    message(sprintf("$$$$$RUNING lmer %i", nbins[b]))
        lmer_bin_pup  <- lmer(pup_velocity ~ (arousal_c* valence)+Mean_gray_z  +
                                (1 | ssid),
                                # (0 +arousal_c* valence | ssid),
                                # (1|stimIAPS),
                              REML = FALSE,
                      data = subset(tmp.df4_full_stim_downs_jun2021_60bins,
                                    !is.na(pup_vel_smooth)&
                                      ssid_num< 500 &
                                    timebin_no == nbins[b]))

        # store results from the simulation
            lmer_bin_pup_summary<- summary(lmer_bin_pup)
            lmer_bin_pup_summary
            # lmer_bin_pup_summary[["coefficients"]][3,1]
            timecourse_60bin_result_df_vel[i,1]<- tmp.df4_full_stim_downs_jun2021_60bins$timerezero3[b] 
            #save the exact value of time bin
            # store arousal (2,parameter)            # first number is term(row), second is column
            timecourse_60bin_result_df_vel[i,2]<-
            lmer_bin_pup_summary[["coefficients"]][2,1] #estimate
            timecourse_60bin_result_df_vel[i,3]<-
              lmer_bin_pup_summary[["coefficients"]][2,4] # t statistic
            timecourse_60bin_result_df_vel[i,4]<-
            lmer_bin_pup_summary[["coefficients"]][2,5] # p value
            
            # valence
            
            timecourse_60bin_result_df_vel[i,5]<-
            lmer_bin_pup_summary[["coefficients"]][3,1] #estimate
            timecourse_60bin_result_df_vel[i,6]<-
              lmer_bin_pup_summary[["coefficients"]][3,4] # t statistic
            timecourse_60bin_result_df_vel[i,7]<-
              lmer_bin_pup_summary[["coefficients"]][3,5] # p value
            
            # brighteness
            
            timecourse_60bin_result_df_vel[i,8]<-
            lmer_bin_pup_summary[["coefficients"]][4,1] #estimate
            timecourse_60bin_result_df_vel[i,9]<-
              lmer_bin_pup_summary[["coefficients"]][4,4] # t statistic
            timecourse_60bin_result_df_vel[i,10]<-
              lmer_bin_pup_summary[["coefficients"]][4,5] # p value
            
            # interaction arousal x brighteness
            
            timecourse_60bin_result_df_vel[i,11]<-
            lmer_bin_pup_summary[["coefficients"]][5,1] #estimate
            timecourse_60bin_result_df_vel[i,12]<-
              lmer_bin_pup_summary[["coefficients"]][5,4] # t statistic
            timecourse_60bin_result_df_vel[i,13]<-
              lmer_bin_pup_summary[["coefficients"]][5,5] # p value
            
            
            timecourse_60bin_result_df_vel[i,14] <-
              ifelse(length(lmer_bin_pup_summary$optinfo$conv$lme4$message)
                                                   != 0,
                                               lmer_bin_pup_summary$optinfo$conv$lme4$message, 'pass')

     i = i+1
}
# timecourse_result_df_pos<- timecourse_result_df
View(timecourse_60bin_result_df_vel)

timecourse_60bin_result_df_vel %>%
  ggplot(aes(timebins, t))+
  geom_line(size = 2)+
  geom_line(aes(y = p), linetype = "dashed", size = 2)+
  geom_hline(yintercept = .05, color = 'red', size = 1.5)

View(timecourse_60bin_result_df_vel)

range(timecourse_60bin_result_df_vel$Estimate_ar, na.rm = TRUE)
timecourse_60bin_result_df_vel %>%
  subset(!is.na(Estimate_ar))%>%
  ggplot(aes(timebins, Estimate_ar))+
  geom_line(size = 1)+
  geom_line(aes(y = Estimate_vl), linetype = "dashed", size = 1)+
  geom_line(aes(y = Estimate_br), linetype = "dotted", size = 1)+
  geom_line(aes(y = Estimate_ar_vl), linetype = "dotdash", size = 1, color = "red")+
  geom_hline(yintercept = 0.2)
  ylim(-.1,.25)
  
```

```{r}
# adjust p values and tag as TRUE whenevee there is at least 3 consecutive p values below .05

```


mutate(ANC=rollapply(ANC, width=3, max, align="left", fill=NA, na.rm=TRUE)) %>%
  filter(ANC >= 0.5) %>%  
  filter(row_number() == 1)
  
  
```{r}
timecourse_60bin_result_df_vel$p_ar_adj<- p.adjust(timecourse_60bin_result_df_vel$p_ar, method = "holm")
timecourse_60bin_result_df_vel$p_ar_adj_TRUE<- if_else(timecourse_60bin_result_df_vel$p_ar_adj<.05, TRUE, FALSE)


timecourse_60bin_result_df_vel$p_vl_adj <- p.adjust(timecourse_60bin_result_df_vel$p_vl, method = "holm")
timecourse_60bin_result_df_vel$p_vl_adj_TRUE<- if_else(timecourse_60bin_result_df_vel$p_vl_adj<.05, TRUE, FALSE)

timecourse_60bin_result_df_vel$p_br_adj <- p.adjust(timecourse_60bin_result_df_vel$p_br, method = "holm")
timecourse_60bin_result_df_vel$p_br_adj_TRUE<- if_else(timecourse_60bin_result_df_vel$p_br_adj<.05, TRUE, FALSE)

timecourse_60bin_result_df_vel$p_ar_vl_adj <- p.adjust(timecourse_60bin_result_df_vel$p_ar_vl, method = "holm")
timecourse_60bin_result_df_vel$p_ar_vl_adj_TRUE<- if_else(timecourse_60bin_result_df_vel$p_ar_vl_adj<.05, TRUE, NULL)

# find the first and last true in a sequence of TRUES
duplicated(timecourse_60bin_result_df_vel$p_ar_adj_TRUE, na.rm = TRUE)

# https://masterr.org/r/how-to-find-consecutive-repeats-in-r/
timecourse_60bin_result_df_vel$test<- NULL

timecourse_60bin_result_df_vel$test <- rle(timecourse_60bin_result_df_vel$p_ar < 0.05)
# View(runs)
# 
# runs[2]
# myruns = which(runs$values == TRUE & runs$lengths >= 3)

View(timecourse_60bin_result_df_vel)
```

```{r}

View(timecourse_60bin_result_df_vel)
#  let's use the order arousal, valence, arousal x valence brightness

plots_timecourse$eff_size_pup_velocity<-
timecourse_60bin_result_df_vel %>% 
  select("timebins","Estimate_ar", "Estimate_vl", "Estimate_br", "Estimate_ar_vl") %>% 
  pivot_longer(-timebins, names_to = "variable", values_to = "Estimate")%>%
    subset(!is.na(Estimate))%>%
  #change the order of the coloring variable here and the name of legends
  mutate(variable = factor(variable, c("Estimate_ar", "Estimate_vl","Estimate_ar_vl",  "Estimate_br"), labels = c("arousal", "valence", "arousal x valence", "brightness")))%>%
  ggplot(aes(timebins, Estimate, group = variable, color= variable))+
  geom_line(aes(linetype = variable), size = 1)+
  
  scale_color_brewer(palette = "Dark2")+
    # scale_color_manual(values=c("#1B9E77", "#D95F02", "#7570B3", "#E7298A"))+
  # use hom correction for significance
  
    # brighteness
    # timecourse_60bin_result_df_vel$timebins[timecourse_60bin_result_df_vel$p_br_adj_TRUE == TRUE]
  
    annotate(geom = 'rect', # use annotate instead of geom_rect, as it is more flexible
             xmin = .37, # got these values from the data-frame. need to fidn a way to automate this
                xmax = .81,
                ymin = -2.03+(sf*1.2), # if I ever need to change this, use the scaling factor sf
                ymax = -2+.1+.01+(sf*1.2),
                fill =  "#E7298A" , alpha = .5)+
    
      # annotate("text", 
      #           x = (1+5.4)/2,
      #           y = ((-2) +(-2+.1))/2+(sf*.3),
      #           label = "brightness") +
    
    # arousal
  
    # timecourse_60bin_result_df$p_ar_adj
      
    # timecourse_60bin_result_df_vel$timebins[timecourse_60bin_result_df_vel$p_ar_adj_TRUE == TRUE]
    
    # timecourse_60bin_result_df_vel$timebins
    
    annotate(geom = 'rect', 
              xmin = 1.028329,
                xmax = 1.028329+.1,
                ymin = -2.03+.1+.1+.1+.1+(sf*1.2),
                ymax = -2+.1+.1+.1+.1+.1+.01+(sf*1.2),
                fill = "#1B9E77", alpha = .5)+
        # annotate("text", 
        #           x = (1+5.4)/2,
        #         y = ((-2+.1+.1+.1+.1) +(-2+.1+.1+.1+.1+.1))/2+(sf*.3),
        #          label = "arousal") +

    # arousal-valence
   # timecourse_60bin_result_df$p_ar_vl_adj
    # timecourse_60bin_result_df_vel$timebins[timecourse_60bin_result_df_vel$p_ar_vl_adj_TRUE == TRUE]
       annotate(geom = 'rect', 
                xmin = 5.5730353,
                xmax = 5.5730353+.1,
                ymin = -2.03+.1+.1+(sf*1.2),
                ymax = -2+.1+.1+.1+.01+(sf*1.2),
                
                fill ="#7570B3", alpha = .5, label = "text")+
    
  # annotate("text", 
  #               x = (1+5.4)/2,
  #               y = ((-2+.1+.1) +(-2+.1+.1+.1))/2+(sf*.3),
  #               label = "arousal x valence") +
        xlab("Time (s)")+
    ylab("Effect size")+
    xlab("Time (s)")+
    ylab("Effect size")

plots_timecourse$eff_size_pup_velocity
# need to rename the label legends


# Edit legend title and labels
plots_timecourse$eff_size_pup_velocity

plots_timecourse$eff_size_pup_velocity<- plots_timecourse$eff_size_pup_velocity + 
  p$graphstyle +
    guides(colour = guide_legend(override.aes = list(size=2)))+ #the line size of the legend tends to be smaller in print
  scale_x_continuous(limits = c(0,6), breaks = c(0,2,4,6))+
  scale_y_continuous(limits = c(-1,1.5), breaks = c(-0.5, 0,0.5,1))
  

plots_timecourse$eff_size_pup_velocity
plots_timecourse$eff_size_pup_amp

```


velocity = actual velocity unlike speed (which is what I actually computed above. velocity encodes direction( constriction or dilation)


use the same datas timecourse to plot aggregated analyses
aggregate arousal plot
```{r}

db_full4new_stim_screen_pupil_nopract$ground_valence_2<-
  cut(db_full4new_stim_screen_pupil_nopract$ValenceMean, c(0,4,5,9), 
                                                              labels = c("negative", "neutral", "positive"))


db_full4new_stim_screen_pupil_nopract$sample_valence_lab2<-
  cut(db_full4new_stim_screen_pupil_nopract$ValenceMeanThisSample, c(-10,-3,3,10), 
                                                              labels = c("negative", "neutral", "positive"))



db_full4new_stim_screen_pupil_nopract$ground_arousal_2<-
  cut(db_full4new_stim_screen_pupil_nopract$ArousalMean, c(0,4,5,9), 
                                                              labels = c("low", "mid", "high"))

db_full4new_stim_screen_pupil_nopract$sample_arousal_lab2<-
  cut(db_full4new_stim_screen_pupil_nopract$ArousalMeanThisSample, c(-10,-3,3,10), 
                                                              labels = c("low", "mid", "high"))





subset(db_full4new_stim_screen_pupil_nopract, 
                                    pupil_outlier == FALSE & ssid_num<500 & 
                                      arousal_outler == FALSE)%>%
  ggplot(aes(sample_valence_lab2, arousal))+
  geom_point()+
  stat_summary(geom = 'pointrange')



subset(db_full4new_stim_screen_pupil_nopract, 
                                    pupil_outlier == FALSE & ssid_num<500 & 
                                      arousal_outler == FALSE)%>%
  group_by(ssid, mediansplit_ground_valence, mediansplit_ground_arousal)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(mediansplit_ground_valence, pup_resid_lm, color = mediansplit_ground_arousal ))+
  # geom_point()+
  stat_summary(geom = 'pointrange')
  


subset(db_full4new_stim_screen_pupil_nopract, 
                                    pupil_outlier == FALSE & ssid_num<500 & 
                                      arousal_outler == FALSE)%>%
  group_by(ssid, mediansplit_ground_valence, mediansplit_ground_arousal)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(mediansplit_ground_valence, pup_resid_lm, color = mediansplit_ground_arousal ))+
  # geom_point()+
  stat_summary(geom = 'pointrange')
  


plots_paper$interaction_ar_vl

# correlation plot

plots_paper$pupil_correlation <-   db_full4new_stim_screen_pupil_nopract %>%
    subset(ssid_num<500)%>%
  subset(pupil_outlier == FALSE & arousal_outler == FALSE)%>%
   group_by(ssid,Alexithymia, mediansplit_ground_valence)%>%
    mutate(cortest = cor.test(arousal_c, pup_basCor)$estimate)%>%
   group_by(ssid,Alexithymia, mediansplit_ground_valence)%>%
    summarise_if(is.numeric, mean, na.rm = TRUE)%>%
     ggplot(aes(mediansplit_ground_valence, cortest, fill = mediansplit_ground_valence))+
     geom_bar(stat="summary", fun.y = "mean", alpha = .5)+
     geom_jitter(width = .1, alpha = .1)+
        stat_summary( geom = 'pointrange')+
        stat_summary(aes(group = ssid), geom = 'line', alpha = .1)+
    ylab("R sujective vs pupil arousal")+
     scale_fill_brewer(palette = "Dark2")+
     p$graphstyle+
     theme(axis.title.x = element_blank())
   
plots_paper$pupil_correlation  




# timecourse plot pupil




```


```


```{r}
# let's test the interaction term
nbins<- unique(tmp.df4_full_stim_downs_jun2021_60bins$timebin_no)
range(tmp.df4_full_stim_downs_jun2021_60bins$timebin_no)

unique(tmp.df4_full_stim_downs_jun2021_60bins$timebin_no)

# nbins = 60 # number of bins

# create and empty dataframe for the timecourse analyses
timecourse_60bin_result_df_vel_dir <- data.frame(timebins= rep(NA, 60), 
                                       Estimate_ar= rep(NA, 60), 
                                       t_ar=rep(NA, 60), 
                                       p_ar=rep(NA, 60),
                                       Estimate_vl= rep(NA, 60), 
                                       t_vl=rep(NA, 60), 
                                       p_vl=rep(NA, 60),
                                       Estimate_br= rep(NA, 60), 
                                       t_br=rep(NA, 60), 
                                       p_br=rep(NA, 60),
                                       Estimate_ar_vl= rep(NA, 60), 
                                       t_ar_vl=rep(NA, 60), 
                                       p_ar_vl=rep(NA, 60),
                                       cov= as.character(rep(NA,60)))


i = 0 # remember to always rezero it
# rm(i,b)

# i =1

for (b in 3:length(nbins)) {
  # for (s in 1:length(nsim)) {

    message(sprintf("$$$$$RUNING lmer %i", nbins[b]))
        lmer_bin_pup  <- lmer(pup_velocity_dir ~ (arousal_c* valence)+Mean_gray_z  +
                                (1 | ssid),
                                # (0 +arousal_c* valence | ssid),
                                # (1|stimIAPS),
                              REML = FALSE,
                      data = subset(tmp.df4_full_stim_downs_jun2021_60bins,
                                    ssid_num< 500&
                                    !is.na(pup_vel_smooth) &
                                    timebin_no == nbins[b]))

        # store results from the simulation
            lmer_bin_pup_summary<- summary(lmer_bin_pup)
            lmer_bin_pup_summary
            # lmer_bin_pup_summary[["coefficients"]][3,1]
            timecourse_60bin_result_df_vel_dir[i,1]<- tmp.df4_full_stim_downs_jun2021_60bins$timerezero3[b] 
            #save the exact value of time bin
            # store arousal (2,parameter)            # first number is term(row), second is column
            timecourse_60bin_result_df_vel_dir[i,2]<-
            lmer_bin_pup_summary[["coefficients"]][2,1] #estimate
            timecourse_60bin_result_df_vel_dir[i,3]<-
              lmer_bin_pup_summary[["coefficients"]][2,4] # t statistic
            timecourse_60bin_result_df_vel_dir[i,4]<-
            lmer_bin_pup_summary[["coefficients"]][2,5] # p value
            
            # valence
            
            timecourse_60bin_result_df_vel_dir[i,5]<-
            lmer_bin_pup_summary[["coefficients"]][3,1] #estimate
            timecourse_60bin_result_df_vel_dir[i,6]<-
              lmer_bin_pup_summary[["coefficients"]][3,4] # t statistic
            timecourse_60bin_result_df_vel_dir[i,7]<-
              lmer_bin_pup_summary[["coefficients"]][3,5] # p value
            
            # brightness
            
            timecourse_60bin_result_df_vel_dir[i,8]<-
            lmer_bin_pup_summary[["coefficients"]][4,1] #estimate
            timecourse_60bin_result_df_vel_dir[i,9]<-
              lmer_bin_pup_summary[["coefficients"]][4,4] # t statistic
            timecourse_60bin_result_df_vel_dir[i,10]<-
              lmer_bin_pup_summary[["coefficients"]][4,5] # p value
            
            # interaction arousal x brighteness
            
            timecourse_60bin_result_df_vel_dir[i,11]<-
            lmer_bin_pup_summary[["coefficients"]][5,1] #estimate
            timecourse_60bin_result_df_vel_dir[i,12]<-
              lmer_bin_pup_summary[["coefficients"]][5,4] # t statistic
            timecourse_60bin_result_df_vel_dir[i,13]<-
              lmer_bin_pup_summary[["coefficients"]][5,5] # p value
            
            
            timecourse_60bin_result_df_vel_dir[i,14] <-
              ifelse(length(lmer_bin_pup_summary$optinfo$conv$lme4$message)
                                                   != 0,
                                               lmer_bin_pup_summary$optinfo$conv$lme4$message, 'pass')

     i = i+1
}
# timecourse_result_df_pos<- timecourse_result_df
View(timecourse_60bin_result_df_vel_dir)

View(timecourse_60bin_result_df_vel_dir)

timecourse_60bin_result_df_vel_dir %>%
  ggplot(aes(timebins, Estimate_ar))+
  geom_line(size = 1)+
  geom_line(aes(y = Estimate_vl), linetype = "dashed", size = 1)+
  geom_line(aes(y = Estimate_br), linetype = "dotted", size = 1)+
  geom_line(aes(y = Estimate_ar_vl), linetype = "dotdash", size = 1, color = "red")
  ylim(-.1,5)
  
  
# adjust p values and tag as TRUE whenevee there is at least 3 consecutive p values below .05
?p.adjust
timecourse_60bin_result_df_vel_dir$p_ar_adj<- p.adjust(timecourse_60bin_result_df_vel_dir$p_ar, method = "holm")
timecourse_60bin_result_df_vel_dir$p_ar_adj_TRUE<- if_else(timecourse_60bin_result_df_vel_dir$p_ar_adj<.05, TRUE, FALSE)


timecourse_60bin_result_df_vel_dir$p_vl_adj <- p.adjust(timecourse_60bin_result_df_vel_dir$p_vl, method = "holm")
timecourse_60bin_result_df_vel_dir$p_vl_adj_TRUE<- if_else(timecourse_60bin_result_df_vel_dir$p_vl_adj<.05, TRUE, FALSE)

timecourse_60bin_result_df_vel_dir$p_br_adj <- p.adjust(timecourse_60bin_result_df_vel_dir$p_br, method = "holm")
timecourse_60bin_result_df_vel_dir$p_br_adj_TRUE<- if_else(timecourse_60bin_result_df_vel_dir$p_br_adj<.05, TRUE, FALSE)

timecourse_60bin_result_df_vel_dir$p_ar_vl_adj <- p.adjust(timecourse_60bin_result_df_vel_dir$p_ar_vl, method = "holm")
timecourse_60bin_result_df_vel_dir$p_ar_vl_adj_TRUE<- if_else(timecourse_60bin_result_df_vel_dir$p_ar_vl_adj<.05, TRUE, NULL)

# find the first and last true in a sequence of TRUES
duplicated(timecourse_60bin_result_df_vel_dir$p_ar_adj_TRUE, na.rm = TRUE)

# https://masterr.org/r/how-to-find-consecutive-repeats-in-r/
timecourse_60bin_result_df_vel_dir$test<- NULL

timecourse_60bin_result_df_vel_dir$test <- rle(timecourse_60bin_result_df_vel_dir$p_ar < 0.05)
```


pupiul velocity and speed might better caprure arousal dynamics because the temporal dynamics are less adffected by a susrtauned effect of brighetenss. whereas amplitude is p[robably strongly affected by brighteness which restricts variability in input from a arousal componenets