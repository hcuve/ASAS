---
title: "Paper_analyses"
author: "Helio"
date: "22/07/2021"
output: html_document
---


Code for the paper: Valence modulated “subjective-objective” arousal

data<- last opened

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```



Participants section

```{r}

library(readr)
library(tidyverse)
db_345_355_stim$Group<- if_else(as.numeric(db_345_355_stim$ssid)<500,"NT", "ASD")
# even though it says no pratice I actually kept the pratice
db_full4new_stim_screen_pupil_nopract$tNo

db_345_355 <- read_csv("tmp.df4_sum_full_bio_hr_self_parsed_345_356.csv")
View(db_345_355)

colnames(db_345_355)
db_345_355<- db_345_355 %>%
  rename(Gender = gender)%>%
  rename(menalHealth = mental_health)

# db_345_355_1<- select(db_345_355, c(1:41, )
colnames(db_full4new_stim_screen_pupil_nopract)



db_345_355_stim<- subset(db_345_355, db_345_355$screencontent == "stim")

# behavioural data
db_345_355
db_f


db_full4new_stim_screen_pupil_nopract$ssid<- as.character(db_full4new_stim_screen_pupil_nopract$ssid)
db_345_355_stim$ssid<- as.character(db_345_355_stim$ssid)
db_345_355_stim$tNo<- as.character(db_345_355_stim$tNo)


colnames(db_full4new_stim_screen_pupil_nopract)
colnames(db_345_355_stim)

install.packages("gtools")
?gtools::smartbind()




# binf only common columns

outersect <- function(x, y) {
  sort(c(setdiff(x, y),
         setdiff(y, x)))
}

common_cols 

oposite_columns<- outersect(colnames(db_full4new_stim_screen_pupil_nopract), colnames(db_345_355_stim$age_response_specific))

common_cols
oposite_columns
rbind(
  db_full4new_stim_screen_pupil_nopract[common_cols], 
  db_345_355_stim[common_cols]
)

colnames(db_full4new_stim_screen_pupil_nopract)
colnames(db_345_355_stim)

db_full4new_stim_screen_pupil_nopract
db_345_355_stim$gender_response

db_345_355_stim<- db_345_355_stim %>% 
  rename(Age = age_response_specific)%>%
  rename(Gender = gender_response)
db_345_355_stim$Age<- age_response_specific



db_full4new_stim_screen_pupil_nopract<- bind_rows(db_full4new_stim_screen_pupil_nopract, db_345_355_stim)


db_full4new_stim_screen_pupil_nopract%>%
  subset(Group == "NT")%>%
  group_by(ssid)%>%
  mutate(cor = cor(arousal, pup_basCor, use = "complete"))%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ungroup()%>%
  ggplot(aes(TAS, cor))+
  geom_point(aes(color = ssid))+
  geom_smooth(method = 'lm', se = F)+
  ggpubr::stat_cor()

db_full4new_stim_screen_pupil_nopract_backup$Mean_HR
table(is.na(db_full4new_stim_screen_pupil_nopract$Mean_HR))

db_full4new_stim_screen_pupil_nopract$Mean_HR %>%
  subset(Group == "NT")%>%
  subset(ssid_num>304)%>%
  subset(ssid!= "344")%>%
  subset(ssid!= "900")%>%
  group_by(ssid)%>%
  mutate(BIO_CDA.AmpSum_z = scale(BIO_CDA.AmpSum, center = TRUE, scale = TRUE)[,1])%>%
  mutate(cor = cor(arousal, pup_basCor, use = "complete"))%>%
  mutate(cor2 = cor(arousal, BIO_CDA.AmpSum_z, use = "complete"))%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ungroup()%>%
  ggplot(aes(TAS, Mean_HR))+
  geom_point(aes(color = ssid))+
  geom_smooth(method = 'lm', se = F)+
  ggpubr::stat_cor()

```



```{r}
unique(db_full4new_stim_screen_pupil_nopract$Group)



db_full4new_stim_screen_pupil_nopract$Group_t<- NULL

unique(db_full4new_stim_screen_pupil_nopract$Group_t)                                                     

# db_full4new_stim_screen_pupil_nopract$grou

# db_full4new_stim_screen_pupil_nopract$Gender<- substr(db_full4new_stim_screen_pupil_nopract$Gender, 1,1)

db_full4new_stim_screen_pupil_nopract_update<- bind_rows(db_full4new_stim_screen_pupil_nopract,
                                                         db_345_355_stim)

db_full4new_stim_screen_pupil_nopract_update$Group<- if_else(as.numeric(db_full4new_stim_screen_pupil_nopract_update$ssid) < 500, "NT",                                               if_else(as.numeric(db_full4new_stim_screen_pupil_nopract_update$ssid) > 700,"NT", "ASD"))


participants_demog <- db_full4new_stim_screen_pupil_nopract_update %>%
  subset(Group == "NT")%>%
  group_by(ssid, Gender)%>%
  summarise_at(c("Age","WASIM", "TAS", "AQ", "IAS", "DASSTotal"), mean, na.rm = TRUE)


unique(participants_demog$ssid)
table(participants_demog$Gender)
colnames(participants_demog)
summary(participants_demog$Age)
sd(participants_demog$Age, na.rm = TRUE)
# table(is.na(participants_demog$Age))
```



Pupil changes and subjective arousal and valence ratings


# let's model it formally
  
# remember baseline corection is equivalendt to stimuli intercept
 
```{r} 
pupil_arousal_findings<- list()
library(lmerTest)
db_345_355_stim$stim
View(db_full4new_stim_screen_pupil_nopract)
unique(db_full4new_stim_screen_pupil_nopract$trialUnq)
db_full4new_stim_screen_pupil_nopract$ssid
unique(db_full4new_stim_screen_pupil_nopract$trialUnq.x)

db_full4new_stim_screen_pupil_nopract_backup<- db_full4new_stim_screen_pupil_nopract

db_full4new_stim_screen_pupil_nopract <- db_full4new_stim_screen_pupil_nopract_update

# db_full4new_stim_screen_pupil_nopract$stimIAPS<- subs
unique(db_full4new_stim_screen_pupil_nopract$stimIAPS)
unique(db_full4new_stim_screen_pupil_nopract_backup$stimIAPS)
unique(substr(db_full4new_stim_screen_pupil_nopract_backup$stimIAPS, 1,8))


db_full4new_stim_screen_pupil_nopract$stimIAPS[db_full4new_stim_screen_pupil_nopract$stimIAPS== "2900.1.jpg"]<- "2900.jpg1.jpg"

db_full4new_stim_screen_pupil_nopract$stimIAPS[db_full4new_stim_screen_pupil_nopract$stimIAPS== "2345.1.jpg"]<- "2345.jpg1.jpg"

unique(db_full4new_stim_screen_pupil_nopract$stimIAPS)
unique(db_full4new_stim_screen_pupil_nopract_backup$stimIAPS)

db_full4new_stim_screen_pupil_nopract$Label<- substr(db_full4new_stim_screen_pupil_nopract$stimIAPS, 1,8)
unique(db_full4new_stim_screen_pupil_nopract$Label)
table(is.na(db_full4new_stim_screen_pupil_nopract$stimIAPS))

table(is.na(db_full4new_stim_screen_pupil_nopract$Label))
unique(imageJ_IAPS$Label)

imageJ_IAPS_names<- colnames(imageJ_IAPS)
imageJ_IAPS_names<- imageJ_IAPS_names[3:14]
imageJ_IAPS_names
db_full4new_stim_screen_pupil_nopract
db_full4new_stim_screen_pupil_nopract_test <- dplyr::left_join(db_full4new_stim_screen_pupil_nopract, imageJ_IAPS, by = "Label")

table(is.na(db_full4new_stim_screen_pupil_nopract_test$Mean.y))

db_full4new_stim_screen_pupil_nopract<- db_full4new_stim_screen_pupil_nopract[,!(names(db_full4new_stim_screen_pupil_nopract) %in% imageJ_IAPS_names)]



db_full4new_stim_screen_pupil_nopract$Mean_gray_z<- NULL

# megre IAPS data

db_full4new_stim_screen_pupil_nopract <- left_join(db_full4new_stim_screen_pupil_nopract, imageJ_IAPS, by = "Label")

table(is.na(db_full4new_stim_screen_pupil_nopract$Mean))
# test<- subset(db_full4new_stim_screen_pupil_nopract, is.na(Mean))
nrow(db_full4new_stim_screen_pupil_nopract)
# rows = 2858

unique(db_full4new_stim_screen_pupil_nopract$ssid)

db_full4new_stim_screen_pupil_nopract$Mean_gray_z<- scale(db_full4new_stim_screen_pupil_nopract$Mean, center = TRUE, scale = TRUE)[,1]


db_full4new_stim_screen_pupil_nopract$ssid_num <- as.numeric(as.character(db_full4new_stim_screen_pupil_nopract$ssid))


```


lmer pupil

```{r}
db_full4new$screencontent_no
db_full4new %>%
  subset(screencontent_no ==4)%>%
  group_by(ssid)%>%
  summarise_if(is.numeric, mean,na.rm = TRUE)%>%
  ggplot(aes(TAS, fix_count))+
  geom_point()+
  geom_smooth(method = lm, se = F)+
  ggpubr::stat_cor()



db_full4new %>%
  subset(screencontent_no > 2)%>%
  group_by(ssid)%>%
  summarise_if(is.numeric, mean,na.rm = TRUE)%>%
  ggplot(aes(TAS, fix_count))+
  geom_point()+
  geom_smooth(method = lm, se = F)+
  ggpubr::stat_cor()

```


```{r}

options(contrasts = c("contr.sum","contr.poly"))
options(scipen = 999)

table(is.na(db_full4new_stim_screen_pupil_nopract$arousal))
table(is.na(db_full4new_stim_screen_pupil_nopract$ArousalMean))
table(is.na(db_full4new_stim_screen_pupil_nopract$Group))

db_full4new_stim_screen_pupil_nopract<- db_full4new_stim_screen_pupil_nopract%>%
  ungroup()%>%
  mutate(arousal_c = scale(arousal, center = TRUE, scale = TRUE)[,1],
         valence_c = scale(valence, center = TRUE, scale = TRUE)[,1])

pupil_arousal_findings$pupil_from_arousal <- lmer(pup_basCor ~ arousal_c*Mean_gray_z  +(1 +Mean_gray_z | ssid) + (0+arousal_c| ssid), REML = FALSE,
                      data = subset(db_full4new_stim_screen_pupil_nopract, 
                                    # pupil_outlier == FALSE & 
                                     Group == "NT"
                                    # arousal_outler == FALSE
                                    ))

summary(pupil_arousal_findings$pupil_from_arousal)
# singularity (drop arousal c slope)

# is there a correlation between mean arousal rating and meang, gray(

db_full4new_stim_screen_pupil_nopract%>%
  group_by(stimIAPS,ground_valence_lab) %>%
  summarise_at(c('arousal_c', 'Mean_gray_z'), mean, na.rm = TRUE)%>%
  ggplot(aes(arousal_c, Mean_gray_z, color = ground_valence_lab))+
  geom_point()+
  ggpubr::stat_cor()


db_full4new_stim_screen_pupil_nopract %>%
  subset(ssid_num<500)%>%
  group_by(ssid)%>%
  mutate(cor_ar_vl = cor(arousal, valence, use = "complete"))%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(ssid,cor_ar_vl))+
  geom_point()+
  geom_hline(yintercept = -.75)+
  geom_hline(yintercept = -.90)
  geom_histogram()

  db_full4new_stim_screen_pupil_nopract$screencontent
  
  table(is.na(  db_full4new_stim_screen_pupil_nopract$pup_basCor ))
  unique(  db_full4new_stim_screen_pupil_nopract$ssid)
  
  db_full4new_stim_screen_pupil_nopract %>%
    # subset(ssid_num < 343)%>%
  # subset(Group == "NT")%>%
  group_by(ssid)%>%
  mutate(cor_ar_pup = cor(arousal, pup_basCor, use = "complete"))%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(TAS,cor_ar_pup))+
  geom_point()+
    geom_smooth(method = lm, se = F)+
    ggpubr::stat_cor()
  geom_hline(yintercept = -.75)+
  geom_hline(yintercept = -.90)



```


# Valence and arousal - ridge
```{r}

db_full4new_stim_screen_pupil_nopract$ssid<- as.factor(as.character(db_full4new_stim_screen_pupil_nopract$ssid))


db_full4new_stim_screen_pupil_nopract$arousal_outler
db_full4new_stim_screen_pupil_nopract$pupil_outlier

# flag potential outliers

db_full4new_stim_screen_pupil_nopract<- db_full4new_stim_screen_pupil_nopract %>%
  group_by(stimIAPS) %>%
  mutate(arousal_outler = if_else(arousal > (median(arousal, na.rm = TRUE) + 
                                               (4*mad(arousal, na.rm = TRUE))), TRUE,
         if_else(arousal < (median(arousal, na.rm = TRUE) - 
                              (4*mad(arousal, na.rm = TRUE))), TRUE, FALSE)))%>%
  group_by(ssid)%>%
   mutate(pupil_outlier = if_else(pup_basCor > (median(pup_basCor, na.rm = TRUE) 
                                                + (3*mad(pup_basCor, na.rm = TRUE))), TRUE,
         if_else(pup_basCor < (median(pup_basCor, na.rm = TRUE) - 
                                 (3*mad(pup_basCor, na.rm = TRUE))), TRUE, FALSE)))


# fit pupil response froma rousal and valence

table(is.na(db_full4new_stim_screen_pupil_nopract$valence_c))
pupil_arousal_findings$pupil_from_ar_vale <- lmer(pup_basCor ~ (valence_c* arousal_c) +
                                                    Mean_gray_z  +
                                                    (1 + Mean_gray_z | ssid)+
                                                    (0+ valence_c | ssid),
                                                  REML = FALSE,
                      data = db_full4new_stim_screen_pupil_nopract%>%
                         subset(Group == "NT")%>%
                        subset(pupil_outlier == FALSE)%>%
                        subset(arousal_outler == FALSE))

# unique(db_full4new_stim_screen_pupil_nopract$tNo)
# 
# unique(db_full4new_stim_screen_pupil_nopract$ssid)

relgrad <- with(pupil_arousal_findings$pupil_from_ar_vale@optinfo$derivs,solve(Hessian,gradient))
max(abs(relgrad)) #0.0002044252

summary(pupil_arousal_findings$pupil_from_ar_vale)
plot(pupil_arousal_findings$pupil_from_ar_vale)

car::vif(pupil_arousal_findings$pupil_from_ar_vale) #curoff 4
# valence_c           arousal_c         Mean_gray_z valence_c:arousal_c 
#            1.876902            1.801054            1.004734            1.080785

plots_paper$interaction_ar_vl <- interactions::interact_plot(pupil_arousal_findings$pupil_from_ar_vale , pred = arousal_c, modx = valence_c)

plots_paper$interaction_ar_vl 
interactions::interact_plot(pupil_arousal_findings$pupil_from_ar_val_gaze , pred = valence_c , modx = arousal_c)




# export model table
library(MuMIn)
library(sjmisc)
sjPlot::tab_model(pupil_arousal_findings$pupil_from_ar_vale)



```


```{r eval=FALSE, include=FALSE}
# lassomodels$firt

ridgemodels<-list()

# ridge
unique(db_new$exp)
# "3b" "3b"
db_full4new_stim_screen_pupil_nopract
unique(db_new$exp)

db_new_exp3b<- subset(db_full4new_stim_screen_pupil_nopract, 
                                     ssid_num< 500)

pp_id_3b<- unique(db_new_exp3b$ssid)

db_new_exp3b$ar_x_val<- db_new_exp3b$arousal_c* db_new_exp3b$valence_c

db_new_exp3b_1 <- select(db_new_exp3b, c(ssid, arousal_c, valence_c, ar_x_val, Mean_gray_z,pup_basCor))
i = 10
?glmnet::cv.glmnet
set.seed(808)

cv_fits_3b<- list(list())
cv_fits<-list(list())
library(glmnet)

for (i in pp_id_3b) {
  temp_3b <- subset(db_new_exp3b_1, ssid == 304)
  # cv_fits <- list(i)
  cv_fits_3b[[i]]<- list(cv.glmnet(as.matrix(temp_3b[,2:5]),temp_3b$pup_basCor, 
                                alpha = 0, nfolds = 8))
  
  cv_fits[[i]]<- list(glmnet(as.matrix(temp_3b[,2:5]),temp_3b$pup_basCor,
                             family = "gaussian",
                             alpha = 0, lambda = cv_fits_3b[[i]][[1]]$lambda.min))
  }

coef(cv_fits_3b[[i]][[1]], s = cv_fits_3b[[i]][[1]]$lambda.min)

coef(cv_fits[[i]][[1]], s = cv_fits[[i]][[1]]$lambda)
# 5 x 1 sparse Matrix of class "dgCMatrix"
#                       1
# (Intercept)  0.57036534
# arousal_c    0.34759064
# valence_c    0.34825059
# ar_x_val    -0.03044521
# Mean_gray_z -0.22724284

my_vector_ar<- vector(mode="numeric")
i

plot(cv_fits[["306"]][[1]])

plot(cv_fits[[2]][[1]])
plot(cv_fits[[2]][[1]],xvar="lambda",label=TRUE)
fit3=glmnet(x,g4,family="multinomial")
plot(cv_fits[[2]][[1]],pch=19)

View(my_vectors)
for (i in pp_id_3b) {
my_vector_ar[i]<- coef(cv_fits[[i]][[1]], s = cv_fits[[i]][[1]]$lambda)[2] # 3 is gender sd
}

my_vector_vl<- vector(mode="numeric")
# non gender sd
for (i in pp_id_3b) {
my_vector_vl[i]<- coef(cv_fits[[i]][[1]], s = cv_fits[[i]][[1]]$lambda)[3] 
}

# status
my_vector_ar_vl<- vector(mode="numeric")

for (i in pp_id_3b) {
my_vector_ar_vl[i]<- coef(cv_fits[[i]][[1]], s = cv_fits[[i]][[1]]$lambda)[4] 
}

# physical
my_vector_gray<- vector(mode="numeric")

for (i in pp_id_3b) {
my_vector_gray[i]<- coef(cv_fits[[i]][[1]], s = cv_fits[[i]][[1]]$lambda)[5] 
}



t.test(my_vector_ar)
# t = 41.071, df = 42, p-value < 0.00000000000000022
t.test(my_vector_vl)
# t = 34.501, df = 42, p-value < 0.00000000000000022

t.test(my_vector_ar_vl)
# t = -16.486, df = 42, p-value < 0.00000000000000022

t.test(my_vector_gray)
# t = -62.057, df = 42, p-value < 0.00000000000000022
```


same analyses as above but regress brightness out of pupil

```{r}

pupil_arousal_findings$pupil_from_brightness <- lmer(pup_basCor ~ 
                                                    Mean_gray_z  +
                                                    (1  | ssid),
                                                    # (0+ valence_c* arousal_c | ssid),
                                                  REML = FALSE,
                      data = subset(db_full4new_stim_screen_pupil_nopract, 
                                    # pupil_outlier == FALSE & ssid_num< 500 & 
                                      # arousal_outler == FALSE
                                    ))

pupil_arousal_findings$pupil_from_brightness_lm <- lm(pup_basCor ~ 
                                                    Mean,
                                                    
                      data = db_full4new_stim_screen_pupil_nopract, na.action=na.exclude) 


summary(pupil_arousal_findings$pupil_from_brightness)

plot(pupil_arousal_findings$pupil_from_brightness)

# store residuals
db_full4new_stim_screen_pupil_nopract$pup_resid <- resid(pupil_arousal_findings$pupil_from_brightness)
?resid
db_full4new_stim_screen_pupil_nopract$pup_resid_lm <- resid(pupil_arousal_findings$pupil_from_brightness_lm,
                                                            na.action=na.exclude)


db_full4new_stim_screen_pupil_nopract%>%
  ggplot(aes(pup_resid, Mean_gray_z))+
  geom_point()+
  geom_smooth(method = 'lm', se = F)+
  ggpubr::stat_cor()

# no correlated with IV - good


db_full4new_stim_screen_pupil_nopract%>%
  ggplot(aes(pup_resid, pup_basCor))+
  geom_point()+
  geom_smooth(method = 'lm', se = F)+
  ggpubr::stat_cor()

# strong correlation, in this case this is good, because it means there is a large amount of unexplained variance not acconted for by the predictor


# predict pupil residuals
pupil_arousal_findings$pupil_resid_from_ar_vale <- lmer(pup_resid_lm ~ (arousal_c*valence_c) +
                                                    
                                                    (1+arousal_c*valence_c  | ssid),
                                                    # (0+ valence_c* arousal_c | ssid),
                                                  REML = FALSE,
                      data = subset(db_full4new_stim_screen_pupil_nopract, 
                                    pupil_outlier == FALSE &
                                    ssid_num< 500 
                                    &
                                      arousal_outler == FALSE
                                      )) # results hold with or withouth outliers 


summary(pupil_arousal_findings$pupil_resid_from_ar_vale)

# using residuals from lmer create a singularity as they eliminate individual participants variability, this is solved by using residuals from lm

plots_paper<- list()
plots_paper$interaction_ar_vl <- interactions::interact_plot(pupil_arousal_findings$pupil_from_ar_vale, pred = arousal_c, modx = valence_c)

interactions::interact_plot(pupil_arousal_findings$pupil_resid_from_ar_vale , pred = valence_c , modx = arousal_c)

plots_paper$interaction_ar_vl+p$graphstyle

plots_paper$interaction_ar_vl


db_full4new_stim_screen_pupil_nopract_nt<- subset(db_full4new_stim_screen_pupil_nopract, Group == "NT")

db_full4new_stim_screen_pupil_nopract_nt%>%
  group_by(stimIAPS)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(arousal_c, valence_c))+
  geom_point()+
  ggpubr::stat_cor()

cor.test(db_full4new_stim_screen_pupil_nopract_nt$valence, db_full4new_stim_screen_pupil_nopract_nt$arousal_c)
car::scatter3d(db_full4new_stim_screen_pupil_nopract_nt$arousal_c, 
          db_full4new_stim_screen_pupil_nopract_nt$pup_basCor, 
          db_full4new_stim_screen_pupil_nopract_nt$valence_c,
          fit = "smooth"
          # point = FALSE,
          
          # surface = FALSE,
          # point.col = ""
          )
```


quick check of TAS

```{r}

db_full4new_stim_screen_pupil_nopract$TASc<- scale(db_full4new_stim_screen_pupil_nopract$TAS, center = TRUE, scale = TRUE)[,1]

db_full4new_stim_screen_pupil_nopract<- db_full4new_stim_screen_pupil_nopract%>%
  ungroup()%>%
  mutate(arousal_c = scale(arousal, center = TRUE, scale = TRUE)[,1],
         valence_c = scale(valence, center = TRUE, scale = TRUE)[,1])


pupil_arousal_findings$pupil_from_ar_vale_TAS <- lmer(pup_basCor ~ (valence_c* arousal_c)*TASc +
                                                    Mean_gray_z  +
                                                    (1 + Mean_gray_z | ssid)+
                                                    (0+ arousal_c | ssid),
                                                  REML = FALSE,
                      data = db_full4new_stim_screen_pupil_nopract%>%
                         subset(Group == "NT"))
                        subset(pupil_outlier == FALSE)%>%
                        subset(arousal_outler == FALSE))

summary(pupil_arousal_findings$pupil_from_ar_vale_TAS)

interactions::interact_plot(pupil_arousal_findings$pupil_from_ar_vale_TAS, pred = TASc, modx = arousal_c)
interactions::interact_plot(pupil_arousal_findings$pupil_from_ar_vale_TAS, pred = TASc, modx = arousal_c, mod2= valence_c)


```

interaction plot

```{r}
sf = 1 # scaling factor to make it easier to change sizes of everything, in which case change here

p$graphstyle_int <-  theme(#base plot theme
  
  # axis lines
  axis.line.y = element_line(color="black", size = 1.5),
  axis.line.x = element_line(color="black", size = 1,5),
  
  axis.title.y=element_text(size = 16*(sf+.5), margin=margin(0,5,0,0)),
  axis.title.x=element_text(size = 16*(sf+.5), margin=margin(0,5,0,0)),
  
  # text
  strip.text.x = element_text(size = 12*(sf+.5),  colour = "black"),
  strip.text.y = element_text(size = 12*(sf+.5),  colour = "black"),
  
  text=element_text(size = 14, family = "sans"),
  axis.text.x = element_text(size = 14*(sf+.5), family = "sans", colour = "black",),
  axis.text.y = element_text(size = 14*(sf+.5), family = "sans", colour = "black"),
  
  
  # panel
  panel.grid.major = element_blank(),
  panel.background = element_blank(),
  # panel.background = element_rect(fill="transparent"),
  # panel.border = element_rect(fill="transparent"),
  # strip shades (reco rectagles)
   # strip.background = element_blank(),
  
  # legend
  legend.position = "top",
  legend.key = element_rect(colour = "transparent", fill="transparent"),
  #legend.direction = "horizontal",

  legend.text = element_text(size = 10*(sf+.3)),
  # legend.title = element_text(size = 10*(sf+.3)),
  # legend line tends to be really small in print so adjust here
  legend.key.height = unit(.5, "cm"),
  legend.key.width = unit(2, "cm"),
  
  #legend.text = element_text(size = 10*sf),
  # legend.title=element_blank(),
  #legend.text = element_blank(),
  #axis.ticks = element_blank(),
)


plots_paper$interaction_ar_vl<- plots_paper$interaction_ar_vl +
  theme_classic()+
  p$graphstyle_int+
  xlab("Arousal (z)")+
  ylab("Pupil change (z)")+
  scale_y_continuous(breaks = c(-1,0,1))

plots_paper$interaction_ar_vl<- plots_paper$interaction_ar_vl+   scale_y_continuous(breaks = c(-2,-1,0,1), limits = c(-2,1))

 plots_paper$interaction_ar_vl +
   theme_classic()+
   p$graphstyle_int
   


plots_paper[["interaction_ar_vl"]][["data"]]%>%
  ggplot(aes(arousal_c, pup_basCor, linetype = modx_group))+
  stat_summary(aes(color = valence_c), geom = 'line', size = 2)+
  p$graphstyle_int
```




Predict arousal from pupil


```{r}
# with arousal as DV
pupil_arousal_findings$arousal_from_pup <- lmer(arousal ~ valence_c*pup_basCor  + 
                                                  (1| stimIAPS)+
                                                 # (1 | stimIAPS)+
                                                  (1  | ssid),
                                                REML = FALSE,
                      data = db_full4new_stim_screen_pupil_nopract%>%
                         subset(Group == "NT")%>%
                        subset(pupil_outlier == FALSE)%>%
                        subset(arousal_outler == FALSE))
summary(pupil_arousal_findings$arousal_from_pup)

anova(pupil_arousal_findings$arousal_from_pup)

# expected correlation between valence and pupil is low



interactions::interact_plot(pupil_arousal_findings$arousal_from_pup , pred = valence_c, modx = pup_basCor)

interactions::interact_plot(pupil_arousal_findings$arousal_from_pup, pred =pup_basCor , modx =  valence_c) #better 
# same pattern
# pupil is more aligned with subjective arousal in the more positive trials



# flip dv to valence

pupil_arousal_findings$valence_from_pup <- lmer(valence ~ arousal_c*pup_basCor  + (1| stimIAPS)+
                                                 # (1 | ssid),
                                                  (0 +arousal_c | ssid),
                                                REML = FALSE,
                      data = subset(db_full4new_stim_screen_pupil_nopract, 
                                    Group == "NT"))
summary(pupil_arousal_findings$valence_from_pup)
anova(pupil_arousal_findings$valence_from_pup)

# so it's not the case that pupil is tracking valence
# it's the case that arousal pupil relation is modulated by valence, and this is true regardless of whether we use a maximal or minimal model

interactions::interact_plot(pupil_arousal_findings$valence_from_pup , pred = valence_c, modx = pup_basCor)

interactions::interact_plot(pupil_arousal_findings$valence_from_pup, pred =pup_basCor , modx =  arousal_c)



```


Timecourse analyses

# prepare timecourse data
```{r prepare timecourse data}
rm(justone_test, lucy_plots, test)

nrow(tmp.df4_full_stim_downs_jun2021)

# import the timecourse

nrow(tmp.df4_full_stim_downs_jun2021)
tmp.df4_full_stim_downs_jun2021 <- readRDS("~/OneDrive - Nexus365/InteroStudy2020/analysis/DataAnalysisJanuary2020/DataAnalysisJan2020/tmp.df4_full_stim_downs_jun2021.rds")


unique(tmp.df4_full_stim_downs_jun2021$timebin)
# new folks 
library(readr)

tmp_df4_timeseries_345_356 <- read_csv("tmp.df4_timeseries_345_356.csv")
View(tmp_df4_timeseries_345_356)

colnames(tmp.df4_full_stim_downs_jun2021)
colnames(tmp_df4_timeseries_345_356)
# downsample to 60 bins


# create bins
# install.packages("OneR")
# install.packages("OneR")
library(OneR)

?bin
unique(tmp_df4_timeseries_345_356$screencontent)
tmp_df4_timeseries_345_356_stim <- subset(tmp_df4_timeseries_345_356, tmp_df4_timeseries_345_356$screencontent == "stim")

tmp_df4_timeseries_345_356_stim$timebin <- OneR::bin(tmp_df4_timeseries_345_356_stim$timerezero3, nbin = 60)



# dowsample by averaging?
colnames(tmp_df4_timeseries_345_356_stim)


tmp_df4_timeseries_345_356_stim_downs <- tmp_df4_timeseries_345_356_stim %>%
  group_by(ssid, tNo, timebin, trial,trialUnq)%>%
  summarise_at(c('timerezero3','pup_basCor', 'gaze_x_cor_pix', 'gaze_y_cor_pix'), 
               mean, na.rm = TRUE)

?saveRDS
saveRDS(tmp_df4_timeseries_345_356_stim_downs, "tmp_df4_timeseries_345_356_stim_downs.rds")


# merge pupil series with behavioural data
colnames(db_full4new_stim_screen_pupil_nopract)
cname_db_full4new_stim_subset<- colnames(db_full4new_stim_subset)

db_full4new_stim_subset_backup<-db_full4new_stim_subset

# db_full4new_stim_subset<- db_full4new_stim_screen_pupil_nopract[,c(1:4,6:7,12:13,16,21:27, 31:56,80:81,84:96,98:114,116:124)]
db_full4new_stim_subset<- db_full4new_stim_screen_pupil_nopract[,c(cname_db_full4new_stim_subset)]

View(db_full4new_stim_subset)

```

# match types of merging variables (this is 30-hz)

```{r}

unique(tmp.df4_full_stim_downs_jun2021_with_beh2$timebin2)


unique(tmp.df4_full_stim_downs_jun2021_with_behnew$timebin2)
tmp.df4_full_stim_downs_jun2021_with_beh2$ssid<- as.character(tmp.df4_full_stim_downs_jun2021_with_beh2$ssid)
db_full4new_stim_subset$ssid<- as.character(db_full4new_stim_subset$ssid)

# tNo
tmp.df4_full_stim_downs_jun2021_with_beh2$tNo <- as.character(tmp.df4_full_stim_downs_jun2021_with_beh2$tNo)

db_full4new_stim_subset$tNo <- as.character(db_full4new_stim_subset$tNo)
# unique(db_full4new_stim_subset$tNo)
# unique(tmp.df4_full_stim_downs_jun2021_with_beh2$tNo)

# merge
nrow(tmp.df4_full_stim_downs_jun2021_with_beh2)
# 87529

table(is.na(db_full4new_stim_subset$mediansplit_self_valence))

tmp.df4_full_stim_downs_jun2021_with_beh2$tNo<- as.numeric(tmp.df4_full_stim_downs_jun2021_with_beh2$tNo)

tmp.df4_full_stim_downs_jun2021_with_beh2<- tmp.df4_full_stim_downs_jun2021_with_beh2%>%
  arrange(ssid,tNo, timerezero3)

tmp.df4_full_stim_downs_jun2021_with_beh <- left_join(tmp.df4_full_stim_downs_jun2021_with_beh2, db_full4new_stim_subset)


```


# higher sample dataset

```{r}
library(ggplot2)
library(tidyverse)
install.packages("gazer")
library(gazer)

# temp backup

tmp.df4_full_stim_downs_jun2021
tmp.df4_full_stim_downs_jun2021_backup<- tmp.df4_full_stim_downs_jun2021

unique(tmp.df4_full_stim_downs_jun2021$timebin)

tmp_df4_timeseries_345_356_stim_downs_backup<- tmp_df4_timeseries_345_356_stim_downs

tmp_df4_timeseries_345_356_stim_downs$ssid<- as.character(tmp_df4_timeseries_345_356_stim_downs$ssid)

tmp_df4_timeseries_345_356_stim_downs$tNo<- as.character(tmp_df4_timeseries_345_356_stim_downs$tNo)

unique(tmp.df4_full_stim_downs_jun2021$timebin)
unique(tmp_df4_timeseries_345_356_stim_downs$timebin)

tmp.df4_full_stim_downs_jun2021$ssid<- as.character(tmp.df4_full_stim_downs_jun2021$ssid)
tmp.df4_full_stim_downs_jun2021$tNo<- as.character(tmp.df4_full_stim_downs_jun2021$tNo)
# bind old and new data
# nrow(tmp.df4_full_stim_downs_jun2021)+ nrow(tmp_df4_timeseries_345_356_stim_downs) = 205703

tmp.df4_full_stim_downs_jun2021$tNo<- as.character(tmp.df4_full_stim_downs_jun2021$tNo)

tmp.df4_full_stim_downs_jun2021 <- bind_rows(tmp.df4_full_stim_downs_jun2021,tmp_df4_timeseries_345_356_stim_downs)

# tmp.df4_full_stim_downs_jun2021
table(is.na(tmp_df4_timeseries_345_356_stim_downs$pup_basCor))
# 355
table(is.na(tmp.df4_full_stim_downs_jun2021$pup_basCor))




# backup[]
tmp.df4_full_stim_downs_jun2021_60bins_backup2<- tmp.df4_full_stim_downs_jun2021_60bins

unique(db_full4new_stim_subset$ssid)


unique(tmp.df4_full_stim_downs_jun2021$ssid)
unique(db_full4new_stim_subset$ssid)

unique(tmp.df4_full_stim_downs_jun2021$tNo)
unique(db_full4new_stim_subset$tNo)

unique(tmp.df4_full_stim_downs_jun2021$trial)
unique(db_full4new_stim_subset$trial)


tmp.df4_full_stim_downs_jun2021_60bins 


table(is.na(db_full4new_stim_subset$arousal))



db_full4new_stim_subset
db_full4new_stim_subset$tNo<- as.character(db_full4new_stim_subset$tNo)


# try see if arranging things solve the issue
tmp.df4_full_stim_downs_jun2021<- tmp.df4_full_stim_downs_jun2021%>%
  arrange(ssid, tNo, timerezero3)

db_full4new_stim_subset<- db_full4new_stim_subset%>%
  arrange(ssid, tNo)

db_full4new_stim_subset_valis<- subset( db_full4new_stim_subset, gaze_valid_prop>.80)

tmp.df4_full_stim_downs_jun2021_.1 <- left_join(tmp.df4_full_stim_downs_jun2021, db_full4new_stim_subset$gaze_valid_prop, by = c("ssid", "tNo", "trial"))


table(is.na(db_full4new_stim_subset_valis$gaze_valid_prop))
tmp.df4_full_stim_downs_jun2021_.1 <- left_join(db_full4new_stim_subset_valis,tmp.df4_full_stim_downs_jun2021,  by = c("ssid", "tNo", "trial"))

table(is.na(tmp.df4_full_stim_downs_jun2021_.1$arousal))
nrow(tmp.df4_full_stim_downs_jun2021_.1)
nrow(tmp.df4_full_stim_downs_jun2021)

nrow(db_full4new_stim_subset)
nrow(test)
nrow(tmp.df4_full_stim_downs_jun2021_60bins)
unique(tmp.df4_full_stim_downs_jun2021_60bins$timebin_no)


View(db_full4new_stim_subset)
table(is.na(db_full4new_stim_subset$arousal))
table(is.na(tmp.df4_full_stim_downs_jun2021_60bins$arousal))

table(is.na(test$arousal))
table(is.na(test$arousal))


test1<- subset(test, is.na(arousal))

test2<- subset(test, !is.na(arousal))
table(test2$ssid)

# create a dataframe version where we downsample to60 and not to 30

tmp.df4_full_stim_downs_jun2021_.1$Label<- substr(tmp.df4_full_stim_downs_jun2021_.1$stimIAPS, 1,8)

tmp.df4_full_stim_downs_jun2021_.1$Label2<- substr(tmp.df4_full_stim_downs_jun2021_.1$stimIAPS, 1,4)
imageJ_IAPS$Label2<- substr(imageJ_IAPS$Label, 1,4)

unique(imageJ_IAPS$Label2)
unique(tmp.df4_full_stim_downs_jun2021_.1$Label2)

# backup
tmp.df4_full_stim_downs_jun2021_60bins_backup<- tmp.df4_full_stim_downs_jun2021_.1

tmp.df4_full_stim_downs_jun2021_60bins<- left_join(tmp.df4_full_stim_downs_jun2021_.1, imageJ_IAPS, by = "Label2")


tmp.df4_full_stim_downs_jun2021_60bins$Mean_gray_z<- scale(tmp.df4_full_stim_downs_jun2021_60bins$Mean, center = TRUE, scale = TRUE)[,1]


nrow(tmp.df4_full_stim_downs_jun2021_60bins)
# 172168 good+
# 205703 (with new)

table(is.na(tmp.df4_full_stim_downs_jun2021_60bins$valence))
table(is.na(tmp.df4_full_stim_downs_jun2021_60bins$pup_basCor))

as.factor(tmp.df4_full_stim_downs_jun2021_60bins$timebin)
```


Quick check that things make sense
30 s timebins
```{r eval=FALSE, include=FALSE}
unique(tmp.df4_full_stim_downs_jun2021_with_beh$timebin2)
# group_by(stimIAPS)%>%


tmp.df4_full_stim_downs_jun2021_with_beh<- tmp.df4_full_stim_downs_jun2021_with_beh %>%
  ungroup()%>%
  mutate(mediansplit_sample_valence2 = 
           if_else(ValenceMeanThisSample >= 
                     median(ValenceMeanThisSample,
                            na.rm = TRUE), 
                   "More positive", "More negative"))%>%
  mutate(mediansplit_sample_arousal2 = if_else(ArousalMeanThisSample >=
                                                  median(ArousalMeanThisSample,
                                                         na.rm = TRUE), "High", "Low"))



# higher sample rate

tmp.df4_full_stim_downs_jun2021_60bins$mediansplit_sample_valence2

tmp.df4_full_stim_downs_jun2021_60bins<- tmp.df4_full_stim_downs_jun2021_60bins %>%
  ungroup()%>%
  mutate(mediansplit_sample_valence2 = 
           if_else(ValenceMeanThisSample > 
                     median(ValenceMeanThisSample,
                            na.rm = TRUE), 
                   "More positive", "More negative"))%>%
  mutate(mediansplit_sample_arousal2 = if_else(ArousalMeanThisSample >
                                                  median(ArousalMeanThisSample,
                                                         na.rm = TRUE), "High", "Low"))




tmp.df4_full_stim_downs_jun2021_with_beh %>%
  subset(!is.na(ground_arousal_lab))%>%
  ggplot(aes(x = timerezero3, y = pup_basCor))+
  stat_smooth(aes(group= ground_arousal_lab, color = ground_arousal_lab), fun = mean,geom = "line",
               se = F, alpha = .1, size = 1.5)+
  stat_smooth(aes(group=ground_arousal_lab, color = ground_arousal_lab), size = 3)+  
theme_classic()+
  ylab("Pupil size (z)")+
  xlab("Time (s)")+
  # p$graphstyle+
  scale_color_brewer(palette = "Dark2")+
  xlim(0,6)+
   facet_grid(~mediansplit_self_valence)


```



60 bins
```{r}


tmp.df4_full_stim_downs_jun2021_60bins<- tmp.df4_full_stim_downs_jun2021_60bins%>%
  ungroup()%>%
  mutate(mediansplit_ground_valence = if_else(ValenceMean >=
                                                  median(ValenceMean,
                                                         na.rm = TRUE), "More positive", "More negative"))%>%
  mutate(mediansplit_ground_arousal = if_else(ArousalMean >=
                                                  median(ArousalMean,
                                                         na.rm = TRUE), "High", "Low"))%>%
    mutate(mediansplit_sample_valence2 = if_else(arousal >=
                                                  median(arousal,
                                                         na.rm = TRUE), "More positive", "More negative"))%>%
  mutate(mediansplit_sample_arousal2 = if_else(valence >=
                                                  median(valence,
                                                         na.rm = TRUE), "High", "Low"))

table(is.na(tmp.df4_full_stim_downs_jun2021_60bins$timebin))
ground_arousal_lab


tmp.df4_full_stim_downs_jun2021_60bins %>%
  subset(!is.na(ground_arousal_lab))%>%
  ggplot(aes(x = timerezero3, y = pup_basCor))+
  stat_smooth(aes(group= mediansplit_ground_arousal, color = mediansplit_ground_arousal), fun = mean,geom = "line",
               se = F, alpha = .1, size = 1.5)+
  stat_smooth(aes(group=mediansplit_ground_arousal, color = mediansplit_ground_arousal), size = 3)+  
theme_classic()+
  ylab("Pupil size (z)")+
  xlab("Time (s)")+
  # p$graphstyle+
  scale_color_brewer(palette = "Dark2")+
  xlim(0,6)+
   facet_grid(~mediansplit_ground_valence)


table(is.na(tmp.df4_full_stim_downs_jun2021_60bins$mediansplit_sample_arousal2))

mediansplit_sample_arousal2

table(is.na(tmp.df4_full_stim_downs_jun2021_60bins$Group))

tmp.df4_full_stim_downs_jun2021_60bins %>%
  subset(Group == "NT")%>%
  # subset(!is.na(mediansplit_sample_arousal2))%>%
  ggplot(aes(x = timerezero3, y = pup_basCor))+
  stat_smooth(aes(group= mediansplit_sample_arousal2, color = mediansplit_sample_arousal2), fun = mean,geom = "line",
               se = F, alpha = .1, size = 1.5)+
  stat_smooth(aes(group=mediansplit_sample_arousal2, color = mediansplit_sample_arousal2), size = 3)+  
theme_classic()+
  ylab("Pupil size (z)")+
  xlab("Time (s)")+
  # p$graphstyle+
  scale_color_brewer(palette = "Dark2")+
  xlim(0,6)+
   facet_grid(~mediansplit_sample_valence2)

```

```{r}

tmp.df4_full_stim_downs_jun2021_60bins %>%
  subset(!is.na(ground_arousal_lab))%>%
  ggplot(aes(x = timerezero3, y = pup_basCor))+
  stat_smooth(aes(group= mediansplit_sample_arousal2, color = mediansplit_sample_arousal2), fun = mean,geom = "line",
               se = F, alpha = .1, size = 1.5)+
  stat_smooth(aes(group=mediansplit_sample_arousal2, color = mediansplit_sample_arousal2), size = 3)+  
theme_classic()+
  ylab("Pupil size (z)")+
  xlab("Time (s)")+
  # p$graphstyle+
  scale_color_brewer(palette = "Dark2")+
  xlim(0,6)+
   facet_grid(~mediansplit_sample_valence2)



tmp.df4_full_stim_downs_jun2021_60bins %>%
  subset(!is.na(ground_arousal_lab))%>%
  ggplot(aes(x = timerezero3, y = pup_basCor))+
  stat_smooth(aes(group= mediansplit_sample_valence2, color = mediansplit_sample_valence2), fun = mean,geom = "line",
               se = F, alpha = .1, size = 1.5)+
  stat_smooth(aes(group=, color = mediansplit_sample_valence2), size = 3)+  
theme_classic()+
  ylab("Pupil size (z)")+
  xlab("Time (s)")+
  # p$graphstyle+
  scale_color_brewer(palette = "Dark2")+
  xlim(0,6)+
   facet_grid(~ mediansplit_sample_arousal2)


# what causes 
tmp.df4_full_stim_downs_jun2021_60bins %>%
  subset(!is.na(ground_arousal_lab))%>%
  ggplot(aes(x = timerezero3, y = pup_basCor))+
  stat_smooth(aes(group= mediansplit_sample_valence2, color = mediansplit_sample_valence2), fun = mean,geom = "line",
               se = F, alpha = .1, size = 1.5)+
  stat_smooth(aes(group=, color = mediansplit_sample_valence2), size = 3)+  
theme_classic()+
  ylab("Pupil size (z)")+
  xlab("Time (s)")+
  # p$graphstyle+
  scale_color_brewer(palette = "Dark2")+
  xlim(0,6)
   facet_grid(~ mediansplit_sample_arousal2)
   
   
   tmp.df4_full_stim_downs_jun2021_60bins %>%
  subset(!is.na(ground_arousal_lab))%>%
  ggplot(aes(x = timerezero3, y = pup_basCor))+
  stat_smooth(aes(color = mediansplit_sample_arousal2), fun = mean,geom = "line",
               se = F, alpha = .1, size = 1.5)+
  stat_smooth(aes(group=stimIAPS, color = mediansplit_sample_arousal2), size = .6, se = F)+
theme_classic()+
  ylab("Pupil size (z)")+
  xlab("Time (s)")+
     # geom_text(aes(label = ssid))+
  # p$graphstyle+
  scale_color_brewer(palette = "Dark2")+
  xlim(0,6)+
     geom_text(aes(label = stimIAPS))
   facet_grid(~ mediansplit_sample_valence2)
   
tmp.df4_full_stim_downs_jun2021_60bins %>%
  subset(!is.na(ground_arousal_lab))%>%
  ggplot(aes(x = timerezero3, y = pup_basCor))+
  # stat_smooth(aes(color = mediansplit_ground_arousal), fun = mean,geom = "line",
  #              se = F, alpha = .1, size = 1.5)+
  stat_smooth(aes(group=stimIAPS, color = ground_arousal_lab), size = .6, se = F)+
theme_classic()+
  ylab("Pupil size (z)")+
  xlab("Time (s)")+
     # geom_text(aes(label = ssid))+
  # p$graphstyle+
  scale_color_brewer(palette = "Dark2")+
  xlim(0,6)+
     # geom_text(aes(label = stimIAPS))+
   facet_grid(~ ground_valence_lab)



```

check baselining onto specific valences
```{r Scrap this}

# - use IAPS data to split valence - positive negative
# - within that - compute arousal low mid high within each valence both for the iaps data and my study
# do this on a participant basis or sampleÇ? try sample first
tmp.df4_full_stim_downs_jun2021_60bins %>%
  ungroup()%>%
  group_by(ground_valence_lab)%>%
  mutate(ArousalMean_z_by_val = scale(ArousalMean, center = TRUE, scale = TRUE)[,1])%>%
   mutate(Arousal_z_by_val = scale(arousal, center = TRUE, scale = TRUE)[,1])%>%
  group_by(stimIAPS,ground_valence_lab)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  # ggplot(aes(ground_valence_lab, ArousalMean_z_by_val ))+
  ggplot(aes(ground_valence_lab, Arousal_z_by_val ))+
  # geom_point()+
  stat_summary(geom = 'pointrange')

# hpw does this relate to the original ratigs

# do this on a participant basis or sampleÇ? try sample first
tmp.df4_full_stim_downs_jun2021_60bins %>%
  ungroup()%>%
  group_by(ground_valence_lab)%>%
  mutate(ArousalMean_z_by_val = scale(ArousalMean, center = TRUE, scale = TRUE)[,1])%>%
   mutate(Arousal_z_by_val = scale(arousal, center = TRUE, scale = TRUE)[,1])%>%
  # group_by(stimIAPS,ground_valence_lab)%>%
  # summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  # ggplot(aes(ground_valence_lab, ArousalMean_z_by_val ))+
  ggplot(aes(ValenceMean, ArousalMean_z_by_val ))+
  geom_point()+
  geom_smooth(method = 'lm', se = F)+
  # geom_smooth(aes(group = ground_valence_lab), method = 'lm', se = F)
  # stat_summary(geom = 'pointrange')+
      ggpubr::stat_cor()


tmp.df4_full_stim_downs_jun2021_60bins %>%
  ungroup()%>%
  group_by(ground_valence_lab)%>%
  mutate(ArousalMean_z_by_val = scale(ArousalMean, center = TRUE, scale = TRUE)[,1])%>%
   mutate(Arousal_z_by_val = scale(arousal, center = TRUE, scale = TRUE)[,1])%>%
  group_by(stimIAPS,ground_valence_lab)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  # ggplot(aes(ground_valence_lab, ArousalMean_z_by_val ))+
  ggplot(aes(Arousal_z_by_val, valence_c))+
  geom_point()+
  geom_smooth(method = 'lm', se = F)+
  # geom_smooth(aes(group = ground_valence_lab), method = 'lm', se = F)
  # stat_summary(geom = 'pointrange')+
      ggpubr::stat_cor()




?cut
tmp.df4_full_stim_downs_jun2021_60bins$valence_self<- cut(tmp.df4_full_stim_downs_jun2021_60bins$valence, 3,
                                                          labels = c("Negative", "Neutral", "Positive"))


tmp.df4_full_stim_downs_jun2021_60bins %>%
  ungroup()%>%
  group_by(ground_valence_lab)%>%
  # mutate(ArousalMean_z_by_val = scale(ArousalMean, center = TRUE, scale = TRUE)[,1])%>%
   mutate(Arousal_z_by_val = scale(arousal, center = TRUE, scale = TRUE)[,1])%>%
  group_by(stimIAPS,ground_valence_lab)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  # ggplot(aes(ground_valence_lab, ArousalMean_z_by_val ))+
  ggplot(aes(ground_valence_lab, Arousal_z_by_val))+
  geom_point()+
  # geom_smooth(aes(group = ground_valence_lab), method = 'lm', se = F)
  stat_summary(geom = 'pointrange')+
      ggpubr::stat_cor()

  
  # mean center within neutral positive, neutral negative


tmp.df4_full_stim_downs_jun2021_60bins$neutral_pos<- if_else(tmp.df4_full_stim_downs_jun2021_60bins$ground_valence_lab!= "More negative", TRUE, FALSE)

tmp.df4_full_stim_downs_jun2021_60bins$neutral_neg <- if_else(tmp.df4_full_stim_downs_jun2021_60bins$ground_valence_lab!= "More positive", TRUE, FALSE)

tmp.df4_full_stim_downs_jun2021_60bins <- tmp.df4_full_stim_downs_jun2021_60bins%>%
  group_by(neutral_pos)%>%
  mutate(neutral_pos_mean_arousal = mean(ArousalMean, na.rm = TRUE),
                                         neutral_pos_sd_arousal = sd(ArousalMean, na.rm = TRUE))%>%
  mutate(neutral_pos_mean_arousal_self = mean(arousal, na.rm = TRUE),
         neutral_pos_sd_arousal_self = sd(arousal, na.rm = TRUE))%>%
  group_by(neutral_neg)%>%
  
  mutate(neutral_neg_mean_arousal = mean(ArousalMean, na.rm = TRUE),
                                         neutral_neg_sd_arousal = sd(ArousalMean, na.rm = TRUE)) %>%
  mutate(neutral_neg_mean_arousal_self = mean(arousal, na.rm = TRUE),
         neutral_neg_sd_arousal_self = sd(arousal, na.rm = TRUE))
  
# group_by()

# replace the values when neutral_pos and neutral_neg is FALSE respectivelly
# library(dplyr)
# check how many nas do we have before we start
table(is.na(tmp.df4_full_stim_downs_jun2021_60bins$neutral_neg_mean_arousal))
 # FALSE   TRUE 
# 158193  13975 


# compute new variables where arousal is scaled to negative (negative value - mean of negative and neutral) same to positive
tmp.df4_full_stim_downs_jun2021_60bins <- tmp.df4_full_stim_downs_jun2021_60bins %>%
    mutate_at(vars(matches('^neutral_pos_.*$')), ~ 
                  replace(., neutral_pos == FALSE, NA))
  
table(is.na(tmp.df4_full_stim_downs_jun2021_60bins$neutral_pos_mean_arousal))
table(is.na(tmp.df4_full_stim_downs_jun2021_60bins$neutral_pos_sd_arousal_self))

table(is.na(tmp.df4_full_stim_downs_jun2021_60bins$neutral_neg_mean_arousal_self))


tmp.df4_full_stim_downs_jun2021_60bins <- tmp.df4_full_stim_downs_jun2021_60bins %>%
    mutate_at(vars(matches('^neutral_neg_.*$')), ~ 
                  replace(., neutral_neg == FALSE, NA))

table(is.na(tmp.df4_full_stim_downs_jun2021_60bins$neutral_neg_sd_arousal_self))


tmp.df4_full_stim_downs_jun2021_60bins$neutral_pos_mean_arousal <- if_else(tmp.df4_full_stim_downs_jun2021_60bins$neutral_pos == TRUE, tmp.df4_full_stim_downs_jun2021_60bins)
  

colnames(tmp.df4_full_stim_downs_jun2021_60bins)


tmp.df4_full_stim_downs_jun2021_60bins$arousal_rel_neutral_ground <- ifelse(tmp.df4_full_stim_downs_jun2021_60bins$neutral_pos == TRUE & 
                                                                      tmp.df4_full_stim_downs_jun2021_60bins$ground_valence_lab == "More positive", tmp.df4_full_stim_downs_jun2021_60bins$ArousalMean - tmp.df4_full_stim_downs_jun2021_60bins$neutral_pos_mean_arousal,
                                                                    ifelse(tmp.df4_full_stim_downs_jun2021_60bins$ground_valence_lab == "More negative" & tmp.df4_full_stim_downs_jun2021_60bins$neutral_neg == TRUE, tmp.df4_full_stim_downs_jun2021_60bins$ArousalMean - 
                                                                             tmp.df4_full_stim_downs_jun2021_60bins$neutral_neg_mean_arousal, 
                                                                           tmp.df4_full_stim_downs_jun2021_60bins$ArousalMean - mean(tmp.df4_full_stim_downs_jun2021_60bins$ArousalMean, na.rm = TRUE)))


# same with self report

tmp.df4_full_stim_downs_jun2021_60bins$arousal_rel_neutral_self <- ifelse(tmp.df4_full_stim_downs_jun2021_60bins$neutral_pos == TRUE & 
                                                                      tmp.df4_full_stim_downs_jun2021_60bins$ground_valence_lab == "More positive", tmp.df4_full_stim_downs_jun2021_60bins$arousal - tmp.df4_full_stim_downs_jun2021_60bins$neutral_pos_mean_arousal_self,
                                                                    ifelse(tmp.df4_full_stim_downs_jun2021_60bins$ground_valence_lab == "More negative" & tmp.df4_full_stim_downs_jun2021_60bins$neutral_neg == TRUE, tmp.df4_full_stim_downs_jun2021_60bins$arousal - 
                                                                             tmp.df4_full_stim_downs_jun2021_60bins$neutral_neg_mean_arousal_self, 
                                                                           tmp.df4_full_stim_downs_jun2021_60bins$arousal - mean(tmp.df4_full_stim_downs_jun2021_60bins$arousal, na.rm = TRUE)))


# visualise new ground and self report arousal baseline separetelly for positive and negative valenced stimuli (based on IAPS validation)
table(is.na(tmp.df4_full_stim_downs_jun2021_60bins$arousal_rel_neutral_ground))
  
table(is.na(tmp.df4_full_stim_downs_jun2021_60bins$arousal_rel_neutral_ground), tmp.df4_full_stim_downs_jun2021_60bins$ground_valence_lab)

library(tidyverse)

tmp.df4_full_stim_downs_jun2021_60bins%>%
  group_by(stimIAPS, ground_valence_lab)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(ground_valence_lab, ArousalMean))+
  geom_point()+
  stat_summary(geom = 'pointrange')

tmp.df4_full_stim_downs_jun2021_60bins%>%
  group_by(stimIAPS, ground_valence_lab)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(ground_valence_lab, arousal_rel_neutral_ground))+
  # geom_point()+
  stat_summary(geom = 'pointrange')


tmp.df4_full_stim_downs_jun2021_60bins%>%
  group_by(stimIAPS, ground_valence_lab)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(ground_valence_lab, arousal_rel_neutral_self))+
  geom_point()+
  stat_summary(geom = 'pointrange')

arousal_rel_neutral_self

# ?cut
# is the cutoff for positive in the prevopis variable too large
tmp.df4_full_stim_downs_jun2021_60bins$ground_valence_2<- cut(tmp.df4_full_stim_downs_jun2021_60bins$ValenceMean, c(0,4,5,9), 
                                                              labels = c("negative", "neutral", "positive"))

tmp.df4_full_stim_downs_jun2021_60bins%>%
  group_by(stimIAPS, ssid,ground_valence)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(stimIAPS, abs(arousal), color = ground_valence))+
  # geom_point()+
  stat_summary(funy = mean, geom = 'pointrange')


tmp.df4_full_stim_downs_jun2021_60bins%>%
  group_by(stimIAPS, ssid,ground_valence)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(ground_valence, abs(arousal), color = ground_valence))+
  geom_boxplot()+
  stat_summary(funy = mean, geom = 'pointrange')

tmp.df4_full_stim_downs_jun2021_60bins%>%
  subset(!is.na(ground_valence))%>%
  group_by(stimIAPS, ssid,ground_valence)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(ground_valence, abs(arousal), color = ground_valence))+
  geom_boxplot()+
  stat_summary(funy = mean, geom = 'pointrange')

# absoluting 

tmp.df4_full_stim_downs_jun2021_60bins%>%
  subset(!is.na(ground_valence))%>%
  # group_by(ground_valence)%>%
  ungroup()%>%
  mutate(abs_arousal = abs(arousal), na.rm = TRUE)%>%
  mutate(abs_arousal_z = abs_arousal - mean(abs_arousal, na.rm = TRUE))%>%
  # summarise_at(c('mean_abs_arousal'), median, na.rm = TRUE)
  group_by(ssid,ground_valence_2)%>%
  summarise_if(is.numeric, median, na.rm = TRUE)%>%
  ggplot(aes(ground_valence_2, abs_arousal_z, color = ground_valence_2))+
  geom_point()+
  stat_summary(funy = median, geom = 'pointrange')+
  geom_boxplot()


absolutetest<- tmp.df4_full_stim_downs_jun2021_60bins%>%
  group_by(stimDescription,ground_valence_2)%>%
  # summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  mutate(arousal_abs = abs(arousal), valence_abs = abs(valence))%>%
  
  summarise_at(c("arousal", "ArousalMean", "ValenceMean","arousal_abs", "valence", "valence_abs", "arousal_abs_on_pos"), mean, na.rm = TRUE) 



absolutetest %>%
  ggplot(aes(ValenceMean,arousal_abs))+
  geom_point()+
  geom_text(aes(label = stimDescription))

absolutetest %>%
  ggplot(aes(ArousalMean,arousal_abs))+
  geom_point()+
  geom_text(aes(label = stimDescription))

# he U shape relationship seems to hold dependign on whether arousal is absolute - converting actovation to absolute

# absolute arousal don't correlate with iaps arousal
# we we taking valence absolute as intensity
absolutetest %>%
  ggplot(aes(ValenceMean,valence_abs))+
  geom_point()+
  geom_text(aes(label = stimDescription))

# arousal vs absolute valence
absolutetest %>%
  ggplot(aes(ArousalMean,valence_abs))+
  geom_point()+
  geom_text(aes(label = stimDescription))+
  geom_smooth(method = 'lm', se = F)+
  ggpubr::stat_cor()
# it seems like arousal in our case is picking something that is not just intemnsity of vaence, as it correlates better with arousal Mean

absolutetest %>%
  ggplot(aes(valence,valence_abs))+
  geom_point()+
  geom_text(aes(label = stimDescription))+
  geom_smooth(method = 'lm', se = F)+
  ggpubr::stat_cor()

# try and compute correlation using valencabs(

tmp.df4_full_stim_downs_jun2021_60bins%>%
  subset(!is.na(ground_valence_2))%>%
  group_by(ssid, stimIAPS,ground_valence_2)%>%
  
  mutate(arousal_abs = abs(arousal), valence_abs = abs(valence))%>%
  group_by(ssid, ground_valence_2)%>%
  mutate(cortest = cor(valence_abs, pup_basCor, use = "complete"))%>%
  
  # summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  # summarise_at(c("arousal", "ArousalMean","ValenceMean", "arousal_abs", "valence", "valence_abs", "arousal_abs_on_pos"), mean, na.rm = TRUE) %>%
  
  ggplot(aes(ground_valence_2, cortest, color = ground_valence_2))+
  # geom_point()+
  stat_summary(funy = mean, geom = 'pointrange')
    theme(axis.text.x = element_text(angle = 60))


```

just positive check
```{r}
# Plot just positive
tmp.df4_full_stim_downs_jun2021_60bins %>%
  subset(ground_valence_2 == "positive")%>%
  group_by(stimDescription,ground_valence_2)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(stimDescription, arousal))+
  # geom_point()+
  stat_summary(funy = mean, geom = 'pointrange', color = "blue")+
   stat_summary(aes( y = ArousalMean), funy = mean, geom = 'pointrange', color = "red")+
  theme(axis.text.x = element_text(angle = 60))


tmp.df4_full_stim_downs_jun2021_60bins %>%
  subset(ground_valence_2 == "positive")%>%
  group_by(stimDescription,ground_valence_2)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(stimDescription, arousal))+
  # geom_point()+
  stat_summary(funy = mean, geom = 'pointrange', color = "blue")+
   stat_summary(aes( y = ArousalMean), funy = mean, geom = 'pointrange', color = "red")+
  theme(axis.text.x = element_text(angle = 60))

# if we removed the erotic ones would we have positive tracking arousal better


# negative
tmp.df4_full_stim_downs_jun2021_60bins %>%
  subset(ground_valence_2 == "negative")%>%
  group_by(stimDescription,ground_valence_2)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(stimDescription, arousal))+
  # geom_point()+
  stat_summary(funy = mean, geom = 'pointrange', color = "blue")+
   stat_summary(aes( y = ArousalMean), funy = mean, geom = 'pointrange', color = "red")+
  theme(axis.text.x = element_text(angle = 60))


tmp.df4_full_stim_downs_jun2021_60bins %>%
  subset(ground_valence_2 == "positive")%>%
  group_by(stimIAPS,ground_valence_2)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(ArousalMean, arousal))+
  geom_point()+
  geom_smooth(method = 'lm')+
  ggpubr::stat_cor()

tmp.df4_full_stim_downs_jun2021_60bins %>%
  subset(ground_valence_2 == "negative")%>%
  group_by(stimIAPS,ground_valence_2)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(ArousalMean, arousal))+
  geom_point()+
  geom_smooth(method = 'lm')+
  ggpubr::stat_cor()


tmp.df4_full_stim_downs_jun2021_60bins %>%
  subset(ground_valence_2 == "neutral")%>%
  group_by(stimIAPS,ground_valence_2)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(ArousalMean, arousal))+
  geom_point()+
  geom_smooth(method = 'lm')+
  ggpubr::stat_cor()
  
  # geom_point()+
  stat_summary(funy = mean, geom = 'pointrange', color = "blue")+
   stat_summary(aes( y = ArousalMean), funy = mean, geom = 'pointrange', color = "red")+
  theme(axis.text.x = element_text(angle = 60))
  
  
  
  tmp.df4_full_stim_downs_jun2021_60bins %>%
  subset(ground_valence_2 == "positive")%>%
  group_by(stimDescription,ground_valence_2)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(stimDescription, arousal))+
  # geom_point()+
  stat_summary(funy = mean, geom = 'pointrange', color = "blue")+
   stat_summary(aes( y = ArousalMean), funy = mean, geom = 'pointrange', color = "red")+
  theme(axis.text.x = element_text(angle = 60))
  

  tmp.df4_full_stim_downs_jun2021_60bins %>%
  subset(ground_valence_2 != "negative")%>%
  group_by(stimDescription,ground_valence_2)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(stimDescription, abs(arousal), color = ground_valence_2))+
  # geom_point()+
  stat_summary(funy = mean, geom = 'pointrange')+
   # stat_summary(aes( y = ArousalMean), funy = mean, geom = 'pointrange')+
  theme(axis.text.x = element_text(angle = 60))
  
  
  tmp.df4_full_stim_downs_jun2021_60bins$arousal_abs_on_pos<- if_else(tmp.df4_full_stim_downs_jun2021_60bins$ground_valence_2!= "negative", abs(tmp.df4_full_stim_downs_jun2021_60bins$arousal), tmp.df4_full_stim_downs_jun2021_60bins$arousal)
  
  
    tmp.df4_full_stim_downs_jun2021_60bins %>%
  # subset(ground_valence_2 != "negative")%>%
  group_by(stimDescription,ground_valence_2)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(ground_valence_2, arousal_abs_on_pos, color = ground_valence_2))+
  geom_point()+
  stat_summary(funy = mean, geom = 'pointrange')+
   # stat_summary(aes( y = ArousalMean), funy = mean, geom = 'pointrange')+
  theme(axis.text.x = element_text(angle = 60))
    
    
        tmp.df4_full_stim_downs_jun2021_60bins %>%
  # subset(ground_valence_2 != "negative")%>%
  group_by(stimDescription,ground_valence_2)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(ground_valence_2, abs(arousal), color = ground_valence_2))+
  # geom_point()+
  stat_summary(funy = mean, geom = 'pointrange')+
   # stat_summary(aes( y = ArousalMean), funy = mean, geom = 'pointrange')+
  theme(axis.text.x = element_text(angle = 60))
  
```

erotica check
```{r}
# if we removed the erotic ones would we have positive tracking arousal better?
  
  
  # organise pupil by growing order of positivearousal
  tmp.df4_full_stim_downs_jun2021_60bins %>%
  subset(ground_valence_2 == "positive")%>%
  group_by(stimIAPS,stimDescription, ground_valence_2)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
    arrange(arousal)%>%
  ggplot(aes(arousal, pup_basCor))+
    geom_text(aes(label = stimDescription))+
  # geom_point()+
  stat_summary(funy = mean, geom = 'pointrange', color = "blue")+
    xlim(-7,-2)+
    ggpubr::stat_cor()
   stat_summary(aes( y = ArousalMean), funy = mean, geom = 'pointrange', color = "red")+
  theme(axis.text.x = element_text(angle = 60))
   
   # so arousal (ativation) sis till being tracked even if we exclude the sexual stimuli
   
   
   
     tmp.df4_full_stim_downs_jun2021_60bins %>%
  subset(ground_valence_2 == "negative")%>%
  group_by(stimIAPS,stimDescription, ground_valence_2)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
    arrange(arousal)%>%
  ggplot(aes(arousal, pup_basCor))+
    geom_text(aes(label = stimDescription))+
  # geom_point()+
  stat_summary(funy = mean, geom = 'pointrange', color = "blue")+
    # xlim(-7,-2)+
    ggpubr::stat_cor()

# if we removed the erotic ones would we have positive tracking arousal better

# maybe not every emotional experience causes a detectable physiologicachangedFiles(
# preparing ubjects might allow them to calibrate
```
abs
```{r}
# does absolute arousal correlate with other variables of interest
tmp.df4_full_stim_downs_jun2021_60bins$abs_arousal<- abs(tmp.df4_full_stim_downs_jun2021_60bins$arousal)

tmp.df4_full_stim_downs_jun2021_60bins %>%
  subset(ssid_num< 500)%>%
  subset(!is.na(groun_valence))%>%
  group_by(ssid, stimIAPS)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(pup_basCor, arousal))+
  geom_point()+
  stat_smooth(aes(group = ssid),method = 'lm', se = F)
    ggpubr::stat_cor()

tmp.df4_full_stim_downs_jun2021_60bins %>%
  subset(!is.na(groun_valence))%>%
  group_by(ssid, stimIAPS)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(pup_basCor, abs_arousal))+
  geom_point()+
  geom_smooth(aes(group = ssid),method = 'lm', se = F)+
  ggpubr::stat_cor()+
  facet_grid()

tmp.df4_full_stim_downs_jun2021_60bins %>%
  subset(!is.na(groun_valence))%>%
  group_by(ssid, stimIAPS,ground_valence_lab)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  group_by(ssid,ground_valence_lab)%>%
  mutate(corar = cor(abs_arousal, pup_basCor, use = "complete"))%>%
  ggplot(aes(ground_valence_lab, corar))+
  # geom_point()
  stat_summary(geom = 'pointrange')


tmp.df4_full_stim_downs_jun2021_60bins %>%
  group_by(stimIAPS)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(ArousalMean, ArousalMeanThisSample))+
  geom_point()+
  ggpubr::stat_cor()

tmp.df4_full_stim_downs_jun2021_60bins %>%
  group_by(stimIAPS)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(ArousalMean, abs_arousal))+
  geom_point()+
  ggpubr::stat_cor()
# this again suggests that there is not too much of a problem in our response format as the absolute would be the equivalent of an scale that encodes for calence (direction)
```

a few checks on stim by ratings 
```{r eval=FALSE, include=FALSE}
<!-- tmp.df4_full_stim_downs_jun2021_60bins%>% -->
<!--   group_by(stimIAPS, ssid,valence_self)%>% -->
<!--   summarise_if(is.numeric, mean, na.rm = TRUE)%>% -->
<!--   ggplot(aes(stimIAPS, arousal, color = valence_self))+ -->
<!--   # geom_point()+ -->
<!--   stat_summary(funy = mean, geom = 'pointrange') -->


<!-- tmp.df4_full_stim_downs_jun2021_60bins%>% -->
<!--   group_by(stimIAPS, ssid,valence_self)%>% -->
<!--   summarise_if(is.numeric, mean, na.rm = TRUE)%>% -->
<!--   ggplot(aes(stimIAPS, abs(valence), color = valence_self))+ -->
<!--   # geom_point()+ -->
<!--   stat_summary(funy = mean, geom = 'pointrange') -->


<!-- tmp.df4_full_stim_downs_jun2021_60bins%>% -->
<!--   group_by(stimIAPS, ssid,ground_valence)%>% -->
<!--   summarise_if(is.numeric, mean, na.rm = TRUE)%>% -->
<!--   ggplot(aes(stimIAPS, abs(valence), color = ground_valence))+ -->
<!--   # geom_point()+ -->
<!--   stat_summary(funy = mean, geom = 'pointrange') -->
  
```

```{r}
# create the new arousal corrected within positive/negative - neutral
tmp.df4_full_stim_downs_jun2021_60bins$arousal_rel_neutral_ground_z <- ifelse(tmp.df4_full_stim_downs_jun2021_60bins$neutral_pos == TRUE & 
                                                                      tmp.df4_full_stim_downs_jun2021_60bins$ground_valence_lab == "More positive", tmp.df4_full_stim_downs_jun2021_60bins$arousal_rel_neutral_ground/ tmp.df4_full_stim_downs_jun2021_60bins$neutral_pos_sd_arousal,
                                                                    ifelse(tmp.df4_full_stim_downs_jun2021_60bins$ground_valence_lab == "More negative" & tmp.df4_full_stim_downs_jun2021_60bins$neutral_neg == TRUE, tmp.df4_full_stim_downs_jun2021_60bins$arousal_rel_neutral_ground / 
                                                                             tmp.df4_full_stim_downs_jun2021_60bins$neutral_neg_sd_arousal, 
                                                                           tmp.df4_full_stim_downs_jun2021_60bins$arousal_rel_neutral_ground/ sd(tmp.df4_full_stim_downs_jun2021_60bins$ArousalMean, na.rm = TRUE)))


# do the same with self report arousal but using ground valence?
tmp.df4_full_stim_downs_jun2021_60bins$arousal_self_rel_neutral_ground_z <- ifelse(tmp.df4_full_stim_downs_jun2021_60bins$neutral_pos == TRUE & 
                                                                                     tmp.df4_full_stim_downs_jun2021_60bins$ground_valence_lab == "More positive", tmp.df4_full_stim_downs_jun2021_60bins$arousal_rel_neutral_ground/ tmp.df4_full_stim_downs_jun2021_60bins$neutral_pos_sd_arousal,
                                                                    ifelse(tmp.df4_full_stim_downs_jun2021_60bins$ground_valence_lab == "More negative" & tmp.df4_full_stim_downs_jun2021_60bins$neutral_neg == TRUE, tmp.df4_full_stim_downs_jun2021_60bins$arousal_rel_neutral_ground / 
                                                                             tmp.df4_full_stim_downs_jun2021_60bins$neutral_neg_sd_arousal, 
                                                                           tmp.df4_full_stim_downs_jun2021_60bins$arousal_rel_neutral_ground/ sd(tmp.df4_full_stim_downs_jun2021_60bins$ArousalMean, na.rm = TRUE)))



table(is.na(tmp.df4_full_stim_downs_jun2021_60bins$arousal_rel_neutral_ground))
table(is.na(tmp.df4_full_stim_downs_jun2021_60bins$arousal_rel_neutral_ground), tmp.df4_full_stim_downs_jun2021_60bins$ground_valence_lab)


tmp.df4_full_stim_downs_jun2021_60bins%>%
  group_by(stimIAPS, ground_valence_lab)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(ground_valence_lab, ArousalMean))+
  # geom_point()+
  # stat_summary(geom = 'pointrange')
 geom_boxplot()
tmp.df4_full_stim_downs_jun2021_60bins %>%
  group_by(stimIAPS, ground_valence_lab)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(ground_valence_lab, arousal_rel_neutral_ground_z ))+
  # geom_point()+
  geom_boxplot()
  # stat_summary(geom = 'pointrange')


# original valence arousal
tmp.df4_full_stim_downs_jun2021_60bins %>%
  group_by(stimIAPS, ground_valence_lab)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(ValenceMean, ArousalMean ))+
  geom_point()+
  geom_smooth(method = 'lm', se = F)+
  ggpubr::stat_cor()

tmp.df4_full_stim_downs_jun2021_60bins %>%
  group_by(stimIAPS, ground_valence_lab)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(ValenceMean, arousal_rel_neutral_ground_z ))+
  geom_point()+
  geom_smooth(method = 'lm', se = F)+
  ggpubr::stat_cor()



```



  valenc and arousla plots  
```{r}
  tmp.df4_full_stim_downs_jun2021_60bins %>%
  ungroup()%>%
  group_by(ground_valence_lab)%>%
  mutate(ArousalMean_z_by_val = scale(ArousalMean, center = TRUE, scale = TRUE)[,1])%>%
   mutate(Arousal_z_by_val = scale(arousal, center = TRUE, scale = TRUE)[,1])%>%
  group_by(stimIAPS,ground_valence_lab)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  # ggplot(aes(ground_valence_lab, ArousalMean_z_by_val ))+
  ggplot(aes(valence_c, ArousalMean ))+
  geom_point()+
  # geom_smooth(aes(group = ground_valence_lab), method = 'lm', se = F)
  stat_summary(geom = 'pointrange')+
  ggpubr::stat_cor()
  
  

      tmp.df4_full_stim_downs_jun2021_60bins %>%
  ungroup()%>%
  group_by(ground_valence_lab)%>%
  mutate(ArousalMean_z_by_val = scale(ArousalMean, center = TRUE, scale = TRUE)[,1])%>%
      
      group_by(ground_valence_lab)%>%
   mutate(Arousal_z_by_val = scale(arousal, center = TRUE, scale = TRUE)[,1])%>%
  group_by(stimIAPS,ground_valence_lab)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  # ggplot(aes(ground_valence_lab, ArousalMean_z_by_val ))+
  ggplot(aes(ArousalMean_z_by_val,pup_basCor ))+
  geom_point()+
      geom_smooth(method = 'lm', se = F)+
      ggpubr::stat_cor()
    
    tmp.df4_full_stim_downs_jun2021_60bins %>%
  ungroup()%>%
  group_by(ground_valence_lab)%>%
  mutate(ArousalMean_z_by_val = scale(ArousalMean, center = TRUE, scale = TRUE)[,1])%>%
      
      group_by(ground_valence_lab)%>%
   mutate(Arousal_z_by_val = scale(arousal, center = TRUE, scale = TRUE)[,1])%>%
  group_by(stimIAPS,ground_valence_lab)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  # ggplot(aes(ground_valence_lab, ArousalMean_z_by_val ))+
  ggplot(aes(Arousal_z_by_val,pup_basCor ))+
  geom_point()+
      geom_smooth(method = 'lm', se = F)+
      ggpubr::stat_cor()
  # geom_smooth(aes(color = ground_valence_lab), method = 'lm', se = F)
    
    
    
    # original variable
  
      tmp.df4_full_stim_downs_jun2021_60bins %>%
  ungroup()%>%
  group_by(ground_valence_lab)%>%
  mutate(ArousalMean_z_by_val = scale(ArousalMean, center = TRUE, scale = TRUE)[,1])%>%
      
      group_by(ground_valence_lab)%>%
   mutate(Arousal_z_by_val = scale(arousal, center = TRUE, scale = TRUE)[,1])%>%
  group_by(stimIAPS,ground_valence_lab)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  # ggplot(aes(ground_valence_lab, ArousalMean_z_by_val ))+
  ggplot(aes(pup_basCor,arousal))+
  geom_point()+
      geom_smooth(method = 'lm', se = F)+
      ggpubr::stat_cor()
      
      
      
  geom_smooth(aes(color = ground_valence_lab), method = 'lm', se = F)
        tmp.df4_full_stim_downs_jun2021_60bins %>%
  ungroup()%>%
  group_by(ground_valence_lab)%>%
  mutate(ArousalMean_z_by_val = scale(ArousalMean, center = TRUE, scale = TRUE)[,1])%>%
      
      group_by(ground_valence_lab)%>%
   mutate(Arousal_z_by_val = scale(arousal, center = TRUE, scale = TRUE)[,1])%>%
  group_by(stimIAPS,ground_valence_lab)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  # ggplot(aes(ground_valence_lab, ArousalMean_z_by_val ))+
  ggplot(aes(pup_basCor, ArousalMean))+
  geom_point()+
          geom_smooth(method = 'lm', se = F)+
          ggpubr::stat_cor()
  # geom_smooth(aes(group = ground_valence_lab), method = 'lm', se = F)
        

```


Pupil changes over time
<!-- 30 bins -->
```{r}

# create number s for time bins
tmp.df4_full_stim_downs_jun2021_with_behnew<- tmp.df4_full_stim_downs_jun2021_with_behnew%>%
  group_by(ssid, tNo)%>%
  mutate(timebin_no = 1:n())

range(tmp.df4_full_stim_downs_jun2021_with_behnew$timebin_no)

nbins<- unique(tmp.df4_full_stim_downs_jun2021_with_behnew$timebin_no)
nrow(nbins)
# nbins = 30 # number of bins

# create and empty dataframe for the timecourse analyses
timecourse_result_df_int <- data.frame(timebins= rep(NA, 30), 
                                       Estimate_ar= rep(NA, 30), 
                                       t_ar=rep(NA, 30), 
                                       p_ar=rep(NA, 30),
                                       Estimate_vl= rep(NA, 30), 
                                       t_vl=rep(NA, 30), 
                                       p_vl=rep(NA, 30),
                                       Estimate_br= rep(NA, 30), 
                                       t_br=rep(NA, 30), 
                                       p_br=rep(NA, 30),
                                       Estimate_ar_vl= rep(NA, 30), 
                                       t_ar_vl=rep(NA, 30), 
                                       p_ar_vl=rep(NA, 30),
                                       cov= as.character(rep(NA,30)))

# View(timecourse_result_df)
nbins<- nbins[1:28]

i = 0 # remember to always rezero it
# b = 10

# rm(i,b)


for (b in 1:length(nbins)) {
  # for (s in 1:length(nsim)) {

    message(sprintf("$$$$$RUNING lmer %i", nbins[b]))
        lmer_bin_pup  <- lmer(pup_basCor ~ arousal_c* valence+Mean_gray_z  +
                                (1 | ssid),
                                # (0 +arousal_c* valence | ssid),
                                # (1|stimIAPS),
                              REML = FALSE,
                      data = subset(tmp.df4_full_stim_downs_jun2021_with_behnew,
                                    # mediansplit_self_valence == "More positive" & 
                                    timebin_no == nbins[b]))

        #store results from the simulation
            lmer_bin_pup_summary<- summary(lmer_bin_pup)
            lmer_bin_pup_summary
            # lmer_bin_pup_summary[["coefficients"]][3,1]
            timecourse_result_df_int[i,1]<- tmp.df4_full_stim_downs_jun2021_with_behnew$timerezero3[b] #save the exact value of time bin
            
            timecourse_result_df_int[i,2]<- lmer_bin_pup_summary[["coefficients"]][5,1] # first number is term(row), second is column
            timecourse_result_df_int[i,3]<-lmer_bin_pup_summary[["coefficients"]][5,4] # t statistic
            timecourse_result_df_int[i,4]<-lmer_bin_pup_summary[["coefficients"]][5,5] # p value
            # simulated_clusters_JEFFE[i,6]<- nsim[s] #store simulation ount
            timecourse_result_df_int[i,5] <-ifelse(length(lmer_bin_pup_summary$optinfo$conv$lme4$message)
                                                   != 0,
                                               lmer_bin_pup_summary$optinfo$conv$lme4$message, 'pass')

     i = i+1
}


# timecourse_result_df_pos<- timecourse_result_df

timecourse_result_df_int %>%
  ggplot(aes(timebins, t))+
  geom_line(size = 2)+
  geom_line(aes(y = p), linetype = "dashed", size = 2)+
  geom_hline(yintercept = .05, color = 'red', size = 1.5)


```


60 bins

10 hz
each bin is an average of 100ms
<!-- https://link.springer.com/article/10.3758/s13428-018-1075-y -->

```{r}

# create number s for time bins

unique(tmp.df4_full_stim_downs_jun2021_60bins$ssid)

tmp.df4_full_stim_downs_jun2021_60bins<- tmp.df4_full_stim_downs_jun2021_60bins%>%
  group_by(ssid, tNo)%>%
  mutate(timebin_no = 1:n())

# let's test the interaction term
nbins<- unique(tmp.df4_full_stim_downs_jun2021_60bins$timebin_no)
range(tmp.df4_full_stim_downs_jun2021_60bins$timebin_no)

unique(tmp.df4_full_stim_downs_jun2021_60bins$timebin_no)

# nbins = 60 # number of bins

# create and empty dataframe for the timecourse analyses
timecourse_60bin_result_df <- data.frame(timebins= rep(NA, 60), 
                                       Estimate_ar= rep(NA, 60), 
                                       t_ar=rep(NA, 60), 
                                       p_ar=rep(NA, 60),
                                       Estimate_vl= rep(NA, 60), 
                                       t_vl=rep(NA, 60), 
                                       p_vl=rep(NA, 60),
                                       Estimate_br= rep(NA, 60), 
                                       t_br=rep(NA, 60), 
                                       p_br=rep(NA, 60),
                                       Estimate_ar_vl= rep(NA, 60), 
                                       t_ar_vl=rep(NA, 60), 
                                       p_ar_vl=rep(NA, 60),
                                       cov= as.character(rep(NA,60)))

# View(timecourse_result_df)
# nbins<- nbins[1:60]

i = 0 # remember to always rezero it
# b = 10

# rm(i,b)

# i =1
# unique(tmp.df4_full_stim_downs_jun2021_60bins$)
table(is.na(tmp.df4_full_stim_downs_jun2021_60bins$arousal_c))
for (b in 1:length(nbins)) {
  # for (s in 1:length(nsim)) {

    message(sprintf("$$$$$RUNING lmer %i", nbins[b]))
        lmer_bin_pup  <- lmer(pup_basCor ~ (arousal_c* valence)+Mean_gray_z  +
                                (1 | ssid),
                                # (0 +arousal_c* valence | ssid),
                                # (1|stimIAPS),
                              REML = FALSE,
                      data = subset(tmp.df4_full_stim_downs_jun2021_60bins,
                                    Group == "NT" &
                                    timebin_no == nbins[b]))

        #store results from the simulation
            lmer_bin_pup_summary<- summary(lmer_bin_pup)
            lmer_bin_pup_summary
            # lmer_bin_pup_summary[["coefficients"]][3,1]
            timecourse_60bin_result_df[i,1]<- tmp.df4_full_stim_downs_jun2021_60bins$timerezero3[b] 
            #save the exact value of time bin
            # store arousal (2,parameter)            # first number is term(row), second is column
            timecourse_60bin_result_df[i,2]<-
            lmer_bin_pup_summary[["coefficients"]][2,1] #estimate
            timecourse_60bin_result_df[i,3]<-
              lmer_bin_pup_summary[["coefficients"]][2,4] # t statistic
            timecourse_60bin_result_df[i,4]<-
            lmer_bin_pup_summary[["coefficients"]][2,5] # p value
            
            # valence
            
            timecourse_60bin_result_df[i,5]<-
            lmer_bin_pup_summary[["coefficients"]][3,1] #estimate
            timecourse_60bin_result_df[i,6]<-
              lmer_bin_pup_summary[["coefficients"]][3,4] # t statistic
            timecourse_60bin_result_df[i,7]<-
              lmer_bin_pup_summary[["coefficients"]][3,5] # p value
            
            # brighteness
            
            timecourse_60bin_result_df[i,8]<-
            lmer_bin_pup_summary[["coefficients"]][4,1] #estimate
            timecourse_60bin_result_df[i,9]<-
              lmer_bin_pup_summary[["coefficients"]][4,4] # t statistic
            timecourse_60bin_result_df[i,10]<-
              lmer_bin_pup_summary[["coefficients"]][4,5] # p value
            
            # interaction arousal x brighteness
            
            timecourse_60bin_result_df[i,11]<-
            lmer_bin_pup_summary[["coefficients"]][5,1] #estimate
            timecourse_60bin_result_df[i,12]<-
              lmer_bin_pup_summary[["coefficients"]][5,4] # t statistic
            timecourse_60bin_result_df[i,13]<-
              lmer_bin_pup_summary[["coefficients"]][5,5] # p value
            
            
            timecourse_60bin_result_df[i,14] <-
              ifelse(length(lmer_bin_pup_summary$optinfo$conv$lme4$message)
                                                   != 0,
                                               lmer_bin_pup_summary$optinfo$conv$lme4$message, 'pass')

     i = i+1
}


# timecourse_result_df_pos<- timecourse_result_df
View(timecourse_60bin_result_df)

  # geom_hline(yintercept = .05, color = 'red', size = 1.5)
  
# adjust p values and tag as TRUE whenevee there is at least 3 consecutive p values below .05
?p.adjust

timecourse_60bin_result_df$p_ar_adj<- p.adjust(timecourse_60bin_result_df$p_ar, method = "holm")
timecourse_60bin_result_df$p_ar_adj_TRUE<- if_else(timecourse_60bin_result_df$p_ar_adj<.05, TRUE, FALSE)


timecourse_60bin_result_df$p_vl_adj <- p.adjust(timecourse_60bin_result_df$p_vl, method = "holm")
timecourse_60bin_result_df$p_vl_adj_TRUE<- if_else(timecourse_60bin_result_df$p_vl_adj<.05, TRUE, FALSE)

timecourse_60bin_result_df$p_br_adj <- p.adjust(timecourse_60bin_result_df$p_br, method = "holm")
timecourse_60bin_result_df$p_br_adj_TRUE<- if_else(timecourse_60bin_result_df$p_br_adj<.05, TRUE, FALSE)

timecourse_60bin_result_df$p_ar_vl_adj <- p.adjust(timecourse_60bin_result_df$p_ar_vl, method = "holm")
timecourse_60bin_result_df$p_ar_vl_adj_TRUE<- if_else(timecourse_60bin_result_df$p_ar_vl_adj<.05, TRUE, NULL)

# find the first and last true in a sequence of TRUES
duplicated(timecourse_60bin_result_df$p_ar_adj_TRUE, na.rm = TRUE)



timecourse_60bin_result_df %>%
  ggplot(aes(timebins, Estimate_ar_vl))+
  # geom_line(size = 1)
  # geom_line(aes(y = t_vl), linetype = "dashed", size = 1)+
  # geom_line(aes(y = t_br), linetype = "dotted", size = 1)+
  # geom_line(aes(y = t_ar), linetype = "dotdash", size = 1, color = "red")
  # 

View(timecourse_60bin_result_df)


?p.adjust

# flad when 3 consecutive rows have a p <.05
require(zoo)

# rle performs lenght encoding
rletest<- rle(timecourse_60bin_result_df$p_ar<.05)
?rle

  (rletest$lengths[rletest$lengths > 3 & rletest$values== TRUE]) # length of each sequence

# To get the vector with only a sequence of "TRUE" you can try

rletest$values[rletest$values != TRUE] <- 0
timecourse_60bin_result_df$p_ar_3below.5<- rep(rletest$values,  rletest$lengths)

table(timecourse_60bin_result_df$p_ar_3below.5)
?p.adjust

timecourse_60bin_result_df%>%
  group_by(p_ar_3below.5)%>%
  mutate(p_ar_adj_clust= p.adjust(p_ar, method = "holm"))

timecourse_60bin_result_df %>%
  mutate(test=rollapply(p_ar, width=3, max, align="left", fill=NA, na.rm=TRUE))
  

View(timecourse_60bin_result_df)  



```

# # figure preferences
good blog in customization 
https://www.datanovia.com/en/blog/ggplot-legend-title-position-and-labels/#rename-legend-labels-and-change-the-order-of-items
```{r}
p<- list()

sf = 1 # scaling factor to make it easier to change sizes of everything, in which case change here

p$graphstyle <-  theme(#base plot theme
  
  # axis lines
  axis.line.y = element_line(color="black"),
  axis.line.x = element_line(color="black"),
  
  axis.title.y=element_text(size = 16*(sf+.5), margin=margin(0,5,0,0)),
  axis.title.x=element_text(size = 16*(sf+.5), margin=margin(0,5,0,0)),
  
  # text
  strip.text.x = element_text(size = 12*(sf+.5),  colour = "black"),
  strip.text.y = element_text(size = 12*(sf+.5),  colour = "black"),
  
  text=element_text(size = 14, family = "sans"),
  axis.text.x = element_text(size = 14*(sf+.5), family = "sans", colour = "black",),
  axis.text.y = element_text(size = 14*(sf+.5), family = "sans", colour = "black"),
  
  
  # panel
  panel.grid.major = element_blank(),
  panel.background = element_blank(),
  # panel.background = element_rect(fill="transparent"),
  # panel.border = element_rect(fill="transparent"),
  # strip shades (reco rectagles)
   strip.background = element_blank(),
  
  # legend
  legend.position = "top",
  legend.key = element_rect(colour = "transparent", fill="transparent"),
  #legend.direction = "horizontal",

  legend.text = element_text(size = 10*(sf+.3)),
  # legend.title = element_text(size = 10*(sf+.3)),
  # legend line tends to be really small in print so adjust here
  legend.key.height = unit(.5, "cm"),
  legend.key.width = unit(2, "cm"),
  
  #legend.text = element_text(size = 10*sf),
  legend.title=element_blank(),
  #legend.text = element_blank(),
  #axis.ticks = element_blank(),
)


```


timecourse stats plots
```{r}
require(RColorBrewer) # make color friendly plots
require(tidyverse)

brewer.pal(4, "Dark2") # gives the exact names of pallets
  # "#1B9E77" "#D95F02" "#7570B3" "#E7298A"
  # timecourse_60bin_result_df$
  # Estimate_ar, Estimate_ar_vl,Estimate_br. Estimate_v
  
plots_timecourse <- list()

#  let's use the order arousal, valence, arousal x valence brightness
View(timecourse_60bin_result_df)

plots_timecourse$eff_size_pup_amp <-   timecourse_60bin_result_df[1:56,] %>% 
  select("timebins","Estimate_ar", "Estimate_vl", "Estimate_br", "Estimate_ar_vl") %>% 
  pivot_longer(-timebins, names_to = "variable", values_to = "Estimate")%>%
    subset(!is.na(Estimate))%>%
  #change the order of the coloring variable here and the name of legends
  mutate(variable = factor(variable, c("Estimate_ar", "Estimate_vl","Estimate_ar_vl",  "Estimate_br"), labels = c("arousal", "valence", "arousal x valence", "brightness")))%>%
  ggplot(aes(timebins, Estimate, group = variable, color= variable))+
  geom_line(aes(linetype = variable), size = 1)+
  
  scale_color_brewer(palette = "Dark2")+
    # scale_color_manual(values=c("#1B9E77", "#D95F02", "#7570B3", "#E7298A"))+
  # use hom correction for significance
  
    # brighteness
    # timecourse_60bin_result_df$timebins[timecourse_60bin_result_df$p_br_adj_TRUE == TRUE]
  
    annotate(geom = 'rect', # use annotate instead of geom_rect, as it is more flexible
             xmin = .16, # got these values from the data-frame. need to fidn a way to automate this
                xmax = 6,
                ymin = -2.03+(sf*.3), # if I ever need to change this, use the scaling factor sf
                ymax = -2+.1+.01+(sf*.3),
                fill =  "#E7298A" , alpha = .5)+ 
    
      annotate("text", 
                x = (1+5.4)/2,
                y = ((-2) +(-2+.1))/2+(sf*.3),
                label = "brightness") +
    
    # arousal
  
    # timecourse_60bin_result_df$p_ar_adj
    # timecourse_60bin_result_df$timebins[timecourse_60bin_result_df$p_ar_adj_TRUE == TRUE]
     annotate(geom = 'rect', xmin = 1,
                xmax = 5.89,
                ymin = -2.03+.1+.1+.1+.1+(sf*.3),
                ymax = -2+.1+.1+.1+.1+.1+.01+(sf*.3),
                fill = "#1B9E77", alpha = .5)+
        annotate("text", 
                  x = (1+5.4)/2,
                y = ((-2+.1+.1+.1+.1) +(-2+.1+.1+.1+.1+.1))/2+(sf*.3),
                 label = "arousal") +

    # arousal-valence
   # timecourse_60bin_result_df$p_ar_vl_adj
    # timecourse_60bin_result_df$timebins[timecourse_60bin_result_df$p_ar_vl_adj_TRUE == TRUE]
       annotate(geom = 'rect', 
                xmin = 1,
                xmax = 5.4,
                ymin = -2.03+.1+.1+(sf*.3),
                ymax = -2+.1+.1+.1+.01+(sf*.3),
                
                fill ="#7570B3", alpha = .5, label = "text")+
    annotate("text", 
                x = (1+5.4)/2,
                y = ((-2+.1+.1) +(-2+.1+.1+.1))/2+(sf*.3),
                label = "arousal x valence") +
        xlab("Time (s)")+
    ylab("Effect size")+
    xlab("Time (s)")+
    ylab("Effect size")

plots_timecourse$eff_size_pup_amp 
# need to rename the label legends


# Edit legend title and labels
plots_timecourse$eff_size_pup_amp <- plots_timecourse$eff_size_pup_amp + 
  p$graphstyle +
    guides(colour = guide_legend(override.aes = list(size=2)))+ #the line size of the legend tends to be smaller in print
  scale_x_continuous(limits = c(0,6), breaks = c(0,2,4,6))+
  scale_y_continuous(limits = c(-2,.7), breaks = c(-1, -0.5, 0,0.5))
  


plots_timecourse$eff_size_pup_amp
plots_timecourse$eff_size_pup_velocity

```


split neutral positive and negative using IAPS validation data and fit the same

```{r}

colnames(tmp.df4_full_stim_downs_jun2021_60bins)

tmp.df4_full_stim_downs_jun2021_60bins$ground_arousal_lab
tmp.df4_full_stim_downs_jun2021_60bins$ground_valence_lab

nbins<- unique(tmp.df4_full_stim_downs_jun2021_60bins$timebin_no)
# create and empty data-frame for the time-course analyses

View(timecourse_60bin_result_df_pos)
timecourse_60bin_result_df_pos <- data.frame(timebins= rep(NA, 60), 
                                       Estimate_ar= rep(NA, 60), 
                                       t_ar=rep(NA, 60), 
                                       p_ar=rep(NA, 60),
                                       # Estimate_vl= rep(NA, 60), 
                                       # t_vl=rep(NA, 60), 
                                       # p_vl=rep(NA, 60),
                                       Estimate_br= rep(NA, 60), 
                                       t_br=rep(NA, 60), 
                                       p_br=rep(NA, 60),
                                       # Estimate_ar_vl= rep(NA, 60), 
                                       # t_ar_vl=rep(NA, 60), 
                                       # p_ar_vl=rep(NA, 60),
                                       cov= as.character(rep(NA,60)))

# View(timecourse_result_df)
# nbins<- nbins[1:60]

i = 0 # remember to always rezero it
# b = 10

# rm(i,b)

# i =1
# unique(tmp.df4_full_stim_downs_jun2021_60bins$)

for (b in 1:length(nbins)) {
  # for (s in 1:length(nsim)) {

    message(sprintf("$$$$$RUNING lmer %i", nbins[b]))
        lmer_bin_pup  <- lmer(pup_basCor ~ arousal_c + Mean_gray_z  +
                                (1 | ssid),
                              REML = FALSE,
                      data = subset(tmp.df4_full_stim_downs_jun2021_60bins,
                                    ssid_num < 500 & ground_valence_lab == "More positive" &
                                    timebin_no == nbins[b]))

        #store results from the simulation
            lmer_bin_pup_summary<- summary(lmer_bin_pup)
            lmer_bin_pup_summary
            # lmer_bin_pup_summary[["coefficients"]][3,1]
            timecourse_60bin_result_df_pos[i,1]<- tmp.df4_full_stim_downs_jun2021_60bins$timerezero3[b] 
            #save the exact value of time bin
            # store arousal (2,parameter)            # first number is term(row), second is column
            timecourse_60bin_result_df_pos[i,2]<-
            lmer_bin_pup_summary[["coefficients"]][2,1] #estimate
            timecourse_60bin_result_df_pos[i,3]<-
              lmer_bin_pup_summary[["coefficients"]][2,4] # t statistic
            timecourse_60bin_result_df_pos[i,4]<-
            lmer_bin_pup_summary[["coefficients"]][2,5] # p value
            
            # brightness
            
            timecourse_60bin_result_df_pos[i,5]<-
            lmer_bin_pup_summary[["coefficients"]][3,1] #estimate
            timecourse_60bin_result_df_pos[i,6]<-
              lmer_bin_pup_summary[["coefficients"]][3,4] # t statistic
            timecourse_60bin_result_df_pos[i,7]<-
              lmer_bin_pup_summary[["coefficients"]][3,5] # p value

            
            timecourse_60bin_result_df_pos[i,8] <-
              ifelse(length(lmer_bin_pup_summary$optinfo$conv$lme4$message)
                                                   != 0,
                                               lmer_bin_pup_summary$optinfo$conv$lme4$message, 'pass')

     i = i+1
}


# timecourse_result_df_pos<- timecourse_result_df
View(timecourse_60bin_result_df_pos)

  
  # geom_hline(yintercept = .05, color = 'red', size = 1.5)
  

# adjust p values and tag as TRUE whenevee there is at least 3 consecutive p values below .05

timecourse_60bin_result_df_pos$p_ar_adj<- p.adjust(timecourse_60bin_result_df_pos$p_ar, method = "holm")
timecourse_60bin_result_df_pos$p_ar_adj_TRUE<- if_else(timecourse_60bin_result_df_pos$p_ar_adj<.05, TRUE, FALSE)


timecourse_60bin_result_df_pos$p_br_adj <- p.adjust(timecourse_60bin_result_df_pos$p_br, method = "holm")
timecourse_60bin_result_df_pos$p_br_adj_TRUE<- if_else(timecourse_60bin_result_df_pos$p_br_adj<.05, TRUE, FALSE)


timecourse_60bin_result_df_pos[1:56,] %>%
  ggplot(aes(timebins, Estimate_ar))+
  geom_line(size = 1)+
  geom_line(aes(y = Estimate_br), linetype = "dashed", size = 1)

  

# subset(tmp.df4_full_stim_downs_jun2021_60bins,
#                                     ssid_num < 500 & ground_valence_lab == "More positive"
#                                    )%>%
#   # group_by(stimIAPS)%>%
#   # summarise_if(is.numeric, mean, na.rm = TRUE)%>%
#   # ggplot(aes(valence, Mean))+
#   # geom_point()+
#   # geom_smooth(method = 'lm', se = F)+
#   # ggpubr::stat_cor()

```
neutral


```{r}



nbins<- unique(tmp.df4_full_stim_downs_jun2021_60bins$timebin_no)
# create and empty data-frame for the time-course analyses

View(timecourse_60bin_result_df_pos)

timecourse_60bin_result_df_neutral <- data.frame(timebins= rep(NA, 60), 
                                       Estimate_ar= rep(NA, 60), 
                                       t_ar=rep(NA, 60), 
                                       p_ar=rep(NA, 60),
                                       # Estimate_vl= rep(NA, 60), 
                                       # t_vl=rep(NA, 60), 
                                       # p_vl=rep(NA, 60),
                                       Estimate_br= rep(NA, 60), 
                                       t_br=rep(NA, 60), 
                                       p_br=rep(NA, 60),
                                       # Estimate_ar_vl= rep(NA, 60), 
                                       # t_ar_vl=rep(NA, 60), 
                                       # p_ar_vl=rep(NA, 60),
                                       cov= as.character(rep(NA,60)))

# View(timecourse_result_df)
# nbins<- nbins[1:60]

i = 0 # remember to always rezero it
# b = 10

# rm(i,b)

# i =1
# unique(tmp.df4_full_stim_downs_jun2021_60bins$)
for (b in 1:length(nbins)) {
  # for (s in 1:length(nsim)) {

    message(sprintf("$$$$$RUNING lmer %i", nbins[b]))
        lmer_bin_pup  <- lmer(pup_basCor ~ arousal_c + Mean_gray_z  +
                                (1 | ssid),
                              REML = FALSE,
                      data = subset(tmp.df4_full_stim_downs_jun2021_60bins,
                                    ssid_num < 500 & ground_valence_lab == "Mild" &
                                    timebin_no == nbins[b]))

        #store results from the simulation
            lmer_bin_pup_summary<- summary(lmer_bin_pup)
            lmer_bin_pup_summary
            # lmer_bin_pup_summary[["coefficients"]][3,1]
            timecourse_60bin_result_df_neutral[i,1]<- tmp.df4_full_stim_downs_jun2021_60bins$timerezero3[b] 
            #save the exact value of time bin
            # store arousal (2,parameter)            # first number is term(row), second is column
            timecourse_60bin_result_df_neutral[i,2]<-
            lmer_bin_pup_summary[["coefficients"]][2,1] #estimate
            timecourse_60bin_result_df_neutral[i,3]<-
              lmer_bin_pup_summary[["coefficients"]][2,4] # t statistic
            timecourse_60bin_result_df_neutral[i,4]<-
            lmer_bin_pup_summary[["coefficients"]][2,5] # p value
            
            # brightness
            
            timecourse_60bin_result_df_neutral[i,5]<-
            lmer_bin_pup_summary[["coefficients"]][3,1] #estimate
            timecourse_60bin_result_df_neutral[i,6]<-
              lmer_bin_pup_summary[["coefficients"]][3,4] # t statistic
            timecourse_60bin_result_df_neutral[i,7]<-
              lmer_bin_pup_summary[["coefficients"]][3,5] # p value

            
            timecourse_60bin_result_df_neutral[i,8] <-
              ifelse(length(lmer_bin_pup_summary$optinfo$conv$lme4$message)
                                                   != 0,
                                               lmer_bin_pup_summary$optinfo$conv$lme4$message, 'pass')

     i = i+1
}


# timecourse_result_df_pos<- timecourse_result_df
View(timecourse_60bin_result_df_neutral)


timecourse_60bin_result_df_neutral$p_ar_adj<- p.adjust(timecourse_60bin_result_df_neutral$p_ar, method = "holm")
timecourse_60bin_result_df_neutral$p_ar_adj_TRUE<- if_else(timecourse_60bin_result_df_neutral$p_ar_adj<.05, TRUE, FALSE)


timecourse_60bin_result_df_neutral$p_br_adj <- p.adjust(timecourse_60bin_result_df_neutral$p_br, method = "holm")
timecourse_60bin_result_df_neutral$p_br_adj_TRUE<- if_else(timecourse_60bin_result_df_neutral$p_br_adj<.05, TRUE, FALSE)



View(timecourse_60bin_result_df_neutral)
timecourse_60bin_result_df_neutral[1:56,] %>%
  ggplot(aes(timebins, Estimate_ar))+
  geom_line(size = 1)+
  geom_line(aes(y = Estimate_br), linetype = "dashed", size = 1)


```


negative


```{r}



nbins<- unique(tmp.df4_full_stim_downs_jun2021_60bins$timebin_no)
# create and empty data-frame for the time-course analyses

View(timecourse_60bin_result_df_pos)

timecourse_60bin_result_df_neg <- data.frame(timebins= rep(NA, 60), 
                                       Estimate_ar= rep(NA, 60), 
                                       t_ar=rep(NA, 60), 
                                       p_ar=rep(NA, 60),
                                       # Estimate_vl= rep(NA, 60), 
                                       # t_vl=rep(NA, 60), 
                                       # p_vl=rep(NA, 60),
                                       Estimate_br= rep(NA, 60), 
                                       t_br=rep(NA, 60), 
                                       p_br=rep(NA, 60),
                                       # Estimate_ar_vl= rep(NA, 60), 
                                       # t_ar_vl=rep(NA, 60), 
                                       # p_ar_vl=rep(NA, 60),
                                       cov= as.character(rep(NA,60)))

# View(timecourse_result_df)
# nbins<- nbins[1:60]

i = 0 # remember to always rezero it
# b = 10

# rm(i,b)

# i =1
# unique(tmp.df4_full_stim_downs_jun2021_60bins$)

for (b in 1:length(nbins)) {
  # for (s in 1:length(nsim)) {

    message(sprintf("$$$$$RUNING lmer %i", nbins[b]))
        lmer_bin_pup  <- lmer(pup_basCor ~ arousal_c + Mean_gray_z  +
                                (1 | ssid),
                              REML = FALSE,
                      data = subset(tmp.df4_full_stim_downs_jun2021_60bins,
                                    ssid_num < 500 & ground_valence_lab == "More negative" &
                                    timebin_no == nbins[b]))

        #store results from the simulation
            lmer_bin_pup_summary<- summary(lmer_bin_pup)
            lmer_bin_pup_summary
            # lmer_bin_pup_summary[["coefficients"]][3,1]
            timecourse_60bin_result_df_neg[i,1]<- tmp.df4_full_stim_downs_jun2021_60bins$timerezero3[b] 
            #save the exact value of time bin
            # store arousal (2,parameter)            # first number is term(row), second is column
            timecourse_60bin_result_df_neg[i,2]<-
            lmer_bin_pup_summary[["coefficients"]][2,1] #estimate
            timecourse_60bin_result_df_neg[i,3]<-
              lmer_bin_pup_summary[["coefficients"]][2,4] # t statistic
            timecourse_60bin_result_df_neg[i,4]<-
            lmer_bin_pup_summary[["coefficients"]][2,5] # p value
            
            # brightness
            
            timecourse_60bin_result_df_neg[i,5]<-
            lmer_bin_pup_summary[["coefficients"]][3,1] #estimate
            timecourse_60bin_result_df_neg[i,6]<-
              lmer_bin_pup_summary[["coefficients"]][3,4] # t statistic
            timecourse_60bin_result_df_neg[i,7]<-
              lmer_bin_pup_summary[["coefficients"]][3,5] # p value

            
            timecourse_60bin_result_df_neg[i,8] <-
              ifelse(length(lmer_bin_pup_summary$optinfo$conv$lme4$message)
                                                   != 0,
                                               lmer_bin_pup_summary$optinfo$conv$lme4$message, 'pass')

     i = i+1
}


# timecourse_result_df_pos<- timecourse_result_df
View(timecourse_60bin_result_df_neg)

# adjust p values
timecourse_60bin_result_df_neg$p_ar_adj<- p.adjust(timecourse_60bin_result_df_neg$p_ar, method = "holm")
timecourse_60bin_result_df_neg$p_ar_adj_TRUE<- if_else(timecourse_60bin_result_df_neg$p_ar_adj<.05, TRUE, FALSE)


timecourse_60bin_result_df_neg$p_br_adj <- p.adjust(timecourse_60bin_result_df_neg$p_br, method = "holm")
timecourse_60bin_result_df_neg$p_br_adj_TRUE<- if_else(timecourse_60bin_result_df_neg$p_br_adj<.05, TRUE, FALSE)



View(timecourse_60bin_result_df_neg)

timecourse_60bin_result_df_neg[1:56,] %>%
  ggplot(aes(timebins, Estimate_ar))+
  geom_line(size = 1)+
  geom_line(aes(y = Estimate_br), linetype = "dashed", size = 1)


```
Pupil velocity test
# velocity analyses

30hz
```{r}
# install.packages("pspline")
library(pspline)

predict(sm.spline(tmp.df4_full_stim_downs_jun2021_with_beh$timerezero3, 
                  tmp.df4_full_stim_downs_jun2021_with_beh$pup_basCor), 
        tmp.df4_full_stim_downs_jun2021_with_beh$timerezero3, 1)

D(tmp.df4_full_stim_downs_jun2021_with_beh$pup_basCor, 'x')

tmp.df4_full_stim_downs_jun2021_with_behnew

tmp.df4_full_stim_downs_jun2021_with_behnew <- tmp.df4_full_stim_downs_jun2021_with_behnew %>%
  # subset(!is.na(mediansplit_sample_arousal2))%>%
  # subset(valencearousal_outliers == TRUE) %>%
  # subset(!is.na(mediansplit_sample_arousal2))%>%
  group_by(ssid, stimIAPS) %>%
  mutate(pup_velocity = (abs(lag(pup_basCor)-pup_basCor)/abs(lag(timerezero3)-timerezero3)))
  # mutate(pup_velocity_peak = max(pup_velocity, na.rm = TRUE))


tmp.df4_full_stim_downs_jun2021_with_behnew$pup_velocity

# global

nrow(nbins)
nbins = 30 # number of bins
unique(tmp.df4_full_stim_downs_jun2021_with_behnew$ssid)
tmp.df4_full_stim_downs_jun2021_with_behnew <- tmp.df4_full_stim_downs_jun2021_with_behnew%>%
  group_by(ssid, tNo)%>%
  arrange(ssid,tNo, timerezero3)%>%
  mutate(pup_vel_smooth = zoo::rollmean(pup_velocity, k = 3, fill = NA))
  
zoo::rollmean(pup_velocity, k = 3, fill = NA)

tmp.df4_full_stim_downs_jun2021_with_behnew$pup_vel_smooth

# create and empty dataframe for the timecourse analyses
timecourse_result_df_int_vel <- data.frame(timebins= rep(NA, 30), Estimate= rep(NA, 30), 
                                   t=rep(NA, 30), p=rep(NA, 30), cov= as.character(rep(NA,30)))

# View(timecourse_result_df)
nbins<- nbins[1:28]

i = 0 # remember to always rezero it
# b = 10

rm(b)

nbins<- unique(tmp.df4_full_stim_downs_jun2021_with_behnew$timebin_no)

for (b in 3:length(nbins)) {
  # for (s in 1:length(nsim)) {

    message(sprintf("$$$$$RUNING lmer %i", nbins[b]))
        lmer_bin_pup  <- lmer(pup_vel_smooth ~ arousal_c* valence+Mean_gray_z  +
                                (1 | ssid)+
                                (0 +arousal_c* valence | ssid),
                                # (1|stimIAPS),
                              REML = FALSE,
                      data = subset(tmp.df4_full_stim_downs_jun2021_with_behnew,
                                    # mediansplit_self_valence == "More positive" & 
                                    timebin_no == nbins[b]))

        #store results from the simulation
            lmer_bin_pup_summary<- summary(lmer_bin_pup)
            lmer_bin_pup_summary
            # lmer_bin_pup_summary[["coefficients"]][3,1]
            timecourse_result_df_int_vel[i,1]<- tmp.df4_full_stim_downs_jun2021_with_behnew$timerezero3[b] #save the exact value of time bin
            timecourse_result_df_int_vel[i,2]<- lmer_bin_pup_summary[["coefficients"]][2,1] # first number is term(row), second is column
            timecourse_result_df_int_vel[i,3]<-lmer_bin_pup_summary[["coefficients"]][2,4] # t statistic
            timecourse_result_df_int_vel[i,4]<-lmer_bin_pup_summary[["coefficients"]][2,5] # p value
            # simulated_clusters_JEFFE[i,6]<- nsim[s] #store simulation ount
            timecourse_result_df_int_vel[i,5] <-ifelse(length(lmer_bin_pup_summary$optinfo$conv$lme4$message)
                                                   != 0,
                                               lmer_bin_pup_summary$optinfo$conv$lme4$message, 'pass')

     i = i+1
}


# timecourse_result_df_pos<- timecourse_result_df

timecourse_result_df_int_vel %>%
  ggplot(aes(timebins, t))+
  geom_line(size = 2)+
  geom_line(aes(y = p), linetype = "dashed", size = 2)+
  geom_hline(yintercept = .05, color = 'red', size = 1.5)+
  geom_vline(xintercept = 1, color = 'red')
  # ylim(-4,4)


??ma
?stats::filter
tmp.df4_full_stim_downs_jun2021_60bins %>%
  subset(ssid == 310 & tNo == 10)%>%
  ggplot(aes(timerezero3,pup_vel_smooth))+
  geom_line()+
  geom_point()
  # geom_line(aes(y = pup_velocity),Ç color = 'red')
  # geom_smooth(se = F)

tmp.df4_full_stim_downs_jun2021_60bins%>%
    subset(ssid == 320 & tNo == 20)%>%
  ggplot(aes(timerezero3,pup_basCor))+
  geom_point()+
  geom_line()+
  geom_line(aes(y = pup_vel_smooth), color = 'red')+
  geom_point(aes(y = pup_vel_smooth), color = 'red')
  # geom_line(aes(y = pup_velocity), color = 'red')+
  # geom_smooth(se = F)




```


velocity 100ms
```{r}
unique(tmp.df4_full_stim_downs_jun2021_60bins$ssid)

tmp.df4_full_stim_downs_jun2021_60bins$ssid_num<- as.numeric(as.character(tmp.df4_full_stim_downs_jun2021_60bins$ssid))

tmp.df4_full_stim_downs_jun2021_60bins <- tmp.df4_full_stim_downs_jun2021_60bins %>%
  # subset(!is.na(mediansplit_sample_arousal2))%>%
  # subset(valencearousal_outliers == TRUE) %>%
  # subset(!is.na(mediansplit_sample_arousal2))%>%
  group_by(ssid, tNo) %>%
  mutate(pup_velocity = (abs(lag(pup_basCor)-pup_basCor)/abs(lag(timerezero3)-timerezero3)))%>%
  mutate(pup_velocity_dir = ((lag(pup_basCor)-pup_basCor) / abs(lag(timerezero3)-timerezero3)))
  # mutate(pup_velocity_peak = max(pup_velocity, na.rm = TRUE))


tmp.df4_full_stim_downs_jun2021_60bins%>%
  subset(ssid == 325 & tNo ==38)%>%
  ggplot(aes(timerezero3, pup_velocity))+
  geom_line()

tmp.df4_full_stim_downs_jun2021_60bins%>%
  subset(ssid == 325 & tNo ==38)%>%
  ggplot(aes(timerezero3, pup_basCor))+
  geom_line()

# compared to pupil velocity is much more jerky

# smooth belocity
# number of bins
unique(tmp.df4_full_stim_downs_jun2021_with_behnew$ssid)
tmp.df4_full_stim_downs_jun2021_with_behnew


tmp.df4_full_stim_downs_jun2021_60bins<- tmp.df4_full_stim_downs_jun2021_60bins%>%
  # subset(ssid == 331 & tNo ==40)%>%
  group_by(ssid, tNo)%>%
  arrange(ssid,tNo, timerezero3)%>%
  mutate(pup_vel_smooth = zoo::rollmean(pup_velocity, k = 3, fill = NA))
   ggplot(aes(timerezero3, pup_velocity))+
  geom_line()+
  geom_line(aes(y = pup_vel_smooth), color = 'red')


tmp.df4_full_stim_downs_jun2021_60bins$four<- paste0(tmp.df4_full_stim_downs_jun2021_60bins$mediansplit_sample_arousal2,
                                                     paste0(tmp.df4_full_stim_downs_jun2021_60bins$mediansplit_sample_valence2))
                                                     
# paste0(tmp.df4_full_stim_downs_jun2021_60bins$mediansplit_sample_arousal2)


# unique(tmp.df4_full_stim_downs_jun2021_60bins)


  tmp.df4_full_stim_downs_jun2021_60bins %>%
  subset(ssid_num < 500)%>%
  subset(!is.na(mediansplit_sample_valence2))%>%
  group_by(ssid, tNo)%>%
  arrange(ssid,tNo, timerezero3)%>%
   ggplot(aes(timerezero3, pup_basCor, color = four))+
  stat_smooth(se = F)
  # geom_line(aes(y = pup_vel_smooth), color = 'red')
  
tmp.df4_full_stim_downs_jun2021_60bins %>%
  subset(ssid_num < 500)%>%
  subset(!is.na(mediansplit_sample_valence2))%>%
  group_by(ssid, tNo)%>%
  arrange(ssid,tNo, timerezero3)%>%
   ggplot(aes(timerezero3, pup_velocity, color = four))+
  stat_smooth(se = T)
  # stat_smooth(aes(y = pup_velocity_dir),se = F, linetype = 'dashed')
  # geom_line(aes(y = pup_vel_smooth), color = 'red')


tmp.df4_full_stim_downs_jun2021_60bins %>%
  subset(ssid_num < 500)%>%
  subset(!is.na(mediansplit_sample_valence2))%>%
  group_by(ssid, tNo)%>%
  arrange(ssid,tNo, timerezero3)%>%
   ggplot(aes(timerezero3, pup_velocity_dir, color = four))+
  # stat_summary(fun = mean, geom = 'line')
  stat_smooth(se = T)
  # stat_smooth(aes(y = pup_velocity_dir),se = F, linetype = 'dashed')
  # geom_line(aes(y = pup_vel_smooth), color = 'red')


```

```{r}  
  tmp.df4_full_stim_downs_jun2021_60bins %>%
  subset(ssid_num < 500)%>%
  subset(!is.na(mediansplit_sample_valence2))%>%
  group_by(ssid, tNo)%>%
  arrange(ssid,tNo, timerezero3)%>%
   ggplot(aes(timerezero3, pup_basCor, color = four))+
  stat_smooth(se = F)
  geom_line(aes(y = pup_vel_smooth), color = 'red')
  
  
  tmp.df4_full_stim_downs_jun2021_60bins %>%
  subset(ssid_num < 500)%>%
  subset(!is.na(mediansplit_sample_valence2))%>%
  group_by(ssid, tNo)%>%
  arrange(ssid,tNo, timerezero3)%>%
   ggplot(aes(timerezero3, pup_vel_smooth, color = four))+
  stat_smooth(se = F)
  geom_line(aes(y = pup_vel_smooth), color = 'red')

  
  tmp.df4_full_stim_downs_jun2021_60bins %>%
  subset(ssid_num < 500)%>%
  subset(!is.na(mediansplit_sample_valence2))%>%
  group_by(ssid, tNo)%>%
  arrange(ssid,tNo, timerezero3)%>%
   ggplot(aes(timerezero3, pup_basCor, color = four))+
  stat_smooth(se = F)
  geom_line(aes(y = pup_vel_smooth), color = 'red')



  

```




is velocity correlated with puypil amplitude
```{r}
require(tidyverse)

tmp.df4_full_stim_downs_jun2021_60bins %>%
  group_by(stimIAPS)%>%
  mutate(cor_vel_pup = cor(pup_vel_smooth,pup_basCor, use = 'complete'))%>%
  mutate(vel_max = max(pup_vel_smooth,na.rm = TRUE))%>%
  summarise_if(is.numeric, mean,na.rm = TRUE)%>%
  ggplot(aes(vel_max,pup_basCor))+
  geom_point()+
  geom_smooth(method = 'lm')+
  ggpubr::stat_cor()

```
velocity timecourse
```{r}
# let's test the interaction term
nbins<- unique(tmp.df4_full_stim_downs_jun2021_60bins$timebin_no)
range(tmp.df4_full_stim_downs_jun2021_60bins$timebin_no)

unique(tmp.df4_full_stim_downs_jun2021_60bins$timebin_no)

# nbins = 60 # number of bins

# create and empty dataframe for the timecourse analyses
timecourse_60bin_result_df_vel <- data.frame(timebins= rep(NA, 60), 
                                       Estimate_ar= rep(NA, 60), 
                                       t_ar=rep(NA, 60), 
                                       p_ar=rep(NA, 60),
                                       Estimate_vl= rep(NA, 60), 
                                       t_vl=rep(NA, 60), 
                                       p_vl=rep(NA, 60),
                                       Estimate_br= rep(NA, 60), 
                                       t_br=rep(NA, 60), 
                                       p_br=rep(NA, 60),
                                       Estimate_ar_vl= rep(NA, 60), 
                                       t_ar_vl=rep(NA, 60), 
                                       p_ar_vl=rep(NA, 60),
                                       cov= as.character(rep(NA,60)))

# View(timecourse_result_df)
# nbins<- nbins[1:60]

i = 0 # remember to always rezero it
# b = 10

# rm(i,b)

tmp.df4_full_stim_downs_jun2021_60bins$pup_vel_smooth

nbins<- nbins[3:59]

for (b in 3:length(nbins)) {
  # for (s in 1:length(nsim)) {

    message(sprintf("$$$$$RUNING lmer %i", nbins[b]))
        lmer_bin_pup  <- lmer(pup_velocity ~ (arousal_c* valence)+Mean_gray_z  +
                                (1 | ssid),
                                # (0 +arousal_c* valence | ssid),
                                # (1|stimIAPS),
                              REML = FALSE,
                      data = subset(tmp.df4_full_stim_downs_jun2021_60bins,
                                    !is.na(pup_velocity)&
                                     Group == "NT" &
                                    timebin_no == nbins[b]))

        # store results from the simulation
            lmer_bin_pup_summary<- summary(lmer_bin_pup)
            lmer_bin_pup_summary
            # lmer_bin_pup_summary[["coefficients"]][3,1]
            timecourse_60bin_result_df_vel[i,1]<- tmp.df4_full_stim_downs_jun2021_60bins$timerezero3[b] 
            #save the exact value of time bin
            # store arousal (2,parameter)            # first number is term(row), second is column
            timecourse_60bin_result_df_vel[i,2]<-
            lmer_bin_pup_summary[["coefficients"]][2,1] #estimate
            timecourse_60bin_result_df_vel[i,3]<-
              lmer_bin_pup_summary[["coefficients"]][2,4] # t statistic
            timecourse_60bin_result_df_vel[i,4]<-
            lmer_bin_pup_summary[["coefficients"]][2,5] # p value
            
            # valence
            
            timecourse_60bin_result_df_vel[i,5]<-
            lmer_bin_pup_summary[["coefficients"]][3,1] #estimate
            timecourse_60bin_result_df_vel[i,6]<-
              lmer_bin_pup_summary[["coefficients"]][3,4] # t statistic
            timecourse_60bin_result_df_vel[i,7]<-
              lmer_bin_pup_summary[["coefficients"]][3,5] # p value
            
            # brighteness
            
            timecourse_60bin_result_df_vel[i,8]<-
            lmer_bin_pup_summary[["coefficients"]][4,1] #estimate
            timecourse_60bin_result_df_vel[i,9]<-
              lmer_bin_pup_summary[["coefficients"]][4,4] # t statistic
            timecourse_60bin_result_df_vel[i,10]<-
              lmer_bin_pup_summary[["coefficients"]][4,5] # p value
            
            # interaction arousal x brighteness
            
            timecourse_60bin_result_df_vel[i,11]<-
            lmer_bin_pup_summary[["coefficients"]][5,1] #estimate
            timecourse_60bin_result_df_vel[i,12]<-
              lmer_bin_pup_summary[["coefficients"]][5,4] # t statistic
            timecourse_60bin_result_df_vel[i,13]<-
              lmer_bin_pup_summary[["coefficients"]][5,5] # p value
            
            
            timecourse_60bin_result_df_vel[i,14] <-
              ifelse(length(lmer_bin_pup_summary$optinfo$conv$lme4$message)
                                                   != 0,
                                               lmer_bin_pup_summary$optinfo$conv$lme4$message, 'pass')

     i = i+1
}
# timecourse_result_df_pos<- timecourse_result_df
View(timecourse_60bin_result_df_vel)

timecourse_60bin_result_df_vel %>%
  ggplot(aes(timebins, t))+
  geom_line(size = 2)+
  geom_line(aes(y = p), linetype = "dashed", size = 2)+
  geom_hline(yintercept = .05, color = 'red', size = 1.5)

View(timecourse_60bin_result_df_vel)

range(timecourse_60bin_result_df_vel$Estimate_ar, na.rm = TRUE)
timecourse_60bin_result_df_vel %>%
  subset(!is.na(Estimate_ar))%>%
  ggplot(aes(timebins, Estimate_ar))+
  geom_line(size = 1)+
  geom_line(aes(y = Estimate_vl), linetype = "dashed", size = 1)+
  geom_line(aes(y = Estimate_br), linetype = "dotted", size = 1)+
  geom_line(aes(y = Estimate_ar_vl), linetype = "dotdash", size = 1, color = "red")+
  geom_hline(yintercept = 0.2)
  ylim(-.1,.25)
  
```

```{r}
# adjust p values and tag as TRUE whenevee there is at least 3 consecutive p values below .05

```


mutate(ANC=rollapply(ANC, width=3, max, align="left", fill=NA, na.rm=TRUE)) %>%
  filter(ANC >= 0.5) %>%  
  filter(row_number() == 1)
  
  
```{r}
timecourse_60bin_result_df_vel$p_ar_adj<- p.adjust(timecourse_60bin_result_df_vel$p_ar, method = "holm")
timecourse_60bin_result_df_vel$p_ar_adj_TRUE<- if_else(timecourse_60bin_result_df_vel$p_ar_adj<.05, TRUE, FALSE)


timecourse_60bin_result_df_vel$p_vl_adj <- p.adjust(timecourse_60bin_result_df_vel$p_vl, method = "holm")
timecourse_60bin_result_df_vel$p_vl_adj_TRUE<- if_else(timecourse_60bin_result_df_vel$p_vl_adj<.05, TRUE, FALSE)

timecourse_60bin_result_df_vel$p_br_adj <- p.adjust(timecourse_60bin_result_df_vel$p_br, method = "holm")
timecourse_60bin_result_df_vel$p_br_adj_TRUE<- if_else(timecourse_60bin_result_df_vel$p_br_adj<.05, TRUE, FALSE)

timecourse_60bin_result_df_vel$p_ar_vl_adj <- p.adjust(timecourse_60bin_result_df_vel$p_ar_vl, method = "holm")
timecourse_60bin_result_df_vel$p_ar_vl_adj_TRUE<- if_else(timecourse_60bin_result_df_vel$p_ar_vl_adj<.05, TRUE, NULL)

# find the first and last true in a sequence of TRUES
duplicated(timecourse_60bin_result_df_vel$p_ar_adj_TRUE, na.rm = TRUE)

# https://masterr.org/r/how-to-find-consecutive-repeats-in-r/
timecourse_60bin_result_df_vel$test<- NULL

timecourse_60bin_result_df_vel$test <- rle(timecourse_60bin_result_df_vel$p_ar < 0.05)
# View(runs)
# 
# runs[2]
# myruns = which(runs$values == TRUE & runs$lengths >= 3)

View(timecourse_60bin_result_df_vel)
```

```{r}

View(timecourse_60bin_result_df_vel)
#  let's use the order arousal, valence, arousal x valence brightness

plots_timecourse$eff_size_pup_velocity<-
timecourse_60bin_result_df_vel %>% 
  select("timebins","Estimate_ar", "Estimate_vl", "Estimate_br", "Estimate_ar_vl") %>% 
  pivot_longer(-timebins, names_to = "variable", values_to = "Estimate")%>%
    subset(!is.na(Estimate))%>%
  #change the order of the coloring variable here and the name of legends
  mutate(variable = factor(variable, c("Estimate_ar", "Estimate_vl","Estimate_ar_vl",  "Estimate_br"), labels = c("arousal", "valence", "arousal x valence", "brightness")))%>%
  ggplot(aes(timebins, Estimate, group = variable, color= variable))+
  geom_line(aes(linetype = variable), size = 1)+
  
  scale_color_brewer(palette = "Dark2")+
    # scale_color_manual(values=c("#1B9E77", "#D95F02", "#7570B3", "#E7298A"))+
  # use hom correction for significance
  
    # brighteness
    # timecourse_60bin_result_df_vel$timebins[timecourse_60bin_result_df_vel$p_br_adj_TRUE == TRUE]
  
    annotate(geom = 'rect', # use annotate instead of geom_rect, as it is more flexible
             xmin = .37, # got these values from the data-frame. need to fidn a way to automate this
                xmax = .81,
                ymin = -2.03+(sf*1.2), # if I ever need to change this, use the scaling factor sf
                ymax = -2+.1+.01+(sf*1.2),
                fill =  "#E7298A" , alpha = .5)+
    
      # annotate("text", 
      #           x = (1+5.4)/2,
      #           y = ((-2) +(-2+.1))/2+(sf*.3),
      #           label = "brightness") +
    
    # arousal
  
    # timecourse_60bin_result_df$p_ar_adj
      
    # timecourse_60bin_result_df_vel$timebins[timecourse_60bin_result_df_vel$p_ar_adj_TRUE == TRUE]
    
    # timecourse_60bin_result_df_vel$timebins
    
    annotate(geom = 'rect', 
              xmin = 1.028329,
                xmax = 1.028329+.1,
                ymin = -2.03+.1+.1+.1+.1+(sf*1.2),
                ymax = -2+.1+.1+.1+.1+.1+.01+(sf*1.2),
                fill = "#1B9E77", alpha = .5)+
        # annotate("text", 
        #           x = (1+5.4)/2,
        #         y = ((-2+.1+.1+.1+.1) +(-2+.1+.1+.1+.1+.1))/2+(sf*.3),
        #          label = "arousal") +

    # arousal-valence
   # timecourse_60bin_result_df$p_ar_vl_adj
    # timecourse_60bin_result_df_vel$timebins[timecourse_60bin_result_df_vel$p_ar_vl_adj_TRUE == TRUE]
       annotate(geom = 'rect', 
                xmin = 5.5730353,
                xmax = 5.5730353+.1,
                ymin = -2.03+.1+.1+(sf*1.2),
                ymax = -2+.1+.1+.1+.01+(sf*1.2),
                
                fill ="#7570B3", alpha = .5, label = "text")+
    
  # annotate("text", 
  #               x = (1+5.4)/2,
  #               y = ((-2+.1+.1) +(-2+.1+.1+.1))/2+(sf*.3),
  #               label = "arousal x valence") +
        xlab("Time (s)")+
    ylab("Effect size")+
    xlab("Time (s)")+
    ylab("Effect size")

plots_timecourse$eff_size_pup_velocity
# need to rename the label legends


# Edit legend title and labels
plots_timecourse$eff_size_pup_velocity

plots_timecourse$eff_size_pup_velocity<- plots_timecourse$eff_size_pup_velocity + 
  p$graphstyle +
    guides(colour = guide_legend(override.aes = list(size=2)))+ #the line size of the legend tends to be smaller in print
  scale_x_continuous(limits = c(0,6), breaks = c(0,2,4,6))+
  scale_y_continuous(limits = c(-1,1.5), breaks = c(-0.5, 0,0.5,1))
  

plots_timecourse$eff_size_pup_velocity
plots_timecourse$eff_size_pup_amp

```


velocity = actual velocity unlike speed (which is what I actually computed above. velocity encodes direction( constriction or dilation)


use the same datas timecourse to plot aggregated analyses
aggregate arousal plot
```{r}

db_full4new_stim_screen_pupil_nopract$ground_valence_2<-
  cut(db_full4new_stim_screen_pupil_nopract$ValenceMean, c(0,4,5,9), 
                                                              labels = c("negative", "neutral", "positive"))


db_full4new_stim_screen_pupil_nopract$sample_valence_lab2<-
  cut(db_full4new_stim_screen_pupil_nopract$ValenceMeanThisSample, c(-10,-3,3,10), 
                                                              labels = c("negative", "neutral", "positive"))



db_full4new_stim_screen_pupil_nopract$ground_arousal_2<-
  cut(db_full4new_stim_screen_pupil_nopract$ArousalMean, c(0,4,5,9), 
                                                              labels = c("low", "mid", "high"))

db_full4new_stim_screen_pupil_nopract$sample_arousal_lab2<-
  cut(db_full4new_stim_screen_pupil_nopract$ArousalMeanThisSample, c(-10,-3,3,10), 
                                                              labels = c("low", "mid", "high"))





subset(db_full4new_stim_screen_pupil_nopract, 
                                    pupil_outlier == FALSE & ssid_num<500 & 
                                      arousal_outler == FALSE)%>%
  ggplot(aes(sample_valence_lab2, arousal))+
  geom_point()+
  stat_summary(geom = 'pointrange')



subset(db_full4new_stim_screen_pupil_nopract, 
                                    pupil_outlier == FALSE & ssid_num<500 & 
                                      arousal_outler == FALSE)%>%
  group_by(ssid, mediansplit_ground_valence, mediansplit_ground_arousal)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(mediansplit_ground_valence, pup_resid_lm, color = mediansplit_ground_arousal ))+
  # geom_point()+
  stat_summary(geom = 'pointrange')
  


subset(db_full4new_stim_screen_pupil_nopract, 
                                    pupil_outlier == FALSE & ssid_num<500 & 
                                      arousal_outler == FALSE)%>%
  group_by(ssid, mediansplit_ground_valence, mediansplit_ground_arousal)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(mediansplit_ground_valence, pup_resid_lm, color = mediansplit_ground_arousal ))+
  # geom_point()+
  stat_summary(geom = 'pointrange')
  


plots_paper$interaction_ar_vl

# correlation plot

plots_paper$pupil_correlation <-   db_full4new_stim_screen_pupil_nopract %>%
  subset(Group == "NT")%>%
    # subset(ssid_num<500)%>%
  subset(pupil_outlier == FALSE & arousal_outler == FALSE)%>%
   group_by(ssid,Alexithymia, mediansplit_ground_valence)%>%
    mutate(cortest = cor.test(arousal_c, pup_basCor)$estimate)%>%
   group_by(ssid,Alexithymia, mediansplit_ground_valence)%>%
    summarise_if(is.numeric, mean, na.rm = TRUE)%>%
     ggplot(aes(mediansplit_ground_valence, cortest, fill = mediansplit_ground_valence))+
     geom_bar(stat="summary", fun.y = "mean", alpha = .5)+
     geom_jitter(width = .1, alpha = .1)+
        stat_summary( geom = 'pointrange')+
        stat_summary(aes(group = ssid), geom = 'line', alpha = .1)+
    ylab("R sujective vs pupil arousal")+
     scale_fill_brewer(palette = "Dark2")+
     p$graphstyle+
     theme(axis.title.x = element_blank())
   
plots_paper$pupil_correlation  




# timecourse plot pupil

tmp.df4_full_stim_downs_jun2021_60bins$sample_arousal_lab2<-
  cut(tmp.df4_full_stim_downs_jun2021_60bins$ArousalMeanThisSample, 3, 
                                                              labels = c("low", "mid", "high"))



tmp.df4_full_stim_downs_jun2021_60bins$sample_valence_lab2<-
  cut(tmp.df4_full_stim_downs_jun2021_60bins$ValenceMeanThisSample, 3 , 
                                                              labels = c("negative", "mid", "positive"))

tmp.df4_full_stim_downs_jun2021_60bins$newvalence <- if_else(tmp.df4_full_stim_downs_jun2021_60bins$sample_valence_lab2 == "mid" & tmp.df4_full_stim_downs_jun2021_60bins$sample_arousal_lab2 == "mid", "neutral", 
                                                             if_else(tmp.df4_full_stim_downs_jun2021_60bins$ValenceMeanThisSample> median(tmp.df4_full_stim_downs_jun2021_60bins$ValenceMeanThisSample, na.rm = TRUE), "positive", "negative")
                                                           )

table(tmp.df4_full_stim_downs_jun2021_60bins$newvalence)
unique(tmp.df4_full_stim_downs_jun2021_60bins$newvalence)

test<- tmp.df4_full_stim_downs_jun2021_60bins %>%
  subset(ssid_num<500)%>%
  subset(!is.na(ground_arousal_lab))%>%
  # subset(stimIAPS!= "4573")%>%
  # subset(pupil_outlier == FALSE)%>%
  # subset(arousal_outler== FALSE)%>%
  group_by(mediansplit_sample_valence2)%>%
  mutate(mediantotes = median(ArousalMeanThisSample, na.rm = TRUE))%>%
  ungroup()%>%
  group_by(mediansplit_sample_valence2)%>%
  mutate(high_lowtes = if_else(arousal> mediantotes, "high", "low"))

tmp.df4_full_stim_downs_jun2021_60bins %>%
  subset(ssid_num<500)%>%
  subset(!is.na(ground_arousal_lab))%>%
  # subset(stimIAPS!= "4573")%>%
  # subset(pupil_outlier == FALSE)%>%
  # subset(arousal_outler== FALSE)%>%
  # group_by(mediansplit_sample_valence2)%>%
  # mutate(mediantotes = median(ArousalMeanThisSample, na.rm = TRUE))%>%
  # ungroup()%>%
  # group_by(mediansplit_sample_valence2)%>%
  # mutate(high_lowtes = if_else(arousal> mediantotes, "high", "low")) %>%
  ggplot(aes(x = timerezero3, y = pup_basCor))+
  # stat_summary(geom = 'pointrange')+
    # facet_grid(~mediansplit_self_valence)
  
  # stat_smooth(aes(group= stimIAPS, color = sample_arousal_lab2), fun = mean,
               # se = F, alpha = .15, size = 1.5)+
  stat_smooth(aes(group=sample_arousal_lab2, color = sample_arousal_lab2), size = 3)+
  # stat_summary(aes(group=stimIAPS, color = high_lowtes), fun = mean, geom = "pointrange")+
theme_classic()+
  ylab("Pupil size (z)")+
  xlab("Time (s)")+
  # geom_text(aes(label = stimIAPS))+
  # p$graphstyle+
  scale_color_brewer(palette = "Dark2")


tmp.df4_full_stim_downs_jun2021_60bins %>%
  subset(ssid_num<500)%>%
  subset(!is.na(ground_arousal_lab))%>%
  # subset(stimIAPS!= "4573")%>%
  # subset(pupil_outlier == FALSE)%>%
  # subset(arousal_outler== FALSE)%>%
  # group_by(mediansplit_sample_valence2)%>%
  # mutate(mediantotes = median(ArousalMeanThisSample, na.rm = TRUE))%>%
  # ungroup()%>%
  # group_by(mediansplit_sample_valence2)%>%
  # mutate(high_lowtes = if_else(arousal> mediantotes, "high", "low")) %>%
  ggplot(aes(x = timerezero3, y = pup_basCor))+
  # stat_summary(geom = 'pointrange')+
    # facet_grid(~mediansplit_self_valence)
  
  # stat_smooth(aes(group= stimIAPS, color = sample_valence_lab2), fun = mean,
  #              se = F, alpha = .15, size = 1.5)+
  stat_smooth(aes(group=newvalence, color = newvalence), size = 3)+
  # stat_summary(aes(group=stimIAPS, color = high_lowtes), fun = mean, geom = "pointrange")+
theme_classic()+
  ylab("Pupil size (z)")+
  xlab("Time (s)")+
  # geom_text(aes(label = stimIAPS))+
  # p$graphstyle+
  scale_color_brewer(palette = "Dark2")
  facet_grid(~newvalence)

```
  # xlim(0,6)+
  facet_grid(~mediansplit_sample_valence2)
```{r}
# plot separatelly




test<- tmp.df4_full_stim_downs_jun2021_60bins %>%
  subset(ssid_num<500)%>%
  subset(!is.na(ground_arousal_lab))%>%
  # subset(stimIAPS!= "4573")%>%
  # subset(pupil_outlier == FALSE)%>%
  # subset(arousal_outler== FALSE)%>%
  group_by(mediansplit_sample_valence2)%>%
  mutate(mediantotes = median(ArousalMeanThisSample, na.rm = TRUE))%>%
  ungroup()%>%
  group_by(mediansplit_sample_valence2)%>%
  mutate(high_lowtes = if_else(arousal> mediantotes, "high", "low"))

tmp.df4_full_stim_downs_jun2021_60bins %>%
  subset(ssid_num<500)%>%
  subset(!is.na(ground_arousal_lab))%>%
  # subset(stimIAPS!= "4573")%>%
  # subset(pupil_outlier == FALSE)%>%
  # subset(arousal_outler== FALSE)%>%
  # group_by(mediansplit_sample_valence2)%>%
  # mutate(mediantotes = median(ArousalMeanThisSample, na.rm = TRUE))%>%
  # ungroup()%>%
  # group_by(mediansplit_sample_valence2)%>%
  # mutate(high_lowtes = if_else(arousal> mediantotes, "high", "low")) %>%
  ggplot(aes(x = timerezero3, y = pup_basCor))+
  # stat_summary(geom = 'pointrange')+
    # facet_grid(~mediansplit_self_valence)
  
  # stat_smooth(aes(group= stimIAPS, color = sample_arousal_lab2), fun = mean,
  #              se = F, alpha = .15, size = 1.5)+
  stat_smooth(aes(group=sample_arousal_lab2, color = sample_arousal_lab2), size = 3)+
  # stat_summary(aes(group=stimIAPS, color = high_lowtes), fun = mean, geom = "pointrange")+
theme_classic()+
  ylab("Pupil size (z)")+
  xlab("Time (s)")+
  # geom_text(aes(label = stimIAPS))+
  # p$graphstyle+
  scale_color_brewer(palette = "Dark2")
  # xlim(0,6)+
  facet_grid(~mediansplit_sample_valence2)
  
  
  tmp.df4_full_stim_downs_jun2021_60bins %>%
  subset(ssid_num<500)%>%
  subset(!is.na(ground_arousal_lab))%>%
  # subset(stimIAPS!= "4573")%>%
  # subset(pupil_outlier == FALSE)%>%
  # subset(arousal_outler== FALSE)%>%
  # group_by(mediansplit_sample_valence2)%>%
  # mutate(mediantotes = median(ArousalMeanThisSample, na.rm = TRUE))%>%
  # ungroup()%>%
  # group_by(mediansplit_sample_valence2)%>%
  # mutate(high_lowtes = if_else(arousal> mediantotes, "high", "low")) %>%
  ggplot(aes(x = timerezero3, y = pup_basCor))+
  # stat_summary(geom = 'pointrange')+
    # facet_grid(~mediansplit_self_valence)
  
  # stat_smooth(aes(group= stimIAPS, color = sample_arousal_lab2), fun = mean,
  #              se = F, alpha = .15, size = 1.5)+
  stat_smooth(aes(group=sample_arousal_lab2, color = sample_arousal_lab2), size = 3)+
  # stat_summary(aes(group=stimIAPS, color = high_lowtes), fun = mean, geom = "pointrange")+
theme_classic()+
  ylab("Pupil size (z)")+
  xlab("Time (s)")+
  # geom_text(aes(label = stimIAPS))+
  # p$graphstyle+
  scale_color_brewer(palette = "Dark2")


# negative

tmp.df4_full_stim_downs_jun2021_60bins %>%
  subset(ssid_num<500)%>%
  subset(!is.na(ground_arousal_lab))%>%
  subset(mediansplit_sample_valence2 != "More negative")%>%
  mutate(mediantotes = median(arousal, na.rm = TRUE))%>%
  ungroup()%>%
  mutate(high_lowtes = if_else(arousal> mediantotes, "high", "low")) %>%
  ggplot(aes(x = timerezero3, y = pup_basCor))+
  # stat_smooth(aes(group= stimIAPS), fun = mean,
               # se = F, alpha = .15, size = 1.5)+
  geom_smooth(aes(group = high_lowtes))+
  # stat_smooth(fun = mean,
  #              se = F, alpha = .15, size = 3)+
theme_classic()+
  ylab("Pupil size (z)")+
  xlab("Time (s)")+
  # geom_text(aes(label = stimIAPS))+
  # p$graphstyle+
  scale_color_brewer(palette = "Dark2")
  # xlim(0,6)+
  facet_grid(~ high_lowtes)+
  geom_hline(yintercept = 0)+
  geom_hline(yintercept = -0.5)

  
```


# start wit aggregate()

# tmp.df4_full_stim_downs_jun2021_60bins%>%


tmp.df4_full_stim_downs_jun2021_60bins %>%
  subset(ssid_num<500)%>%
  subset(!is.na(ground_arousal_lab))%>%
  subset(stimIAPS!= "4573")%>%
  subset(pupil_outlier == FALSE)%>%
  group_by(stimIAPS,stimDescription, mediansplit_sample_arousal2, mediansplit_sample_valence2)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
    group_by(mediansplit_sample_valence2)%>%
  mutate(high_lowtes = if_else(arousal> median(arousal, na.rm = TRUE), "high", "low"))%>%
  ggplot(aes(x =high_lowtes , y = pup_basCor))+
  stat_summary(geom = 'pointrange')+
  facet_grid(~mediansplit_sample_valence2)+
  geom_text(aes(label = stimDescription))


tmp.df4_full_stim_downs_jun2021_60bins %>%
  subset(ssid_num<500)%>%
  subset(!is.na(ground_arousal_lab))%>%
  subset(stimIAPS!= "4573")%>%
  subset(pupil_outlier == FALSE)%>%
  group_by(stimIAPS,stimDescription, mediansplit_sample_arousal2, mediansplit_sample_valence2)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
    group_by(mediansplit_sample_valence2)%>%
  mutate(high_lowtes = if_else(arousal> median(arousal, na.rm = TRUE), "high", "low"))%>%
  ggplot(aes(x =high_lowtes , y = Mean_gray_z))+
  stat_summary(geom = 'pointrange')+
  facet_grid(~mediansplit_sample_valence2)+
  geom_text(aes(label = stimDescription))
    # facet_grid(~mediansplit_self_valence)
  # stat_smooth(aes(group= stimIAPS, color = sample_arousal_lab2), fun = median,geom = "line",
               # se = F, alpha = .1, size = 1.5)+
  stat_smooth(aes(group=mediansplit_sample_arousal2, color = mediansplit_sample_arousal2), size = 3)+
  # stat_summary(aes(group=sample_arousal_lab2, color = sample_arousal_lab2), fun = mean, geom = "pointrange")+
theme_classic()+
  ylab("Pupil size (z)")+
  xlab("Time (s)")+
  # geom_text(aes(label = stimIAPS))+
  # p$graphstyle+
  scale_color_brewer(palette = "Dark2")+
  xlim(0,6)+
  facet_grid(~mediansplit_self_valence)



```{r}
# let's test the interaction term
nbins<- unique(tmp.df4_full_stim_downs_jun2021_60bins$timebin_no)
range(tmp.df4_full_stim_downs_jun2021_60bins$timebin_no)

unique(tmp.df4_full_stim_downs_jun2021_60bins$timebin_no)

# nbins = 60 # number of bins

# create and empty dataframe for the timecourse analyses
timecourse_60bin_result_df_vel_dir <- data.frame(timebins= rep(NA, 60), 
                                       Estimate_ar= rep(NA, 60), 
                                       t_ar=rep(NA, 60), 
                                       p_ar=rep(NA, 60),
                                       Estimate_vl= rep(NA, 60), 
                                       t_vl=rep(NA, 60), 
                                       p_vl=rep(NA, 60),
                                       Estimate_br= rep(NA, 60), 
                                       t_br=rep(NA, 60), 
                                       p_br=rep(NA, 60),
                                       Estimate_ar_vl= rep(NA, 60), 
                                       t_ar_vl=rep(NA, 60), 
                                       p_ar_vl=rep(NA, 60),
                                       cov= as.character(rep(NA,60)))


i = 0 # remember to always rezero it
# rm(i,b)

# i =1

for (b in 3:length(nbins)) {
  # for (s in 1:length(nsim)) {

    message(sprintf("$$$$$RUNING lmer %i", nbins[b]))
        lmer_bin_pup  <- lmer(pup_velocity_dir ~ (arousal_c* valence)+Mean_gray_z  +
                                (1 | ssid),
                                # (0 +arousal_c* valence | ssid),
                                # (1|stimIAPS),
                              REML = FALSE,
                      data = subset(tmp.df4_full_stim_downs_jun2021_60bins,
                                    ssid_num< 500&
                                    !is.na(pup_vel_smooth) &
                                    timebin_no == nbins[b]))

        # store results from the simulation
            lmer_bin_pup_summary<- summary(lmer_bin_pup)
            lmer_bin_pup_summary
            # lmer_bin_pup_summary[["coefficients"]][3,1]
            timecourse_60bin_result_df_vel_dir[i,1]<- tmp.df4_full_stim_downs_jun2021_60bins$timerezero3[b] 
            #save the exact value of time bin
            # store arousal (2,parameter)            # first number is term(row), second is column
            timecourse_60bin_result_df_vel_dir[i,2]<-
            lmer_bin_pup_summary[["coefficients"]][2,1] #estimate
            timecourse_60bin_result_df_vel_dir[i,3]<-
              lmer_bin_pup_summary[["coefficients"]][2,4] # t statistic
            timecourse_60bin_result_df_vel_dir[i,4]<-
            lmer_bin_pup_summary[["coefficients"]][2,5] # p value
            
            # valence
            
            timecourse_60bin_result_df_vel_dir[i,5]<-
            lmer_bin_pup_summary[["coefficients"]][3,1] #estimate
            timecourse_60bin_result_df_vel_dir[i,6]<-
              lmer_bin_pup_summary[["coefficients"]][3,4] # t statistic
            timecourse_60bin_result_df_vel_dir[i,7]<-
              lmer_bin_pup_summary[["coefficients"]][3,5] # p value
            
            # brightness
            
            timecourse_60bin_result_df_vel_dir[i,8]<-
            lmer_bin_pup_summary[["coefficients"]][4,1] #estimate
            timecourse_60bin_result_df_vel_dir[i,9]<-
              lmer_bin_pup_summary[["coefficients"]][4,4] # t statistic
            timecourse_60bin_result_df_vel_dir[i,10]<-
              lmer_bin_pup_summary[["coefficients"]][4,5] # p value
            
            # interaction arousal x brighteness
            
            timecourse_60bin_result_df_vel_dir[i,11]<-
            lmer_bin_pup_summary[["coefficients"]][5,1] #estimate
            timecourse_60bin_result_df_vel_dir[i,12]<-
              lmer_bin_pup_summary[["coefficients"]][5,4] # t statistic
            timecourse_60bin_result_df_vel_dir[i,13]<-
              lmer_bin_pup_summary[["coefficients"]][5,5] # p value
            
            
            timecourse_60bin_result_df_vel_dir[i,14] <-
              ifelse(length(lmer_bin_pup_summary$optinfo$conv$lme4$message)
                                                   != 0,
                                               lmer_bin_pup_summary$optinfo$conv$lme4$message, 'pass')

     i = i+1
}
# timecourse_result_df_pos<- timecourse_result_df
View(timecourse_60bin_result_df_vel_dir)

View(timecourse_60bin_result_df_vel_dir)

timecourse_60bin_result_df_vel_dir %>%
  ggplot(aes(timebins, Estimate_ar))+
  geom_line(size = 1)+
  geom_line(aes(y = Estimate_vl), linetype = "dashed", size = 1)+
  geom_line(aes(y = Estimate_br), linetype = "dotted", size = 1)+
  geom_line(aes(y = Estimate_ar_vl), linetype = "dotdash", size = 1, color = "red")
  ylim(-.1,5)
  
  
# adjust p values and tag as TRUE whenevee there is at least 3 consecutive p values below .05
?p.adjust
timecourse_60bin_result_df_vel_dir$p_ar_adj<- p.adjust(timecourse_60bin_result_df_vel_dir$p_ar, method = "holm")
timecourse_60bin_result_df_vel_dir$p_ar_adj_TRUE<- if_else(timecourse_60bin_result_df_vel_dir$p_ar_adj<.05, TRUE, FALSE)


timecourse_60bin_result_df_vel_dir$p_vl_adj <- p.adjust(timecourse_60bin_result_df_vel_dir$p_vl, method = "holm")
timecourse_60bin_result_df_vel_dir$p_vl_adj_TRUE<- if_else(timecourse_60bin_result_df_vel_dir$p_vl_adj<.05, TRUE, FALSE)

timecourse_60bin_result_df_vel_dir$p_br_adj <- p.adjust(timecourse_60bin_result_df_vel_dir$p_br, method = "holm")
timecourse_60bin_result_df_vel_dir$p_br_adj_TRUE<- if_else(timecourse_60bin_result_df_vel_dir$p_br_adj<.05, TRUE, FALSE)

timecourse_60bin_result_df_vel_dir$p_ar_vl_adj <- p.adjust(timecourse_60bin_result_df_vel_dir$p_ar_vl, method = "holm")
timecourse_60bin_result_df_vel_dir$p_ar_vl_adj_TRUE<- if_else(timecourse_60bin_result_df_vel_dir$p_ar_vl_adj<.05, TRUE, NULL)

# find the first and last true in a sequence of TRUES
duplicated(timecourse_60bin_result_df_vel_dir$p_ar_adj_TRUE, na.rm = TRUE)

# https://masterr.org/r/how-to-find-consecutive-repeats-in-r/
timecourse_60bin_result_df_vel_dir$test<- NULL

timecourse_60bin_result_df_vel_dir$test <- rle(timecourse_60bin_result_df_vel_dir$p_ar < 0.05)
```



SCR
```{r}

db_full4new_stim_screen_pupil_nopract_nt<- subset(db_full4new_stim_screen_pupil_nopract, Group == "NT")

unique(db_full4new_stim_screen_pupil_nopract_nt$screencontent)
db_full4new_stim_screen_pupil_nopract_nt_304<- subset(db_full4new_stim_screen_pupil_nopract_nt, ssid_num>303)

db_full4new_stim_screen_pupil_nopract_nt_304

db_full4new_stim_screen_pupil_nopract_nt_304<- db_full4new_stim_screen_pupil_nopract_nt_304%>%
  ungroup%>%
  mutate(valence_c = scale(valence, center = TRUE, scale = TRUE)[,1])%>%
  mutate(arousal_c = scale(arousal, center = TRUE, scale = TRUE)[,1])%>%
  mutate(TASc = scale(TAS, center = TRUE, scale = TRUE)[,1])

# models
table(is.na(db_full4new_stim_screen_pupil_nopract_nt_304$BIO_CDA.SCR))

pupil_arousal_findings$arousal_scr <- lmer(log(BIO_CDA.SCR+.1) ~ arousal_c*valence_c +
                                             (1|ssid) + (1|stimIAPS),
                        REML = FALSE,
                        data = subset(db_full4new_stim_screen_pupil_nopract_nt_304))

summary(pupil_arousal_findings$arousal_scr)

interactions::interact_plot(pupil_arousal_findings$arousal_scr, pred = arousal_c, modx = valence_c)


# arousal_BIO_CDA.AmpSum
pupil_arousal_findings$arousal_BIO_CDA.AmpSum <- lmer(log(BIO_CDA.AmpSum+.1) ~ arousal_c*valence_c +
                                             (1|ssid) + (1|stimIAPS),
                        REML = FALSE,
                        data = subset(db_full4new_stim_screen_pupil_nopract_nt_304))

summary(pupil_arousal_findings$arousal_BIO_CDA.AmpSum)

interactions::interact_plot(pupil_arousal_findings$arousal_BIO_CDA.AmpSum, pred = arousal_c, modx = valence_c)


# BIO_CDA.ISCR
pupil_arousal_findings$BIO_CDA.ISCR <- lmer(log(BIO_CDA.ISCR+.1) ~ arousal_c*valence_c +
                                             (1+valence_c|ssid) + (1|stimIAPS),
                        REML = FALSE,
                        data = subset(db_full4new_stim_screen_pupil_nopract_nt_304))

summary(pupil_arousal_findings$BIO_CDA.ISCR)

interactions::interact_plot(pupil_arousal_findings$BIO_CDA.ISCR, pred = arousal_c, modx = valence_c)


# phasic
unique(db_full4new_stim_screen_pupil_nopract_nt_304$ssid)

pupil_arousal_findings$BIO_CDA.PhasicMax <- lmer(log1p(BIO_CDA.PhasicMax+.1) ~ arousal_c * valence_c + (1|ssid),
                        REML = FALSE,
                        data = db_full4new_stim_screen_pupil_nopract_nt_304)

summary(pupil_arousal_findings$BIO_CDA.PhasicMax)
anova(pupil_arousal_findings$arousal_phas_max)
interactions::interact_plot(pupil_arousal_findings$BIO_CDA.PhasicMax, pred = arousal_c, modx = valence_c)

interactions::interact_plot(pupil_arousal_findings$BIO_CDA.PhasicMax, pred =valence_c , modx =  arousal_c)

# Global
unique(db_full4new_stim_screen_pupil_nopract_nt_304$ssid)

pupil_arousal_findings$BIO_Global.Mean <- lmer(log1p(BIO_Global.Mean+.1) ~ arousal_c * valence_c + (1|ssid)+ (1|stimIAPS),
                        REML = FALSE,
                        data = db_full4new_stim_screen_pupil_nopract_nt_304)

# TTP
table(is.na(db_full4new_stim_screen_pupil_nopract_nt_304$BIO_TTP.AmpSum))
pupil_arousal_findings$BIO_TTP.AmpSum <- lmer(log1p(BIO_TTP.AmpSum+.1) ~ arousal_c * valence_c + (1|ssid)+ (1|stimIAPS),
                        REML = FALSE,
                        data = db_full4new_stim_screen_pupil_nopract_nt_304)

summary(pupil_arousal_findings$BIO_TTP.AmpSum)


anova(pupil_arousal_findings$arousal_phas_max)
interactions::interact_plot(pupil_arousal_findings$BIO_CDA.PhasicMax, pred = arousal_c, modx = valence_c)

interactions::interact_plot(pupil_arousal_findings$BIO_CDA.PhasicMax, pred =valence_c , modx =  arousal_c)



# alexithymia
table(is.na(db_full4new_stim_screen_pupil_nopract_nt_304$BIO_CDA.PhasicMax))
interactions::interact_plot(pupil_arousal_findings$BIO_CDA.PhasicMax, pred = arousal_c, modx = valence_c)
pupil_arousal_findings$BIO_CDA.ISCR_TAS <- lmer(log(BIO_CDA.AmpSum +.1) ~ arousal_c+
                                             (1|ssid) + (1|stimIAPS),
                        REML = FALSE,
                        data = subset(db_full4new_stim_screen_pupil_nopract_nt_304$gsr_basCor))
summary(pupil_arousal_findings$BIO_CDA.ISCR_TAS)

# table(is.na(db_full4new_stim_screen_pupil_nopract_nt_304

# collapsed
```


Heart rate

```{r}

# keep stim and and fixation
unique(db_full6new$screencontent)
unique(db_full6new$screencontent_no)
colnames(db_full6new)

# 345:355
library(readr)
library(readr)
 # read_csv("tmp.df4_sum_full_bio_hr_self_parsed_345_356.csv")
View(tmp_df4_sum_full_bio_hr_self_parsed_345_356)

# tmp.df4_sum_full_bio_hr_self_parsed_345_356.csv
db_HR_bio_final_346_355_withfix <-  read_csv("tmp.df4_sum_full_bio_hr_self_parsed_345_356.csv")
View(db_HR_bio_final_346_355_withfix)

db_HR_bio_final_346_355_withfix$screencontent<- db_HR_bio_final_346_355_withfix$screen_content
db_HR_bio_final_346_355_withfix<- subset(db_HR_bio_final_346_355_withfix, tNo > -7)

db_HR_bio_final_346_355_withfix$screencontent_no<- if_else(db_HR_bio_final_346_355_withfix$screen_content == "fixation", 1,
                                                           if_else(db_HR_bio_final_346_355_withfix$screen_content == "stim", 2,
                                                                   if_else(db_HR_bio_final_346_355_withfix$screen_content == "valence", 3, 4)))

db_HR_bio_final_346_355_withfix_stim <- subset(db_HR_bio_final_346_355_withfix, screencontent_no<3)


# 
# db_HR_bio_final_346_355_withfix_stim$tNo<- db_HR_bio_final_346_355_withfix_stim$tNo3
unique(db_HR_bio_final_346_355_withfix$tNo)
unique(db_HR_bio_final_346_355_withfix$tNo)

db_HR_bio_final_346_355_withfix_stim$tNo2<-NULL

db_HR_bio_final_346_355_withfix_stim$tNo3<- NULL

unique(db_HR_bio_final_346_355_withfix$screencontent)
unique(db_full6new_hr_fix_stim$screencontent)
# db_HR_bio_final_346_355_withfix$screencontent_no<- 


colnames(db_full6new)

db_full6new_hr_fix_stim <- subset(db_full6new, screencontent_no <3)

View(db_full6new_hr_fix_stim)
# fixation"    "stim" 
colnames(db_full6new_hr_fix_stim)
colnames(db_HR_bio_final_346_355_withfix_stim)

db_HR_bio_final_346_355_withfix_stim$Bio_Mean_HR<- db_HR_bio_final_346_355_withfix_stim$Mean_HR

db_HR_bio_final_346_355_withfix_stim$ssid_num<- as.numeric(db_HR_bio_final_346_355_withfix_stim$ssid)
# keep controls
unique(db_full6new_hr_fix_stim$ssid)
db_full6new_hr_fix_stim$ssid_num <- as.numeric(as.character(db_full6new_hr_fix_stim$ssid))



table(is.na(db_full6new_hr_fix_stim))

db_full6new_hr_fix_stim$Group<- if_else(db_full6new_hr_fix_stim$ssid_num< 500, "NT",
                                        if_else(db_full6new_hr_fix_stim$ssid_num>700, "NT",
                                                "ASC"))

table(is.na(db_full6new_hr_fix_stim$Group))

db_full6new_hr_fix_stim_nt<- subset(db_full6new_hr_fix_stim, Group == "NT")
unique(db_full6new_hr_fix_stim_nt$ssid_num)

# attention
db_full6new_hr_fix_stim_nt<- subset(db_full6new_hr_fix_stim_nt, ssid_num> 303)
unique(db_full6new_hr_fix_stim_nt$ssid)
colnames(db_full6new_hr_fix_stim_nt)

# HR differences
db_full6new_hr_fix_stim_nt$Bio_Mean_HR_fix<- if_else(db_full6new_hr_fix_stim_nt$screencontent_no ==1, db_full6new_hr_fix_stim_nt$Bio_Mean_HR, NULL)


db_HR_bio_final_346_355_withfix_stim$Bio_Mean_HR_fix<- if_else(db_HR_bio_final_346_355_withfix_stim$screencontent_no ==1, db_HR_bio_final_346_355_withfix_stim$Bio_Mean_HR, NULL)

View(db_full6new_hr_fix_stim_nt)
View(db_HR_bio_final_346_355_withfix_stim)

db_HR_bio_final_346_355_withfix_stim$Mean_HR<- NULL

db_HR_bio_final_346_355_withfix_stim$ssid<- as.character(db_HR_bio_final_346_355_withfix_stim$ssid)


db_HR_bio_final_346_355_withfix_stim$tNo <- db_HR_bio_final_346_355_withfix_stim$tNo3.x
unique(db_HR_bio_final_346_355_withfix_stim$tNo)

db_HR_bio_final_346_355_withfix_stim$tNo <- as.character(db_HR_bio_final_346_355_withfix_stim$tNo)
db_HR_bio_final_346_355_withfix_stim$trigger <- as.character(db_HR_bio_final_346_355_withfix_stim$trigger)

db_full6new_hr_fix_stim_nt$trigger<- as.character(db_full6new_hr_fix_stim_nt$trigger)
db_full6new_hr_fix_stim_nt$trigger.x<- NULL

# db_HR_bio_final_346_355_withfix_stim$trig <- as.character(db_HR_bio_final_346_355_withfix_stim$tNo)

# db_HR_bio_final_346_355_withfix_stim$triger<- NULL
db_HR_bio_final_346_355_withfix_stim$trigger.x<- NULL

db_HR_bio_final_346_355_withfix_stim$trigger.y<- NULL
db_HR_bio_final_346_355_withfix_stim$trigger2<- NULL
db_HR_bio_final_346_355_withfix_stim$trigger_200<- NULL

nrow(db_full6new_hr_fix_stim_nt)+ nrow(db_HR_bio_final_346_355_withfix_stim)
# 6895
# nrow(bind_rows(db_full6new_hr_fix_stim_nt, db_HR_bio_final_346_355_withfix_stim))
db_HR_bio_final_346_355_withfix_stim$Bio_Mean_HR_fix

colnames(db_HR_bio_final_346_355_withfix_stim)
as.factor(db_HR_bio_final_346_355_withfix_stim$stimIAPS)
db_full6new_hr_fix_stim_nt$stimIAPS

db_HR_bio_final_346_355_withfix_stim

as.factor(db_HR_bio_final_346_355_withfix_stim$stim.x)
as.factor(db_HR_bio_final_346_355_withfix_stim$stim.y)
db_HR_bio_final_346_355_withfix_stim$stim.y<- NULL

unique(db_HR_bio_final_346_355_withfix_stim$screencontent)
unique(db_full6new_hr_fix_stim_nt$screencontent)
unique(db_full6new_hr_fix_stim_nt$screencontent.y)

db_full6new_hr_fix_stim_nt$screencontent.x<- NULL
db_full6new_hr_fix_stim_nt$screencontent.y<- NULL

unique(db_full6new_hr_fix_stim_nt$trialUnq.x)
unique(db_full6new_hr_fix_stim_nt$trialUnq.y)

db_full6new_hr_fix_stim_nt$trialUnq<- db_full6new_hr_fix_stim_nt$trialUnq.x
db_full6new_hr_fix_stim_nt$trialUnq.y<- NULL
db_full6new_hr_fix_stim_nt$trialUnq.x<- NULL


db_HR_bio_final_346_355_withfix_stim$stim<- db_HR_bio_final_346_355_withfix_stim$stim.x
# db_HR_bio_final_346_355_withfix_stim$stim<- db_HR_bio_final_346_355_withfix_stim$stim.x

# bind heartrate old and new
table(is.na(db_HR_bio_final_346_355_withfix_stim$Bio_Mean_HR))
table(is.na(db_full6new_hr_fix_stim_nt$Bio_Mean_HR))
test<- subset(db_full6new_hr_fix_stim_nt, is.na(Bio_Mean_HR))
test1<- subset(db_HR_bio_final_346_355_withfix_stim, is.na(Bio_Mean_HR))

db_full6new_hr_fix_stim_nt1<- bind_rows(db_full6new_hr_fix_stim_nt,
                                        db_HR_bio_final_346_355_withfix_stim)



unique(db_full6new_hr_fix_stim_nt$Group)

# 346 missing praticdata - it was processed wrongly
# 347 missing



library(dplyr)
library(tidyverse)

table(is.na(db_full6new_hr_fix_stim_nt1$Bio_Mean_HR))

test<- subset(db_full6new_hr_fix_stim_nt1, is.na(Bio_Mean_HR))

unique(test$ssid)
# 606 

# 348 to 355 are missing pratice

db_full6new_hr_fix_stim_nt1.1<- db_full6new_hr_fix_stim_nt1 %>%
  # mutate()
  group_by(as.numeric(ssid_num), as.numeric(tNo)) %>%
  arrange(ssid_num, as.numeric(tNo),as.numeric(screencontent_no))%>%
  # select(ssid, tNo,screencontent_no, Bio_Mean_HR,Bio_Mean_HR_fix)
  fill(Bio_Mean_HR_fix, .direction = "down")%>%
  subset(screencontent_no == 2)

View(db_full6new_hr_fix_stim_nt1.1)

# 2 1
# stim - fix
db_full6new_hr_fix_stim_nt1.1<- db_full6new_hr_fix_stim_nt1.1 %>%
  mutate(Bio_Mean_HR_dif = Bio_Mean_HR - Bio_Mean_HR_fix)



db_full6new_hr_fix_stim_nt1.1%>%
  ggplot(aes(Bio_Mean_HR_dif))+
  geom_histogram()

?scatter3d 


db_full6new_hr_fix_stim_nt1.1%>%
  subset(!is.na(pup_basCor))%>%
   subset(!is.na(BIO_CDA.PhasicMax))%>%
  subset(!is.na(Bio_Mean_HR_dif))


db_full6new_hr_fix_stim_nt1<- db_full6new_hr_fix_stim_nt1%>%
  group_by(ssid)%>%
  mutate(BIO_CDA.PhasicMax_z= scale(BIO_CDA.PhasicMax, center = TRUE, scale = TRUE)[,1])

car::scatter3d(x = db_full6new_hr_fix_stim_nt1.1$pup_basCor, 
          y = db_full6new_hr_fix_stim_nt1.1$BIO_CDA.PhasicMax_z, 
          z = db_full6new_hr_fix_stim_nt1.1$Bio_Mean_HR_dif, 
          fit = "smooth",
          
          surface = FALSE,
          point.col = "blue",
          # point
          groups = as.factor(db_full6new_hr_fix_stim_nt1.1$mediansplit_ground_arousal),
          ellipsoid = TRUE)



cor(db_full6new_hr_fix_stim_nt1[,c("pup_basCor", "BIO_CDA.PhasicMax_z","Bio_Mean_HR_dif")], use = "complete")



db_full6new_hr_fix_stim_nt1%>%
  group_by(ssid,mediansplit_ground_valence)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(pup_basCor,BIO_CDA.PhasicMax_z, color= mediansplit_ground_valence))+
  geom_point()+
  geom_smooth(method = 'lm', se = F)+
  ylim(0,.4)+
  ggpubr::stat_cor()



db_full6new_hr_fix_stim_nt1%>%
  # group_by(ssid)%>%
  # mutate(Bio_Mean_HR_dif_z = scale(Bio_Mean_HR_dif))
  group_by(ssid,mediansplit_ground_valence)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(pup_basCor,Bio_Mean_HR_dif_z, color= mediansplit_ground_valence))+
  geom_point()+
  geom_smooth(method = 'lm', se = F)+
  # ylim(-7,2)+
  ggpubr::stat_cor()



db_full6new_hr_fix_stim_nt1%>%
  subset(!is.na(mediansplit_ground_valence))%>%
  # group_by(ssid)%>%
  # mutate(Bio_Mean_HR_dif_z = scale(Bio_Mean_HR_dif))
  group_by(ssid,mediansplit_ground_valence)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(BIO_CDA.PhasicMax_z,Bio_Mean_HR_dif, color= mediansplit_ground_valence))+
  geom_point()+
  geom_smooth(method = 'lm', se = F)+
  # ylim(-7,2)+
  ggpubr::stat_cor()+
  facet_grid(~mediansplit_ground_valence)
  

```


```{r}

unique(db_full6new_hr_fix_stim_nt1.1$screencontent_no)

test<- subset(db_full6new_hr_fix_stim_nt1.1, is.na(Bio_Mean_HR_dif))

unique(test$ssid)

db_full6new_hr_fix_stim_nt1.1$Bio_Mean_HR_dif_outl <- if_else(abs(db_full6new_hr_fix_stim_nt1.1$Bio_Mean_HR_dif)>                                                   (median(abs(db_full6new_hr_fix_stim_nt1.1$Bio_Mean_HR_dif),na.rm = TRUE) +                                                               (4*(sd(abs(db_full6new_hr_fix_stim_nt1.1$Bio_Mean_HR_dif), na.rm = TRUE)))), "outlier", "not outlier")


db_full6new_hr_fix_stim_nt1.1%>%
  ggplot(aes(Bio_Mean_HR_dif))+
  geom_histogram()+
  facet_grid(~Bio_Mean_HR_dif_outl)

```


```{r}

db_full6new_hr_fix_stim_nt1.1<- db_full6new_hr_fix_stim_nt1.1%>%
  ungroup()%>%
  mutate(arousal_c = scale(arousal, center = TRUE, scale = TRUE)[,1],
         valence_c = scale(valence, center = TRUE, scale = TRUE)[,1])

db_full6new_hr_fix_stim_nt1.1 %>%
    # subset(Bio_Mean_HR_dif_outl == "not outlier")%>%
  # subset(ssid_num<500)%>%
  group_by(ssid)%>%
  mutate(Bio_Mean_HR_dif_ssid = mean(Bio_Mean_HR_dif, na.rm = TRUE))%>%
  group_by(ssid)%>%
  # mutate(Bio_Mean_HR_dif_stim = mean(Bio_Mean_HR_dif, na.rm = TRUE))%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(TAS, Bio_Mean_HR_dif))+
  geom_point()+
  geom_smooth(method = 'lm', se = F)+
  ggpubr::stat_cor()
  
  

db_full6new_hr_fix_stim_nt1.1 %>%
    subset(Bio_Mean_HR_dif_outl == "not outlier")%>%
  # subset(ssid_num<500)%>%
  # group_by(ssid)%>%
  mutate(Bio_Mean_HR_dif = abs(Bio_Mean_HR_dif))%>%
  group_by(ssid, stimIAPS)%>%
  mutate(Bio_Mean_HR_dif_stim = abs(Bio_Mean_HR_dif))%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(TASc, Bio_Mean_HR_dif))+
  
  # geom_point()
  
  geom_smooth(aes(group = stimIAPS, y =Bio_Mean_HR_dif_stim), method=lm, se=FALSE, colour = "gray40", alpha = .01,linetype="dashed", size = .2 )+
  geom_smooth( method=lm, se=FALSE, linetype="dashed",
             color="darkred", size = 2)+
  stat_summary(geom = 'pointrange', pch = 1)+
    ggpubr::stat_cor()+
  
  
  
  # geom_point()+
  # stat_summary(aes(group =ssid, y = Bio_Mean_HR_dif),method = "line",alpha = .1)+
  # ggpubr::stat_cor()+
  p$graphstyle+
  xlab("Alexithymia (Z)")+
  ylab("HR difference")+
p$graphstyle


db_full6new_hr_fix_stim_nt1$TASc<- scale(db_full6new_hr_fix_stim_nt1$TAS, center = TRUE, scale = TRUE)


# model

table(is.na(db_full6new_hr_fix_stim_nt1.1$Bio_Mean_HR_dif))
Bio_Mean_HR_dif_outl

hr_bio <- lmer(Bio_Mean_HR_dif ~ TASc * arousal_c + 
                 (1|ssid) + 
                 (1| stimIAPS),
     REML = FALSE,
     data = subset(db_full6new_hr_fix_stim_nt1.1, 
                   Bio_Mean_HR_dif_outl == "not outlier"))


interactions::interact_plot(hr_bio, pred = arousal_c, modx = TASc)

summary(hr_bio)



# create more variables ground and self
db_full6new_hr_fix_stim_nt1.1<- db_full6new_hr_fix_stim_nt1.1%>%
  ungroup()%>%
  mutate(mediansplit_ground_valence = if_else(ValenceMean >=
                                                  median(ValenceMean,
                                                         na.rm = TRUE), "More positive", "More negative"))%>%
  mutate(mediansplit_ground_arousal = if_else(ArousalMean >=
                                                  median(ArousalMean,
                                                         na.rm = TRUE), "High", "Low"))%>%
    mutate(mediansplit_sample_valence2 = if_else(valence >=
                                                  median(valence,
                                                         na.rm = TRUE), "More positive", "More negative"))%>%
  mutate(mediansplit_sample_arousal2 = if_else(arousal >=
                                                  median(arousal,
                                                         na.rm = TRUE), "High", "Low"))


db_full6new_hr_fix_stim_nt1.1%>%
  subset(Bio_Mean_HR_dif_outl == "not outlier")%>%
  subset(!is.na(mediansplit_ground_valence))%>%
  group_by(ssid,mediansplit_ground_arousal, mediansplit_ground_valence,)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(mediansplit_ground_arousal, Bio_Mean_HR_dif))+
  geom_jitter(alpha = .2, width = .2)+
   geom_bar(stat="summary", fun.y = "mean", alpha = .2)+
  stat_summary(geom = 'pointrange')+
  # stat_smooth(aes(group = ssid), se = F, method = 'lm', alpha = .2)+
    facet_grid(~mediansplit_ground_valence)



```

```{r}
db_full6new_hr_fix_stim_nt1.1%>%
  subset(!is.na(mediansplit_ground_valence))%>%
  subset(Bio_Mean_HR_dif_outl== "not outlier")%>%
  group_by(ssid, mediansplit_ground_arousal,mediansplit_ground_valence)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(mediansplit_ground_arousal, Bio_Mean_HR_dif, fill = mediansplit_ground_valence))+
  geom_jitter(alpha = .2, width = .2)+
   geom_bar(stat="summary", fun.y = "mean", alpha = .2)+
  stat_summary(geom = 'pointrange')+
  stat_summary(aes(group = ssid), geom = 'line', alpha = .2)+
  
 
  facet_grid(~mediansplit_ground_valence)+
     ggpubr::stat_compare_means()+
  # p$graphstyle+
  scale_fill_brewer(palette = "Dark2")

```



Models

```{r}
table(is.na(db_full6new_hr_fix_stim_nt1.1$Bio_Mean_HR_dif))
test3<- subset(db_full6new_hr_fix_stim_nt1.1, is.na(Bio_Mean_HR_dif))
test4<- subset(db_full6new_hr_fix_stim_nt1.1, !is.na(Bio_Mean_HR_dif))
unique(test4$ssid)

db_full6new_hr_fix_stim_nt1.1$ssid<- as.factor(as.character(db_full6new_hr_fix_stim_nt1.1$ssid))

db_full6new_hr_fix_stim_nt1.1<- db_full6new_hr_fix_stim_nt1.1%>%
  ungroup()%>%
  mutate(arousal_c = scale(arousal, center = TRUE, scale = TRUE)[,1],
         valence_c = scale(valence, center = TRUE, scale = TRUE)[,1])

unique(db_full6new_hr_fix_stim_nt1$Group)
# test - analyse just positive
summary(hr_dif_models$arousal_val)

hr_dif_models$arousal_val <- lmer(Bio_Mean_HR_dif ~   valence_c+
                                        + (1 | ssid) + 
                                    (1|stimIAPS),
                                        # (1|mediansplit_sample_arousal2),
     REML = FALSE,
     data = subset(db_full6new_hr_fix_stim_nt1.1, 
                   # mediansplit_ground_valence == "More negative" &
                     Bio_Mean_HR_dif_outl == "not outlier"))

summary(hr_dif_models$arousal_val)


summary(hr_dif_models$arousal_AR)


View(db_full6new_hr_fix_stim_nt1.1)

hr_outlier<- subset(db_full6new_hr_fix_stim_nt1.1, 
                   # mediansplit_ground_valence == "More negative" &
                     Bio_Mean_HR_dif_outl != "not outlier")


hr_dif_models$arousal_AR <- lmer(Bio_Mean_HR_dif ~   arousal_c+
                                        + (1 | ssid) + 
                                    (1|stimIAPS),
                                        # (1|mediansplit_sample_arousal2),
     REML = FALSE,
     data = subset(db_full6new_hr_fix_stim_nt1.1, 
                   # mediansplit_ground_valence == "More negative" &
                     Bio_Mean_HR_dif_outl == "not outlier"))


summary(hr_dif_models$arousal_AR)


unique(db_full6new_hr_fix_stim_nt1$ssid)

summary(hr_dif_models$valfrom_hr)

unique(db_full6new_hr_fix_stim_nt1.1$ssid)

hr_dif_models$valfrom_hr <- lmer(arousal_c ~   Bio_Mean_HR_dif* valence_c+
                                        + (1 | ssid) + (1|stimIAPS),
                                        # (1|mediansplit_sample_arousal2),
     REML = FALSE,
     data = subset(db_full6new_hr_fix_stim_nt1.1, 
                   # mediansplit_ground_valence == "More positive" &
                   Bio_Mean_HR_dif_outl == "not outlier"))
# arousal_c
summary(hr_dif_models$valfrom_hr)

# arousal * valence

hr_dif_models$hr_dif_ar_vl <- lmer(Bio_Mean_HR_dif~arousal_c   * valence_c+
                                        + (1 | ssid),
                                     # (1|stimIAPS),
                                        # (1|mediansplit_sample_arousal2),
     REML = FALSE,
     data = subset(db_full6new_hr_fix_stim_nt1.1, 
                   # mediansplit_ground_valence == "More positive" &
                   Bio_Mean_HR_dif_outl == "not outlier" & !is.na(Bio_Mean_HR_dif)))
# arousal_c
summary(hr_dif_models$hr_dif_ar_vl)



```



correlaation between the multiple signals

```{r}
table(is.na(db_full6new_hr_fix_stim_nt1.1$BIO_C))
db_full6new_hr_fix_stim_nt1.1$pup_basCor
db_full6new_hr_fix_stim_nt1.1$TTP.nSCR
db_full6new_hr_fix_stim_nt1.1$CDA.nSCR
db_full6new_hr_fix_stim_nt1.1$Bio_Mean_HR_dif


# 
library(tidyverse)
library(ggplot2)
db_full6new_hr_fix_stim_nt1.1<- db_full6new_hr_fix_stim_nt1.1 %>%
  group_by(ssid)%>%
  mutate(BIO_CDA.PhasicMax_z = scale(BIO_CDA.PhasicMax, center = TRUE, scale = TRUE)[,1])%>%
  mutate(BIO_CDA.SCR_z = scale(BIO_CDA.SCR, center = TRUE, scale = TRUE)[,1])%>%
  mutate(BIO_CDA.ISCR_z = scale(BIO_CDA.ISCR, center = TRUE, scale = TRUE)[,1])%>%
  mutate(BIO_TTP.AmpSum_z = scale(BIO_TTP.AmpSum, center = TRUE, scale = TRUE)[,1])%>%
  mutate(BIO_CDA.AmpSum_z = scale(BIO_CDA.AmpSum, center = TRUE, scale = TRUE)[,1])%>%
  mutate(Bio_Mean_HR_dif_z = scale(Bio_Mean_HR_dif, center = TRUE, scale = TRUE)[,1])

car::scatter3d(x = db_full6new_hr_fix_stim_nt1.1$pup_basCor, 
          y = db_full6new_hr_fix_stim_nt1.1$BIO_CDA.PhasicMax_z, 
          z = db_full6new_hr_fix_stim_nt1.1$Bio_Mean_HR_dif, 
          fit = "smooth",
          
          surface = TRUE,
          point.col = "blue")
          # point
db_full6new_hr_fix_stim_nt1.1%>%
  group_by(ssid)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(BIO_CDA.PhasicMax_z, pup_basCor))+
  geom_point()+
  geom_smooth(method = lm, se = F)+
  ggpubr::stat_cor()


db_full6new_hr_fix_stim_nt1.1%>%
  group_by(ssid)%>%
  mutate(cor_pup_scr = cor(BIO_CDA.PhasicMax_z, pup_basCor, use = "complete"))%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(cor_pup_scr))+
  geom_histogram()


db_full6new_hr_fix_stim_nt1.1 %>%
  group_by(ssid)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(BIO_CDA.SCR_z, Bio_Mean_HR_dif_z))+
  geom_point()+
  geom_smooth(method = lm, se = F)+
  ggpubr::stat_cor()


db_full6new_hr_fix_stim_nt1.1 %>%
  group_by(ssid)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(BIO_CDA.SCR_z, Bio_Mean_HR))+
  geom_point()+
  geom_smooth(method = lm, se = F)+
  ggpubr::stat_cor()


db_full6new_hr_fix_stim_nt1.1 %>%
  group_by(ssid)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(pup_basCor, Bio_Mean_HR))+
  geom_point()+
  # xlim()
  geom_smooth(method = lm, se = F)+
  ggpubr::stat_cor()
```