---
title: "Paper_analyses"
author: "Helio"
date: "22/07/2021"
output: html_document
---


Code for the paper: Valence modulated “subjective-objective” arousal

data<- last opened

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```



Participants section

```{r}
participants_demog <- db_full4new_stim_screen_pupil_nopract %>%
  subset(Group == "NT")%>%
  group_by(ssid, Gender)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)

# gender
table(participants_demog$Gender)
colnames(participants_demog)
summary(participants_demog$Age)
sd(participants_demog$Age, na.rm = TRUE)
# table(is.na(participants_demog$Age))
```



Pupil changes and subjective arousal and valence ratings


# let's model it formally
  
# remember baseline corection is equivalendt to stimuli intercept
 
```{r} 
pupil_arousal_findings<- list()
library(lmerTest)

unique(db_full4new_stim_screen_pupil_nopract$stimIAPS)
unique(substr(db_full4new_stim_screen_pupil_nopract$stimIAPS, 1,8))
db_full4new_stim_screen_pupil_nopract$Label<- substr(db_full4new_stim_screen_pupil_nopract$stimIAPS, 1,8)


db_full4new_stim_screen_pupil_nopract<- left_join(db_full4new_stim_screen_pupil_nopract, imageJ_IAPS, by = "Label")

nrow(db_full4new_stim_screen_pupil_nopract)
# rows = 2858

db_full4new_stim_screen_pupil_nopract$Mean_gray_z<- scale(db_full4new_stim_screen_pupil_nopract$Mean, center = TRUE, scale = TRUE)[,1]


db_full4new_stim_screen_pupil_nopract$ssid_num <- as.numeric(as.character(db_full4new_stim_screen_pupil_nopract$ssid))


```


lmer pupil

```{r}
options(contrasts = c("contr.sum","contr.poly"))
options(scipen = 999)


pupil_arousal_findings$pupil_from_arousal <- lmer(pup_basCor ~ arousal_c*Mean_gray_z  +(1 +Mean_gray_z | ssid) + (0+arousal_c| ssid), REML = FALSE,
                      data = subset(db_full4new_stim_screen_pupil_nopract, 
                                    pupil_outlier == FALSE & ssid_num< 500 & 
                                    arousal_outler == FALSE))

summary(pupil_arousal_findings$pupil_from_arousal)
# singularity (drop arousal c slope)

# is there a correlation between mean arousal rating and meang, gray(

db_full4new_stim_screen_pupil_nopract%>%
  group_by(stimIAPS,ground_valence_lab) %>%
  summarise_at(c('arousal_c', 'Mean_gray_z'), mean, na.rm = TRUE)%>%
  ggplot(aes(arousal_c, Mean_gray_z, color = ground_valence_lab))+
  geom_point()+
  ggpubr::stat_cor()

```


# Valence and arousal
```{r}

pupil_arousal_findings$pupil_from_ar_vale <- lmer(pup_basCor ~ (valence_c* arousal_c) +
                                                    Mean_gray_z  +
                                                    (1 + Mean_gray_z | ssid)+
                                                    (0+ valence_c* arousal_c | ssid),
                                                  REML = FALSE,
                      data = subset(db_full4new_stim_screen_pupil_nopract, 
                                    pupil_outlier == FALSE & ssid_num< 500 & 
                                      arousal_outler == FALSE))

# relgrad <- with(pupil_arousal_findings$pupil_from_ar_vale@optinfo$derivs,solve(Hessian,gradient))
# max(abs(relgrad))0.0002044252

summary(pupil_arousal_findings$pupil_from_ar_vale)
plot(pupil_arousal_findings$pupil_from_ar_vale)

# car::vif(pupil_arousal_findings$pupil_from_ar_vale) #curoff 4


interactions::interact_plot(pupil_arousal_findings$pupil_from_ar_val_gaze , pred = arousal_c, modx = valence_c)

interactions::interact_plot(pupil_arousal_findings$pupil_from_ar_val_gaze , pred = valence_c , modx = arousal_c)

# export model table
library(MuMIn)
library(sjmisc)
sjPlot::tab_model(pupil_arousal_findings$pupil_from_ar_vale)

```

Linear mixed model fit by maximum likelihood . t-tests use Satterthwaite's method ['lmerModLmerTest']
Formula: pup_basCor ~ (valence_c * arousal_c) + Mean_gray_z + (1 + Mean_gray_z |  
    ssid) + (0 + valence_c * arousal_c | ssid)
   Data: subset(db_full4new_stim_screen_pupil_nopract, pupil_outlier ==      FALSE & ssid_num < 500 & arousal_outler == FALSE)

     AIC      BIC   logLik deviance df.resid 
  8493.9   8579.2  -4231.9   8463.9     2170 

Scaled residuals: 
    Min      1Q  Median      3Q     Max 
-3.6141 -0.5987  0.0067  0.5952  3.6796 

Random effects:
 Groups   Name                Variance Std.Dev. Corr       
 ssid     (Intercept)         0.78415  0.8855              
          Mean_gray_z         0.13611  0.3689   0.55       
 ssid.1   valence_c           0.04233  0.2057              
          arousal_c           0.02296  0.1515    0.89      
          valence_c:arousal_c 0.01700  0.1604   -0.19  0.01
 Residual                     2.57999  1.6062              
Number of obs: 2185, groups:  ssid, 43

Fixed effects:
                    Estimate Std. Error       df t value             Pr(>|t|)    
(Intercept)         -0.66764    0.14166 44.77819  -4.713          0.000023962 ***
valence_c            0.08546    0.06557 28.33677   1.603              0.20294    
arousal_c            0.44137    0.06445 22.53213   6.848          0.000000619 ***
Mean_gray_z         -0.96311    0.06622 43.35750 -14.544 < 0.0000000000000002 ***
valence_c:arousal_c  0.15461    0.04434 24.37046   3.487              0.00187 ** 
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

Correlation of Fixed Effects:
            (Intr) vlnc_c arsl_c Mn_gr_
valence_c   -0.042                     
arousal_c   -0.031  0.746              
Mean_gray_z  0.453 -0.013  0.028       
vlnc_c:rsl_  0.147 -0.267 -0.128  0.035

same analyses as above but regress brightness out of pupil

```{r}

pupil_arousal_findings$pupil_from_brightness <- lmer(pup_basCor ~ 
                                                    Mean  +
                                                    (1  | ssid),
                                                    # (0+ valence_c* arousal_c | ssid),
                                                  REML = FALSE,
                      data = subset(db_full4new_stim_screen_pupil_nopract, 
                                    # pupil_outlier == FALSE & ssid_num< 500 & 
                                      # arousal_outler == FALSE
                                    ))

pupil_arousal_findings$pupil_from_brightness_lm <- lm(pup_basCor ~ 
                                                    Mean,
                                                    
                      data = subset(db_full4new_stim_screen_pupil_nopract, 
                                    # pupil_outlier == FALSE & ssid_num< 500 & 
                                      # arousal_outler == FALSE
                                    ))



summary(pupil_arousal_findings$pupil_from_brightness)

plot(pupil_arousal_findings$pupil_from_brightness)

# store residuals
db_full4new_stim_screen_pupil_nopract$pup_resid <- resid(pupil_arousal_findings$pupil_from_brightness)

db_full4new_stim_screen_pupil_nopract$pup_resid_lm <-
resid(pupil_arousal_findings$pupil_from_brightness_lm)


db_full4new_stim_screen_pupil_nopract%>%
  ggplot(aes(pup_resid, Mean_gray_z))+
  geom_point()+
  geom_smooth(method = 'lm', se = F)+
  ggpubr::stat_cor()

# no correlated with IV - good


db_full4new_stim_screen_pupil_nopract%>%
  ggplot(aes(pup_resid, pup_basCor))+
  geom_point()+
  geom_smooth(method = 'lm', se = F)+
  ggpubr::stat_cor()

# strong correlation, in this case this is good, because it means there is a large ammount of unexplain ed variane not acconted for by the predictor



# predict pupil residuals
pupil_arousal_findings$pupil_resid_from_ar_vale <- lmer(pup_resid_lm ~ (arousal_c*valence_c) +
                                                    
                                                    (1+arousal_c*valence_c  | ssid),
                                                    # (0+ valence_c* arousal_c | ssid),
                                                  REML = FALSE,
                      data = subset(db_full4new_stim_screen_pupil_nopract, 
                                    pupil_outlier == FALSE &
                                    ssid_num< 500 
                                    &
                                      arousal_outler == FALSE
                                      )) # results hold with or withouth outliers 


summary(pupil_arousal_findings$pupil_resid_from_ar_vale)

# using residuals from lmer create a singularity as they eliminate individual participants variability, this is solved by using residuals from lm


interactions::interact_plot(pupil_arousal_findings$pupil_resid_from_ar_vale , pred = arousal_c, modx = valence_c)

interactions::interact_plot(pupil_arousal_findings$pupil_resid_from_ar_vale , pred = valence_c , modx = arousal_c)


```



Predict arousal from pupil


```{r}
# with arousal as DV
pupil_arousal_findings$arousal_from_pup <- lmer(arousal_c ~ valence_c*pup_basCor  + (1| stimIAPS)+
                                                 # (1 | ssid),
                                                  (0 +valence_c+pup_basCor | ssid),
                                                REML = FALSE,
                      data = subset(db_full4new_stim_screen_pupil_nopract, 
                                    pupil_outlier == FALSE & ssid_num<500 & 
                                      arousal_outler == FALSE))
summary(pupil_arousal_findings$arousal_from_pup)
anova(pupil_arousal_findings$arousal_from_pup)

# expected correlation between valence and pupil is low



interactions::interact_plot(pupil_arousal_findings$arousal_from_pup , pred = valence_c, modx = pup_basCor)

interactions::interact_plot(pupil_arousal_findings$arousal_from_pup, pred =pup_basCor , modx =  valence_c) #better 
# same pattern
# pupil is more aligned with subjective arousal in the more positive trials



# flip dv to valence

pupil_arousal_findings$valence_from_pup <- lmer(valence_c ~ arousal_c*pup_basCor  + (1| stimIAPS)+
                                                 # (1 | ssid),
                                                  (0 +arousal_c +pup_basCor | ssid),
                                                REML = FALSE,
                      data = subset(db_full4new_stim_screen_pupil_nopract, 
                                    pupil_outlier == FALSE & ssid_num<500 & 
                                      arousal_outler == FALSE))
summary(pupil_arousal_findings$valence_from_pup)
anova(pupil_arousal_findings$valence_from_pup)

# so it's not the case that pupil is tracking valence
# it's the case that arousal pupil relation is modulated by valence, and this is true regardless of whether we use a maximal or minimal model

interactions::interact_plot(pupil_arousal_findings$valence_from_pup , pred = valence_c, modx = pup_basCor)

interactions::interact_plot(pupil_arousal_findings$valence_from_pup, pred =pup_basCor , modx =  arousal_c)



```


Timecourse analyses

# prepare timecourse data
```{r prepare timecourse data}
rm(justone_test, lucy_plots, test)

nrow(tmp.df4_full_stim_downs_jun2021)

# import the timecourse

nrow(tmp.df4_full_stim_downs_jun2021)
tmp.df4_full_stim_downs_jun2021 <- readRDS("~/OneDrive - Nexus365/InteroStudy2020/analysis/DataAnalysisJanuary2020/DataAnalysisJan2020/tmp.df4_full_stim_downs_jun2021.rds")

db_full4new_stim_subset<- db_full4new_stim_screen_pupil_nopract[,c(1:4,6:7,12:13,16,21:27, 31:56,80:81,84:96,98:114,116:124)]


# match types of merging variables
tmp.df4_full_stim_downs_jun2021_with_beh2$ssid<- as.character(tmp.df4_full_stim_downs_jun2021_with_beh2$ssid)
db_full4new_stim_subset$ssid<- as.character(db_full4new_stim_subset$ssid)

# tNo
tmp.df4_full_stim_downs_jun2021_with_beh2$tNo <- as.character(tmp.df4_full_stim_downs_jun2021_with_beh2$tNo)

db_full4new_stim_subset$tNo <- as.character(db_full4new_stim_subset$tNo)
# unique(db_full4new_stim_subset$tNo)
# unique(tmp.df4_full_stim_downs_jun2021_with_beh2$tNo)

# merge
nrow(tmp.df4_full_stim_downs_jun2021_with_beh2)
# 87529

table(is.na(db_full4new_stim_subset$mediansplit_self_valence))

tmp.df4_full_stim_downs_jun2021_with_beh2$tNo<- as.numeric(tmp.df4_full_stim_downs_jun2021_with_beh2$tNo)

tmp.df4_full_stim_downs_jun2021_with_beh2<- tmp.df4_full_stim_downs_jun2021_with_beh2%>%
  arrange(ssid,tNo, timerezero3)

tmp.df4_full_stim_downs_jun2021_with_beh <- left_join(tmp.df4_full_stim_downs_jun2021_with_beh2, db_full4new_stim_subset)


```


# higher sample dataset

```{r}
library(ggplot2)
library(tidyverse)
install.packages("gazer")
library(gazer)

tmp.df4_full_stim_downs_jun2021$tNo<- as.numeric(tmp.df4_full_stim_downs_jun2021$tNo)

tmp.df4_full_stim_downs_jun2021_60bins<- left_join(tmp.df4_full_stim_downs_jun2021, db_full4new_stim_subset, by = c("ssid", "tNo", "trial"))


# create a dataframe version where we downsample to60 and not to 30
tmp.df4_full_stim_downs_jun2021_60bins$Label<- substr(tmp.df4_full_stim_downs_jun2021_60bins$stimIAPS, 1,8)

tmp.df4_full_stim_downs_jun2021_60bins<- left_join(tmp.df4_full_stim_downs_jun2021_60bins, imageJ_IAPS, by = "Label")


tmp.df4_full_stim_downs_jun2021_60bins$Mean_gray_z<- scale(tmp.df4_full_stim_downs_jun2021_60bins$Mean, center = TRUE, scale = TRUE)[,1]






nrow(tmp.df4_full_stim_downs_jun2021_60bins)
# 172168 good


```


Quick check that things make sense
```{r}
tmp.df4_full_stim_downs_jun2021_with_beh %>%
  subset(!is.na(ground_arousal_lab))%>%
  ggplot(aes(x = timerezero3, y = pup_basCor))+
  stat_smooth(aes(group= ground_arousal_lab, color = ground_arousal_lab), fun = mean,geom = "line",
               se = F, alpha = .1, size = 1.5)+
  stat_smooth(aes(group=ground_arousal_lab, color = ground_arousal_lab), size = 3)+  
theme_classic()+
  ylab("Pupil size (z)")+
  xlab("Time (s)")+
  # p$graphstyle+
  scale_color_brewer(palette = "Dark2")+
  xlim(0,6)+
   facet_grid(~mediansplit_self_valence)


tmp.df4_full_stim_downs_jun2021_60bins %>%
  subset(!is.na(ground_arousal_lab))%>%
  ggplot(aes(x = timerezero3, y = pup_basCor))+
  stat_smooth(aes(group= ground_arousal_lab, color = ground_arousal_lab), fun = mean,geom = "line",
               se = F, alpha = .1, size = 1.5)+
  stat_smooth(aes(group=ground_arousal_lab, color = ground_arousal_lab), size = 3)+  
theme_classic()+
  ylab("Pupil size (z)")+
  xlab("Time (s)")+
  # p$graphstyle+
  scale_color_brewer(palette = "Dark2")+
  xlim(0,6)+
   facet_grid(~mediansplit_self_valence)





# group_by(stimIAPS)%>%
tmp.df4_full_stim_downs_jun2021_with_beh<- tmp.df4_full_stim_downs_jun2021_with_beh %>%
  ungroup()%>%
  mutate(mediansplit_sample_valence2 = 
           if_else(ValenceMeanThisSample >= 
                     median(ValenceMeanThisSample,
                            na.rm = TRUE), 
                   "More positive", "More negative"))%>%
  mutate(mediansplit_sample_arousal2 = if_else(ArousalMeanThisSample >=
                                                  median(ArousalMeanThisSample,
                                                         na.rm = TRUE), "High", "Low"))



# higher samp[le rate]

tmp.df4_full_stim_downs_jun2021_60bins<- tmp.df4_full_stim_downs_jun2021_60bins %>%
  ungroup()%>%
  mutate(mediansplit_sample_valence2 = 
           if_else(ValenceMeanThisSample >= 
                     median(ValenceMeanThisSample,
                            na.rm = TRUE), 
                   "More positive", "More negative"))%>%
  mutate(mediansplit_sample_arousal2 = if_else(ArousalMeanThisSample >=
                                                  median(ArousalMeanThisSample,
                                                         na.rm = TRUE), "High", "Low"))



```


Pupil changes over time
<!-- 30 bins -->
```{r}

# create number s for time bins
tmp.df4_full_stim_downs_jun2021_with_behnew<- tmp.df4_full_stim_downs_jun2021_with_behnew%>%
  group_by(ssid, tNo)%>%
  mutate(timebin_no = 1:n())

range(tmp.df4_full_stim_downs_jun2021_with_behnew$timebin_no)

nbins<- unique(tmp.df4_full_stim_downs_jun2021_with_behnew$timebin_no)
nrow(nbins)
# nbins = 30 # number of bins

# create and empty dataframe for the timecourse analyses
timecourse_result_df_int <- data.frame(timebins= rep(NA, 30), 
                                       Estimate_ar= rep(NA, 30), 
                                       t_ar=rep(NA, 30), 
                                       p_ar=rep(NA, 30),
                                       Estimate_vl= rep(NA, 30), 
                                       t_vl=rep(NA, 30), 
                                       p_vl=rep(NA, 30),
                                       Estimate_br= rep(NA, 30), 
                                       t_br=rep(NA, 30), 
                                       p_br=rep(NA, 30),
                                       Estimate_ar_vl= rep(NA, 30), 
                                       t_ar_vl=rep(NA, 30), 
                                       p_ar_vl=rep(NA, 30),
                                       cov= as.character(rep(NA,30)))

# View(timecourse_result_df)
nbins<- nbins[1:28]

i = 0 # remember to always rezero it
# b = 10

# rm(i,b)


for (b in 1:length(nbins)) {
  # for (s in 1:length(nsim)) {

    message(sprintf("$$$$$RUNING lmer %i", nbins[b]))
        lmer_bin_pup  <- lmer(pup_basCor ~ arousal_c* valence+Mean_gray_z  +
                                (1 | ssid),
                                # (0 +arousal_c* valence | ssid),
                                # (1|stimIAPS),
                              REML = FALSE,
                      data = subset(tmp.df4_full_stim_downs_jun2021_with_behnew,
                                    # mediansplit_self_valence == "More positive" & 
                                    timebin_no == nbins[b]))

        #store results from the simulation
            lmer_bin_pup_summary<- summary(lmer_bin_pup)
            lmer_bin_pup_summary
            # lmer_bin_pup_summary[["coefficients"]][3,1]
            timecourse_result_df_int[i,1]<- tmp.df4_full_stim_downs_jun2021_with_behnew$timerezero3[b] #save the exact value of time bin
            
            timecourse_result_df_int[i,2]<- lmer_bin_pup_summary[["coefficients"]][5,1] # first number is term(row), second is column
            timecourse_result_df_int[i,3]<-lmer_bin_pup_summary[["coefficients"]][5,4] # t statistic
            timecourse_result_df_int[i,4]<-lmer_bin_pup_summary[["coefficients"]][5,5] # p value
            # simulated_clusters_JEFFE[i,6]<- nsim[s] #store simulation ount
            timecourse_result_df_int[i,5] <-ifelse(length(lmer_bin_pup_summary$optinfo$conv$lme4$message)
                                                   != 0,
                                               lmer_bin_pup_summary$optinfo$conv$lme4$message, 'pass')

     i = i+1
}


# timecourse_result_df_pos<- timecourse_result_df

timecourse_result_df_int %>%
  ggplot(aes(timebins, t))+
  geom_line(size = 2)+
  geom_line(aes(y = p), linetype = "dashed", size = 2)+
  geom_hline(yintercept = .05, color = 'red', size = 1.5)


```


60 bins

10 hz
each bin is an average of 100ms
<!-- https://link.springer.com/article/10.3758/s13428-018-1075-y -->

```{r}

# create number s for time bins
tmp.df4_full_stim_downs_jun2021_60bins<- tmp.df4_full_stim_downs_jun2021_60bins%>%
  group_by(ssid, tNo)%>%
  mutate(timebin_no = 1:n())

# let's test the interaction term
nbins<- unique(tmp.df4_full_stim_downs_jun2021_60bins$timebin_no)
range(tmp.df4_full_stim_downs_jun2021_60bins$timebin_no)

unique(tmp.df4_full_stim_downs_jun2021_60bins$timebin_no)

# nbins = 60 # number of bins

# create and empty dataframe for the timecourse analyses
timecourse_60bin_result_df <- data.frame(timebins= rep(NA, 60), 
                                       Estimate_ar= rep(NA, 60), 
                                       t_ar=rep(NA, 60), 
                                       p_ar=rep(NA, 60),
                                       Estimate_vl= rep(NA, 60), 
                                       t_vl=rep(NA, 60), 
                                       p_vl=rep(NA, 60),
                                       Estimate_br= rep(NA, 60), 
                                       t_br=rep(NA, 60), 
                                       p_br=rep(NA, 60),
                                       Estimate_ar_vl= rep(NA, 60), 
                                       t_ar_vl=rep(NA, 60), 
                                       p_ar_vl=rep(NA, 60),
                                       cov= as.character(rep(NA,60)))

# View(timecourse_result_df)
# nbins<- nbins[1:60]

i = 0 # remember to always rezero it
# b = 10

# rm(i,b)

# i =1
# unique(tmp.df4_full_stim_downs_jun2021_60bins$)

for (b in 1:length(nbins)) {
  # for (s in 1:length(nsim)) {

    message(sprintf("$$$$$RUNING lmer %i", nbins[b]))
        lmer_bin_pup  <- lmer(pup_basCor ~ (arousal_c* valence)+Mean_gray_z  +
                                (1 | ssid),
                                # (0 +arousal_c* valence | ssid),
                                # (1|stimIAPS),
                              REML = FALSE,
                      data = subset(tmp.df4_full_stim_downs_jun2021_60bins,
                                    ssid_num< 500 &
                                    timebin_no == nbins[b]))

        #store results from the simulation
            lmer_bin_pup_summary<- summary(lmer_bin_pup)
            lmer_bin_pup_summary
            # lmer_bin_pup_summary[["coefficients"]][3,1]
            timecourse_60bin_result_df[i,1]<- tmp.df4_full_stim_downs_jun2021_60bins$timerezero3[b] 
            #save the exact value of time bin
            # store arousal (2,parameter)            # first number is term(row), second is column
            timecourse_60bin_result_df[i,2]<-
            lmer_bin_pup_summary[["coefficients"]][2,1] #estimate
            timecourse_60bin_result_df[i,3]<-
              lmer_bin_pup_summary[["coefficients"]][2,4] # t statistic
            timecourse_60bin_result_df[i,4]<-
            lmer_bin_pup_summary[["coefficients"]][2,5] # p value
            
            # valence
            
            timecourse_60bin_result_df[i,5]<-
            lmer_bin_pup_summary[["coefficients"]][3,1] #estimate
            timecourse_60bin_result_df[i,6]<-
              lmer_bin_pup_summary[["coefficients"]][3,4] # t statistic
            timecourse_60bin_result_df[i,7]<-
              lmer_bin_pup_summary[["coefficients"]][3,5] # p value
            
            # brighteness
            
            timecourse_60bin_result_df[i,8]<-
            lmer_bin_pup_summary[["coefficients"]][4,1] #estimate
            timecourse_60bin_result_df[i,9]<-
              lmer_bin_pup_summary[["coefficients"]][4,4] # t statistic
            timecourse_60bin_result_df[i,10]<-
              lmer_bin_pup_summary[["coefficients"]][4,5] # p value
            
            # interaction arousal x brighteness
            
            timecourse_60bin_result_df[i,11]<-
            lmer_bin_pup_summary[["coefficients"]][5,1] #estimate
            timecourse_60bin_result_df[i,12]<-
              lmer_bin_pup_summary[["coefficients"]][5,4] # t statistic
            timecourse_60bin_result_df[i,13]<-
              lmer_bin_pup_summary[["coefficients"]][5,5] # p value
            
            
            timecourse_60bin_result_df[i,14] <-
              ifelse(length(lmer_bin_pup_summary$optinfo$conv$lme4$message)
                                                   != 0,
                                               lmer_bin_pup_summary$optinfo$conv$lme4$message, 'pass')

     i = i+1
}


# timecourse_result_df_pos<- timecourse_result_df
View(timecourse_60bin_result_df)

  
  # geom_hline(yintercept = .05, color = 'red', size = 1.5)
  

# adjust p values and tag as TRUE whenevee there is at least 3 consecutive p values below .05
?p.adjust

timecourse_60bin_result_df$p_ar_adj<- p.adjust(timecourse_60bin_result_df$p_ar, method = "holm")
timecourse_60bin_result_df$p_ar_adj_TRUE<- if_else(timecourse_60bin_result_df$p_ar_adj<.05, TRUE, FALSE)


timecourse_60bin_result_df$p_vl_adj <- p.adjust(timecourse_60bin_result_df$p_vl, method = "holm")
timecourse_60bin_result_df$p_vl_adj_TRUE<- if_else(timecourse_60bin_result_df$p_vl_adj<.05, TRUE, FALSE)

timecourse_60bin_result_df$p_br_adj <- p.adjust(timecourse_60bin_result_df$p_br, method = "holm")
timecourse_60bin_result_df$p_br_adj_TRUE<- if_else(timecourse_60bin_result_df$p_br_adj<.05, TRUE, FALSE)

timecourse_60bin_result_df$p_ar_vl_adj <- p.adjust(timecourse_60bin_result_df$p_ar_vl, method = "holm")
timecourse_60bin_result_df$p_ar_vl_adj_TRUE<- if_else(timecourse_60bin_result_df$p_ar_vl_adj<.05, TRUE, NULL)

# find the first and last true in a sequence of TRUES
duplicated(timecourse_60bin_result_df$p_ar_adj_TRUE, na.rm = TRUE)



timecourse_60bin_result_df %>%
  ggplot(aes(timebins, Estimate_ar_vl))+
  geom_line(size = 1)
  geom_line(aes(y = t_vl), linetype = "dashed", size = 1)+
  geom_line(aes(y = t_br), linetype = "dotted", size = 1)+
  geom_line(aes(y = t_ar), linetype = "dotdash", size = 1, color = "red")


View(timecourse_60bin_result_df)

```

# # figure preferences
good blog in customization 
https://www.datanovia.com/en/blog/ggplot-legend-title-position-and-labels/#rename-legend-labels-and-change-the-order-of-items
```{r}
p<- list()

sf = 1 # scaling factor to make it easier to change sizes of everything, in which case change here

p$graphstyle <-  theme(#base plot theme
  
  # axis lines
  axis.line.y = element_line(color="black"),
  axis.line.x = element_line(color="black"),
  
  axis.title.y=element_text(size = 16*(sf+.5), margin=margin(0,5,0,0)),
  axis.title.x=element_text(size = 16*(sf+.5), margin=margin(0,5,0,0)),
  
  # text
  strip.text.x = element_text(size = 12*(sf+.5),  colour = "black"),
  strip.text.y = element_text(size = 12*(sf+.5),  colour = "black"),
  
  text=element_text(size = 14, family = "sans"),
  axis.text.x = element_text(size = 14*(sf+.5), family = "sans", colour = "black",),
  axis.text.y = element_text(size = 14*(sf+.5), family = "sans", colour = "black"),
  
  
  # panel
  panel.grid.major = element_blank(),
  panel.background = element_blank(),
  # panel.background = element_rect(fill="transparent"),
  # panel.border = element_rect(fill="transparent"),
  # strip shades (reco rectagles)
   strip.background = element_blank(),
  
  # legend
  legend.position = "top",
  legend.key = element_rect(colour = "transparent", fill="transparent"),
  #legend.direction = "horizontal",

  legend.text = element_text(size = 10*(sf+.3)),
  # legend.title = element_text(size = 10*(sf+.3)),
  # legend line tends to be really small in print so adjust here
  legend.key.height = unit(.5, "cm"),
  legend.key.width = unit(2, "cm"),
  
  #legend.text = element_text(size = 10*sf),
  legend.title=element_blank(),
  #legend.text = element_blank(),
  #axis.ticks = element_blank(),
)


```


timecourse stats plots
```{r}
require(RColorBrewer) # make color friendly plots
require(tidyverse)

brewer.pal(4, "Dark2") # gives the exact names of pallets
  # "#1B9E77" "#D95F02" "#7570B3" "#E7298A"
  # timecourse_60bin_result_df$
  # Estimate_ar, Estimate_ar_vl,Estimate_br. Estimate_v
  
plots_timecourse <- list()

#  let's use the order arousal, valence, arousal x valence brightness
plots_timecourse$eff_size_pup_amp <-   timecourse_60bin_result_df %>% 
  select("timebins","Estimate_ar", "Estimate_vl", "Estimate_br", "Estimate_ar_vl") %>% 
  pivot_longer(-timebins, names_to = "variable", values_to = "Estimate")%>%
    subset(!is.na(Estimate))%>%
  #change the order of the coloring variable here and the name of legends
  mutate(variable = factor(variable, c("Estimate_ar", "Estimate_vl","Estimate_ar_vl",  "Estimate_br"), labels = c("arousal", "valence", "arousal x valence", "brightness")))%>%
  ggplot(aes(timebins, Estimate, group = variable, color= variable))+
  geom_line(aes(linetype = variable), size = 1)+
  
  scale_color_brewer(palette = "Dark2")+
    # scale_color_manual(values=c("#1B9E77", "#D95F02", "#7570B3", "#E7298A"))+
  # use hom correction for significance
  
    # brighteness
    # timecourse_60bin_result_df$timebins[timecourse_60bin_result_df$p_br_adj_TRUE == TRUE]
  
    annotate(geom = 'rect', # use annotate instead of geom_rect, as it is more flexible
             xmin = .16, # got these values from the data-frame. need to fidn a way to automate this
                xmax = 6,
                ymin = -2.03+(sf*.3), # if I ever need to change this, use the scaling factor sf
                ymax = -2+.1+.01+(sf*.3),
                fill =  "#E7298A" , alpha = .5)+ 
    
      annotate("text", 
                x = (1+5.4)/2,
                y = ((-2) +(-2+.1))/2+(sf*.3),
                label = "brightness") +
    
    # arousal
  
    # timecourse_60bin_result_df$p_ar_adj
    # timecourse_60bin_result_df$timebins[timecourse_60bin_result_df$p_ar_adj_TRUE == TRUE]
     annotate(geom = 'rect', xmin = 1,
                xmax = 5.89,
                ymin = -2.03+.1+.1+.1+.1+(sf*.3),
                ymax = -2+.1+.1+.1+.1+.1+.01+(sf*.3),
                fill = "#1B9E77", alpha = .5)+
        annotate("text", 
                  x = (1+5.4)/2,
                y = ((-2+.1+.1+.1+.1) +(-2+.1+.1+.1+.1+.1))/2+(sf*.3),
                 label = "arousal") +

    # arousal-valence
   # timecourse_60bin_result_df$p_ar_vl_adj
    # timecourse_60bin_result_df$timebins[timecourse_60bin_result_df$p_ar_vl_adj_TRUE == TRUE]
       annotate(geom = 'rect', 
                xmin = 1,
                xmax = 5.4,
                ymin = -2.03+.1+.1+(sf*.3),
                ymax = -2+.1+.1+.1+.01+(sf*.3),
                
                fill ="#7570B3", alpha = .5, label = "text")+
    annotate("text", 
                x = (1+5.4)/2,
                y = ((-2+.1+.1) +(-2+.1+.1+.1))/2+(sf*.3),
                label = "arousal x valence") +
        xlab("Time (s)")+
    ylab("Effect size")+
    xlab("Time (s)")+
    ylab("Effect size")

plots_timecourse$eff_size_pup_amp 
# need to rename the label legends


# Edit legend title and labels
plots_timecourse$eff_size_pup_amp <- plots_timecourse$eff_size_pup_amp + 
  p$graphstyle +
    guides(colour = guide_legend(override.aes = list(size=2)))+ #the line size of the legend tends to be smaller in print
  scale_x_continuous(limits = c(0,6), breaks = c(0,2,4,6))+
  scale_y_continuous(limits = c(-2,.7), breaks = c(-1, -0.5, 0,0.5))
  


plots_timecourse$eff_size_pup_amp


    # valence - no significance
      
    
    # scale_fill_brewer()
    
?annotate
```

I think this clustering might 


Pupil velocity test
# velocity analyses


```{r}
# install.packages("pspline")
library(pspline)

predict(sm.spline(tmp.df4_full_stim_downs_jun2021_with_beh$timerezero3, 
                  tmp.df4_full_stim_downs_jun2021_with_beh$pup_basCor), 
        tmp.df4_full_stim_downs_jun2021_with_beh$timerezero3, 1)

D(tmp.df4_full_stim_downs_jun2021_with_beh$pup_basCor, 'x')

tmp.df4_full_stim_downs_jun2021_with_behnew

tmp.df4_full_stim_downs_jun2021_with_behnew <- tmp.df4_full_stim_downs_jun2021_with_behnew %>%
  # subset(!is.na(mediansplit_sample_arousal2))%>%
  # subset(valencearousal_outliers == TRUE) %>%
  # subset(!is.na(mediansplit_sample_arousal2))%>%
  group_by(ssid, stimIAPS) %>%
  mutate(pup_velocity = (abs(lag(pup_basCor)-pup_basCor)/abs(lag(timerezero3)-timerezero3)))
  # mutate(pup_velocity_peak = max(pup_velocity, na.rm = TRUE))


tmp.df4_full_stim_downs_jun2021_with_behnew$pup_velocity

# global

nrow(nbins)
nbins = 30 # number of bins
unique(tmp.df4_full_stim_downs_jun2021_with_behnew$ssid)
tmp.df4_full_stim_downs_jun2021_with_behnew <- tmp.df4_full_stim_downs_jun2021_with_behnew%>%
  group_by(ssid, tNo)%>%
  arrange(ssid,tNo, timerezero3)%>%
  mutate(pup_vel_smooth = zoo::rollmean(pup_velocity, k = 3, fill = NA))
  
zoo::rollmean(pup_velocity, k = 3, fill = NA)

tmp.df4_full_stim_downs_jun2021_with_behnew$pup_vel_smooth

# create and empty dataframe for the timecourse analyses
timecourse_result_df_int_vel <- data.frame(timebins= rep(NA, 30), Estimate= rep(NA, 30), 
                                   t=rep(NA, 30), p=rep(NA, 30), cov= as.character(rep(NA,30)))

# View(timecourse_result_df)
nbins<- nbins[1:28]

i = 0 # remember to always rezero it
# b = 10

rm(b)

nbins<- unique(tmp.df4_full_stim_downs_jun2021_with_behnew$timebin_no)

for (b in 3:length(nbins)) {
  # for (s in 1:length(nsim)) {

    message(sprintf("$$$$$RUNING lmer %i", nbins[b]))
        lmer_bin_pup  <- lmer(pup_vel_smooth ~ arousal_c* valence+Mean_gray_z  +
                                (1 | ssid)+
                                (0 +arousal_c* valence | ssid),
                                # (1|stimIAPS),
                              REML = FALSE,
                      data = subset(tmp.df4_full_stim_downs_jun2021_with_behnew,
                                    # mediansplit_self_valence == "More positive" & 
                                    timebin_no == nbins[b]))

        #store results from the simulation
            lmer_bin_pup_summary<- summary(lmer_bin_pup)
            lmer_bin_pup_summary
            # lmer_bin_pup_summary[["coefficients"]][3,1]
            timecourse_result_df_int_vel[i,1]<- tmp.df4_full_stim_downs_jun2021_with_behnew$timerezero3[b] #save the exact value of time bin
            timecourse_result_df_int_vel[i,2]<- lmer_bin_pup_summary[["coefficients"]][2,1] # first number is term(row), second is column
            timecourse_result_df_int_vel[i,3]<-lmer_bin_pup_summary[["coefficients"]][2,4] # t statistic
            timecourse_result_df_int_vel[i,4]<-lmer_bin_pup_summary[["coefficients"]][2,5] # p value
            # simulated_clusters_JEFFE[i,6]<- nsim[s] #store simulation ount
            timecourse_result_df_int_vel[i,5] <-ifelse(length(lmer_bin_pup_summary$optinfo$conv$lme4$message)
                                                   != 0,
                                               lmer_bin_pup_summary$optinfo$conv$lme4$message, 'pass')

     i = i+1
}


# timecourse_result_df_pos<- timecourse_result_df

timecourse_result_df_int_vel %>%
  ggplot(aes(timebins, t))+
  geom_line(size = 2)+
  geom_line(aes(y = p), linetype = "dashed", size = 2)+
  geom_hline(yintercept = .05, color = 'red', size = 1.5)+
  geom_vline(xintercept = 1, color = 'red')
  # ylim(-4,4)


??ma
?stats::filter
tmp.df4_full_stim_downs_jun2021_60bins %>%
  subset(ssid == 310 & tNo == 10)%>%
  ggplot(aes(timerezero3,pup_vel_smooth))+
  geom_line()+
  geom_point()
  # geom_line(aes(y = pup_velocity),Ç color = 'red')
  # geom_smooth(se = F)

tmp.df4_full_stim_downs_jun2021_60bins%>%
    subset(ssid == 320 & tNo == 20)%>%
  ggplot(aes(timerezero3,pup_basCor))+
  geom_point()+
  geom_line()+
  geom_line(aes(y = pup_vel_smooth), color = 'red')+
  geom_point(aes(y = pup_vel_smooth), color = 'red')
  # geom_line(aes(y = pup_velocity), color = 'red')+
  # geom_smooth(se = F)




```


velocity 100ms
```{r}
unique(tmp.df4_full_stim_downs_jun2021_60bins$ssid)

tmp.df4_full_stim_downs_jun2021_60bins$ssid_num<- as.numeric(as.character(tmp.df4_full_stim_downs_jun2021_60bins$ssid))

tmp.df4_full_stim_downs_jun2021_60bins <- tmp.df4_full_stim_downs_jun2021_60bins %>%
  # subset(!is.na(mediansplit_sample_arousal2))%>%
  # subset(valencearousal_outliers == TRUE) %>%
  # subset(!is.na(mediansplit_sample_arousal2))%>%
  group_by(ssid, tNo) %>%
  mutate(pup_velocity = (abs(lag(pup_basCor)-pup_basCor)/abs(lag(timerezero3)-timerezero3)))%>%
  mutate(pup_velocity_dir = ((lag(pup_basCor)-pup_basCor) / abs(lag(timerezero3)-timerezero3)))
  # mutate(pup_velocity_peak = max(pup_velocity, na.rm = TRUE))


tmp.df4_full_stim_downs_jun2021_60bins%>%
  subset(ssid == 325 & tNo ==38)%>%
  ggplot(aes(timerezero3, pup_velocity))+
  geom_line()

tmp.df4_full_stim_downs_jun2021_60bins%>%
  subset(ssid == 325 & tNo ==38)%>%
  ggplot(aes(timerezero3, pup_basCor))+
  geom_line()

# compared to pupil velocity is much more jerky

# smooth belocity
# number of bins
unique(tmp.df4_full_stim_downs_jun2021_with_behnew$ssid)
tmp.df4_full_stim_downs_jun2021_with_behnew


tmp.df4_full_stim_downs_jun2021_60bins%>%
  subset(ssid == 331 & tNo ==40)%>%
  group_by(ssid, tNo)%>%
  arrange(ssid,tNo, timerezero3)%>%
  mutate(pup_vel_smooth = zoo::rollmean(pup_velocity, k = 3, fill = NA))%>%
   ggplot(aes(timerezero3, pup_velocity))+
  geom_line()+
  geom_line(aes(y = pup_vel_smooth), color = 'red')


tmp.df4_full_stim_downs_jun2021_60bins$four<- paste0(tmp.df4_full_stim_downs_jun2021_60bins$mediansplit_sample_arousal2,
                                                     paste0(tmp.df4_full_stim_downs_jun2021_60bins$mediansplit_sample_valence2))
                                                     
paste0(tmp.df4_full_stim_downs_jun2021_60bins$mediansplit_sample_arousal2)


# unique(tmp.df4_full_stim_downs_jun2021_60bins)


  tmp.df4_full_stim_downs_jun2021_60bins %>%
  subset(ssid_num < 500)%>%
  subset(!is.na(mediansplit_sample_valence2))%>%
  group_by(ssid, tNo)%>%
  arrange(ssid,tNo, timerezero3)%>%
   ggplot(aes(timerezero3, pup_basCor, color = four))+
  stat_smooth(se = F)
  # geom_line(aes(y = pup_vel_smooth), color = 'red')
  
tmp.df4_full_stim_downs_jun2021_60bins %>%
  subset(ssid_num < 500)%>%
  subset(!is.na(mediansplit_sample_valence2))%>%
  group_by(ssid, tNo)%>%
  arrange(ssid,tNo, timerezero3)%>%
   ggplot(aes(timerezero3, pup_velocity, color = four))+
  stat_smooth(se = T)
  # stat_smooth(aes(y = pup_velocity_dir),se = F, linetype = 'dashed')
  # geom_line(aes(y = pup_vel_smooth), color = 'red')


tmp.df4_full_stim_downs_jun2021_60bins %>%
  subset(ssid_num < 500)%>%
  subset(!is.na(mediansplit_sample_valence2))%>%
  group_by(ssid, tNo)%>%
  arrange(ssid,tNo, timerezero3)%>%
   ggplot(aes(timerezero3, pup_velocity_dir, color = four))+
  # stat_summary(fun = mean, geom = 'line')
  stat_smooth(se = T)
  # stat_smooth(aes(y = pup_velocity_dir),se = F, linetype = 'dashed')
  # geom_line(aes(y = pup_vel_smooth), color = 'red')


```

```{r}  
  tmp.df4_full_stim_downs_jun2021_60bins %>%
  subset(ssid_num < 500)%>%
  subset(!is.na(mediansplit_sample_valence2))%>%
  group_by(ssid, tNo)%>%
  arrange(ssid,tNo, timerezero3)%>%
   ggplot(aes(timerezero3, pup_basCor, color = four))+
  stat_smooth(se = F)
  geom_line(aes(y = pup_vel_smooth), color = 'red')
  
  
  tmp.df4_full_stim_downs_jun2021_60bins %>%
  subset(ssid_num < 500)%>%
  subset(!is.na(mediansplit_sample_valence2))%>%
  group_by(ssid, tNo)%>%
  arrange(ssid,tNo, timerezero3)%>%
   ggplot(aes(timerezero3, pup_vel_smooth, color = four))+
  stat_smooth(se = F)
  geom_line(aes(y = pup_vel_smooth), color = 'red')

  
  tmp.df4_full_stim_downs_jun2021_60bins %>%
  subset(ssid_num < 500)%>%
  subset(!is.na(mediansplit_sample_valence2))%>%
  group_by(ssid, tNo)%>%
  arrange(ssid,tNo, timerezero3)%>%
   ggplot(aes(timerezero3, pup_basCor, color = four))+
  stat_smooth(se = F)
  geom_line(aes(y = pup_vel_smooth), color = 'red')



  

```




is velocity correlated with puypil amplitude
```{r}
require(tidyverse)

tmp.df4_full_stim_downs_jun2021_60bins %>%
  group_by(stimIAPS)%>%
  mutate(cor_vel_pup = cor(pup_vel_smooth,pup_basCor, use = 'complete'))%>%
  mutate(vel_max = max(pup_vel_smooth,na.rm = TRUE))%>%
  summarise_if(is.numeric, mean,na.rm = TRUE)%>%
  ggplot(aes(vel_max,pup_basCor))+
  geom_point()+
  geom_smooth(method = 'lm')+
  ggpubr::stat_cor()

```
velocity timecourse
```{r}
# let's test the interaction term
nbins<- unique(tmp.df4_full_stim_downs_jun2021_60bins$timebin_no)
range(tmp.df4_full_stim_downs_jun2021_60bins$timebin_no)

unique(tmp.df4_full_stim_downs_jun2021_60bins$timebin_no)

# nbins = 60 # number of bins

# create and empty dataframe for the timecourse analyses
timecourse_60bin_result_df_vel <- data.frame(timebins= rep(NA, 60), 
                                       Estimate_ar= rep(NA, 60), 
                                       t_ar=rep(NA, 60), 
                                       p_ar=rep(NA, 60),
                                       Estimate_vl= rep(NA, 60), 
                                       t_vl=rep(NA, 60), 
                                       p_vl=rep(NA, 60),
                                       Estimate_br= rep(NA, 60), 
                                       t_br=rep(NA, 60), 
                                       p_br=rep(NA, 60),
                                       Estimate_ar_vl= rep(NA, 60), 
                                       t_ar_vl=rep(NA, 60), 
                                       p_ar_vl=rep(NA, 60),
                                       cov= as.character(rep(NA,60)))

# View(timecourse_result_df)
# nbins<- nbins[1:60]

i = 0 # remember to always rezero it
# b = 10

# rm(i,b)

tmp.df4_full_stim_downs_jun2021_60bins$pup_vel_smooth

nbins<- nbins[3:59]

for (b in 3:length(nbins)) {
  # for (s in 1:length(nsim)) {

    message(sprintf("$$$$$RUNING lmer %i", nbins[b]))
        lmer_bin_pup  <- lmer(pup_velocity ~ (arousal_c* valence)+Mean_gray_z  +
                                (1 | ssid),
                                # (0 +arousal_c* valence | ssid),
                                # (1|stimIAPS),
                              REML = FALSE,
                      data = subset(tmp.df4_full_stim_downs_jun2021_60bins,
                                    !is.na(pup_vel_smooth)&
                                      ssid_num< 500 &
                                    timebin_no == nbins[b]))

        # store results from the simulation
            lmer_bin_pup_summary<- summary(lmer_bin_pup)
            lmer_bin_pup_summary
            # lmer_bin_pup_summary[["coefficients"]][3,1]
            timecourse_60bin_result_df_vel[i,1]<- tmp.df4_full_stim_downs_jun2021_60bins$timerezero3[b] 
            #save the exact value of time bin
            # store arousal (2,parameter)            # first number is term(row), second is column
            timecourse_60bin_result_df_vel[i,2]<-
            lmer_bin_pup_summary[["coefficients"]][2,1] #estimate
            timecourse_60bin_result_df_vel[i,3]<-
              lmer_bin_pup_summary[["coefficients"]][2,4] # t statistic
            timecourse_60bin_result_df_vel[i,4]<-
            lmer_bin_pup_summary[["coefficients"]][2,5] # p value
            
            # valence
            
            timecourse_60bin_result_df_vel[i,5]<-
            lmer_bin_pup_summary[["coefficients"]][3,1] #estimate
            timecourse_60bin_result_df_vel[i,6]<-
              lmer_bin_pup_summary[["coefficients"]][3,4] # t statistic
            timecourse_60bin_result_df_vel[i,7]<-
              lmer_bin_pup_summary[["coefficients"]][3,5] # p value
            
            # brighteness
            
            timecourse_60bin_result_df_vel[i,8]<-
            lmer_bin_pup_summary[["coefficients"]][4,1] #estimate
            timecourse_60bin_result_df_vel[i,9]<-
              lmer_bin_pup_summary[["coefficients"]][4,4] # t statistic
            timecourse_60bin_result_df_vel[i,10]<-
              lmer_bin_pup_summary[["coefficients"]][4,5] # p value
            
            # interaction arousal x brighteness
            
            timecourse_60bin_result_df_vel[i,11]<-
            lmer_bin_pup_summary[["coefficients"]][5,1] #estimate
            timecourse_60bin_result_df_vel[i,12]<-
              lmer_bin_pup_summary[["coefficients"]][5,4] # t statistic
            timecourse_60bin_result_df_vel[i,13]<-
              lmer_bin_pup_summary[["coefficients"]][5,5] # p value
            
            
            timecourse_60bin_result_df_vel[i,14] <-
              ifelse(length(lmer_bin_pup_summary$optinfo$conv$lme4$message)
                                                   != 0,
                                               lmer_bin_pup_summary$optinfo$conv$lme4$message, 'pass')

     i = i+1
}
# timecourse_result_df_pos<- timecourse_result_df
View(timecourse_60bin_result_df_vel)

timecourse_60bin_result_df_vel %>%
  ggplot(aes(timebins, t))+
  geom_line(size = 2)+
  geom_line(aes(y = p), linetype = "dashed", size = 2)+
  geom_hline(yintercept = .05, color = 'red', size = 1.5)

View(timecourse_60bin_result_df_vel)

range(timecourse_60bin_result_df_vel$Estimate_ar, na.rm = TRUE)
timecourse_60bin_result_df_vel %>%
  subset(!is.na(Estimate_ar))%>%
  ggplot(aes(timebins, Estimate_ar))+
  geom_line(size = 1)+
  geom_line(aes(y = Estimate_vl), linetype = "dashed", size = 1)+
  geom_line(aes(y = Estimate_br), linetype = "dotted", size = 1)+
  geom_line(aes(y = Estimate_ar_vl), linetype = "dotdash", size = 1, color = "red")+
  geom_hline(yintercept = 0.2)
  ylim(-.1,.25)
  
```

```{r}
# adjust p values and tag as TRUE whenevee there is at least 3 consecutive p values below .05
?p.adjust
timecourse_60bin_result_df_vel$p_ar_adj<- p.adjust(timecourse_60bin_result_df_vel$p_ar, method = "holm")
timecourse_60bin_result_df_vel$p_ar_adj_TRUE<- if_else(timecourse_60bin_result_df_vel$p_ar_adj<.05, TRUE, FALSE)


timecourse_60bin_result_df_vel$p_vl_adj <- p.adjust(timecourse_60bin_result_df_vel$p_vl, method = "holm")
timecourse_60bin_result_df_vel$p_vl_adj_TRUE<- if_else(timecourse_60bin_result_df_vel$p_vl_adj<.05, TRUE, FALSE)

timecourse_60bin_result_df_vel$p_br_adj <- p.adjust(timecourse_60bin_result_df_vel$p_br, method = "holm")
timecourse_60bin_result_df_vel$p_br_adj_TRUE<- if_else(timecourse_60bin_result_df_vel$p_br_adj<.05, TRUE, FALSE)

timecourse_60bin_result_df_vel$p_ar_vl_adj <- p.adjust(timecourse_60bin_result_df_vel$p_ar_vl, method = "holm")
timecourse_60bin_result_df_vel$p_ar_vl_adj_TRUE<- if_else(timecourse_60bin_result_df_vel$p_ar_vl_adj<.05, TRUE, NULL)

# find the first and last true in a sequence of TRUES
duplicated(timecourse_60bin_result_df_vel$p_ar_adj_TRUE, na.rm = TRUE)

# https://masterr.org/r/how-to-find-consecutive-repeats-in-r/
timecourse_60bin_result_df_vel$test<- NULL

timecourse_60bin_result_df_vel$test <- rle(timecourse_60bin_result_df_vel$p_ar < 0.05)
# View(runs)
# 
# runs[2]
# myruns = which(runs$values == TRUE & runs$lengths >= 3)

View(timecourse_60bin_result_df_vel)
```

```{r}
#  let's use the order arousal, valence, arousal x valence brightness
timecourse_60bin_result_df_vel %>% 
  select("timebins","Estimate_ar", "Estimate_vl", "Estimate_br", "Estimate_ar_vl") %>% 
  pivot_longer(-timebins, names_to = "variable", values_to = "Estimate")%>%
    subset(!is.na(Estimate))%>%
  #change the order of the coloring variable here and the name of legends
  mutate(variable = factor(variable, c("Estimate_ar", "Estimate_vl","Estimate_ar_vl",  "Estimate_br"), labels = c("arousal", "valence", "arousal x valence", "brightness")))%>%
  ggplot(aes(timebins, Estimate, group = variable, color= variable))+
  geom_line(aes(linetype = variable), size = 1)+
  
  scale_color_brewer(palette = "Dark2")
    # scale_color_manual(values=c("#1B9E77", "#D95F02", "#7570B3", "#E7298A"))+
  # use hom correction for significance
  
    # brighteness
    timecourse_60bin_result_df_vel$timebins[timecourse_60bin_result_df_vel$p_br_adj_TRUE == TRUE]
  
    annotate(geom = 'rect', # use annotate instead of geom_rect, as it is more flexible
             xmin = .16, # got these values from the data-frame. need to fidn a way to automate this
                xmax = 6,
                ymin = -2.03+(sf*.3), # if I ever need to change this, use the scaling factor sf
                ymax = -2+.1+.01+(sf*.3),
                fill =  "#E7298A" , alpha = .5)+ 
    
      annotate("text", 
                x = (1+5.4)/2,
                y = ((-2) +(-2+.1))/2+(sf*.3),
                label = "brightness") +
    
    # arousal
  
    # timecourse_60bin_result_df$p_ar_adj
    # timecourse_60bin_result_df$timebins[timecourse_60bin_result_df$p_ar_adj_TRUE == TRUE]
     annotate(geom = 'rect', xmin = 1,
                xmax = 5.89,
                ymin = -2.03+.1+.1+.1+.1+(sf*.3),
                ymax = -2+.1+.1+.1+.1+.1+.01+(sf*.3),
                fill = "#1B9E77", alpha = .5)+
        annotate("text", 
                  x = (1+5.4)/2,
                y = ((-2+.1+.1+.1+.1) +(-2+.1+.1+.1+.1+.1))/2+(sf*.3),
                 label = "arousal") +

    # arousal-valence
   # timecourse_60bin_result_df$p_ar_vl_adj
    # timecourse_60bin_result_df$timebins[timecourse_60bin_result_df$p_ar_vl_adj_TRUE == TRUE]
       annotate(geom = 'rect', 
                xmin = 1,
                xmax = 5.4,
                ymin = -2.03+.1+.1+(sf*.3),
                ymax = -2+.1+.1+.1+.01+(sf*.3),
                
                fill ="#7570B3", alpha = .5, label = "text")+
    annotate("text", 
                x = (1+5.4)/2,
                y = ((-2+.1+.1) +(-2+.1+.1+.1))/2+(sf*.3),
                label = "arousal x valence") +
        xlab("Time (s)")+
    ylab("Effect size")+
    xlab("Time (s)")+
    ylab("Effect size")

plots_timecourse$eff_size_pup_amp 
# need to rename the label legends


# Edit legend title and labels
plots_timecourse$eff_size_pup_amp <- plots_timecourse$eff_size_pup_amp + 
  p$graphstyle +
    guides(colour = guide_legend(override.aes = list(size=2)))+ #the line size of the legend tends to be smaller in print
  scale_x_continuous(limits = c(0,6), breaks = c(0,2,4,6))+
  scale_y_continuous(limits = c(-2,.7), breaks = c(-1, -0.5, 0,0.5))
  


plots_timecourse$eff_size_pup_amp


    # valence - no significance
      
    
    # scale_fill_brewer()
    
?annotate



```


velocity = actual velocity unlike speed (which is what I actually computed above. velocity encodes direction( constriction or dilation)


```{r}
# let's test the interaction term
nbins<- unique(tmp.df4_full_stim_downs_jun2021_60bins$timebin_no)
range(tmp.df4_full_stim_downs_jun2021_60bins$timebin_no)

unique(tmp.df4_full_stim_downs_jun2021_60bins$timebin_no)

# nbins = 60 # number of bins

# create and empty dataframe for the timecourse analyses
timecourse_60bin_result_df_vel_dir <- data.frame(timebins= rep(NA, 60), 
                                       Estimate_ar= rep(NA, 60), 
                                       t_ar=rep(NA, 60), 
                                       p_ar=rep(NA, 60),
                                       Estimate_vl= rep(NA, 60), 
                                       t_vl=rep(NA, 60), 
                                       p_vl=rep(NA, 60),
                                       Estimate_br= rep(NA, 60), 
                                       t_br=rep(NA, 60), 
                                       p_br=rep(NA, 60),
                                       Estimate_ar_vl= rep(NA, 60), 
                                       t_ar_vl=rep(NA, 60), 
                                       p_ar_vl=rep(NA, 60),
                                       cov= as.character(rep(NA,60)))


i = 0 # remember to always rezero it
# rm(i,b)

# i =1

for (b in 3:length(nbins)) {
  # for (s in 1:length(nsim)) {

    message(sprintf("$$$$$RUNING lmer %i", nbins[b]))
        lmer_bin_pup  <- lmer(pup_velocity_dir ~ (arousal_c* valence)+Mean_gray_z  +
                                (1 | ssid),
                                # (0 +arousal_c* valence | ssid),
                                # (1|stimIAPS),
                              REML = FALSE,
                      data = subset(tmp.df4_full_stim_downs_jun2021_60bins,
                                    ssid_num< 500&
                                    !is.na(pup_vel_smooth) &
                                    timebin_no == nbins[b]))

        # store results from the simulation
            lmer_bin_pup_summary<- summary(lmer_bin_pup)
            lmer_bin_pup_summary
            # lmer_bin_pup_summary[["coefficients"]][3,1]
            timecourse_60bin_result_df_vel_dir[i,1]<- tmp.df4_full_stim_downs_jun2021_60bins$timerezero3[b] 
            #save the exact value of time bin
            # store arousal (2,parameter)            # first number is term(row), second is column
            timecourse_60bin_result_df_vel_dir[i,2]<-
            lmer_bin_pup_summary[["coefficients"]][2,1] #estimate
            timecourse_60bin_result_df_vel_dir[i,3]<-
              lmer_bin_pup_summary[["coefficients"]][2,4] # t statistic
            timecourse_60bin_result_df_vel_dir[i,4]<-
            lmer_bin_pup_summary[["coefficients"]][2,5] # p value
            
            # valence
            
            timecourse_60bin_result_df_vel_dir[i,5]<-
            lmer_bin_pup_summary[["coefficients"]][3,1] #estimate
            timecourse_60bin_result_df_vel_dir[i,6]<-
              lmer_bin_pup_summary[["coefficients"]][3,4] # t statistic
            timecourse_60bin_result_df_vel_dir[i,7]<-
              lmer_bin_pup_summary[["coefficients"]][3,5] # p value
            
            # brightness
            
            timecourse_60bin_result_df_vel_dir[i,8]<-
            lmer_bin_pup_summary[["coefficients"]][4,1] #estimate
            timecourse_60bin_result_df_vel_dir[i,9]<-
              lmer_bin_pup_summary[["coefficients"]][4,4] # t statistic
            timecourse_60bin_result_df_vel_dir[i,10]<-
              lmer_bin_pup_summary[["coefficients"]][4,5] # p value
            
            # interaction arousal x brighteness
            
            timecourse_60bin_result_df_vel_dir[i,11]<-
            lmer_bin_pup_summary[["coefficients"]][5,1] #estimate
            timecourse_60bin_result_df_vel_dir[i,12]<-
              lmer_bin_pup_summary[["coefficients"]][5,4] # t statistic
            timecourse_60bin_result_df_vel_dir[i,13]<-
              lmer_bin_pup_summary[["coefficients"]][5,5] # p value
            
            
            timecourse_60bin_result_df_vel_dir[i,14] <-
              ifelse(length(lmer_bin_pup_summary$optinfo$conv$lme4$message)
                                                   != 0,
                                               lmer_bin_pup_summary$optinfo$conv$lme4$message, 'pass')

     i = i+1
}
# timecourse_result_df_pos<- timecourse_result_df
View(timecourse_60bin_result_df_vel_dir)

View(timecourse_60bin_result_df_vel_dir)

timecourse_60bin_result_df_vel_dir %>%
  ggplot(aes(timebins, Estimate_ar))+
  geom_line(size = 1)+
  geom_line(aes(y = Estimate_vl), linetype = "dashed", size = 1)+
  geom_line(aes(y = Estimate_br), linetype = "dotted", size = 1)+
  geom_line(aes(y = Estimate_ar_vl), linetype = "dotdash", size = 1, color = "red")
  ylim(-.1,5)
  
  
# adjust p values and tag as TRUE whenevee there is at least 3 consecutive p values below .05
?p.adjust
timecourse_60bin_result_df_vel_dir$p_ar_adj<- p.adjust(timecourse_60bin_result_df_vel_dir$p_ar, method = "holm")
timecourse_60bin_result_df_vel_dir$p_ar_adj_TRUE<- if_else(timecourse_60bin_result_df_vel_dir$p_ar_adj<.05, TRUE, FALSE)


timecourse_60bin_result_df_vel_dir$p_vl_adj <- p.adjust(timecourse_60bin_result_df_vel_dir$p_vl, method = "holm")
timecourse_60bin_result_df_vel_dir$p_vl_adj_TRUE<- if_else(timecourse_60bin_result_df_vel_dir$p_vl_adj<.05, TRUE, FALSE)

timecourse_60bin_result_df_vel_dir$p_br_adj <- p.adjust(timecourse_60bin_result_df_vel_dir$p_br, method = "holm")
timecourse_60bin_result_df_vel_dir$p_br_adj_TRUE<- if_else(timecourse_60bin_result_df_vel_dir$p_br_adj<.05, TRUE, FALSE)

timecourse_60bin_result_df_vel_dir$p_ar_vl_adj <- p.adjust(timecourse_60bin_result_df_vel_dir$p_ar_vl, method = "holm")
timecourse_60bin_result_df_vel_dir$p_ar_vl_adj_TRUE<- if_else(timecourse_60bin_result_df_vel_dir$p_ar_vl_adj<.05, TRUE, NULL)

# find the first and last true in a sequence of TRUES
duplicated(timecourse_60bin_result_df_vel_dir$p_ar_adj_TRUE, na.rm = TRUE)

# https://masterr.org/r/how-to-find-consecutive-repeats-in-r/
timecourse_60bin_result_df_vel_dir$test<- NULL

timecourse_60bin_result_df_vel_dir$test <- rle(timecourse_60bin_result_df_vel_dir$p_ar < 0.05)
```


pupiul velocity and speed might better caprure arousal dynamics because the temporal dynamics are less adffected by a susrtauned effect of brighetenss. whereas amplitude is p[robably strongly affected by brighteness which restricts variability in input from a arousal componenets