---
title: "Paper_analyses"
author: "Helio"
date: "22/07/2021"
output: html_document
---


Code for the paper: Valence modulated “subjective-objective” arousal

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```



Participants section

```{r}
participants_demog <- db_full4new_stim_screen_pupil_nopract %>%
  subset(Group == "NT")%>%
  group_by(ssid, Gender)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)

# gender
table(participants_demog$Gender)
colnames(participants_demog)
summary(participants_demog$Age)
sd(participants_demog$Age, na.rm = TRUE)
# table(is.na(participants_demog$Age))
```



Pupil changes and subjective arousal and valence ratings


# let's model it formally
  
# remember baseline corection is equivalendt to stimuli intercept
 
```{r} 
pupil_arousal_findings<- list()
library(lmerTest)

unique(db_full4new_stim_screen_pupil_nopract$stimIAPS)
unique(substr(db_full4new_stim_screen_pupil_nopract$stimIAPS, 1,8))
db_full4new_stim_screen_pupil_nopract$Label<- substr(db_full4new_stim_screen_pupil_nopract$stimIAPS, 1,8)


db_full4new_stim_screen_pupil_nopract<- left_join(db_full4new_stim_screen_pupil_nopract, imageJ_IAPS, by = "Label")

nrow(db_full4new_stim_screen_pupil_nopract)
# rows = 2858

db_full4new_stim_screen_pupil_nopract$Mean_gray_z<- scale(db_full4new_stim_screen_pupil_nopract$Mean, center = TRUE, scale = TRUE)[,1]


db_full4new_stim_screen_pupil_nopract$ssid_num <- as.numeric(as.character(db_full4new_stim_screen_pupil_nopract$ssid))


```


lmer pupil

```{r}
options(contrasts = c("contr.sum","contr.poly"))
options(scipen = 999)


pupil_arousal_findings$pupil_from_arousal <- lmer(pup_basCor ~ arousal_c*Mean_gray_z  +(1 +Mean_gray_z | ssid) + (0+arousal_c| ssid), REML = FALSE,
                      data = subset(db_full4new_stim_screen_pupil_nopract, 
                                    pupil_outlier == FALSE & ssid_num< 500 & 
                                    arousal_outler == FALSE))

summary(pupil_arousal_findings$pupil_from_arousal)
# singularity (drop arousal c slope)

# is there a correlation between mean arousal rating and meang, gray(

db_full4new_stim_screen_pupil_nopract%>%
  group_by(stimIAPS,ground_valence_lab) %>%
  summarise_at(c('arousal_c', 'Mean_gray_z'), mean, na.rm = TRUE)%>%
  ggplot(aes(arousal_c, Mean_gray_z, color = ground_valence_lab))+
  geom_point()+
  ggpubr::stat_cor()

```


# Valence and arousal
```{r}

pupil_arousal_findings$pupil_from_ar_vale <- lmer(pup_basCor ~ (valence_c* arousal_c) +
                                                    Mean_gray_z  +
                                                    (1 + Mean_gray_z | ssid)+
                                                    (0+ valence_c* arousal_c | ssid),
                                                  REML = FALSE,
                      data = subset(db_full4new_stim_screen_pupil_nopract, 
                                    pupil_outlier == FALSE & ssid_num< 500 & 
                                      arousal_outler == FALSE))

# relgrad <- with(pupil_arousal_findings$pupil_from_ar_vale@optinfo$derivs,solve(Hessian,gradient))
# max(abs(relgrad))0.0002044252

summary(pupil_arousal_findings$pupil_from_ar_vale)
plot(pupil_arousal_findings$pupil_from_ar_vale)

# car::vif(pupil_arousal_findings$pupil_from_ar_vale) #curoff 4


interactions::interact_plot(pupil_arousal_findings$pupil_from_ar_val_gaze , pred = arousal_c, modx = valence_c)

interactions::interact_plot(pupil_arousal_findings$pupil_from_ar_val_gaze , pred = valence_c , modx = arousal_c)

# export model table
library(MuMIn)
library(sjmisc)
sjPlot::tab_model(pupil_arousal_findings$pupil_from_ar_vale)

```

Linear mixed model fit by maximum likelihood . t-tests use Satterthwaite's method ['lmerModLmerTest']
Formula: pup_basCor ~ (valence_c * arousal_c) + Mean_gray_z + (1 + Mean_gray_z |  
    ssid) + (0 + valence_c * arousal_c | ssid)
   Data: subset(db_full4new_stim_screen_pupil_nopract, pupil_outlier ==      FALSE & ssid_num < 500 & arousal_outler == FALSE)

     AIC      BIC   logLik deviance df.resid 
  8493.9   8579.2  -4231.9   8463.9     2170 

Scaled residuals: 
    Min      1Q  Median      3Q     Max 
-3.6141 -0.5987  0.0067  0.5952  3.6796 

Random effects:
 Groups   Name                Variance Std.Dev. Corr       
 ssid     (Intercept)         0.78415  0.8855              
          Mean_gray_z         0.13611  0.3689   0.55       
 ssid.1   valence_c           0.04233  0.2057              
          arousal_c           0.02296  0.1515    0.89      
          valence_c:arousal_c 0.01700  0.1304   -0.19  0.01
 Residual                     2.57999  1.6062              
Number of obs: 2185, groups:  ssid, 43

Fixed effects:
                    Estimate Std. Error       df t value             Pr(>|t|)    
(Intercept)         -0.66764    0.14166 44.77819  -4.713          0.000023962 ***
valence_c            0.08546    0.06557 28.33677   1.303              0.20294    
arousal_c            0.44137    0.06445 22.53213   6.848          0.000000619 ***
Mean_gray_z         -0.96311    0.06622 43.35750 -14.544 < 0.0000000000000002 ***
valence_c:arousal_c  0.15461    0.04434 24.37046   3.487              0.00187 ** 
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

Correlation of Fixed Effects:
            (Intr) vlnc_c arsl_c Mn_gr_
valence_c   -0.042                     
arousal_c   -0.031  0.746              
Mean_gray_z  0.453 -0.013  0.028       
vlnc_c:rsl_  0.147 -0.267 -0.128  0.035

same analyses as above but regress brightness out of pupil

```{r}

pupil_arousal_findings$pupil_from_brightness <- lmer(pup_basCor ~ 
                                                    Mean  +
                                                    (1  | ssid),
                                                    # (0+ valence_c* arousal_c | ssid),
                                                  REML = FALSE,
                      data = subset(db_full4new_stim_screen_pupil_nopract, 
                                    # pupil_outlier == FALSE & ssid_num< 500 & 
                                      # arousal_outler == FALSE
                                    ))

pupil_arousal_findings$pupil_from_brightness_lm <- lm(pup_basCor ~ 
                                                    Mean,
                                                    
                      data = subset(db_full4new_stim_screen_pupil_nopract, 
                                    # pupil_outlier == FALSE & ssid_num< 500 & 
                                      # arousal_outler == FALSE
                                    ))



summary(pupil_arousal_findings$pupil_from_brightness)

plot(pupil_arousal_findings$pupil_from_brightness)

# store residuals
db_full4new_stim_screen_pupil_nopract$pup_resid <- resid(pupil_arousal_findings$pupil_from_brightness)

db_full4new_stim_screen_pupil_nopract$pup_resid_lm <-
resid(pupil_arousal_findings$pupil_from_brightness_lm)


db_full4new_stim_screen_pupil_nopract%>%
  ggplot(aes(pup_resid, Mean_gray_z))+
  geom_point()+
  geom_smooth(method = 'lm', se = F)+
  ggpubr::stat_cor()

# no correlated with IV - good


db_full4new_stim_screen_pupil_nopract%>%
  ggplot(aes(pup_resid, pup_basCor))+
  geom_point()+
  geom_smooth(method = 'lm', se = F)+
  ggpubr::stat_cor()

# strong correlation, in this case this is good, because it means there is a large ammount of unexplain ed variane not acconted for by the predictor



# predict pupil residuals
pupil_arousal_findings$pupil_resid_from_ar_vale <- lmer(pup_resid_lm ~ (arousal_c*valence_c) +
                                                    
                                                    (1+arousal_c*valence_c  | ssid),
                                                    # (0+ valence_c* arousal_c | ssid),
                                                  REML = FALSE,
                      data = subset(db_full4new_stim_screen_pupil_nopract, 
                                    pupil_outlier == FALSE &
                                    ssid_num< 500 
                                    &
                                      arousal_outler == FALSE
                                      )) # results hold with or withouth outliers 


summary(pupil_arousal_findings$pupil_resid_from_ar_vale)

# using residuals from lmer create a singularity as they eliminate individual participants variability, this is solved by using residuals from lm


interactions::interact_plot(pupil_arousal_findings$pupil_resid_from_ar_vale , pred = arousal_c, modx = valence_c)

interactions::interact_plot(pupil_arousal_findings$pupil_resid_from_ar_vale , pred = valence_c , modx = arousal_c)


```



Predict arousal from pupil


```{r}
# with arousal as DV
pupil_arousal_findings$arousal_from_pup <- lmer(arousal_c ~ valence_c*pup_basCor  + (1| stimIAPS)+
                                                 # (1 | ssid),
                                                  (0 +valence_c+pup_basCor | ssid),
                                                REML = FALSE,
                      data = subset(db_full4new_stim_screen_pupil_nopract, 
                                    pupil_outlier == FALSE & ssid_num<500 & 
                                      arousal_outler == FALSE))
summary(pupil_arousal_findings$arousal_from_pup)
anova(pupil_arousal_findings$arousal_from_pup)

# expected correlation between valence and pupil is low



interactions::interact_plot(pupil_arousal_findings$arousal_from_pup , pred = valence_c, modx = pup_basCor)

interactions::interact_plot(pupil_arousal_findings$arousal_from_pup, pred =pup_basCor , modx =  valence_c) #better 
# same pattern
# pupil is more aligned with subjective arousal in the more positive trials



# flip dv to valence

pupil_arousal_findings$valence_from_pup <- lmer(valence_c ~ arousal_c*pup_basCor  + (1| stimIAPS)+
                                                 # (1 | ssid),
                                                  (0 +arousal_c +pup_basCor | ssid),
                                                REML = FALSE,
                      data = subset(db_full4new_stim_screen_pupil_nopract, 
                                    pupil_outlier == FALSE & ssid_num<500 & 
                                      arousal_outler == FALSE))
summary(pupil_arousal_findings$valence_from_pup)
anova(pupil_arousal_findings$valence_from_pup)

# so it's not the case that pupil is tracking valence
# it's the case that arousal pupil relation is modulated by valence, and this is true regardless of whether we use a maximal or minimal model

interactions::interact_plot(pupil_arousal_findings$valence_from_pup , pred = valence_c, modx = pup_basCor)

interactions::interact_plot(pupil_arousal_findings$valence_from_pup, pred =pup_basCor , modx =  arousal_c)



```


Timecourse analyses

# prepare timecourse data
```{r prepare timecourse data}
rm(justone_test, lucy_plots, test)

# import the timecourse

tmp.df4_full_stim_downs_jun2021 <- readRDS("~/OneDrive - Nexus365/InteroStudy2020/analysis/DataAnalysisJanuary2020/DataAnalysisJan2020/tmp.df4_full_stim_downs_jun2021.rds")


# merge with behavioral data
unique(db_full4new_stim_screen_pupil_nopract$ssid)
# colnames(db_full4new_stim_screen_pupil_nopract)
# colnames(tmp.df4_full_stim_downs_jun2021)
# db_full4new_stim
# colnames(db_full4new_stim_screen_pupil_nopract)
db_full4new_stim_subset<- db_full4new_stim_screen_pupil_nopract[,c(1:4,6:7,12:13,16,21:27, 31:56,80:81,84:96,98:114,116:124)]


# match types of merging variables
tmp.df4_full_stim_downs_jun2021_with_beh2$ssid<- as.character(tmp.df4_full_stim_downs_jun2021_with_beh2$ssid)
db_full4new_stim_subset$ssid<- as.character(db_full4new_stim_subset$ssid)

# tNo
tmp.df4_full_stim_downs_jun2021_with_beh2$tNo <- as.character(tmp.df4_full_stim_downs_jun2021_with_beh2$tNo)
db_full4new_stim_subset$tNo <- as.character(db_full4new_stim_subset$tNo)
unique(db_full4new_stim_subset$tNo)
unique(tmp.df4_full_stim_downs_jun2021_with_beh2$tNo)

# merge
nrow(tmp.df4_full_stim_downs_jun2021_with_beh2)
# 87529

table(is.na(db_full4new_stim_subset$mediansplit_self_valence))

tmp.df4_full_stim_downs_jun2021_with_beh2$tNo<- as.numeric(tmp.df4_full_stim_downs_jun2021_with_beh2$tNo)
tmp.df4_full_stim_downs_jun2021_with_beh2<- tmp.df4_full_stim_downs_jun2021_with_beh2%>%
  arrange(ssid,tNo, timerezero3)

tmp.df4_full_stim_downs_jun2021_with_beh<- left_join(tmp.df4_full_stim_downs_jun2021_with_beh2, db_full4new_stim_subset)

db_full4new_stim_subset$tNo<- as.numeric(db_full4new_stim_subset$tNo)


table(is.na(db_full4new_stim_subset$arousal))

tmp.df4_full_stim_downs_jun2021_with_behnew<- right_join(tmp.df4_full_stim_downs_jun2021_with_beh2, db_full4new_stim_subset,
                                                     by = c('ssid', 'tNo'))

nrow(tmp.df4_full_stim_downs_jun2021_with_beh)
# 172168 good

nrow(tmp.df4_full_stim_downs_jun2021_with_beh2)
# 87529
nrow(tmp.df4_full_stim_downs_jun2021_with_behnew)

table(is.na(tmp.df4_full_stim_downs_jun2021_with_behnew$mediansplit_self_valence))


```


Quick check that things make sense
```{r}
tmp.df4_full_stim_downs_jun2021_with_beh %>%
  subset(!is.na(ground_arousal_lab))%>%
  ggplot(aes(x = timerezero3, y = pup_basCor))+
  stat_smooth(aes(group= ground_arousal_lab, color = ground_arousal_lab), fun = mean,geom = "line",
               se = F, alpha = .1, size = 1.5)+
  stat_smooth(aes(group=ground_arousal_lab, color = ground_arousal_lab), size = 3)+  
theme_classic()+
  ylab("Pupil size (z)")+
  xlab("Time (s)")+
  # p$graphstyle+
  scale_color_brewer(palette = "Dark2")+
  xlim(0,6)+
   facet_grid(~mediansplit_self_valence)

# group_by(stimIAPS)%>%
tmp.df4_full_stim_downs_jun2021_with_beh<- tmp.df4_full_stim_downs_jun2021_with_beh %>%
  ungroup()%>%
  mutate(mediansplit_sample_valence2 = 
           if_else(ValenceMeanThisSample >= 
                     median(ValenceMeanThisSample,
                            na.rm = TRUE), 
                   "More positive", "More negative"))%>%
  mutate(mediansplit_sample_arousal2 = if_else(ArousalMeanThisSample >=
                                                  median(ArousalMeanThisSample,
                                                         na.rm = TRUE), "High", "Low"))



```


let's test the interaction term
```{r}
nrow(nbins)
nbins = 30 # number of bins

# create and empty dataframe for the timecourse analyses
timecourse_result_df_int <- data.frame(timebins= rep(NA, 30), Estimate= rep(NA, 30), 
                                   t=rep(NA, 30), p=rep(NA, 30), cov= as.character(rep(NA,30)))

# View(timecourse_result_df)
nbins<- nbins[1:28]

i = 0 # remember to always rezero it
# b = 10

rm(i,b)

nbins<- unique(tmp.df4_full_stim_downs_jun2021_with_behnew$timebin_no)

for (b in 1:length(nbins)) {
  # for (s in 1:length(nsim)) {

    message(sprintf("$$$$$RUNING lmer %i", nbins[b]))
        lmer_bin_pup  <- lmer(pup_basCor ~ arousal_c* valence+Mean_gray_z  +
                                (1 | ssid)+
                                (0 +arousal_c* valence | ssid),
                                # (1|stimIAPS),
                              REML = FALSE,
                      data = subset(tmp.df4_full_stim_downs_jun2021_with_behnew,
                                    # mediansplit_self_valence == "More positive" & 
                                    timebin_no == nbins[b]))

        #store results from the simulation
            lmer_bin_pup_summary<- summary(lmer_bin_pup)
            lmer_bin_pup_summary
            # lmer_bin_pup_summary[["coefficients"]][3,1]
            timecourse_result_df_int[i,1]<- tmp.df4_full_stim_downs_jun2021_with_behnew$timerezero3[b] #save the exact value of time bin
            timecourse_result_df_int[i,2]<- lmer_bin_pup_summary[["coefficients"]][5,1] # first number is term(row), second is column
            timecourse_result_df_int[i,3]<-lmer_bin_pup_summary[["coefficients"]][5,4] # t statistic
            timecourse_result_df_int[i,4]<-lmer_bin_pup_summary[["coefficients"]][5,5] # p value
            # simulated_clusters_JEFFE[i,6]<- nsim[s] #store simulation ount
            timecourse_result_df_int[i,5] <-ifelse(length(lmer_bin_pup_summary$optinfo$conv$lme4$message)
                                                   != 0,
                                               lmer_bin_pup_summary$optinfo$conv$lme4$message, 'pass')

     i = i+1
}


# timecourse_result_df_pos<- timecourse_result_df

timecourse_result_df_int %>%
  ggplot(aes(timebins, t))+
  geom_line(size = 2)+
  geom_line(aes(y = p), linetype = "dashed", size = 2)+
  geom_hline(yintercept = .05, color = 'red', size = 1.5)


```

Velocity test

```{r}
nrow(nbins)
nbins = 30 # number of bins
unique(tmp.df4_full_stim_downs_jun2021_with_behnew$ssid)
tmp.df4_full_stim_downs_jun2021_with_behnew <- tmp.df4_full_stim_downs_jun2021_with_behnew%>%
  group_by(ssid, tNo)%>%
  arrange(ssid,tNo, timerezero3)%>%
  mutate(pup_vel_smooth = zoo::rollmean(pup_velocity, k = 3, fill = NA))
  
zoo::rollmean(pup_velocity, k = 3, fill = NA)

tmp.df4_full_stim_downs_jun2021_with_behnew$pup_vel_smooth

# create and empty dataframe for the timecourse analyses
timecourse_result_df_int_vel <- data.frame(timebins= rep(NA, 30), Estimate= rep(NA, 30), 
                                   t=rep(NA, 30), p=rep(NA, 30), cov= as.character(rep(NA,30)))

# View(timecourse_result_df)
nbins<- nbins[1:28]

i = 0 # remember to always rezero it
# b = 10

rm(b)

nbins<- unique(tmp.df4_full_stim_downs_jun2021_with_behnew$timebin_no)

for (b in 3:length(nbins)) {
  # for (s in 1:length(nsim)) {

    message(sprintf("$$$$$RUNING lmer %i", nbins[b]))
        lmer_bin_pup  <- lmer(pup_vel_smooth ~ arousal_c* valence+Mean_gray_z  +
                                (1 | ssid)+
                                (0 +arousal_c* valence | ssid),
                                # (1|stimIAPS),
                              REML = FALSE,
                      data = subset(tmp.df4_full_stim_downs_jun2021_with_behnew,
                                    # mediansplit_self_valence == "More positive" & 
                                    timebin_no == nbins[b]))

        #store results from the simulation
            lmer_bin_pup_summary<- summary(lmer_bin_pup)
            lmer_bin_pup_summary
            # lmer_bin_pup_summary[["coefficients"]][3,1]
            timecourse_result_df_int_vel[i,1]<- tmp.df4_full_stim_downs_jun2021_with_behnew$timerezero3[b] #save the exact value of time bin
            timecourse_result_df_int_vel[i,2]<- lmer_bin_pup_summary[["coefficients"]][2,1] # first number is term(row), second is column
            timecourse_result_df_int_vel[i,3]<-lmer_bin_pup_summary[["coefficients"]][2,4] # t statistic
            timecourse_result_df_int_vel[i,4]<-lmer_bin_pup_summary[["coefficients"]][2,5] # p value
            # simulated_clusters_JEFFE[i,6]<- nsim[s] #store simulation ount
            timecourse_result_df_int_vel[i,5] <-ifelse(length(lmer_bin_pup_summary$optinfo$conv$lme4$message)
                                                   != 0,
                                               lmer_bin_pup_summary$optinfo$conv$lme4$message, 'pass')

     i = i+1
}


# timecourse_result_df_pos<- timecourse_result_df

timecourse_result_df_int_vel %>%
  ggplot(aes(timebins, t))+
  geom_line(size = 2)+
  geom_line(aes(y = p), linetype = "dashed", size = 2)+
  geom_hline(yintercept = .05, color = 'red', size = 1.5)+
  geom_vline(xintercept = 1, color = 'red')
  # ylim(-4,4)


??ma
?stats::filter
tmp.df4_full_stim_downs_jun2021_with_behnew%>%
  subset(ssid == 310 & tNo == 10)%>%
  ggplot(aes(timerezero3,zoo::rollmean(pup_velocity, k = 3, fill = NA)))+
  geom_line()+
  geom_line(aes(y = pup_velocity), color = 'red')+
  geom_smooth(se = F)

tmp.df4_full_stim_downs_jun2021_with_behnew%>%
  subset(ssid == 310 & tNo == 15)%>%
  ggplot(aes(timerezero3,pup_basCor))+
  geom_point()+
  # geom_line(aes(y = pup_velocity), color = 'red')+
  geom_smooth(se = F)




```



