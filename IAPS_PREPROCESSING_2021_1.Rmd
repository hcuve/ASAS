---
title: "InteroceptionStudy_GPValidation"
Author: "Helio Cuve & "
date: "8 January 2021"
output: html_document
---


# Loading rdhf5 
```{r}
if (!requireNamespace("BiocManager", quietly = TRUE))
    install.packages("BiocManager")
BiocManager::install(version = "3.10")

BiocManager::install("rhdf5")

library(rhdf5)


```

# Preferences
list necessary package install them if not already and load them
```{r}
# devtools::install_github("dmirman/gazer")


list.of.packages <- c("ggplot2", "data.table", 'readr', "rhdf5", 'tidyverse', "gazer", 'lmerTest')
new.packages <- list.of.packages[!(list.of.packages %in% installed.packages()[,"Package"])]
if(length(new.packages)) install.packages(new.packages)
lapply(list.of.packages, require, character.only = TRUE)
lapply(new.packages, require, character.only = TRUE)

library(purrr)
library(data.table)
library(dplyr)
library(tidyr)

# setting a workspace
# change approproatelly

setwd("D:/OneDrive - Nexus365/InteroStudy2020/analysis/DataAnalysisJanuary2020/DataAnalysisJan2020")
hdf5FilesPath<- "D:/OneDrive - Nexus365/InteroStudy2020/analysis/DataAnalysisJanuary2020/DataAnalysisJan2020"


# 2021 data
setwd("~/OneDrive - Nexus365/InteroStudy2020/analysis/DataAnalysisJanuary2020/DataAnalysisJan2020/Eyetracking/2021")
hdf5FilesPath<- "~/OneDrive - Nexus365/InteroStudy2020/analysis/DataAnalysisJanuary2020/DataAnalysisJan2020/Eyetracking/2021"
```


# gp extractor function
takes gp files and returns a clean files with messages parsed and deletes unnecessary stuff

note that starting from 322 we have gsr-v and hr-v, and pulse

```{r, gp extractor}

# hdf5FilesPath<- "D:/OneDrive - Nexus365/InteroStudy2020/analysis/DataAnalysisJanuary2020/DataAnalysisJan2020/Eyetracking"

hdf5FilesPath<- "~/OneDrive - Nexus365/InteroStudy2020/analysis/DataAnalysisJanuary2020/DataAnalysisJan2020/Eyetracking/2021"

gp.extractor = function(hdf5FilesPath) {
  
  setwd(hdf5FilesPath)
  #getwd()
  hdfFilesList = list.files(hdf5FilesPath, pattern = "\\.hdf5$")
  
  if (length(hdfFilesList) == 0){
    
    return(message('No HDF5 files found in the directory provided.'))
  }
   f = 30
  for (f in 1:length(hdfFilesList)) {
    
    message(sprintf("Extracting file %i / %i - %s", f, length(hdfFilesList), hdfFilesList[f]))
    
    #note that some r-studio bug sometimes causes this to fail when runnin from notebook, 
    # in that case run it directly on command line
    tmp.events =h5read(hdfFilesList[f], '/data_collection/events/experiment/MessageEvent')
  
    tmp.eyetr  = h5read(hdfFilesList[f], '/data_collection/events/eyetracker/BinocularEyeSampleEvent')
    
    # Get subject id from Events
    ssid = sapply(strsplit(grep('SubjJID', tmp.events$text, value = TRUE), split = ": "), "[", 2)
    date = sapply(strsplit(grep('DATE', tmp.events$text, value = TRUE), split = ": "), "[", 2)
    session = sapply(strsplit(grep('Session:', tmp.events$text, value = TRUE), split = ":"), "[", 2)
    cali<- subset(tmp.events, grepl('Cali', tmp.events$text) == TRUE)
    
    # Create DF for trials data
    tmp.df = data.frame(matrix(ncol = ncol(tmp.eyetr)))
    names(tmp.df) = names(tmp.eyetr)
    colnames(tmp.df)
    
    # Prepare Events, keep only start/end messages
    phrases = c('tStart', 'tEnd')
    tmp.events_backup<- tmp.events
    # tmp.events<-  tmp.events_backup
    tmp.events = subset(tmp.events, grepl(paste(phrases, collapse = "|"), tmp.events$text))
    
    # Create start/end references
    tmp.events$tStart   = NA
    tmp.events$tEnd     = NA
    
    # Trial number extraction 
    tmp.events$tNo      = NA
    tmp.df$tNo          = NA
    tmp.df$Condition    = NA
    
    # Space for subject id
    tmp.df$ssid         = NA
    tmp.df$text<-NA
    
    for (l in 1:nrow(tmp.events)) {
 
      message(sprintf("Grabing start messages %s", tmp.events$text[l]))
      
      if ((grepl('tStart', tmp.events$text[l])) == TRUE) {
        tmp.events$tStart[l] = tmp.events$time[l]
        
        if ((grepl('tEnd', tmp.events$text[l+1])) == TRUE){
          tmp.events$tEnd[l] = tmp.events$time[l+1]
        }
        
        else {
          message('trial start/end structure not valid')
        }
      }
      
    }
    message(sprintf("done grabbing messages"))
    # readline(prompt="Press [enter] to continue")
    
    tmp.events$tNo<- as.numeric(as.character(gsub(".*_","",tmp.events$text)))

     message(sprintf("making screencontent"))
     
     tmp.eventsbackup<- tmp.events
    tmp.events$screencontent<- if_else(grepl('fixation', tmp.events$text), 'fixation',
                                       if_else(grepl('Valence', tmp.events$text), 'ValenceResp',
                                               if_else(grepl('rest', tmp.events$text), 'rest1', 
                                                       if_else(grepl('IntResp', tmp.events$text), 'IntResp','stim'))))
    
    # unique(tmp.events$screencontent)
    
    # atorw condition
    
    tmp.events$Condition<- if_else(grepl('IAPS', tmp.events$text), 'IAPS',
                                   if_else(grepl('Example', tmp.events$text), 'Practice',
                                           if_else(grepl('rest', tmp.events$text), 'Rest', NULL)))
    tmp.events$stim<- if_else(tmp.events$Condition == 'IAPS', sub(".*_ *(.*?) *jpg.*", "\\1", tmp.events$text),
                              if_else(tmp.events$Condition == 'Practice', sub(".*_ *(.*?) *jpg.*", "\\1", tmp.events$text), 'REST'))
    
    # substitute periods
    tmp.events$stim<- gsub('\\.', '.jpg', tmp.events$stim)
    
    tmp.events$tNo<- if_else(tmp.events$Condition == 'Practice', (tmp.events$tNo)-6,
                             if_else(tmp.events$Condition == 'Rest',-7, tmp.events$tNo))
    
    # create trial number < 0 are practice trials
    tmp.events$tNo<- if_else(tmp.events$tNo> -1, tmp.events$tNo+1, tmp.events$tNo) # avoid zeros
    
    tmp.events1 = subset(tmp.events, grepl('tStart',tmp.events$text))
    # tmp.events1$tNo1<- NULL
    # tmp.events1$tNo2<- NULL
    
    tmp.events1<- subset(tmp.events1, is.na(tmp.events1$tNo) == FALSE)
  

    # colnames(tmp.df)
    # colnames(tmp.df)
    # colnames(tmp.events1)
    # colnames(tmp.eyetr)
    
    tmp.df$screencontent<- NA
    tmp.df$stim<- NA
    tmp.events1$tEnd<- if_else(tmp.events1$tNo == -7, tmp.events1$tStart+120, tmp.events1$tEnd)
    
    message(sprintf("subsetting eyetracking data"))
    
    for(e in 1:nrow(tmp.events1)) {
      
      # Subset the EyeTracking data based on start/end
      tmp.raw.trial = subset(tmp.eyetr, tmp.eyetr$time >= tmp.events1$tStart[e] & tmp.eyetr$time <= tmp.events1$tEnd[e])
      
      tmp.raw.trial$tNo = tmp.events1$tNo[e]
      
      tmp.raw.trial$Condition = tmp.events1$Condition[e]
      tmp.raw.trial$screencontent = tmp.events1$screencontent[e]
      tmp.raw.trial$stim = tmp.events1$stim[e]
      # tmp.raw.trial$stim = tmp.events1$[e]
      tmp.raw.trial$ssid = ssid
      tmp.raw.trial$text = tmp.events1$text[e]
      
      message(sprintf("binding tmp.df"))
      
      tmp.df= rbind(tmp.raw.trial, tmp.df)
    }
     message(sprintf("done binding"))
    
    # Arrange the dataframe byu time
    tmp.df<- tmp.df%>%
      arrange(time)
    
    # Save file for the task with subject name
    name = sprintf("ss%s_GPdata",ssid)
    message(sprintf("saving data"))
    write_csv(tmp.df, paste(name,".csv"))

    # write calibration file
    name2 = sprintf("ss%s_GPdata_cali", ssid)
    write_csv(cali, paste(name2,".csv"))
    
    
  }
  
  
  message("Processing Completed.")
  tmp.df
}

# run function
tmp_full<- gp.extractor(hdf5FilesPath)

```


Problem files
```{r}
# 355  - did not finish IAPS
# adjust below manually 


hdf5FilesPath<- "~/OneDrive - Nexus365/InteroStudy2020/analysis/DataAnalysisJanuary2020/DataAnalysisJan2020/Eyetracking/2021"

gp.extractor = function(hdf5FilesPath) {
  
  setwd(hdf5FilesPath)
  #getwd()
  hdfFilesList = list.files(hdf5FilesPath, pattern = "\\.hdf5$")
  
  if (length(hdfFilesList) == 0){
    hdfFilesList
    
    return(message('No HDF5 files found in the directory provided.'))
  }
   f = 10
  for (f in 1:length(hdfFilesList)) {
    
    message(sprintf("Extracting file %i / %i - %s", f, length(hdfFilesList), hdfFilesList[f]))
    
    #note that some r-studio bug sometimes causes this to fail when runnin from notebook, 
    # in that case run it directly on command line
    tmp.events =h5read(hdfFilesList[f], '/data_collection/events/experiment/MessageEvent')
  
    tmp.eyetr  = h5read(hdfFilesList[f], '/data_collection/events/eyetracker/BinocularEyeSampleEvent')
    
    # Get subject id from Events
    ssid = sapply(strsplit(grep('SubjJID', tmp.events$text, value = TRUE), split = ": "), "[", 2)
    date = sapply(strsplit(grep('DATE', tmp.events$text, value = TRUE), split = ": "), "[", 2)
    session = sapply(strsplit(grep('Session:', tmp.events$text, value = TRUE), split = ":"), "[", 2)
    cali<- subset(tmp.events, grepl('Cali', tmp.events$text) == TRUE)
    
    # Create DF for trials data
    tmp.df = data.frame(matrix(ncol = ncol(tmp.eyetr)))
    names(tmp.df) = names(tmp.eyetr)
    colnames(tmp.df)
    
    # Prepare Events, keep only start/end messages
    phrases = c('tStart', 'tEnd')
    tmp.events_backup<- tmp.events
    # tmp.events<-  tmp.events_backup
    tmp.events = subset(tmp.events, grepl(paste(phrases, collapse = "|"), tmp.events$text))
    
    # Create start/end references
    tmp.events$tStart   = NA
    tmp.events$tEnd     = NA
    
    # Trial number extraction 
    tmp.events$tNo      = NA
    tmp.df$tNo          = NA
    tmp.df$Condition    = NA
    
    # Space for subject id
    tmp.df$ssid         = NA
    tmp.df$text<-NA
    
    for (l in 1:nrow(tmp.events)) {
 
      message(sprintf("Grabing start messages %s", tmp.events$text[l]))
      
      if ((grepl('tStart', tmp.events$text[l])) == TRUE) {
        tmp.events$tStart[l] = tmp.events$time[l]
        
        if ((grepl('tEnd', tmp.events$text[l+1])) == TRUE){
          tmp.events$tEnd[l] = tmp.events$time[l+1]
        }
        
        else {
          message('trial start/end structure not valid')
        }
      }
      
    }
    message(sprintf("done grabbing messages"))
    # readline(prompt="Press [enter] to continue")
    
    tmp.events$tNo<- as.numeric(as.character(gsub(".*_","",tmp.events$text)))

     message(sprintf("making screencontent"))
     
     tmp.eventsbackup<- tmp.events
    tmp.events$screencontent<- if_else(grepl('fixation', tmp.events$text), 'fixation',
                                       if_else(grepl('Valence', tmp.events$text), 'ValenceResp',
                                               if_else(grepl('rest', tmp.events$text), 'rest1', 
                                                       if_else(grepl('IntResp', tmp.events$text), 'IntResp','stim'))))
    
    # unique(tmp.events$screencontent)
    
    
    tmp.events$Condition<- if_else(grepl('IAPS', tmp.events$text), 'IAPS',
                                   if_else(grepl('Example', tmp.events$text), 'Practice',
                                           if_else(grepl('rest', tmp.events$text), 'Rest', NULL)))
    tmp.events$stim<- if_else(tmp.events$Condition == 'IAPS', sub(".*_ *(.*?) *jpg.*", "\\1", tmp.events$text),
                              if_else(tmp.events$Condition == 'Practice', sub(".*_ *(.*?) *jpg.*", "\\1", tmp.events$text), 'REST'))
    
    # substitute periods
    tmp.events$stim<- gsub('\\.', '.jpg', tmp.events$stim)
    
    tmp.events$tNo<- if_else(tmp.events$Condition == 'Practice', (tmp.events$tNo)-6,
                             if_else(tmp.events$Condition == 'Rest',-7, tmp.events$tNo))
    
    # create trial number < 0 are practice trials
    tmp.events$tNo<- if_else(tmp.events$tNo> -1, tmp.events$tNo+1, tmp.events$tNo) # avoid zeros
    
    tmp.events1 = subset(tmp.events, grepl('tStart',tmp.events$text))
    # tmp.events1$tNo1<- NULL
    # tmp.events1$tNo2<- NULL
    
    tmp.events1<- subset(tmp.events1, is.na(tmp.events1$tNo) == FALSE)
  

    # colnames(tmp.df)
    # colnames(tmp.df)
    # colnames(tmp.events1)
    # colnames(tmp.eyetr)
    
    tmp.df$screencontent<- NA
    tmp.df$stim<- NA
    tmp.events1$tEnd<- if_else(tmp.events1$tNo == -7, tmp.events1$tStart+120, tmp.events1$tEnd)
    
    message(sprintf("subsetting eyetracking data"))
    
    for(e in 1:nrow(tmp.events1)) {
      
      # Subset the EyeTracking data based on start/end
      tmp.raw.trial = subset(tmp.eyetr, tmp.eyetr$time >= tmp.events1$tStart[e] & tmp.eyetr$time <= tmp.events1$tEnd[e])
      
      tmp.raw.trial$tNo = tmp.events1$tNo[e]
      
      tmp.raw.trial$Condition = tmp.events1$Condition[e]
      tmp.raw.trial$screencontent = tmp.events1$screencontent[e]
      tmp.raw.trial$stim = tmp.events1$stim[e]
      # tmp.raw.trial$stim = tmp.events1$[e]
      tmp.raw.trial$ssid = ssid
      tmp.raw.trial$text = tmp.events1$text[e]
      
      message(sprintf("binding tmp.df"))
      
      tmp.df= rbind(tmp.raw.trial, tmp.df)
    }
     message(sprintf("done binding"))
    
    # Arrange the dataframe byu time
    tmp.df<- tmp.df%>%
      arrange(time)
    
    # Save file for the task with subject name
    name = sprintf("ss%s_GPdata",ssid)
    message(sprintf("saving data"))
    write_csv(tmp.df, paste(name,".csv"))

    # write calibration file
    name2 = sprintf("ss%s_GPdata_cali", ssid)
    write_csv(cali, paste(name2,".csv"))
    
    
  }
  
  
  message("Processing Completed.")
  tmp.df
}

unique(tmp.df$tNo)

```


Now cleaning gaze data and prepare data for ledalab and artifact

```{r, cleaning}
# function to read all the csvs into one dataframe

setwd("~/OneDrive - Nexus365/InteroStudy2020/analysis/DataAnalysisJanuary2020/DataAnalysisJan2020/Eyetracking/Step1_GpExtractor_Output/346-355")

# rm(tmp_full)
read_plus <- function(flnm) {
  data.table::fread(flnm, select = c("session_id","event_id", "time", "left_gaze_x", "left_gaze_y","right_gaze_x", "right_gaze_y","left_pupil_measure1",
                                     "right_pupil_measure1","gsr", "gsrv", 'hr', "hrv", "hrp", "status", "tNo",  "Condition", "screencontent", "stim", "ssid", "text")) %>% 
    mutate(filename = flnm)
}


# read all clean data 
tmp.df2 <-
  list.files(pattern = "*.csv", 
             full.names = T) %>% 
  map_df(~read_plus(.))

unique(tmp.df2$ssid)

table(is.na(tmp.df2$ssid))
# tmp.df2$ssid<- substr(tmp.df2$filename, 5,7)
head(tmp.df2)
# check we have all participants
# unique(tmp.df2$ssid)
tmp.df2<- subset(tmp.df2, !is.na(ssid))

```



#####################################################################################
# gp preprocessing funtion, checks for losses, averages gaze, pupil and pixelate
#####################################################################################

```{r, gppreprocessing}
gp_preprocessing = function(tmp.df2) {
  
  message(sprintf("step1 lft gaze validity"))
  
  # transform invalid gaze into NA based on validity codes
  
  tmp.df2$left_gaze_x_cor<- if_else(tmp.df2$status != '20', tmp.df2$left_gaze_x, NULL)
  tmp.df2$left_gaze_x_cor<- if_else(tmp.df2$status != '22', tmp.df2$left_gaze_x_cor, NULL)
  tmp.df2$left_gaze_y_cor<- if_else(tmp.df2$status != '20', tmp.df2$left_gaze_y, NULL)
  tmp.df2$left_gaze_y_cor<- if_else(tmp.df2$status != '22', tmp.df2$left_gaze_y_cor, NULL)
  
  message(sprintf("step2 right gaze validity"))
  
  tmp.df2$right_gaze_x_cor<- if_else(tmp.df2$status != '2', tmp.df2$right_gaze_x, NULL)
  #
  tmp.df2$right_gaze_x_cor<- if_else(tmp.df2$status != '22', tmp.df2$right_gaze_x_cor, NULL)
  tmp.df2$right_gaze_y_cor<- if_else(tmp.df2$status != '22', tmp.df2$right_gaze_y, NULL)
  tmp.df2$right_gaze_y_cor<- if_else(tmp.df2$status != '22', tmp.df2$right_gaze_y_cor, NULL)

  # pupil validity
  
  message(sprintf("step3 pupil validity"))
  tmp.df2$left_pupil_measure1<- if_else(tmp.df2$status != '20', tmp.df2$left_pupil_measure1, NULL)
  tmp.df2$left_pupil_measure1<- if_else(tmp.df2$status != '22', tmp.df2$left_pupil_measure1, NULL)
  
  tmp.df2$right_pupil_measure1<- if_else(tmp.df2$status != '2', tmp.df2$right_pupil_measure1, NULL)
  tmp.df2$right_pupil_measure1<- if_else(tmp.df2$status != '22', tmp.df2$right_pupil_measure1, NULL)
  table(is.na(tmp.df2$right_pupil_measure1))
  
  # check gazepoint out of bounds nd repixelate (1920/2 = 960 by 1200/2 = 600. add half to normalised coordinates from psychopy)
  
  message(sprintf("step 4 cutting off screen in points and repixelate"))
  
  tmp.df2$left_gaze_x_cor<- if_else(tmp.df2$left_gaze_x_cor >= -960 & tmp.df2$left_gaze_x_cor <= 960, tmp.df2$left_gaze_x_cor, NULL)
  tmp.df2$right_gaze_x_cor<- if_else(tmp.df2$right_gaze_x_cor >= -960 & tmp.df2$right_gaze_x_cor <= 960, tmp.df2$right_gaze_x_cor, NULL)
  
  tmp.df2$left_gaze_y_cor<- if_else(tmp.df2$left_gaze_y_cor >= -600 & tmp.df2$left_gaze_y_cor <= 600, tmp.df2$left_gaze_y_cor, NULL)
  tmp.df2$right_gaze_y_cor<- if_else(tmp.df2$right_gaze_y_cor >= -600 & tmp.df2$right_gaze_y_cor <= 600, tmp.df2$right_gaze_y_cor, NULL)
  
  tmp.df2$left_gaze_x_cor_pix<- tmp.df2$left_gaze_x_cor+960
  tmp.df2$right_gaze_x_cor_pix<- tmp.df2$right_gaze_x_cor+960
  
  tmp.df2$left_gaze_y_cor_pix<- tmp.df2$left_gaze_y_cor+600
  tmp.df2$right_gaze_y_cor_pix<- tmp.df2$right_gaze_y_cor+600
  
  # is left or right an NA
  
  tmp.df2$left_na<- is.na(tmp.df2$left_gaze_x_cor) 
  tmp.df2$right_na<- is.na(tmp.df2$right_gaze_x_cor)
  tmp.df2$both_na<- if_else(tmp.df2$left_na == TRUE & tmp.df2$right_na == TRUE, TRUE, FALSE)
  
  message(sprintf("step5 gaze x  means"))
  
  tmp.df2$gaze_x_cor<-if_else(tmp.df2$left_na == TRUE & tmp.df2$both_na == FALSE, tmp.df2$right_gaze_x_cor,
                              if_else(tmp.df2$right_na == TRUE & tmp.df2$both_na == FALSE, tmp.df2$left_gaze_x_cor,
                                      ((tmp.df2$left_gaze_x_cor + tmp.df2$right_gaze_x_cor)/2)))
  message(sprintf("step6 gaze y means"))
  
  tmp.df2$gaze_y_cor<-if_else(tmp.df2$left_na == TRUE & tmp.df2$both_na == FALSE, tmp.df2$right_gaze_y_cor,
                              if_else(tmp.df2$right_na == TRUE & tmp.df2$both_na == FALSE, tmp.df2$left_gaze_y_cor,
                                      ((tmp.df2$left_gaze_y_cor + tmp.df2$right_gaze_y_cor)/2)))
  
  message(sprintf("step6 repixel gaze means"))
  
  tmp.df2$gaze_x_cor_pix<- tmp.df2$gaze_x_cor + 960
  min(tmp.df2$gaze_x_cor_pix, na.rm = TRUE)
  
  tmp.df2$gaze_y_cor_pix<- tmp.df2$gaze_y_cor+600
  min(tmp.df2$gaze_y_cor_pix, na.rm = TRUE)
  
  # clean_pupil
  
  message(sprintf("cleaning pupil"))
  
  max(tmp.df2$left_pupil_measure1)
  
  tmp.df2$pupil<- if_else(tmp.df2$left_na == TRUE & tmp.df2$both_na == FALSE, tmp.df2$right_pupil_measure1,
                          if_else(tmp.df2$right_na == TRUE & tmp.df2$both_na == FALSE, tmp.df2$left_pupil_measure1,
                                  ((tmp.df2$left_pupil_measure1 + tmp.df2$right_pupil_measure1)/2)))
  
  # tmp.df2$trackloss<- if_else(tmp.df2$status > 0, TRUE, FALSE)
  tmp.df2$trialUnq<- paste(tmp.df2$tNo, paste(tmp.df2$screencontent, paste(tmp.df2$stim)))
  tmp.df2$distance = 630
  
  # min(tmp.df2$pupil, na.rm = TRUE)
  # max(tmp.df2$pupil, na.rm = TRUE)
  # colnames(tmp.df2)
  tmp.df2<- tmp.df2%>%
    arrange(time)
}

tmp.df2<- gp_preprocessing(tmp.df2)
 colnames(tmp.df2) 
 
min(tmp.df2$pupil, na.rm = TRUE)
max(tmp.df2$gaze_y_cor_pix, na.rm = TRUE)
 
  
```



Compute proportions outside the screen


# check gazepoint out of bounds nd repixelate (1920/2 = 960 by 1200/2 = 600. add half to normalised coordinates from psychopy)
  
  
  x -960 by 960
  y -600 by 600

```{r eval=FALSE, include=FALSE}
range(tmp.df2$gaze_x_cor, na.rm = TRUE)


tmp.df2
range(tmp.df2$left_gaze_y, na.rm = TRUE)

range(tmp.df2$left_gaze_y, na.rm = TRUE)
range(tmp.df2$left_gaze_x, na.rm = TRUE)
tmp.df2$x_outside<- ifelse(tmp.df2$left_gaze_x < -960, TRUE,
                           ifelse(tmp.df2$left_gaze_x > 960, TRUE, FALSE))



tmp.df2$y_outside<- ifelse(tmp.df2$right_gaze_y < -600, TRUE,
                           ifelse(tmp.df2$right_gaze_y > 600, TRUE, FALSE))


table(tmp.df2$y_outside)
137/(185406+137)
0.0007383733*100

range(tmp.df, na.rm = TRUE)
tmp.df2$y_outside<-NULL



```

# rezeroing times by trial, by participants

```{r}
tmp.df3<- tmp.df2

# create start at every screen content
tmp.df3<- tmp.df3%>% 
  arrange(ssid, time, tNo)%>%
  group_by(ssid)%>%
  mutate(firststart = duplicated(trialUnq))

head(tmp.df3)

# make zero-times
tmp.df3$zero<- if_else(tmp.df3$firststart == FALSE, tmp.df3$time, NULL)

# fill in the zeros
tmp.df3<- tmp.df3%>%
  group_by(ssid, Condition, tNo)%>%
  # group_by(text)%>%
  fill(zero)

unique(tmp.df3$zero)

# rezero
tmp.df3<-tmp.df3%>%
  arrange(ssid, time, tNo)%>%
  group_by(ssid, tNo)%>%
  mutate(timerezero = time - zero)

min(tmp.df3$timerezero, na.rm = TRUE)
max(tmp.df3$timerezero, na.rm = TRUE) # max shoudl be around 120s for 2 mnutes
natest<-subset(tmp.df3, is.na(tmp.df3$ssid) == TRUE)

# let's check to see if it looks fine
ggplot(subset(tmp.df3, tmp.df3$tNo == -1), aes(timerezero, gsr, colour = as.factor(ssid)))+
  geom_line()

# create a new time rezero where before stim start, time is negative

tmp.df3<- tmp.df3%>%
  # arrange(time)%>%
  group_by(ssid, Condition, screencontent)%>%
  mutate(firststartSTIM = duplicated(tNo))

#this will create a time in the stim start which we can use to do the a second rezeroing
tmp.df3$zero_stim<- if_else(tmp.df3$firststartSTIM == FALSE & tmp.df3$screencontent == 'stim', tmp.df3$time, NULL)
   
    # fill down
tmp.df3<- tmp.df3%>%
      arrange(time)%>%
      group_by(tNo, ssid)%>%
      fill(zero_stim, .direction = c('updown'))

   tmp.df3$timerezero2<- tmp.df3$time-tmp.df3$zero_stim
   
   # check timerezero2
     range(tmp.df3$timerezero2, na.rm = TRUE)

# time 3 including rest
  # simply includes rest as is

tmp.df3$timerezero3<- if_else(tmp.df3$Condition == 'Rest', tmp.df3$timerezero, tmp.df3$timerezero2)
min(tmp.df3$timerezero3, na.rm = TRUE)


# quick check that everything is fine

ggplot(subset(tmp.df3, tmp.df3$tNo == 27 ) , aes(x = timerezero3, y= gsr, colour = as.factor(ssid)))+
    geom_smooth()+
    # geom_()+
    geom_vline(aes(xintercept = 0), colour = 'red', linetype = 'dashed', size = 2)+
    geom_vline(aes(xintercept = 4), colour = 'gray30', linetype = 'dotted', size = 2)+
    geom_vline(aes(xintercept = 8), colour = 'gray30', linetype = 'dotted', size = 2)+
    geom_vline(aes(xintercept = 6), colour = 'blue', linetype = 'dashed', size = 2)


ggplot(subset(tmp.df3, tmp.df3$tNo == -4) , aes(x = timerezero2, y= gsr, colour = as.factor(ssid)))+
  # geom_point()
      geom_line() +
    # geom_smooth(aes())+
    geom_vline(aes(xintercept = 0), colour = 'red', linetype = 'dashed', size = 2)+
    geom_vline(aes(xintercept = 4), colour = 'gray30', linetype = 'dotted', size = 2)+
    geom_vline(aes(xintercept = 8), colour = 'gray30', linetype = 'dotted', size = 2)+
    geom_vline(aes(xintercept = 6), colour = 'blue', linetype = 'dashed', size = 2)


ggplot(subset(tmp.df3, tmp.df3$tNo == -7) , aes(x = timerezero3, y= gsr, colour = as.factor(ssid)))+
  # geom_point()
      geom_line() +
    # geom_smooth(aes())+
    geom_vline(aes(xintercept = 0), colour = 'red', linetype = 'dashed', size = 2)+
    geom_vline(aes(xintercept = 4), colour = 'gray30', linetype = 'dotted', size = 2)+
    geom_vline(aes(xintercept = 8), colour = 'gray30', linetype = 'dotted', size = 2)+
    geom_vline(aes(xintercept = 6), colour = 'blue', linetype = 'dashed', size = 2)

```


triggers

```{r}
unique(tmp.df3$tNo)

natest<- subset(tmp.df3, is.na(tmp.df3$tNo) == TRUE)
tmp.df3<- subset(tmp.df3, is.na(tmp.df3$tNo) == FALSE)

tmp.df3$intercept_time<- if_else(tmp.df3$firststart == FALSE, tmp.df3$time, 
                          if_else(tmp.df3$firststartSTIM == FALSE, tmp.df3$time,
                                  NULL))

# takes a bit with a group - so don't run
# ggplot(tmp.df3, aes(time, gsr))+
#   geom_line()+
#   geom_vline(aes(xintercept = intercept_time))

unique(tmp.df3$tNo)

tmp.df3$trigger<- as.double(tmp.df3$tNo)

tmp.df3$trigger<- if_else(tmp.df3$firststart == FALSE, tmp.df3$trigger, 
                          if_else(tmp.df3$firststartSTIM == FALSE, tmp.df3$trigger, 0))
unique(tmp.df3$trigger)

tmp.df3$trigger <- if_else(tmp.df3$screencontent == 'fixation' &tmp.df3$firststart == FALSE, 100,
                          if_else(tmp.df3$screencontent == 'ValenceResp' & tmp.df3$firststart == FALSE, 101,
                             if_else(tmp.df3$screencontent == 'IntResp' & tmp.df3$firststart == FALSE, 102, tmp.df3$trigger))) 

unique(tmp.df3$trigger)

tmp.df3$trigger<- if_else(tmp.df3$firststart == TRUE, 0, tmp.df3$trigger)

unique(tmp.df3$trigger)


```



writing for ledalab

```{r}

tmp.df3<- tmp.df3%>%
  arrange(ssid, tNo,time)
# gsr baseline wil be the 1 second before tial start
# gsr to microsiemnes 1/J3*100000

options(scipen = 999)

tmp.df3$gsr_ms <- 1/tmp.df3$gsr*100000
unique(tmp.df3$ssid)
max(tmp.df3$gsr_ms)
min(tmp.df3$gsr_ms)

# gsr for leda
colnames(tmp.df3)
db_GSR<- select(tmp.df3, c(3,  14, 17, 50, 49,51 ))
db_GSR$tNo<- NULL
colnames(db_GSR)

unique(db_GSR$Condition)

db_GSR$Condition2<- if_else(db_GSR$Condition == 'Rest', 'Rest', 'IAPS')
unique(db_GSR$Condition2)
db_GSR$split_column<- paste0(db_GSR$Condition2,paste(db_GSR$ssid))
unique(db_GSR$split_column)
  (sprintf("writing for ledlab"))

split_column<- unique(db_GSR$split_column)

split_gsr = split(db_GSR, list(db_GSR$split_column))

setwd("~/OneDrive - Nexus365/InteroStudy2020/analysis/DataAnalysisJanuary2020/DataAnalysisJan2020/PhysioLedalab/GP_gsr_forLeda/346-355_2021")

    for (ssid in names(split_gsr)) {
      write_tsv(split_gsr[[ssid]][,c("time","gsr_ms", "trigger")], paste0("gpgsr_", paste0(ssid),".txt"), col_names = FALSE)
    }

```


# baselining gsr
```{r}
# use ms to baseline
tmp.df3_backup<- tmp.df3


tmp.df3$gsr_bas<- if_else(tmp.df3$timerezero3 >= -3 & tmp.df3$timerezero3 < 0, tmp.df3$gsr_ms, NULL)
# true if baseline within window
tmp.df3$gsr_bastrue<- if_else(tmp.df3$timerezero3 >= -3 & tmp.df3$timerezero3 < 0, TRUE, FALSE)

# create baseline median
tmp.df3$gsr_bas_mean<- NULL

tmp.df3<- tmp.df3%>%
  arrange(ssid, time,tNo)%>%
  group_by(ssid, tNo, gsr_bastrue)%>%
  mutate(gsr_bas_median = median(gsr_bas))

# fill the baseline mean
tmp.df3<- tmp.df3%>%
  # arrange(time)%>%
  group_by(ssid, tNo)%>%
  fill(gsr_bas_median)

# fill up to complete
unique(tmp.df3$gsrv)

tmp.df3<- tmp.df3%>%
  # arrange(time)%>%
  group_by(ssid, tNo)%>%
  fill(gsr_bas_median, .direction = 'up')

# do baseline correction
# 
tmp.df3<- tmp.df3%>%
  # arrange(time)%>%
  group_by(ssid, tNo)%>%
  mutate(gsr_basCor = gsr_ms - gsr_bas_median)


# rest baselining
tmp.df3<- tmp.df3%>%
  # arrange(time)%>%
  group_by(ssid, Condition)%>%
  mutate(gsr_restmedian = median(gsr_ms))

tmp.df3$gsr_basCor<- if_else(tmp.df3$Condition == 'Rest', tmp.df3$gsr_ms- tmp.df3$gsr_restmedian, tmp.df3$gsr_basCor)

# plot diagnosis
ggplot(subset(tmp.df3, tmp.df3$Condition == 'IAPS') , aes(x = timerezero3, y= gsr_basCor, colour = as.factor(ssid)))+
  # stat_summary(geom = 'line', fun.data = 'mean')+
    geom_smooth()+
    geom_vline(aes(xintercept = 0), colour = 'red', linetype = 'dashed', size = 2)+
    geom_vline(aes(xintercept = 4), colour = 'gray30', linetype = 'dotted', size = 2)+
    geom_vline(aes(xintercept = 8), colour = 'gray30', linetype = 'dotted', size = 2)+
    geom_vline(aes(xintercept = 6), colour = 'blue', linetype = 'dashed', size = 2)
  
 ggplot(subset(tmp.df3, tmp.df3$Condition == 'Rest') , aes(x = timerezero3, y= gsr_basCor, colour = as.factor(ssid)))+
  # stat_summary(geom = 'line', fun.data = 'mean')+
    geom_smooth()+
    geom_vline(aes(xintercept = 0), colour = 'red', linetype = 'dashed', size = 2)+
    geom_vline(aes(xintercept = 4), colour = 'gray30', linetype = 'dotted', size = 2)+
    geom_vline(aes(xintercept = 8), colour = 'gray30', linetype = 'dotted', size = 2)+
    geom_vline(aes(xintercept = 6), colour = 'blue', linetype = 'dashed', size = 2) 
  # tmp.df_norest$tNo<- as.factor(tmp.df_norest$tNo)
    
ggplot(subset(tmp.df3, tmp.df3$screencontent == 'stim') , aes(x = timerezero3, y= gsr_basCor, olour = as.factor(ssid)))+
    geom_smooth(aes())+
    geom_vline(aes(xintercept = 0), colour = 'red', linetype = 'dashed', size = 2)+
    geom_vline(aes(xintercept = 4), colour = 'gray30', linetype = 'dotted', size = 2)+
    geom_vline(aes(xintercept = 8), colour = 'gray30', linetype = 'dotted', size = 2)+
    geom_vline(aes(xintercept = 6), colour = 'blue', linetype = 'dashed', size = 2)


tmp.df3_backup<- tmp.df3
# gsr respone
tmp.df3$gsr_resp_Log<- if_else(tmp.df3$timerezero3 > 1,TRUE, FALSE)
unique(tmp.df3$gsr_resp_Log)

tmp.df3 <- tmp.df3 %>%
    group_by(ssid, tNo, gsr_resp_Log )%>%
    mutate(gsr_response =   max(gsr_basCor))

# gsr response for every bit
unique(tmp.df3$screencontent)

tmp.df3<- tmp.df3%>%
  # arrange(time)%>%
  group_by(ssid, tNo, screencontent)%>%
  mutate(gsr_response_scrcont =   max(gsr_basCor))
  
tmp.df3$gsr_response <- if_else(tmp.df3$gsr_resp_Log == TRUE, tmp.df3$gsr_response, NULL) 


tmp.df3<-
  tmp.df3%>%
  arrange(ssid, tNo,time)%>%
  group_by(ssid, tNo)%>%
    fill(gsr_response)

tmp.df3<-
  tmp.df3%>%
  arrange(ssid, tNo,time)%>%
  group_by(ssid, tNo)%>%
    fill(gsr_response,  .direction = c('up'))
  
  
  

unique(tmp.df3$gsr_response )

tmp.df3_backup<- tmp.df3
```

#baseline and clean pupil

```{r}
library(gazer)

min(tmp.df3$pupil, na.rm = TRUE)
max(tmp.df3$pupil, na.rm = TRUE)

tmp.df3$pupil<- if_else(tmp.df3$pupil> 7.2, tmp.df3$pupil, NULL)

tmp.df3$pupil<- if_else(tmp.df3$pupil< 45, tmp.df3$pupil, NULL)

tmp.df3_backup <- tmp.df3


# note that smothing and interpolating is order dependednt so order by ssid, trial and time
tmp.df3<- tmp.df3 %>%
  arrange(ssid, time,tNo)%>%
  group_by(ssid, trialUnq,tNo,screencontent) %>%
  mutate(extendpupil=gazer::extend_blinks(pupil, fillback=100, fillforward=100, hz=150))

min(tmp.df3$extendpupil, na.rm = TRUE)
max(tmp.df3$pupil, na.rm = TRUE)

# let's check

ggplot(subset(tmp.df3, tmp.df3$tNo == 3), aes(x = timerezero3, y= extendpupil , colour = as.factor(ssid)))+
      geom_line()
  # geom_line(aes(y = extendpupil), linetype = 'dashed', colour = 'red')

# Smooth and Interpolate
tmp.df3$subject<- tmp.df3$ssid
tmp.df3$trial = tmp.df3$trialUnq

# min(pup_extend$pupil, na.rm = TRUE)
tmp.df3$extendpupil
# ?smooth_interpolate_pupil

# library(gazer)

?smooth_interpolate_pupil

# vert order dependent
tmp.df3 <- gazer::smooth_interpolate_pupil(tmp.df3, pupil="pupil", extendpupil="extendpupil",
                                    extendblinks=TRUE, step.first= 'smooth',
                                    maxgap=Inf, 
                                    filter = 'moving',
                                    type="linear", hz=150, n = 30)

# tmp.df3<- tmp.df3 %>%
#   group_by(ssid, trialUnq,tNo,screencontent) %>%
#   smooth_interpolate_pupil(pupil="pupil", extendpupil="extendpupil",
#                                     extendblinks=TRUE, 
#                            step.first= 'smooth',
#                                     maxgap=10, 
#                                     filter = 'moving',
#                                     type="linear", hz=20, n = 10)
# 
# 
# tmp.df3<-
#   tmp.df3%>%
#   arrange(ssid,tNo,time)
#   # group_by(ssid, tNo, timerezero3)%>%
# 
# tmp.df3te<- tmp.df3 %>%
#   group_by(ssid, Condition,tNo,screencontent) %>%
#   smooth_interpolate_pupil(pupil="pupil", extendpupil="extendpupil",
#                                     extendblinks=TRUE, 
#                            step.first= 'smooth',
#                                     maxgap=Inf, 
#                                     filter = 'moving',
#                                     type="linear", hz=100, n = 5)

min(tmp.df3$pup_interp, na.rm = TRUE)
max(tmp.df3$pup_interp, na.rm = TRUE)

subset(tmp.df3, tNo == 20 & ssid == 347)%>%
ggplot(aes(x = timerezero3, y= pup_interp))+
  geom_line()+
   geom_line(aes(y = extendpupil), color = 'red')+
  geom_line(aes(y = pupil), colour = 'gray')
  # facet_grid(~Condition)


subset(tmp.df3, tNo == -7 & ssid == 350)%>%
ggplot(aes(x = timerezero3, y= pupil))+
  geom_line()


subset(tmp.df3, tNo == 1)%>%
ggplot(aes(x = timerezero3, y= pup_interp))+
  geom_line()+
   # geom_line(aes(y = extendpupil), color = 'red')+
  # geom_line(aes(y = pup_interp), colour = 'gray')+
    facet_grid(~ssid)
  # facet_grid(~Condition)
```


# create baseline pupil mean
```{r}
tmp.df3backup<- tmp.df3
tmp.df3$pup_bas<- if_else(tmp.df3$timerezero3 >= -1 & tmp.df3$timerezero3 < 1, tmp.df3$pup_interp, NULL)
# true if bseline if baseline within widnown
tmp.df3$pup_bastrue<- if_else(tmp.df3$timerezero3 >= -1 & tmp.df3$timerezero3 < 1, TRUE, FALSE)


tmp.df3<- tmp.df3%>%
  # arrange(time)%>%
  group_by(ssid, tNo, pup_bastrue)%>%
  mutate(pup_bas_med = median(pup_bas))


# fill the baseline mean pupil
tmp.df3<- tmp.df3%>%
  # arrange(time)%>%
  group_by(ssid,tNo)%>%
  fill(pup_bas_med)

# fill up to complete pupil
tmp.df3<- tmp.df3%>%
  # arrange(time)%>%
  group_by(ssid, tNo)%>%
  fill(pup_bas_med, .direction = 'up')


# do baseline correction
tmp.df3<- tmp.df3%>%
  arrange(ssid, tNo, time)%>% # pay attentipn to order
  group_by(ssid, tNo)%>%
  mutate(pup_basCor = pup_interp - pup_bas_med)


# we only one the median for rest
tmp.df3<- tmp.df3%>%
  group_by(Condition)%>%
  mutate(pupilrest = median(pup_interp))

tmp.df3$pup_basCor<- if_else(tmp.df3$Condition == 'Rest', tmp.df3$pup_interp-tmp.df3$pupilrest, tmp.df3$pup_basCor)


# MAD removal
library(gazer)
max_pup<-tmp.df3 %>%
  dplyr::group_by(subject, trial) %>%
  dplyr::mutate(speed=speed_pupil(pup_interp,time)) %>%
  dplyr::mutate(MAD=calc_mad(speed))
  # dplyr::filter(speed < MAD)

tmp.df3<- max_pup

# instead of deleting, nus put NA
tmp.df3$pup_basCor<- if_else(tmp.df3$speed< tmp.df3$MAD, tmp.df3$pup_basCor, NULL)

tmp.df3$pup_interp_mad<- if_else(tmp.df3$speed< tmp.df3$MAD, tmp.df3$pup_interp, NULL)
# tmp.df3$pup_basCor<- if_else(tmp.df3$speed< tmp.df3$MAD, tmp.df3$pup_basCor, NULL)

 
  
ggplot(subset(tmp.df3, tNo == 10 & tmp.df3$ssid == 354) , aes(x = timerezero3, y= pup_basCor))+
    # geom_smooth(se = F)+
  geom_line()+
    geom_vline(aes(xintercept = 0), colour = 'red', linetype = 'dashed', size = 2)+
    geom_vline(aes(xintercept = 4), colour = 'gray30', linetype = 'dotted', size = 2)+
    geom_vline(aes(xintercept = 8), colour = 'gray30', linetype = 'dotted', size = 2)+
    geom_vline(aes(xintercept = 6), colour = 'blue', linetype = 'dashed', size = 2)


ggplot(subset(tmp.df3, tNo == 10 & tmp.df3$ssid == 354) , aes(x = timerezero3, y= pup_basCor))+
    # geom_smooth(se = F)+
  geom_line()+
    geom_vline(aes(xintercept = 0), colour = 'red', linetype = 'dashed', size = 2)+
    geom_vline(aes(xintercept = 4), colour = 'gray30', linetype = 'dotted', size = 2)+
    geom_vline(aes(xintercept = 8), colour = 'gray30', linetype = 'dotted', size = 2)+
    geom_vline(aes(xintercept = 6), colour = 'blue', linetype = 'dashed', size = 2)+
  xlim(-3,3)


# preparation
subset(tmp.df3, tNo == 10)%>%
  group_by(ssid, tNo)%>%
  mutate(pupil_z = pup_interp_mad - mean(pup_interp_mad, na.rm = TRUE))%>%
  ungroup()%>%
ggplot(aes(x = timerezero3, y= pupil_z))+
    # geom_smooth(se = F)+
  stat_summary(fun = mean, geom = 'line')+
    geom_vline(aes(xintercept = 0), colour = 'red', linetype = 'dashed', size = 2)+
    geom_vline(aes(xintercept = 4), colour = 'gray30', linetype = 'dotted', size = 2)+
    geom_vline(aes(xintercept = 8), colour = 'gray30', linetype = 'dotted', size = 2)+
    geom_vline(aes(xintercept = 6), colour = 'blue', linetype = 'dashed', size = 2)+
  xlim(-3,15)
```
unique(tmp.df3$ssid)

```{r}
# rest period
ggplot(subset(tmp.df3, tmp.df3$Condition == 'Rest') , aes(x = timerezero3, y= pup_basCor, colour = as.factor(ssid)))+
    geom_smooth(se = T)+
    geom_vline(aes(xintercept = 0), colour = 'red', linetype = 'dashed', size = 2)+
    geom_vline(aes(xintercept = 4), colour = 'gray30', linetype = 'dotted', size = 2)+
    geom_vline(aes(xintercept = 8), colour = 'gray30', linetype = 'dotted', size = 2)+
    geom_vline(aes(xintercept = 6), colour = 'blue', linetype = 'dashed', size = 2)

```

```{r}
colnames(tmp.df3)
table(is.na(tmp.df3$gsr_ms))
table(is.na(tmp.df3$hr))

# heart rate


min(tmp.df3$hr, na.rm = TRUE)
max(tmp.df3$hr, na.rm = TRUE)

tmp.df3$hrv<- as.double(tmp.df3$hrv)
tmp.df3$hrv2<- if_else(is.na(tmp.df3$hrv) == TRUE, 999,tmp.df3$hrv)

tmp.df3$hr_clean<- tmp.df3$hr
tmp.df3$hr_clean<- as.double(tmp.df3$hr_clean)

tmp.df3$hr_clean<- if_else(tmp.df3$hrv2 >0,  tmp.df3$hr_clean, NULL)
                           

tmp.df3$hr_clean<- if_else(tmp.df3$hr_clean > 40 & tmp.df3$hr_clean< 120, tmp.df3$hr_clean, NULL)

table(is.na(tmp.df3$hr_clean))
# interpolate, only 2 seconds 
library(zoo)

tmp.df3<- tmp.df3%>%
  arrange(ssid, time,tNo)

# tmp.df3$hr_interp = 

tmp.df3<- tmp.df3%>%
  # arrange(ssid, time, tNo)%>%
  group_by(ssid, tNo,screencontent)%>%
  mutate(hr_interp = na.approx(hr_clean, na.rm=FALSE, maxgap =400))


  min(tmp.df3$hr, na.rm = TRUE)
ggplot(subset(tmp.df3, tmp.df3$tNo == -7 & tmp.df3$ssid == 352) , aes(x = timerezero3, y= hr_interp))+
    # geom_smooth(se = F)+
  geom_line()+
  geom_line(aes(y = hr_clean), linetype = 'dashed', colour = 'green', size = 0.3)+
   geom_line(aes(y = hr), linetype = 'dotted', colour = 'blue', size = 0.4)
    # geom_vline(aes(xintercept = 0), colour = 'red', linetype = 'dashed', size = 2)+
    # geom_vline(aes(xintercept = 4), colour = 'gray30', linetype = 'dotted', size = 2)+
    # geom_vline(aes(xintercept = 8), colour = 'gray30', linetype = 'dotted', size = 2)+
    # geom_vline(aes(xintercept = 6), colour = 'blue', linetype = 'dashed', size = 2)

# na.approx(object, x = index(object), xout, ..., na.rm = TRUE, maxgap = Inf, along)
# z <- na.spline(zoo(y, x), maxgap = 2)

```

```{r}
tmp.df3 <- tmp.df3 %>%
    group_by(ssid, tNo, gsr_resp_Log, screencontent)%>%
    mutate(gsr_response_bycond =   max(gsr_basCor))

# tmp.df3$gsr_response_bycond <- if_else(tmp.df3$gsr_resp_Log == TRUE, tmp.df3$gsr_response, NULL) 

colnames(tmp.df3)
# tmp.df4<- select(tmp.df3, c(1:3,10:22,27:30,33:37,44,46,47,51,53:56,60))

tmp.df4<- select(tmp.df3, c("session_id", "event_id", "ssid", "subject", "text", "trial","trialUnq", "tNo","trigger", "Condition" ,"screencontent","stim",
                            "time", "timerezero", "timerezero2", "timerezero3", "status","filename",
                            "left_gaze_x_cor_pix","right_gaze_x_cor_pix","left_gaze_y_cor_pix","right_gaze_y_cor_pix",  "gaze_x_cor_pix",  "gaze_y_cor_pix",
                            "pupil", "pup_interp_mad", "extendpupil","pup_basCor",
                            "hr", "hrv", "hrp", "hr_clean", 'hr_interp', 
                            'gsr_ms', 'gsr_basCor', 'gsr_response', 'gsr_response_bycond', 
                            "distance"))
head(tmp.df4)

# calculate trackloss
unique(tmp.df4$status)

tmp.df4$trackloss<- if_else(is.na(tmp.df4$gaze_x_cor_pix) == TRUE, 0, 
                         if_else(is.na(tmp.df4$gaze_y_cor_pix) == TRUE, 0, 1))
unique(tmp.df4$trackloss)
                           
# tmp.df4$trackloss<- if_else(tmp.df4$status> 0, 1, 0)

tmp.df4$hr_trackloss<- if_else(is.na(tmp.df4$hr_clean) == TRUE, 0, 1) # 1 means valid, 0 missing


tmp.df4 <- tmp.df4 %>%
  group_by(ssid, tNo, trialUnq, text)%>%
  mutate(gaze_valid_prop = sum(trackloss)/n())%>%
  mutate(gaze_loss_prop = 1 - gaze_valid_prop)%>%
  mutate(hr_valid_prop = sum(hr_trackloss)/n())%>%
  mutate(hr_loss_prop = 1 - hr_valid_prop)

# check to see this is right
ggplot(subset(tmp.df4, tmp.df3$ssid == 353) , aes(x = tNo, y= hr_valid_prop))+
    # geom_smooth(se = F)+
  geom_line()+
  geom_line(aes(y = hr_loss_prop), linetype = 'dashed', colour = 'green', size = 0.3)
   # geom_line(aes(y = hr), linetype = 'dotted', colour = 'blue', size = 0.4)

ggplot(subset(tmp.df4, tmp.df3$ssid == 354) , aes(x = tNo, y= gaze_valid_prop))+
    # geom_smooth(se = F)+
  geom_line()+
  geom_line(aes(y = gaze_loss_prop), linetype = 'dashed', colour = 'green', size = 0.3)
   # geom_line(aes(y = hr), linetype = 'dotted', colour = 'blue', size = 0.4)

colnames(tmp.df4)
write_csv(tmp.df4, 'interodata_clean_gp_346_355.csv')

# tmp.df4<- read_csv('intero_tsdata_clean.csv')

tmp.df4<- tmp.df4%>%
  arrange(ssid, time, tNo)

unique(tmp.df4$trigger)

# why

tmp.df4$trigger2 <- tmp.df4$trigger

tmp.df4$trigger2<- if_else(tmp.df4$trigger>99, tmp.df4$trigger, as.double(tmp.df4$tNo))

unique(tmp.df4$trigger2)
unique(tmp.df4$trigger)
unique(tmp.df4$tNo)

# \why?
unique(tmp.df4$text)

tmp.df4<- tmp.df4%>%
  group_by(ssid, tNo, text)%>%
  mutate(stdev_gaze_x = sd(gaze_x_cor_pix, na.rm = TRUE))%>%
  mutate(stdev_gaze_y = sd(gaze_y_cor_pix, na.rm = TRUE))

tmp.df4$sdev_gazesum<- tmp.df4$stdev_gaze_x+ tmp.df4$stdev_gaze_y

# summarise
tmp.df4_sum<- tmp.df4%>%
  arrange(ssid, time, tNo)%>%
  group_by(ssid, subject, trial, Condition, screencontent, tNo, stim, trialUnq,text)%>%
  summarise_at(c('pup_basCor', 'gsr_response','gsr_response_bycond', 'gsr_basCor', 'hr_interp', 'hr_clean', 'time', 'gaze_loss_prop', 'gaze_valid_prop', 'hr_valid_prop', 'hr_loss_prop', 'timerezero3', 'sdev_gazesum', 'stdev_gaze_x', 'stdev_gaze_y'), mean, na.rm = TRUE)

tmp.df4_sum$trigger<-if_else(tmp.df4_sum$screencontent == 'fixation', 100,
                          if_else(tmp.df4_sum$screencontent == 'ValenceResp', 101,
                             if_else(tmp.df4_sum$screencontent == 'IntResp', 102, as.double(tmp.df4_sum$tNo))))
  
unique(tmp.df4_sum$trigger)
  
unique(tmp.df4_sum$trigger)
tmp.df4_sum<- tmp.df4_sum%>%
  arrange(time, tNo, ssid)

write_csv(tmp.df4_sum, 'intero_aggdata_clean.csv')

write_csv(tmp.df4_sum, 'intero_aggdata_clean_3046_355.csv')
# 
# head(tmp.df4_sum)
# unique(tmp.df4_sum$tNo)

ggplot(tmp.df4_sum, aes(tNo, gaze_valid_prop, colour = as.factor(ssid)))+
  geom_point()+
  geom_line()

ggplot(subset(tmp.df4_sum, tmp.df4_sum$screencontent == 'stim'), aes(tNo, gaze_valid_prop, colour = as.factor(ssid)))+
  geom_point()+
  geom_line()

ggplot(subset(tmp.df4_sum, tmp.df4_sum$screencontent == 'stim'), aes(gaze_valid_prop, colour = as.factor(ssid)))+
# geom_density()+
  geom_histogram()
  # geom_line()



```


# for gaze parsing

```{r}

(sprintf("preparing for gazepath"))
  
colnames(tmp.df4)
  
  for_gazepath<- select(tmp.df4, c(2:15,17:26, 39:40,42:43))
  
  for_gazepath$screencontent[for_gazepath$screencontent == 'rest1']<- 'fixation'
  for_gazepath<- for_gazepath%>%
    arrange(ssid, time, tNo)
  
  colnames(for_gazepath)
  
  for_gazepath<- subset(for_gazepath, is.na(for_gazepath$time) == FALSE)
   # View(for_gazepath)
  
  for_gazepath$split_column<- paste0(for_gazepath$ssid, paste0(for_gazepath$screencontent))
  splitcol<- unique(for_gazepath$split_column)
  splitcol
  # ssid<- unique(for_gazepath$ssid)
  # ssid
  split_df = split(for_gazepath, list(for_gazepath$split_column))
  
  
  setwd("~/OneDrive - Nexus365/InteroStudy2020/analysis/DataAnalysisJanuary2020/DataAnalysisJan2020/Eyetracking/GP_IAPS_for_gazepath/346_355")
  
  (sprintf("writing for gazepath"))
  # ssid = split(for_gazepath, list(for_gazepath$ssid))
  # for (ssid in names(split_df)) {
    for (splitcol in names(split_df)) {
      # message( split_df[splitcol])
      write_csv(split_df[[splitcol]], paste0('gp_',paste0(splitcol),".csv"))
    }


```


process gazepath and ledalab

gazepath settings


left eye x coord: left_gaze_x_cor_pix
left eye y coord: left_gaze_y_cor_pix

didtance: distance (mm)

right eye x coord: right_gaze__cor_pix
right eye y coord: right_gaze_x_cor_pix
didtance: distance (mm)

trial index: trialnq


sample rate: 150
screen resolution height (pix): 1200
screen resolution width (pix): 1920

stimuli height (px): 768
stimuli width (px): 1024
variables to keep: trial unq

203
270

```{r}


# install.packages('gazepath')
library(gazepath)
GUI()

```


read parsed data
```{r}
read_parsed <- function(flnm) {
    read_csv(flnm) %>%
        mutate(filename = flnm)
}

db_parsed <- list.files(pattern = "*.csv", 
               full.names = T) %>% 
    map_df(~read_parsed(.))


# return content between spaces
# put things in the correct order
library(stringr)

db_parsed$screencontent<- str_extract(db_parsed$trialUnq, "(?<=\\s)(.*)(?=\\s)")
unique(db_parsed$screencontent)
db_parsed$screencontent[db_parsed$screencontent == 'rest1']<- 'fixation'


db_parsed$screencontent_no <- if_else(db_parsed$screencontent == 'fixation', 1,
                                      if_else(db_parsed$screencontent == 'stim', 2,
                                              if_else(db_parsed$screencontent == 'ValenceResp', 3,
                                                      if_else(db_parsed$screencontent == 'IntResp', 4, NULL))))

db_parsed$tNo<- as.numeric(substr(db_parsed$trialUnq, 1,2))
unique(db_parsed$screencontent_no)
db_parsed$ssid<- substr(db_parsed$Participant, 4,6)

db_parsed<- db_parsed%>%
  arrange(ssid, tNo, screencontent_no)

ggplot(db_parsed, aes(mean_x, mean_y))+
  geom_point()+
  facet_grid(ssid~screencontent)

unique(db_parsed$tNo)
# db_parsed$tNo<- if_else(db_parsed$tNo > -1, db_parsed$tNo-1, db_parsed$tNo )

db_parsed<-db_parsed%>%
  group_by(ssid, tNo, screencontent,Value)%>%
  mutate(mean_fix_dur = mean(Duration))%>%
  mutate(mean_POGsdSacAmp = mean(POGsdSacAmp))%>%
  mutate(fix_count = sum(Value == 'f'))%>%
  mutate(sac_count = sum(Value == 's'))

# this might be needed for tempoal analisys
write_csv(db_parsed, 'db_parsed.csv')
write_csv(db_parsed, 'db_parsed_346_355.csv')

db_parsed_summarised<- db_parsed%>%
  group_by(ssid, tNo,screencontent, trialUnq, screencontent_no, Value)%>%
  summarise_at(c('fix_count', 'sac_count', 'mean_fix_dur', 'mean_POGsdSacAmp', 'RMS'), mean, na.rm = TRUE)


colnames(db_parsed_summarised)
db_parsed_summarised_fix<- subset(db_parsed_summarised, db_parsed_summarised$Value == 'f')
db_parsed_summarised_fix$sac_count<- NULL
db_parsed_summarised_fix$POGsd<- db_parsed_summarised_fix$mean_POGsdSacAmp
db_parsed_summarised_fix$mean_POGsdSacAmp<- NULL
db_parsed_summarised_fix$Value<-NULL
db_parsed_summarised_sac<- subset(db_parsed_summarised, db_parsed_summarised$Value == 's')
db_parsed_summarised_sac$fix_count<- NULL
db_parsed_summarised_sac$mean_sac_dur<-  db_parsed_summarised_sac$mean_fix_dur
db_parsed_summarised_sac$SacAmp<- db_parsed_summarised_sac$mean_POGsdSacAmp
db_parsed_summarised_sac$mean_POGsdSacAmp<- NULL
db_parsed_summarised_sac$mean_fix_dur<- NULL
db_parsed_summarised_sac$RMS<- NULL
db_parsed_summarised_sac$Value<- NULL
View(db_parsed_summarised_sac)
View(db_parsed_summarised_fix)
db_parsed_summarised_sac$Value<- NULL
db_parsed_summarised_fix$Value<- NULL
db_parsed_summarised_sac$RMS<- NULL

View(db_parsed)

colnames(db_parsed_summarised_fix)
colnames(db_parsed_summarised_sac)


db_parsed_summarised2<- left_join(db_parsed_summarised_fix,db_parsed_summarised_sac, by = (c('ssid', 'tNo', 'screencontent', "screencontent_no", "trialUnq")))

db_parsed_summarised2<- db_parsed_summarised2%>%
  arrange(ssid, tNo, screencontent_no)
# View(db_parsed_summarised2)
write_csv(db_parsed_summarised2, 'db_parsed_summarised.csv')
write_csv(db_parsed_summarised2, 'db_parsed_summarised_346_355.csv')

db_parsed_summarised2$ssid<- as.numeric(db_parsed_summarised2$ssid)
db_parsed_summarised2


# merge parsed with eyetracking data
# tmp.df4_sum_full<- left_join(tmp.df4_sum_full,db_parsed_summarised2, by = c("ssid", "trialUnq", "tNo", "screencontent")) #original

tmp.df4_sum_full<- left_join(tmp.df4_sum,db_parsed_summarised2, by = c("ssid", "trialUnq", "tNo", "screencontent"))

# rm(tmp.df4_sum_fullt)
# testna<- subset(tmp.df4_sum_fullt, is.na(tmp.df4_sum_fullt$mean_fix_dur) == TRUE)
# 
# tmp.df4_sum_fullt

tmp.df4_sum_full
```



Behavioral data

```{r}
# colnames(X309_2019_Dec_11_1807_01)
library(data.table) 
library(purrr)

read_plus_beh <- function(flnm, select = c("condition", "stimIAPS","stimDescription", "ValenceMean","ArousalMean","trigger",
                                     "trialsPract.thisTrialN","trialIAPS.thisTrialN", "self_valence_4.response","self_valence_2.response","Self_intensity_2.response","Self_intensity_3.response", "self_valence_4.rt", "self_valence_2.rt", "Self_intensity_2.rt", "Self_intensity_3.rt")) {
  read.csv(flnm) %>% 
    mutate(filename = flnm)
}


setwd("~/OneDrive - Nexus365/InteroStudy2020/analysis/DataAnalysisJanuary2020/DataAnalysisJan2020/IAPSBehav/346_355")
# now read them
db_beh <-
  list.files(pattern = "*.csv",
             full.names = T) %>%
  map_df(~read_plus_beh(.))

# problem file
# db328$condition<-db328$ï..condition

db328 <-select(db328, c("condition", "stimIAPS","stimDescription", "ValenceMean","ArousalMean","trigger",
                                     "trialsPract.thisTrialN","trialIAPS.thisTrialN", "self_valence_4.response","self_valence_2.response","Self_intensity_2.response","Self_intensity_3.response", "self_valence_4.rt", "self_valence_2.rt", "Self_intensity_2.rt", "Self_intensity_3.rt"))

db328$ssid<- 328


db328$filename<- db328$ssid

files <- list.files(pattern = ".csv")
files
temp <- do.call(rbind,lapply(files, read.csv), header = TRUE)

#install.packages("data.table", repos = "https://cran.rstudio.com")
library(data.table)



# Read all the files and create a FileName column to store filenames
db_beh <- rbindlist(sapply(files, fread, simplify = FALSE),
                use.names = TRUE, idcol = "filename")
db_beh$condition <- db_beh$ï..condition

db_beh<- select(db_beh, c("filename", "condition", "stimIAPS","stimDescription", "ValenceMean","ArousalMean","trigger",
                                     "trialsPract.thisTrialN","trialIAPS.thisTrialN", "self_valence_4.response","self_valence_2.response","Self_intensity_2.response","Self_intensity_3.response", "self_valence_4.rt", "self_valence_2.rt", "Self_intensity_2.rt", "Self_intensity_3.rt"))

db328<- select(db328, c("filename", "condition", "stimIAPS","stimDescription", "ValenceMean","ArousalMean","trigger",
                                     "trialsPract.thisTrialN","trialIAPS.thisTrialN", "self_valence_4.response","self_valence_2.response","Self_intensity_2.response","Self_intensity_3.response", "self_valence_4.rt", "self_valence_2.rt", "Self_intensity_2.rt", "Self_intensity_3.rt"))


# 
# db304<- rbindlist(sapply(files, fread, simplify = FALSE),
#                 use.names = TRUE, idcol = "filename")
# 
# 
# 
# db304<- select(db304, c("filename", "condition", "stimIAPS","stimDescription", "ValenceMean","ArousalMean","trigger",
#                                      "trialsPract.thisTrialN","trialIAPS.thisTrialN", "self_valence_4.response","self_valence_2.response","Self_intensity_2.response","Self_intensity_3.response", "self_valence_4.rt", "self_valence_2.rt", "Self_intensity_2.rt", "Self_intensity_3.rt"))

# db304$ssid<- 304
colnames(db_beh)
# db_beh<- bind_rows(db_beh, db304)
db_beh$ssid<- substr(db_beh$filename, 3,5)

# for (i in 1:length(temp)) assign(temp[i], read.csv(temp[i]))

View(db_beh)

colnames(db_beh)

db_beh2<- db_beh

# problem
db328$filename<- as.character(db328$filename)
db328$ssid<- as.character(db328$ssid)

db328$ssid <- 328

db_beh2<- bind_rows(db_beh2, db328)

unique(db_beh2$ssid)

# create one column for arousl and RT

db_beh2$valence<- if_else(is.na(db_beh2$self_valence_4.response) == FALSE, db_beh2$self_valence_4.response,
                          if_else(is.na(db_beh2$self_valence_2.response) == FALSE, db_beh2$self_valence_2.response, NULL))

db_beh2$Self_intensity_3.response<- as.double(db_beh2$Self_intensity_3.response)                      
db_beh2$arousal<- if_else(is.na(db_beh2$Self_intensity_2.response) == FALSE, as.numeric(db_beh2$Self_intensity_2.response),
                          if_else(is.na(db_beh2$Self_intensity_3.response) == FALSE,
                                  as.numeric(db_beh2$Self_intensity_3.response), NULL))


db_beh2$valence_rt<- if_else(is.na(db_beh2$self_valence_4.rt) == FALSE, db_beh2$self_valence_4.rt,
                          if_else(is.na(db_beh2$self_valence_2.rt) == FALSE, db_beh2$self_valence_2.rt, NULL))
                          
db_beh2$arousal_rt<- if_else(is.na(db_beh2$Self_intensity_2.rt) == FALSE, db_beh2$Self_intensity_2.rt,
                          if_else(is.na(db_beh2$Self_intensity_3.rt) == FALSE, db_beh2$Self_intensity_3.rt, NULL))


db_beh2$trialsPract.thisTrialN<- db_beh2$trialsPract.thisTrialN - 6

db_beh2$trialIAPS.thisTrialN<-db_beh2$trialIAPS.thisTrialN +1 
db_beh2$tNo<- if_else(is.na(db_beh2$Self_intensity_2.response) == FALSE, db_beh2$trialsPract.thisTrialN, db_beh2$trialIAPS.thisTrialN)
unique(db_beh2$tNo)
db_beh2<- subset(db_beh2, is.na(db_beh2$tNo) == FALSE)

db_beh2<- db_beh2%>%
  arrange(ssid, tNo)

ggplot(db_beh2, aes(tNo, valence, colour = ssid))+
  geom_point()+
  geom_line()

ggplot(db_beh2, aes(x = tNo, y = valence_rt))+
  geom_point()+
  geom_line()

ggplot(db_beh2, aes(x = valence, y = ValenceMean))+
  geom_point()+
  geom_smooth(method = lm, se = T)

ggplot(db_beh2, aes(x = arousal, y = ArousalMean))+
  geom_point()+
  geom_smooth(method = lm, se = T)

colnames(db_beh2)

db_beh2$triggeracq <- db_beh2$trigger
unique(db_beh2$ssid)

db_beh3<- select(db_beh2, c(2:7, 18:23))

# db_beh3<- subset(db_beh3, is.na(db_beh3$condition) == FALSE)

colnames(db_beh3)

colnames(db_beh3_301_309)

db_beh3$trigger<-NULL
db_beh3_301_309$triggeracq<- NULL


db_beh3_301_309$condition[db_beh3_301_309$condition == "Example Stimuli"]<- "Practice"

db_beh3$condition[db_beh3$condition == "Example Stimuli"]<- "Practice"


# db_beh3$triggeracq<- NULL

library(readr)
db_beh300 <-  read_csv("300-309 beh/tmp.df4300_sum_full.csv")
View(tmp_df4300_sum_full)

db_beh300 <- subset(db_beh300, db_beh300$condition != "Rest")
colnames(db_beh300)

db_beh300$ssid<- 300


db_beh300<- select(db_beh300, c("condition", "stimIAPS","stimDescription","ValenceMean", "ArousalMean", "ssid", "valence","arousal","valence_rt","arousal_rt", "tNo"))

db_beh3$ssid<- as.numeric(db_beh3$ssid)
db_beh_all<- bind_rows(db_beh3, db_beh300)
db_beh_all<- bind_rows(db_beh_all, db_beh3_301_309)
# db_beh4<- db_beh3

unique(db_beh_all$ssid)

str(tmp.df4_sum)
str(db_beh_all)
tmp.df4_sum$ssid<- as.numeric(tmp.df4_sum$ssid)

db_beh3$ssid <- as.numeric(db_beh3$ssid)
# rm(tmp.df4_sum_full_t)

tmp.df4_sum_full<- left_join(tmp.df4_sum, db_beh_all, by = c('ssid', 'tNo'))
tmp.df4_sum_full$ssid<- as.numeric(tmp.df4_sum_full$ssid)

tmp.df4_sum_full<- left_join(tmp.df4_sum_full, db_beh3, by = c('ssid', 'tNo'))

tmp.df4_sum_full<- tmp.df4_sum_full%>%
  arrange(ssid, tNo, time)

```


# self reports
- New Tas is already scored
- use questionnaire scoring 2021
- score AQ, etc using https://xavierrg.shinyapps.io/datacleaning 

gorilla codes


STAI:: 5nzr
AQ:7uqw
STAIS: 8rfo
Demog: 8zto
BVAQ: 83b1
BPQ: bbc4
DASS: chif
IQ: esh8
IAS: jvi8
TAS:pdlt
demog_meantal health: v2gn


consent: 8nsp

```{r}

db_selfrep <- read_csv("intero_selrep.csv")
library(readxl)
db_selfrep <- read_excel("db_self_rep_345_356_final.xlsx")
# View(db_self_rep_345_356_final)


db_selfrep$ssid <- as.character(db_selfrep$`Participant No`)
tmp.df4_sum_full$ssid <- as.character(tmp.df4_sum_full$ssid)

tmp.df4_sum_full<- left_join(tmp.df4_sum_full, db_selfrep, by = 'ssid')

unique(tmp.df4_sum_full$ssid)
# colnames(tmp_df4300_sum_full)
# colnames(tmp.df4_sum_full)
# 
# tmp.df4_sum_full<- tmp.df4_sum_full[,1:54]
# tmp.df4_sum_full<- bind_rows(tmp.df4_sum_full, tmp_df4300_sum_full)

# db_selfrep <- read_csv("~/Documents/InteroStudy/data/Bio/Dec12/db_selfrep.csv")

# db_selfrep$ssid<- as.numeric(db_selfrep$ssid)

# tmp.df4_sum_full<- left_join(tmp.df4_sum_full, db_selfrep, by = 'ssid' )

View(tmp.df4_sum_full)
write_csv(tmp.df4_sum_full, 'tmp.df4_sum_full_345_356.csv')

# tmp.df4_sum_full<- tmp.df4_sum_full%>%
#   arrange(ssid, tNo, screencontent_no)

colnames(tmp.df4_sum_full)
```



# Import Ledalab
Ledalab('/Users/heliocuve/Documents/InteroStudy/EATProcesing/EAT/forLeda/', 'open','text3','downsample', 15, 'smooth',{'adapt'}, 'analyze','CDA', 'optimize',3, 'export_era', [1 105 .01 2])

Ledalab('/Users/heliocuve/Documents/InteroStudy/EATProcesing/EAT/forLeda/', 'open','biopac','downsample', 15, 'smooth',{'adapt'}, 'analyze','CDA', 'optimize',3, 'export_era', [1 6 .01 2])


setwd("~/OneDrive - Nexus365/InteroStudy2020/analysis/DataAnalysisJanuary2020/DataAnalysisJan2020/PhysioLedalab/GP_gsr_forLeda/346-355_2021")

Ledalab('/Users/heliocuve/OneDrive - Nexus365/InteroStudy2020/analysis/DataAnalysisJanuary2020/DataAnalysisJan2020/PhysioLedalab/GP_gsr_forLeda/346-355_2021/', 'open','text3','downsample', 15, 'smooth',{'adapt'}, 'analyze','CDA', 'optimize',3, 'export_era', [1 6 .01 2])

SC column = 2
Event marker column 3
sampling rate 150hz


346, 351 - GP gsr data is messed up
- Note triggers need to be recreated here, never figured out why the digital events don't translate to ledalab

```{r}
setwd("~/OneDrive - Nexus365/InteroStudy2020/analysis/DataAnalysisJanuary2020/DataAnalysisJan2020/PhysioLedalab/GP_gsr_forLeda/346-355_2021/Processed")

read_leda <- function(flnm) {
  data.table::fread(flnm) %>% 
    mutate(filename = flnm)
}

# now read them
db_leda <-
  list.files(pattern = "*.txt", 
             full.names = T) %>% 
  map_df(~read_leda(.))

db_leda$trigger<- as.numeric(db_leda$Event.NID)
unique(db_leda$trigger)

db_leda$ssid<- as.numeric(substr(db_leda$filename, 13,15))

colnames(tmp.df4_sum)
colnames(db_leda)

nrow(tmp.df4_sum)
nrow(db_leda)

colnames(tmp.df4_sum)

tmp.df4_sum2<- subset(tmp.df4_sum,tmp.df4_sum$tNo != -7)

tmp.df4_sum2<- tmp.df4_sum2%>%
  arrange(ssid, time, tNo)%>%
  group_by(ssid)%>%
  mutate(order = 1:n())

db_leda2<- subset(db_leda, db_leda$trigger != -7)

db_leda2<- db_leda2%>%
  arrange(ssid, Event.Nr)%>%
  group_by(ssid)%>%
  mutate(order = 1:n())

unique(db_leda2$order)

range(db_leda2$order, na.rm = TRUE)

# tmp.df4_sum_fullt<- left_join(tmp.df4_sum2, db_leda2, by = c("order", "trigger", "ssid"))
# tmp.df4_sum_full_backup<- tmp.df4_sum_full

tmp.df4_sum_full<- left_join(tmp.df4_sum2, db_leda2, by = c("order", "trigger", "ssid"))

# tmp.df4_sum_full<- bind_cols(tmp.df4_sum, db_leda)

tmp.df4_sum_full<- tmp.df4_sum_full%>%
  arrange(ssid, tNo)

View(tmp.df4_sum_full)


trigger<- db_leda2 %>%
  subset(ssid == 348)%>%
  select(order, Event.NID, trigger,Event.Nr)
```


check
```{r}

View(tmp.df4_sum_full)

# check stiom screen
tmp.df4_sum_full_stim<- subset(tmp.df4_sum_full,  tmp.df4_sum_full$screencontent == 'stim')

# levels(as.factor(tmp.df4_sum_full_stim$Event.Name))

# exclude trials with very low gaze validity
tmp.df4_sum_full_stim<- subset(tmp.df4_sum_full_stim, tmp.df4_sum_full_stim$gaze_valid_prop> .85)
colnames(tmp.df4_sum_full_stim)

colnames(tmp.df4_sum_full)


```


```{r eval=FALSE, include=FALSE}

# is objective arousal and self report arousal correated
tmp.df4_sum_full_stim$ValenceMean_cat<- if_else(tmp.df4_sum_full_stim$ValenceMean > 4, 'pos', 'neg')

ggplot(tmp.df4_sum_full_stim, aes(arousal, log1p(TTP.AmpSum)), color = as.factor(ssid))+
         geom_point()+
  geom_smooth(method= 'lm')+
  facet_grid(~ValenceMean_cat)
ggplot(tmp.df4_sum_full_stim, aes(arousal, log1p(TTP.AmpSum), color = as.factor(ssid)))+
         geom_point()+
  geom_smooth(method= 'lm')+
   facet_grid(~ValenceMean_cat)
  # facet_grid(~ssid) # for some subjects

color = as.factor(ssid)
ggplot(tmp.df4_sum_full_stim, aes(arousal, pup_basCor))+
         geom_point()+
  geom_smooth(method= 'lm')+
   facet_grid(~ValenceMean_cat)
  # facet_grid(~ssid)
color = as.factor(ssid)
ggplot(tmp.df4_sum_full_stim, aes(arousal, hr))+
         geom_point()+
  geom_smooth(method= 'lm')+
   facet_grid(~ValenceMean_cat)


ggplot(tmp.df4_sum_full_stim, aes(arousal, hr))+
         geom_point()+
  geom_smooth(method= 'lm')


ggplot(tmp.df4_sum_full_stim, aes(arousal, pup_basCor))+
         geom_point()+
  geom_smooth(method= 'lm')

# do our physio signals corelate with one another

ggplot(tmp.df4_sum_full_stim, aes(gsr_basCor, hr, color = as.factor(ssid)))+
         geom_point()+
  geom_smooth(method= 'lm')+
   facet_grid(~ValenceMean_cat)


ggplot(subset(tmp.df4_sum_full_stim, tmp.df4_sum_full_stim$CDA.AmpSum > 0), aes(TTP.AmpSum, hr))+
         geom_point()+
  geom_smooth(method= 'lm')+
   facet_grid(~ValenceMean_cat)

ggplot(tmp.df4_sum_full_stim, aes(gsr_basCor, pup_basCor))+
         geom_point()+
  geom_smooth(method= 'lm')+
   facet_grid(~ValenceMean_cat)
 colour = as.factor(ssid)
ggplot(tmp.df4_sum_full_stim, aes(hr, pup_basCor))+
         geom_point()+
  geom_smooth(method= 'lm')+
   facet_grid(~ValenceMean_cat)


ggplot(tmp.df4_sum_full_stim, aes(arousal, log1p(CDA.PhasicMax)), color = as.factor(ssid))+
         geom_point()+
  geom_smooth(method= 'lm')+
   facet_grid(~ValenceMean_cat)

# okay arousal on gaze

# is there and affect of arousal on number of fxation and saccadescolor = as.factor(ssid)
library(tibble)

is_outlier <- function(x) {
  return(x < quantile(x, 0.25) - 1.5 * IQR(x) | x > quantile(x, 0.75) + 1.5 * IQR(x))
}

ggplot(tmp.df4_sum_full_stim, aes(CDA.PhasicMax, fix_count))+
         geom_point()+
  geom_smooth(method= 'lm')+
   facet_grid(~ValenceMean_cat)

ggplot(tmp.df4_sum_full_stim, aes(CDA.PhasicMax, sac_count))+
         geom_point()+
  geom_smooth(method= 'lm')+
   facet_grid(~ValenceMean_cat)

ggplot(tmp.df4_sum_full_stim, aes(ValenceMean_cat, sac_count))+
  # geom_jitter()+
  stat_summary( geom = 'pointrange', fun.data = 'mean_se', colour = "red", size = 2)
    # geom_boxplot()
  # geom_text(aes(label=ssid),hjust=0, vjust=0)


ggplot( tmp.df4_sum_full_stim, aes(IAS, cor_arousal))+
  geom_point()+
  geom_smooth(method = 'lm')
  # stat_summary( geom = 'pointrange', fun.data = 'mean_se', colour = "red", size = 2)+
    # geom_boxplot()+
  # geom_text(aes(label=ssid),hjust=0, vjust=0)


ggplot(tmp.df4_sum_full_stim, aes(ValenceMean_cat, fix_count))+
  # geom_jitter()+
  stat_summary( geom = 'pointrange', fun.data = 'mean_se', colour = "red", size = 2) 
    # geom_boxplot()+
  # geom_text(aes(label=ssid),hjust=0, vjust=0)


ggplot(tmp.df4_sum_full_stim, aes(ValenceMean_cat, mean_sac_dur))+
  # geom_jitter()+
  stat_summary( geom = 'pointrange', fun.data = 'mean_se', colour = "red", size = 2)
    # geom_boxplot()
  # geom_text(aes(label=ssid),hjust=0, vjust=0)

ggplot(tmp.df4_sum_full_stim, aes(ValenceMean_cat, mean_fix_dur))+
  # geom_jitter()+
  stat_summary( geom = 'pointrange', fun.data = 'mean_se', colour = "red", size = 2)
  geom_boxplot()
  # geom_text(aes(label=ssid),hjust=0, vjust=0)

ggplot(tmp.df4_sum_full_stim, aes(CDA.PhasicMax, fix_count, color = as.factor(ssid)))+
         geom_point()+
  geom_smooth(method= 'lm')
  # facet_grid(~ssid)+
    # geom_text(aes(label=ssid),hjust=0, vjust=0)

ggplot(subset(tmp.df4_sum_full_stim, tmp.df4_sum_full_stim$mean_fix_dur < 6000), aes(TTP.AmpSum, mean_fix_dur))+
         geom_point()+
  geom_smooth(method= 'lm')+
   facet_grid(~ValenceMean_cat)

ggplot(subset(tmp.df4_sum_full_stim, tmp.df4_sum_full_stim$mean_fix_dur < 6000 & tmp.df4_sum_full_stim$CDA.AmpSum>0 ), aes(CDA.PhasicMax, mean_fix_dur))+
         geom_point()+
  geom_smooth(method= 'lm')+
   facet_grid(~ValenceMean_cat)

ggplot(tmp.df4_sum_full_stim, aes(TAS, IAS))+
         geom_point()+
  geom_smooth(method= 'lm')

p<- list()
library(lmerTest)


tmp.df4_sum_full_stim$TAS_c<- scale(tmp.df4_sum_full_stim$TAS, center = TRUE,scale = TRUE)
tmp.df4_sum_full_stim$IAS_c<- scale(tmp.df4_sum_full_stim$IAS, center = TRUE, scale = TRUE)
tmp.df4_sum_full_stim$arousal_c<- scale(tmp.df4_sum_full_stim$arousal, center = TRUE,scale = TRUE)

tmp.df4_sum_full_stim<- tmp.df4_sum_full_stim%>%
  group_by(ssid)%>%
  mutate(cor_arousal = cor(arousal_c, hr))
tmp.df4_sum_full_stim<- tmp.df4_sum_full_stim%>%
  # mutate(ssid = as.factor(ssid))%>%
  mutate(stim = as.factor(stim))
tmp.df4_sum_full_stim$ssid<- as.factor(tmp.df4_sum_full_stim$ssid)

tmp.df4_sum_full_stim$valence_c<- scale(tmp.df4_sum_full_stim$valence, center = TRUE, scale = TRUE)
tmp.df4_sum_full_stim$TTP.AmpSum<- scale(tmp.df4_sum_full_stim$TTP.AmpSum,center = TRUE, scale = TRUE)

# test soe models
tmp.df4_sum_full_stimagg<- (tmp.df4_sum_full_stim%>%
              group_by(ssid)%>%
              summarise_at(c('IAS_c', 'TAS_c', 'AQ','cor_arousal', 'fix_count'), mean, na.rm = TRUE))


ggplot(tmp.df4_sum_full_stimagg, aes(TAS_c, cor_arousal))+
  geom_point()+
  geom_smooth(method = 'lm')

ggplot(tmp.df4_sum_full_stimagg, aes(IAS_c, cor_arousal))+
  geom_point()+
  geom_smooth(method = 'lm')

# tmp.df4_sum_full_stimagg<- subset(tmp.df4_sum_full_stimagg, is.na(tmp.df4_sum_full_stimagg$IAS_c) == FALSE)

p$a<- glmer(fix_count ~ 1 + IAS_c * CDA.ISCR *ValenceMean_cat + (1 | ssid ),
           family = poisson(), data = tmp.df4_sum_full_stim)

summary(p$a)

p$a1<- lmer(mean_fix_dur ~ 1 + IAS_c * (arousal_c + hr) * ValenceMean_cat + (1 | ssid ),
           REML = FALSE, data = tmp.df4_sum_full_stim)

summary(p$a1)


p$a1<- lmer(mean_fix_dur ~ 1 + IAS_c * + hr * ValenceMean_cat + (1 | ssid ),
           REML = FALSE, data = tmp.df4_sum_full_stim)

summary(p$a1)

p$a2<- lmer(mean_fix_dur ~ 1 + IAS_c * (arousal_c + TTP.AmpSum) + (1 | ssid ),
           REML = FALSE, data = tmp.df4_sum_full_stim)

summary(p$a2)

p$a2<- lmer(mean_fix_dur ~ 1 + cor_arousal * hr + (1 | ssid ),
           REML = FALSE, data = tmp.df4_sum_full_stim)

tmp.df4_sum_full_stim$hr_c<- scale(tmp.df4_sum_full_stim$hr, center = TRUE, scale = TRUE)

p$a3<- glmer(sac_count ~ 1 + IAS_c * hr * ValenceMean_cat  + (1 | ssid ),
           family = poisson(), data = tmp.df4_sum_full_stim)

summary(p$a3)
# p$a2<- lmer(mean_fix_dur ~ 1 + cor_arousal * ( hr)+ (1 | ssid ),
#            REML = FALSE, data = tmp.df4_sum_full_stim)
p$a4<- lmer(gsr_basCor ~ 1 + IAS_c * arousal_c + (1 | ssid ),
           REML = FALSE, data = tmp.df4_sum_full_stim)

summary(p$a4)     
       
       tmp.df4_sum_full_stim_cor<- tmp.df4_sum_full_stim%>%
  group_by(ssid, TAS, IAS, AQ, `DASS Total`)%>%
  summarise(cor_arousal_self = cor(arousal,  log1p(CDA.PhasicMax)))

ggplot(tmp.df4_sum_full_stim_cor, aes(`DASS Total`, cor_arousal_self))+
         geom_point()+
  geom_smooth(method= 'lm')

cor(tmp.df4_sum_full_stim_cor$cor_arousal_self, tmp.df4_sum_full_stim_cor$TAS,  use = 'complete')
cor(tmp.df4_sum_full_stim_cor$cor_arousal_self, tmp.df4_sum_full_stim_cor$IAS,  use = 'complete')
cor(tmp.df4_sum_full_stim_cor$TAS, tmp.df4_sum_full_stim_cor$IAS,  use = 'complete')

tmp.df4_sum_full_stim_cor [1:8,]%>%
  summarise(cor2 = cor(cor_arousal_self, TAS, use = 'complete'))


ggplot(tmp.df4_sum_full_stim, aes(arousal_c, log1p(mean_fix_dur)))+
  geom_point()+
  geom_smooth(method = 'lm')
```




IMPORT BIOPAC

```{r}
setwd("~/OneDrive - Nexus365/InteroStudy2020/analysis/DataAnalysisJanuary2020/DataAnalysisJan2020/PhysioLedalab/IAPS/processed/345_456/CDA")



colnames(tmp.df4_sum_full)

# import
read_leda_bio <- function(flnm) {
  data.table::fread(flnm) %>% 
    mutate(filename = flnm)
}

# now read them
db_leda_bio <-
  list.files(pattern = "*.txt", 
             full.names = T) %>% 
  map_df(~read_leda_bio(.))

write_csv(db_leda_bio, 'db_leda_bio.csv')
write_csv(db_leda_bio, 'db_leda_bio_345_355_CDA.csv')

# db_leda_bio <- read_csv("db_leda_bio.csv")

colnames(db_leda_bio)

db_leda_bio$BIO_Event.NID<- db_leda_bio$Event.NID
db_leda_bio$BIO_filename <- db_leda_bio$filename



db_leda_bio$ssid<- as.numeric(substr(db_leda_bio$BIO_filename, 3,5))

unique(db_leda_bio$ssid)

# unique(db_leda_bio$trigger)


# subset out rest period
db_leda_bio<- subset(db_leda_bio, Event.Nr>1)


db_leda_bio<- subset(db_leda_bio, CDA.nSCR!= "NaN")
range(db_leda_bio$Event.Nr)

# transform NaNs into proper NA
db_leda_bio[db_leda_bio == "NaN"] <- NA

# move counter to 1
range(db_leda_bio$Event.Nr-1)
# range(db_leda_bio$Event.Nr)
# trigger$Event.Nr<- NULL

db_leda_bio$order <- db_leda_bio$Event.Nr-1
# db_leda_bio$trigger<- NULL


# merge trigger
trigger$Event.NID<- NULL
trigger$ssid<- NULL
View(db_leda_bio)

db_leda_bio$order
# db_345_355$order

trigger<- db_345_355 %>%
  group_by(order,trigger, tNo)%>%
  summarise_at(c('ssid'), mean, na.rm = TRUE)
  # select(db_345_355, c(trigger, tNo, order))
  

  trigger$ssid<- NULL

  db_leda_bio<- left_join(db_leda_bio, trigger)


tmp.df4_sum_full

leda_bioames <- colnames(db_leda_bio)

leda_bioames
newnames<- c("Event.Nr", paste0("BIO_", paste(leda_bioames[2:16])),"BIO_Event.NID","BIO_filename"  ,"ssid","order","trigger")

newnames

db_leda_bio_backup<- db_leda_bio

colnames(db_leda_bio_backup)

names(db_leda_bio) <- newnames

colnames(db_leda_bio)

# db_leda_bio$ssid <- db_leda_bio$BIO_ssid

# db_leda_bio$BIO_ssid<-NULL


db_leda_bio

db_leda_bio$ssid<- as.character(db_leda_bio$ssid)

# db_leda_bio$order<- db_leda_bio$BIO_order

unique(tmp.df4_sum_full$Event.Nr)

db_leda_bio$BIO_Event.NID<- NULL
db_leda_bio$BIO_filename<- NULL

tmp.df4_sum_full_bio<- left_join(tmp.df4_sum_full,  db_leda_bio, by = c("ssid", "order"))

colnames(tmp.df4_sum_full_bio)

write_csv(db_leda_bio, "db_leda_bio_346_347_ledagsr.csv")

write_csv(db_leda_bio, "db_leda_bio_346_355_ledagsr.csv")
```



```{r eval=FALSE, include=FALSE}
# stim
db_leda_bio_stim<-subset(db_leda_bio, db_leda_bio$trigger< 100)
unique(db_leda_bio_stim$trigger)

colnames(tmp.df4_sum_full_stim_gp_leda_beh_self)
(unique(tmp.df4_sum_full_stim_gp_leda_beh_self$trigger))


db_leda_bio_stim$ssid<- as.character(db_leda_bio_stim$ssid)

# db_leda_bio_stim$trigger<- as.character(db_leda_bio_stim$trigger)

db_leda_bio$order<- db_leda_bio$Event.Nr

tmp.df4_sum_full_stim_gp_leda_beh_self$ssid<- as.character(tmp.df4_sum_full_stim_gp_leda_beh_self$ssid)

tmp.df4_sum_full_stim_gp_leda_beh_self$trigger<- as.character(tmp.df4_sum_full_stim_gp_leda_beh_self$trigger)

colnames(tmp.df4_sum_full_stim_gp_leda_beh_self)

unique(db_leda_bio$trigger)
unique(db_leda_bio$Event.Name)
unique(tmp.df4_sum_full_bio$trigger)
unique(tmp.df4_sum_full_bio$Event.Name)

tmp.df4_sum_full_stim_gp_leda_beh_self<- tmp.df4_sum_full_stim_gp_leda_beh_self%>%
  arrange(ssid, tNo, Event.Nr)

db_leda_bio_stim<- db_leda_bio_stim%>%
  arrange(ssid, Event.Nr)

#tmp.df4_sum_full_bio$trigger<- tmp.df4_sum_full_bio$tNo
#tmp.df4_sum_full_bio$trigger<- if_else(tmp.df4_sum_full_bio$screencontent == 'fixation', 100,
 #                                      if_else(tmp.df4_sum_full_bio$screencontent == 'ValenceResp', 101,
                                               #if_else(tmp.df4_sum_full_bio$screencontent == #'IntResp', 102, #tmp.df4_sum_full_bio$tNo)))

unique(tmp.df4_sum_full_bio$trigger)
tmp.df4_sum_full_stim_gp_leda_beh_self$Event.Nr<- as.character(tmp.df4_sum_full_stim_gp_leda_beh_self$Event.Nr)

db_leda_bio_stim$Event.Nr<- as.character(db_leda_bio_stim$Event.Nr)
View(tmp.df4_sum_full_stim_gp_leda_beh_self_biopac)

tmp.df4_sum_full_stim_gp_leda_beh_self_biopac<-left_join(tmp.df4_sum_full_stim_gp_leda_beh_self, db_leda_bio_stim, by = c("Event.Nr", "ssid"))

write_csv(tmp.df4_sum_full_stim_gp_leda_beh_self_biopac, 'tmp.df4_sum_full_stim_gp_leda_beh_self_biopac2.csv')

(db_leda_bio$trigger)

nrow(tmp.df4_sum_full_bio)
nrow(db_leda_bio)

tmp.df4_sum_full<- tmp.df4_sum_full%>%
  arrange(ssid, tNo)

ggplot(tmp.df4_sum_full_biot, aes(CDA.PhasicMax.x, CDA.PhasicMax.y))+
  geom_point()+
  geom_smooth(method = 'lm')

ggplot(tmp.df4_sum_full_biot, aes(TTP.AmpSum.x, TTP.AmpSum.y))+
  geom_point()+
  geom_smooth(method = 'lm')

tmp.df4_sum_full_biot
ggplot(subset(tmp.df4_sum_full_biot, tmp.df4_sum_full_biot$ssid != 308), aes(TTP.AmpSum.y, arousal, colour = ssid))+
  geom_point()+
  geom_smooth(method = 'lm', se = T)

ggplot(subset(tmp.df4_sum_full_biot, tmp.df4_sum_full_biot$ssid != 308), aes(TTP.AmpSum.y, arousal))+
  geom_point()+
  geom_smooth(method = 'lm', se = T)
ggplot(subset(tmp.df4_sum_full_biot, tmp.df4_sum_full_biot$ssid != 308 & tmp.df4_sum_full_biot$TTP.AmpSum.y> 0), aes( TTP.AmpSum.y, arousal))+
  geom_point()+
  geom_smooth(method = 'lm', se = T)

tmp.df4_sum_full_biot1 <-subset(tmp.df4_sum_full_biot, tmp.df4_sum_full_biot$ssid != 308)

cor(tmp.df4_sum_full_biot1$arousal, tmp.df4_sum_full_biot1$Global.Mean.y, use = 'complete.obs')

```


import biopac heart rate
```{r}


nrow(tmp.df4_sum_full_bio)

colnames(tmp.df4_sum_full_bio)
unique(tmp.df4_sum_full_bio$ssid)

# import
read_biohr <- function(flnm) {
  data.table::fread(flnm) %>% 
    mutate(filename = flnm)
}

# now read them
# old
db_biohr <-
  list.files(pattern = "*.xls", 
             full.names = T) %>% 
  map_df(~read_biohr(.))


unique(db_biohr$filename)

db_biohr$ssid<- substr(db_biohr$filename, 6,8)
db_biohr$order<- db_biohr$Order

db_biohr$Order<- NULL
db_biohr$filename<- NULL
db_biohr$trigger<- as.factor(as.character(db_biohr$trigger))

unique(db_biohr$ssid)

db_biohr$ssid<- as.factor(as.character(db_biohr$ssid))

```


#HR BIOPAC



```{r}
setwd("~/OneDrive - Nexus365/InteroStudy2020/Data Collection 2019- 2020/2020/InteroStudyBIOPAC/IAPS/Processed/HR/345_355")
library(readxl)
library(dplyr)
# db_HR_bio <- read_excel("310_IAPS_Physio_HR.xls")



# db_HR_bio<- db_HR_bio[6:nrow(db_HR_bio),]


library(data.table)
library(purrr)
# import
read_biohr <- function(flnm) {
  read_excel(flnm) %>% 
    mutate(filename = flnm)
}

# now read them
db_HR_bionew <-
  list.files(pattern = "*.xls", 
             full.names = T) %>% 
  map_df(~read_biohr(.))

db_HR_bio<- db_HR_bionew

unique(db_HR_bionew$filename)
nrow(db_HR_bionew)

# test<- subset(db_HR_bio, db_HR_bio$filename == "./607_IAPS_Physio_HR.xls")

levels(as.factor(db_HR_bio$filename))

db_HR_bio$ssid<- substr(db_HR_bio $filename, 3,5)

db_HR_bio$filename<- NULL


# 
db_HR_bio$`Stim-Response Analysis`

# flag stimulus
db_HR_bio$stim <- if_else(grepl('Stimulus', (db_HR_bio$`Stim-Response Analysis`)) == TRUE, db_HR_bio$`Stim-Response Analysis`, NULL)

library(tidyr)

db_HR_bio<- db_HR_bio%>%
  group_by(ssid)%>%
  fill(stim)

db_HR_bio

levels(as.factor(db_HR_bio$ssid))

#  remove na in the mean heart rate

db_HR_bio<- subset(db_HR_bio, !is.na(db_HR_bio$...2))


db_HR_bio$mhrtext<- is.character(db_HR_bio$...2)

db_HR_bio<- subset(db_HR_bio, !grepl('interval ', db_HR_bio$`Stim-Response Analysis`) == TRUE)


# loosing participants here
View(db_HR_bio)

db_HR_bio<- subset(db_HR_bio, !grepl('Interval ', db_HR_bio$`Stim-Response Analysis`) == TRUE)


# test<- subset(db_HR_bio, grepl('Interval ', db_HR_bio$`Stim-Response Analysis`) == TRUE)
# levels(as.factor(db_HR_biotest$ssid))

db_HR_bio<- subset(db_HR_bio, !grepl('Time', db_HR_bio$`Stim-Response Analysis`) == TRUE)

#db_HR_biotest1<- subset(db_HR_biotest, !is.na(db_HR_biotest$stim))

#test<- subset(db_HR_bio, db_HR_bio$ssid == 607)


levels(as.factor(db_HR_bio$ssid))

db_HR_bio<- subset(db_HR_bio, !is.na(db_HR_bio$`Stim-Response Analysis`))

db_HR_bio$...3<- NULL
db_HR_bio$...4<- NULL


db_HR_bio<- subset(db_HR_bio, !is.na(db_HR_bio$...2))

db_HR_bio<- subset(db_HR_bio, db_HR_bio$...2 != 'Mean(CH 40)')
db_HR_bio$timestart<- db_HR_bio$`Stim-Response Analysis`

db_HR_bio$Mean_HR<- db_HR_bio$...2

db_HR_bio<- db_HR_bio%>%
  arrange((as.numeric(timestart)), ssid)

db_HR_bio<- subset(db_HR_bio, !is.na(db_HR_bio$stim))


db_HR_bio$trigger <- substr(db_HR_bio$stim, 10,13)

# for soem reason this 
unique((as.numeric(db_HR_bio$trigger)-128))

db_HR_bio$trigger_200<- if_else(db_HR_bio$trigger> 103, TRUE, FALSE)

db_HR_bio$trigger2 <- if_else(db_HR_bio$trigger_200 == TRUE, as.numeric(db_HR_bio$trigger)-128, as.numeric(db_HR_bio$trigger))


unique((as.numeric(db_HR_bio$trigger2)))


#subset(db_HR_bio, db_HR_bio$ssid!= 328)%>%
#  group_by(timestart, ssid)%>%
 # mutate(EventNR= 1:225)

# this will delete fixation and stuff so no
db_HR_bio1<- subset(db_HR_bio,db_HR_bio$trigger2> 15)

db_HR_bio1<- db_HR_bio%>%
  arrange(ssid, as.numeric(timestart))

db_HR_bio1<- subset(db_HR_bio1,!is.na(db_HR_bio1$stim))

#tno
#subset(db_HR_bio1, db_HR_bio1$ssid != 328)%>%
table(is.na(db_HR_bio1$ssid))
# 
# db_HR_bio1<- db_HR_bio1%>%
#   arrange(as.numeric(timestart), ssid)

# use this
table(db_HR_bio1$ssid!= 328)
db_HR_bio1no328<-subset(db_HR_bio1, db_HR_bio1$ssid!= 328)

db_HR_bio1no328$trigger2
db_HR_bio1no328<- subset(db_HR_bio1no328, trigger2> 15 & trigger2<106)

db_HR_bio1no328$trigger<- db_HR_bio1no328$tNo
# db_HR_bio1no328

# db_HR_bio1no328<- db_HR_bio1no328 %>%
#   arrange(ssid, trigger2)%>%
#   filter(!duplicated(trigger2))

View(trigger)
db_HR_bio1no328<- db_HR_bio1no328$t %>%
  group_by(ssid)%>%
  mutate(tNo =  -6:(n()-7)) #56 trials

unique(db_HR_bio1no328$tNo)

range(db_HR_bio1no328$tNo)


table(db_HR_bio1no328$tNo)

# test<- subset(db_HR_bio1no328, tNo>49)
# 
# db_HR_bio328<-subset(db_HR_bio1, db_HR_bio1$ssid== 352)
# 
# subset(db_HR_bio328, trigger> 15 & trigger<72)


db_HR_bio1no328<- db_HR_bio1no328%>%
  arrange(ssid,as.numeric(timestart))

```


```{r}
# db_HR_bio2<- 


unique(db_HR_bio1no328$stim)
db_HR_bio1no328<- db_HR_bio1no328 %>%
  group_by(ssid)%>%
  mutate(tNo = -6:(n()-7))

unique(db_HR_bio1no328$tNo)
```



```{r}
View(db_HR_bio1no328)

unique(db_HR_bio1no328$ssid)
unique(db_HR_bio328$ssid)
# db_HR_bio2<- bind_rows(db_HR_bio1no328,db_HR_bio328)
db_HR_bio2<-db_HR_bio1no328

colnames(db_HR_bio2)

levels(as.factor(db_HR_bio1no328$ssid))
# db_HR_bio2$ssid<-db_HR_bio2$`as.numeric(ssid)`


#mereg old and new heart rate
# now read them
# db_biohr$trigger
# 
# db_biohr$tno<-db_biohr$trigger
# db_HR_bio2$trigger
# colnames(db_biohr)
# 
# colnames(db_HR_bio2)
# 
# db_biohr$Mean_HR<- db_biohr$HR_BIO
# 
# db_biohr$timestart<- db_biohr$Time
# 
# 
# left_join(db_HR_bio2, db_biohr)

colnames(db_HR_bio2)
db_HR_bio2<- select(db_HR_bio2, c(timestart,Mean_HR, tNo, ssid,trigger2,trigger_200, trigger,stim,mhrtext))

# store only fixation screens

# create screecontr.treatment()
unique(db_HR_bio2$trigger)
unique(db_HR_bio2$trigger2)

db_HR_bio2$screen_content<- if_else(db_HR_bio2$trigger == 100, "Rest",
                                    if_else(db_HR_bio2$trigger == 101, "fixation",
                                    if_else(db_HR_bio2$trigger == 102, "valence",
                                    if_else(db_HR_bio2$trigger == 103, "arousal",
                                    "stim"))))

unique(db_HR_bio2$trigger)

db_HR_bio2$timestart<- as.numeric(db_HR_bio2$timestart)
db_HR_bio2.1<- db_HR_bio2 %>%
  group_by(ssid)%>%
  arrange(ssid, timestart)%>%
  group_by(ssid,screen_content)%>%
  # arrange(ssid, timestart)%>%
  mutate(tNo =  1:n())
   arrange(timestart,ssid)
  # subset(trigger == 100)
  
unique(db_HR_bio2.1$tNo)

unique(db_HR_bio2.1$tNo-8)
table(db_HR_bio2.1$tNo)

db_HR_bio2.1$tNo2<- if_else(db_HR_bio2.1$screen_content == "Rest", -7,
                           as.numeric(as.character(db_HR_bio2.1$tNo)))

db_HR_bio2.1$tNo3<- if_else(db_HR_bio2.1$tNo2 >0 &  db_HR_bio2.1$tNo2< 7, db_HR_bio2.1$tNo2-7,
                          if_else(db_HR_bio2.1$tNo2  >6, db_HR_bio2.1$tNo2-6, db_HR_bio2.1$tNo2))

table(db_HR_bio2.1$tNo3)
test352<- subset(db_HR_bio2.1, ssid == 352)
test353<- subset(db_HR_bio2.1, ssid == 353)
table(test352$tNo3)

write_csv(test352, "test352.csv")

# fixed the issue was trial 15 is supposed to be trigger 23 but we also had a 70, that can be seen on the psychopy data files
write_csv(test353, "test353.csv")

# on 353 the issue was a 99 trigger bveing loaded as a stim

# export 352 and 353 and corect manually, they seems ot have an extra trigger


db_352 <- read_csv("352_Biohr_fixed.csv")
db_353 <- read_csv("353_Biohr_fixed.csv")
unique(db_352$ssid)
db_352
nrow(db_353)

# new dataset withouth the problem ssids
db_HR_bio2.2<- subset(db_HR_bio2.1, ssid != "352")
db_HR_bio2.2<- subset(db_HR_bio2.2, ssid != "353")

nrow(db_HR_bio2.2)

unique(db_HR_bio2.2$ssid)

db_352_353<- bind_rows(db_352, db_353)

nrow(db_352_353)

db_HR_bio2.2$ssid<- as.character(db_HR_bio2.2$ssid)
db_352_353$ssid<- as.character(db_352_353$ssid)

db_352_353$trigger <- as.character(db_352_353$trigger)

nrow(db_HR_bio2.2)
# nrow(db_HR_bio2.1) 2021 result should be less than this

nrow(db_352_353)

db_HR_bio2.3<- bind_rows(db_HR_bio2.2,db_352_353)
nrow(db_HR_bio2.3)
# order

db_HR_bio2.3.1<- db_HR_bio2.3 %>%
  group_by(ssid)%>%
  arrange(ssid, timestart) %>%
  group_by(ssid,screen_content)%>%
  # arrange(ssid, timestart)%>%
  mutate(tNo =  1:n())
   # arrange(timestart,ssid)
  # subset(ssid == 353)

table(db_HR_bio2.3.1$tNo)

# test<- subset(db_HR_bio2.3.1, ssid == "353")

unique(db_HR_bio2.3.1$tNo)

db_HR_bio2.3.1$tNo2<- if_else(db_HR_bio2.3.1$screen_content == "Rest", -7,
                           as.numeric(as.character(db_HR_bio2.3.1$tNo)))

db_HR_bio2.3.1$tNo3<- if_else(db_HR_bio2.3.1$tNo2 >0 &  db_HR_bio2.3.1$tNo2< 7, db_HR_bio2.3.1$tNo2-7,
                          if_else(db_HR_bio2.3.1$tNo2  >6, db_HR_bio2.3.1$tNo2-6, db_HR_bio2.3.1$tNo2))

unique(db_HR_bio2.3.1$tNo3)
```


```{r}
unique(db_HR_bio2.3.1$screen_content)
table(is.na(db_HR_bio2.3.1$screen_content))

str((db_HR_bio2.3.1))
# str(db_biohrold2)
db_biohr$tNo<- db_biohr$tno
db_biohrold2<- db_biohr

db_biohrold2<- select(db_biohr, c(timestart,Mean_HR, tNo, ssid))
unique(db_biohrold2$tNo)

db_HR_bio2$timestart<- as.numeric(db_HR_bio2$timestart)

View(db_biohrold2)
db_biohrold2$timestart<- as.numeric(db_biohrold2$timestart)


# View(db_HR_bio2)
db_HR_bio2$Mean_HR<- as.numeric(db_HR_bio2$Mean_HR)
# db_biohrold2$Mean_HR<- as.numeric(db_biohrold2$Mean_HR)

db_HR_bio2$tNo<- as.character(db_HR_bio2$tNo)

db_biohrold2$tNo<- as.character(db_biohrold2$tNo)
db_HR_bio2$ssid<- as.character(db_HR_bio2$ssid)

db_biohrold2$ssid<- as.character(db_biohrold2$ssid)

str(db_HR_bio2)


# db_biohrold2test<- subset(db_biohrold2, db_biohrold2$tNo != 100)
# db_biohrold2test<- subset(db_biohrold2test, db_biohrold2test$tNo != 101)
# db_biohrold2test<- subset(db_biohrold2test, db_biohrold2test$tNo != 102)
# db_biohrold2test<- subset(db_biohrold2test, db_biohrold2test$tNo != 103)
# db_HR_bio2$subj<- as.factor(db_HR_bio2$ssid)
# db_biohrold2test$subj<- as.factor(db_biohrold2test$ssid)
# db_biohrold2test$ssid<- NULL
# db_HR_bio2$ssid<- NULL

str(db_HR_bio2)

db_HR_bio2<- db_HR_bio2[,1:4]
db_HR_bio2$Mean_HR<- as.numeric(db_HR_bio2$Mean_HR)

db_biohrold2test$Mean_HR<- as.numeric(db_biohrold2test$Mean_HR)

db_HR_bio2$timestart<- as.numeric(db_HR_bio2$timestart)

db_biohrold2test$timestart<- as.numeric(db_biohrold2test$timestart)


# final
colnames(db_HR_bio_final)
db_HR_bio2.3.1
colnames(db_HR_bio2.3.1)

unique(db_HR_bio2.3.1$tNo)
db_HR_bio2.3.1
# db_HR_bio2.3.2<-select()
db_HR_bio_final<- select(db_HR_bio2.3.1, c(1:12))

table(is.na(db_HR_bio_final$Mean_HR))

# db_HR_bio_final<- bind_rows(db_HR_bio2, db_biohrold2test)

View(db_HR_bio_final)

# db_HR_bio_final$ssid<- db_HR_bio_final$subj
levels(as.factor(db_HR_bio_final$ssid))

db_HR_bio_final$subj<- NULL

write_csv(db_HR_bio_final, 'db_HR_bio_final_mar5.csv')

write_csv(db_HR_bio_final, 'db_HR_bio_final_346_355_withfix.csv')

db_HR_bio_final$tNo

db_HR_bio_final$tNo




db_HR_bio1$tNo<- -6:49

db_HR_bio_final$tNo<- if_else(as.numeric(db_HR_bio_final$tNo) < 0, as.numeric(db_HR_bio_final$tNo), as.numeric(db_HR_bio_final$tNo)+1)

db_HR_bio_final$BIO

```

merge heart rate


```{r}
tmp.df4_sum_full_bio$ssid<- as.character(tmp.df4_sum_full_bio$ssid)
db_HR_bio_final$ssid<- as.character(db_HR_bio_final$ssid)


colnames(tmp.df4_sum_full_bio)

unique(tmp.df4_sum_full_bio$tNo)
tmp.df4_sum_full_bio$tNo3<- tmp.df4_sum_full_bio$tNo
tmp.df4_sum_full_bio1<- tmp.df4_sum_full_bio
tmp.df4_sum_full_bio1$tNo<-NULL

unique(tmp.df4_sum_full_bio$screencontent)
unique(db_HR_bio_final$screen_content)

unique(tmp.df4_sum_full_bio$screen_content)

tmp.df4_sum_full_bio$screen_content<- if_else(tmp.df4_sum_full_bio$screencontent == "ValenceResp", "valence",
                                              if_else(tmp.df4_sum_full_bio$screencontent == "IntResp", "arousal", tmp.df4_sum_full_bio$screencontent))


db_HR_bio_final

table(is.na(tmp.df4_sum_full_bio_hr$Mean_HR))

test<- subset(tmp.df4_sum_full_bio_hr, is.na(Mean_HR))

db_HR_bio_final_norest<- subset(db_HR_bio_final, screen_content!= "Rest")


unique(tmp.df4_sum_full_bio$tNo)

unique(db_HR_bio_final_norest$tNo)

# remeber to do this otherwise tno will be matchjing wrong data
db_HR_bio_final_norest$tNo<- db_HR_bio_final_norest$tNo3

tmp.df4_sum_full_bio_hr <- left_join(tmp.df4_sum_full_bio, db_HR_bio_final_norest, by = c('ssid', 'tNo', 'screen_content'))
  
unique(tmp.df4_sum_full_bio_hr$tNo)

table(is.na(tmp.df4_sum_full_bio_hr$Mean_HR))

```

Merge self reports

# add the self report
```{r}

View(tmp.df4_sum_full_bio_hr)

library(readxl)
setwd("~/OneDrive - Nexus365/InteroStudy2020/analysis/DataAnalysisJanuary2020/DataAnalysisJan2020/selfreport")

View(db_selfrep)
db_selfrep <- read_excel("db_self_rep_345_356_final.xlsx")



db_selfrep$ssid <- as.character(db_selfrep$`Participant No`)

tmp.df4_sum_full_bio_hr$ssid <- as.character(tmp.df4_sum_full_bio_hr$ssid)

unique(tmp.df4_sum_full_bio_hr_self$ssid)
table(is.na(tmp.df4_sum_full_bio_hr$Mean_HR))

tmp.df4_sum_full_bio_hr_self <- left_join(tmp.df4_sum_full_bio_hr, db_selfrep, by = 'ssid')
table(is.na(tmp.df4_sum_full_bio_hr_self$Mean_HR))
write_csv(tmp.df4_sum_full, 'tmp.df4_sum_full_bio_hr_self_345_356.csv')


```

merge parsed data
```{r}
tmp.df4_sum_full_bio_hr_self
db_parsed_summarised2$ssid<- as.character(db_parsed_summarised2$ssid)

tmp.df4_sum_full_bio_hr_self_parsed <- left_join(tmp.df4_sum_full_bio_hr_self, db_parsed_summarised2, 
                             by = c("ssid", "trialUnq", "tNo", "screencontent"))


# tmp.df4_sum_full<- left_join(tmp.df4_sum,db_parsed_summarised2, by = c("ssid", "trialUnq", "tNo", "screencontent"))

# save the timecourse data and the aggregated data

tmp.df4_sum_full_bio_hr_self_parsed

# merge behavioural data
db_beh3$ssid<- as.character(db_beh3$ssid)
db_beh3$tNo <- as.character(db_beh3$tNo)
tmp.df4_sum_full_bio_hr_self_parsed$tNo<- as.character(tmp.df4_sum_full_bio_hr_self_parsed$tNo)
# tmp.df4_sum_full<- 
  
tmp.df4_sum_full_bio_hr_self_parsed
table(is.na(tmp.df4_sum_full_bio_hr_self_parsed$Mean_HR))

tmp.df4_sum_full_bio_hr_self_parsed<- left_join(tmp.df4_sum_full_bio_hr_self_parsed, db_beh3, by = c('ssid', 'tNo'))


View(db_beh3)
tmp.df4_sum_full<- tmp.df4_sum_full%>%
  arrange(ssid, tNo, time)



tmp.df4_sum_full_bio_hr_self_parsed$screencontent_no

tmp.df4_sum_full_bio_hr_self_parsed$TAS
# tmp.df4_sum_full_bio_hr_self_parsed<- tmp.df4_sum_full_bio_hr_self_parsed %>%
#   subset(screencontent_no>2)%>%
#   group_by(ssid)%>%
#   summarise_if(is.numeric,mean, na.rm = TRUE)%>%
#   ggplot(aes(Age,sdev_gazesum))+
#   geom_point()+
#   geom_smooth(method = lm, se = F)


colnames(tmp.df4_sum_full_bio_hr_self_parsed)  

tmp.df4_sum_full_bio_hr_self_parsed$Age<- tmp.df4_sum_full_bio_hr_self_parsed$age_response_specific
tmp.df4_sum_full_bio_hr_self_parsed$gender<- substr(tmp.df4_sum_full_bio_hr_self_parsed$gender_response,1,1)

tmp.df4_sum_full_bio_hr_self_parsed$BIO_filename<- NULL
tmp.df4_sum_full_bio_hr_self_parsed$`Participant Completion Code`<- NULL
tmp.df4_sum_full_bio_hr_self_parsed$`Participant Private ID`<- NULL

tmp.df4_sum_full_bio_hr_self_parsed$`Participant No`<- NULL
tmp.df4_sum_full_bio_hr_self_parsed$age_response_specific<- NULL
tmp.df4_sum_full_bio_hr_self_parsed$Event.NID<- NULL
tmp.df4_sum_full_bio_hr_self_parsed$`Event Index`<- NULL
tmp.df4_sum_full_bio_hr_self_parsed$gender_response<- NULL

tmp.df4_sum_full_bio_hr_self_parsed$`Person testing`<- NULL
tmp.df4_sum_full_bio_hr_self_parsed$Event.Nr.x<- NULL
tmp.df4_sum_full_bio_hr_self_parsed$filename.x<- NULL
tmp.df4_sum_full_bio_hr_self_parsed$filename.y<- NULL

tmp.df4_sum_full_bio_hr_self_parsed

tmp.df4_sum_full_bio_hr_self_parsed<- tmp.df4_sum_full_bio_hr_self_parsed%>%
  rename(IAS = IAS_score)%>%
  rename(ASD_self = ASD)


# tmp.df4_sum_full_bio_hr_self_parsed1<- select(tmp.df4_sum_full_bio_hr_self_parsed,)

write_csv(tmp.df4_sum_full_bio_hr_self_parsed, 'tmp.df4_sum_full_bio_hr_self_parsed_345_356.csv')
write_csv(tmp.df4, 'tmp.df4_timeseries_345_356.csv')
```





